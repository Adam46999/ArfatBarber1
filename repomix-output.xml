This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.firebase/hosting.ZGlzdA.cache
.firebaserc
.github/workflows/booking-reminders.yml
.gitignore
eslint.config.js
et --hard a2865d4
et --hard HEAD~3
firebase.json
functions/.gitignore
functions/index.js
functions/package.json
index.html
package.json
postcss.config.cjs
public/barber-hero.jpg
public/barber-logo.png
public/cuts/p1.jpg
public/cuts/p10.jpg
public/cuts/p11.jpg
public/cuts/p2.jpg
public/cuts/p3.jpg
public/cuts/p4.jpg
public/cuts/p5.jpg
public/cuts/p6.jpg
public/cuts/p8.jpg
public/cuts/p9.jpg
public/firebase-messaging-sw.js
public/vite.svg
README.md
scripts/notifications/config.js
scripts/notifications/firebaseAdmin.js
scripts/notifications/firestoreBookings.js
scripts/notifications/runReminders.js
scripts/notifications/runTestNotifications.js
scripts/notifications/sendFcm.js
scripts/notifications/sendTestNotification.js
scripts/notifications/templates.js
src/App.css
src/App.jsx
src/assets/arfatblacklogo.png
src/assets/barber-logo.png.jpg
src/assets/react.svg
src/components/about/AboutContent.jsx
src/components/BackToTopButton.jsx
src/components/booking/BookingSection.jsx
src/components/booking/BookingTracker.jsx
src/components/booking/CheckReservation.jsx
src/components/booking/parts/DateField.jsx
src/components/booking/parts/DateSelector.jsx
src/components/booking/parts/OpeningStatusCard.jsx
src/components/booking/parts/PhoneInput.jsx
src/components/booking/parts/ProgressBar.jsx
src/components/booking/parts/ServiceOption.jsx
src/components/booking/parts/ServiceSelector.jsx
src/components/booking/parts/SuccessModal.jsx
src/components/booking/parts/TimeSelector.jsx
src/components/booking/parts/TimeSlots.jsx
src/components/booking/parts/UpcomingBookings.jsx
src/components/booking/workingHours.js
src/components/CalendarGrid.jsx
src/components/common/SectionTitle.jsx
src/components/home/ContactSection.jsx
src/components/home/HeroSection.jsx
src/components/home/InstagramSlider.jsx
src/components/layout/FloatingWhatsappButton.jsx
src/components/layout/Footer.jsx
src/components/layout/Header.jsx
src/components/layout/LanguageSwitcher.jsx
src/components/reviews/AllReviewsModal.jsx
src/components/reviews/BarberRatingSection.jsx
src/components/reviews/CustomerRatingSection.jsx
src/components/reviews/reviewsApi.js
src/components/shared/SecretBarberButton.jsx
src/components/shared/Spinner.jsx
src/components/ui/Button.jsx
src/components/ui/Card.jsx
src/constants/barberDefaultWeeklyHours.js
src/constants/workingHours.js
src/firebase.js
src/hooks/useAvailableTimes.js
src/hooks/useBookingSubmit.js
src/hooks/useWeeklyWorkingHours.js
src/i18n.js
src/index.css
src/main.jsx
src/pages/AdminBookings.jsx
src/pages/adminBookings/AdminBookingsPage.jsx
src/pages/adminBookings/BookingCard.jsx
src/pages/adminBookings/DayGroup.jsx
src/pages/adminBookings/helpers.js
src/pages/adminBookings/PastSection.jsx
src/pages/adminBookings/Toolbar.jsx
src/pages/adminBookings/useAdminBookingsData.js
src/pages/AdminBookingsV2.jsx
src/pages/BarberPanel.old.jsx
src/pages/barberPanel/BarberPanel.jsx
src/pages/barberPanel/components/DateDropdown.jsx
src/pages/barberPanel/components/ExtraSlotsCard.jsx
src/pages/barberPanel/components/LimitOnePerDayCard.jsx
src/pages/barberPanel/components/NotificationTestCard.jsx
src/pages/barberPanel/components/RecentBookingsCard.jsx
src/pages/barberPanel/components/StickySaveBar.jsx
src/pages/barberPanel/components/TimesGrid.jsx
src/pages/barberPanel/components/WeeklyDayCard.jsx
src/pages/barberPanel/components/WeeklyHoursEditor.jsx
src/pages/barberPanel/components/WeeklyHoursEditorMobile.jsx
src/pages/barberPanel/components/WeeklyHoursEditSheet.jsx
src/pages/barberPanel/components/WeeklyHoursReadOnly.jsx
src/pages/barberPanel/hooks/useBlockedDay.js
src/pages/barberPanel/hooks/useBlockedTimes.js
src/pages/barberPanel/hooks/useBookingsLive.js
src/pages/barberPanel/hooks/useLimitOnePerDaySetting.js
src/pages/barberPanel/hooks/useSlotExtrasLive.js
src/pages/barberPanel/RecentBookingsCard.jsx
src/pages/barberPanel/reviews/ArchivedPanel.jsx
src/pages/barberPanel/reviews/BlockedPhonesPanel.jsx
src/pages/barberPanel/reviews/FiltersBar.jsx
src/pages/barberPanel/reviews/ReviewCard.jsx
src/pages/barberPanel/reviews/ReviewsList.jsx
src/pages/barberPanel/reviews/ReviewsManagerPage.jsx
src/pages/barberPanel/reviews/SummaryCards.jsx
src/pages/barberPanel/reviews/TabsBar.jsx
src/pages/barberPanel/reviews/UndoToast.jsx
src/pages/barberPanel/reviews/useReviewsManager.js
src/pages/barberPanel/ReviewsAdminPage.jsx
src/pages/barberPanel/ReviewsManagerPage.jsx
src/pages/barberPanel/utils/dates.js
src/pages/barberPanel/utils/targets.js
src/pages/barberPanel/utils/weeklyHours.js
src/pages/barberPanel/utils/weeklyHoursUX.js
src/pages/barberPanel/WeeklyHoursPage.jsx
src/pages/BlockedPhones.jsx
src/pages/BookingForm.jsx
src/pages/BookingIntro.jsx
src/pages/Contact.jsx
src/pages/Dashboard.jsx
src/pages/Home.jsx
src/pages/InstagramCallback.jsx
src/pages/Login.jsx
src/pages/NotFound.jsx
src/pages/products/ProductsPage.jsx
src/routes.jsx
src/services/barberWeeklyHours.js
src/services/bookingService.js
src/services/fcmTest.js
src/translations/ar.json
src/translations/en.json
src/translations/he.json
src/utils/cancelGuard.js
src/utils/dateTime.js
src/utils/phone.js
src/utils/phone.jsx
src/utils/slots.js
src/utils/timeSlots.js
src/utils/validators.js
src/utils/workingHours.js
tailwind.config.js
vercel.json
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/reviews/AllReviewsModal.jsx">
// src/components/reviews/AllReviewsModal.jsx
import { useEffect, useMemo, useState } from "react";
import { fetchReviewsPage } from "./reviewsApi";

// ✅ ملاحظة: أنا ما بفرض ستايل.
// كل الستايلات جوا props.classes عشان تنسخها من صفحة الزبون الحالية.
export default function AllReviewsModal({
  open,
  onClose,
  db,
  barberId,
  classes,
  title = "كل التقييمات",
  pageSize = 10,
}) {
  const [items, setItems] = useState([]);
  const [lastDoc, setLastDoc] = useState(null);
  const [loading, setLoading] = useState(false);
  const [loadingMore, setLoadingMore] = useState(false);

  const canLoadMore = useMemo(() => !!lastDoc, [lastDoc]);

  useEffect(() => {
    if (!open) return;

    let alive = true;
    (async () => {
      setLoading(true);
      try {
        const res = await fetchReviewsPage({
          db,
          barberId,
          pageSize,
          afterDoc: null,
        });
        if (!alive) return;
        setItems(res.items);
        setLastDoc(res.lastDoc);
      } finally {
        if (alive) setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [open, db, barberId, pageSize]);

  const loadMore = async () => {
    if (!lastDoc || loadingMore) return;
    setLoadingMore(true);
    try {
      const res = await fetchReviewsPage({
        db,
        barberId,
        pageSize,
        afterDoc: lastDoc,
      });
      setItems((p) => [...p, ...res.items]);
      setLastDoc(res.lastDoc);
    } finally {
      setLoadingMore(false);
    }
  };

  if (!open) return null;

  return (
    <div className={classes.modalOverlay} onClick={onClose}>
      <div className={classes.modalCard} onClick={(e) => e.stopPropagation()}>
        <div className={classes.modalHeader}>
          <div className={classes.modalTitle}>{title}</div>
          <button className={classes.modalCloseBtn} onClick={onClose}>
            ✕
          </button>
        </div>

        <div className={classes.modalBody}>
          {loading ? (
            <div className={classes.loading}>جارٍ التحميل...</div>
          ) : items.length === 0 ? (
            <div className={classes.emptyState}>
              لا يوجد تقييمات لعرضها حاليًا
            </div>
          ) : (
            <div className={classes.list}>
              {items.map((r) => (
                <ReviewRow key={r.id} r={r} classes={classes} />
              ))}
            </div>
          )}

          {canLoadMore && !loading && (
            <button
              className={classes.loadMoreBtn}
              onClick={loadMore}
              disabled={loadingMore}
            >
              {loadingMore ? "جارٍ تحميل المزيد..." : "تحميل المزيد"}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

function ReviewRow({ r, classes }) {
  const [expanded, setExpanded] = useState(false);

  const name = prettyName(r.userName);
  const stars = clampStars(r.rating);

  return (
    <div className={classes.reviewCard}>
      <div className={classes.reviewTopRow}>
        <div className={classes.starsRow}>
          <Stars value={stars} classes={classes} />
        </div>

        {/* ✅ اسم الزبون */}
        <div className={classes.userName}>{name}</div>
      </div>

      {!!r.comment && (
        <div className={classes.commentWrap}>
          <div
            className={expanded ? classes.commentFull : classes.commentClamp}
          >
            {r.comment}
          </div>

          {String(r.comment).length > 140 && (
            <button
              className={classes.moreBtn}
              onClick={() => setExpanded((p) => !p)}
            >
              {expanded ? "إخفاء" : "عرض المزيد"}
            </button>
          )}
        </div>
      )}
    </div>
  );
}

function Stars({ value, classes }) {
  // رسم نجوم بسيط بدون فرض ألوان جديدة — استخدم كلاس مشروعك
  const v = clampStars(value);
  return (
    <div className={classes.starsInner}>
      {Array.from({ length: 5 }).map((_, i) => (
        <span key={i} className={i < v ? classes.starOn : classes.starOff}>
          ★
        </span>
      ))}
    </div>
  );
}

function clampStars(x) {
  const n = Number(x || 0);
  if (Number.isNaN(n)) return 0;
  return Math.max(0, Math.min(5, Math.round(n)));
}

function prettyName(name) {
  const s = String(name || "").trim();
  if (!s) return "زبون";
  // Ahmad S. style (بدون ما نكسر أسماء عربية)
  const parts = s.split(/\s+/).filter(Boolean);
  if (parts.length <= 1) return parts[0];
  const first = parts[0];
  const lastInitial = parts[parts.length - 1][0] || "";
  return `${first} ${lastInitial}.`;
}
</file>

<file path="src/components/reviews/CustomerRatingSection.jsx">
// src/components/reviews/CustomerRatingSection.jsx
import { useEffect, useState } from "react";
import AllReviewsModal from "./AllReviewsModal";
import { fetchLatestReviews } from "./reviewsApi";

export default function CustomerRatingSection({
  db,
  barberId,
  title = "التقييمات",
  classes,
  previewCount = 3,
}) {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [openAll, setOpenAll] = useState(false);

  useEffect(() => {
    let alive = true;

    (async () => {
      if (!barberId) {
        setItems([]);
        return;
      }

      setLoading(true);
      try {
        const res = await fetchLatestReviews({
          db,
          barberId,
          pageSize: previewCount,
        });

        if (!alive) return;
        setItems(res.items);
      } finally {
        if (alive) setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [db, barberId, previewCount]);

  return (
    <div className={classes.sectionWrap}>
      <div className={classes.sectionTitle}>{title}</div>

      {loading ? (
        <div className={classes.loading}>جارٍ التحميل...</div>
      ) : items.length === 0 ? (
        <div className={classes.emptyState}>لا يوجد تقييمات بعد</div>
      ) : (
        <>
          <div className={classes.list}>
            {items.map((r) => (
              <PreviewReviewCard key={r.id} r={r} classes={classes} />
            ))}
          </div>

          <div className={classes.viewAllRow}>
            <button
              className={classes.viewAllBtn}
              onClick={() => setOpenAll(true)}
            >
              عرض كل التقييمات
            </button>
          </div>
        </>
      )}

      <AllReviewsModal
        open={openAll}
        onClose={() => setOpenAll(false)}
        db={db}
        barberId={barberId}
        classes={classes}
        title="كل التقييمات"
      />
    </div>
  );
}

function PreviewReviewCard({ r, classes }) {
  const [expanded, setExpanded] = useState(false);

  const name = prettyName(r.userName);
  const stars = clampStars(r.rating);

  return (
    <div className={classes.reviewCard}>
      <div className={classes.reviewTopRow}>
        <div className={classes.starsRow}>
          <Stars value={stars} classes={classes} />
        </div>

        {/* ✅ اسم الزبون */}
        <div className={classes.userName}>{name}</div>
      </div>

      {!!r.comment && (
        <div className={classes.commentWrap}>
          <div
            className={expanded ? classes.commentFull : classes.commentClamp}
          >
            {r.comment}
          </div>

          {String(r.comment).length > 140 && (
            <button
              className={classes.moreBtn}
              onClick={() => setExpanded((p) => !p)}
            >
              {expanded ? "إخفاء" : "عرض المزيد"}
            </button>
          )}
        </div>
      )}
    </div>
  );
}

function Stars({ value, classes }) {
  const v = clampStars(value);
  return (
    <div className={classes.starsInner}>
      {Array.from({ length: 5 }).map((_, i) => (
        <span key={i} className={i < v ? classes.starOn : classes.starOff}>
          ★
        </span>
      ))}
    </div>
  );
}

function clampStars(x) {
  const n = Number(x || 0);
  if (Number.isNaN(n)) return 0;
  return Math.max(0, Math.min(5, Math.round(n)));
}

function prettyName(name) {
  const s = String(name || "").trim();
  if (!s) return "زبون";
  const parts = s.split(/\s+/).filter(Boolean);
  if (parts.length <= 1) return parts[0];
  const first = parts[0];
  const lastInitial = parts[parts.length - 1][0] || "";
  return `${first} ${lastInitial}.`;
}
</file>

<file path="src/components/reviews/reviewsApi.js">
// src/components/reviews/reviewsApi.js
import {
  collection,
  getDocs,
  limit,
  orderBy,
  query,
  startAfter,
  where,
} from "firebase/firestore";

/**
 * حاولنا نخلي أسماء الحقول مرنة (لأنه مرات المشاريع بتختلف):
 * - barberId
 * - rating
 * - comment / text / message
 * - createdAt
 * - userName / customerName / displayName
 */

function normalizeReview(docSnap) {
  const d = docSnap.data() || {};
  return {
    id: docSnap.id,
    barberId: d.barberId,
    rating: Number(d.rating ?? d.stars ?? 0),
    comment: d.comment ?? d.text ?? d.message ?? "",
    createdAt: d.createdAt ?? d.timestamp ?? null,
    userName: d.userName ?? d.customerName ?? d.displayName ?? d.name ?? "",
    userId: d.userId ?? d.customerId ?? null,
    visible: d.visible ?? true,
    raw: d,
  };
}

export async function fetchLatestReviews({
  db,
  barberId,
  pageSize = 3,
  includeHidden = false,
}) {
  if (!barberId) return { items: [], lastDoc: null };

  // لو عندك فلترة visible بالمشروع، خليك consistent بين الزبون والحلاق
  const base = [
    collection(db, "reviews"),
    where("barberId", "==", barberId),
    orderBy("createdAt", "desc"),
    limit(pageSize),
  ];

  // ما بنحط where("visible"==true) افتراضيًا عشان ما “يختفي” اشي عند طرف ويظهر عند طرف
  // انت إذا بدك تفعّلها، فعّلها بالطرفين معًا.
  const q = query(...base);

  const snap = await getDocs(q);
  const docs = snap.docs;
  const items = docs
    .map(normalizeReview)
    .filter((r) => (includeHidden ? true : r.visible !== false));

  return { items, lastDoc: docs.length ? docs[docs.length - 1] : null };
}

export async function fetchReviewsPage({
  db,
  barberId,
  pageSize = 10,
  afterDoc = null,
  includeHidden = false,
}) {
  if (!barberId) return { items: [], lastDoc: null };

  const parts = [
    collection(db, "reviews"),
    where("barberId", "==", barberId),
    orderBy("createdAt", "desc"),
    limit(pageSize),
  ];

  const q = afterDoc ? query(...parts, startAfter(afterDoc)) : query(...parts);

  const snap = await getDocs(q);
  const docs = snap.docs;

  const items = docs
    .map(normalizeReview)
    .filter((r) => (includeHidden ? true : r.visible !== false));

  return { items, lastDoc: docs.length ? docs[docs.length - 1] : null };
}
</file>

<file path="src/pages/barberPanel/reviews/ArchivedPanel.jsx">
// src/pages/barberPanel/reviews/ArchivedPanel.jsx
function starsLabel(n) {
  const v = Math.max(0, Math.min(5, Number(n || 0)));
  return "★".repeat(v) + "☆".repeat(5 - v);
}

export default function ArchivedPanel({
  items,
  loading,
  onRestore,
  onDeleteForever,
}) {
  if (loading && (!items || items.length === 0)) {
    return (
      <div className="bg-white border border-gray-200 rounded-2xl p-6 text-center shadow-sm">
        جارٍ تحميل الأرشيف...
      </div>
    );
  }

  if (!items || items.length === 0) {
    return (
      <div className="bg-white border border-gray-200 rounded-2xl p-6 text-center shadow-sm text-gray-600">
        لا يوجد تقييمات مؤرشفة.
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {items.map((r) => (
        <div
          key={r.id}
          className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm"
        >
          <div className="flex items-start justify-between gap-3">
            <div className="text-right">
              <div className="font-extrabold text-gray-900">
                {r.customerName || r.userName || r.displayName || "زبون"}
              </div>
              <div className="text-xs text-gray-500 mt-0.5">
                {r.phoneKey ? `رقم: ${r.phoneKey}` : "بدون رقم"}
              </div>
            </div>

            <div className="text-right">
              <div className="text-lg font-black text-gray-900">
                {starsLabel(r.rating ?? r.stars ?? 0)}
              </div>
              <div className="text-xs text-gray-500">مؤرشف</div>
            </div>
          </div>

          <div className="mt-4 flex flex-wrap gap-2 justify-end">
            <button
              onClick={() => onRestore(r.id)}
              className="px-3 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 font-extrabold text-sm"
            >
              استرجاع
            </button>

            <button
              onClick={() => onDeleteForever(r.id)}
              className="px-3 py-2 rounded-xl border border-rose-200 bg-rose-50 text-rose-800 hover:bg-rose-100 font-extrabold text-sm"
            >
              حذف نهائي
            </button>
          </div>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/BlockedPhonesPanel.jsx">
// src/pages/barberPanel/reviews/BlockedPhonesPanel.jsx
export default function BlockedPhonesPanel({ blocked, loading, onUnblock }) {
  if (loading && (!blocked || blocked.length === 0)) {
    return (
      <div className="bg-white border border-gray-200 rounded-2xl p-6 text-center shadow-sm">
        جارٍ تحميل الأرقام...
      </div>
    );
  }

  if (!blocked || blocked.length === 0) {
    return (
      <div className="bg-white border border-gray-200 rounded-2xl p-6 text-center shadow-sm text-gray-600">
        لا يوجد أرقام محظورة.
      </div>
    );
  }

  return (
    <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
      <div className="text-right font-extrabold text-gray-900 mb-3">
        قائمة الأرقام المحظورة
      </div>

      <div className="divide-y">
        {blocked.map((b) => (
          <div
            key={b.id}
            className="py-3 flex items-center justify-between gap-3"
          >
            <div className="text-right">
              <div className="font-black text-gray-900">
                {b.phoneKey || b.id}
              </div>
              <div className="text-xs text-gray-500">
                {b.from ? `المصدر: ${b.from}` : ""}{" "}
                {b.fromBarberId ? ` • ${b.fromBarberId}` : ""}
              </div>
            </div>

            <button
              onClick={() => onUnblock(b.phoneKey || b.id)}
              className="px-3 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 font-extrabold text-sm"
            >
              إلغاء الحظر
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/FiltersBar.jsx">
// src/pages/barberPanel/reviews/FiltersBar.jsx
export default function FiltersBar({
  qText,
  setQText,
  stars,
  setStars,
  sortBy,
  setSortBy,
  onRefresh,
  loading,
}) {
  return (
    <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input
          value={qText}
          onChange={(e) => setQText(e.target.value)}
          placeholder="بحث بالاسم / الرقم / النص..."
          className="w-full rounded-xl border border-gray-300 px-3 py-2 text-right focus:ring-2 focus:ring-gold bg-white"
        />

        <select
          value={stars}
          onChange={(e) => setStars(e.target.value)}
          className="w-full rounded-xl border border-gray-300 px-3 py-2 text-right bg-white"
        >
          <option value="all">كل النجوم</option>
          <option value="5">5 نجوم</option>
          <option value="4">4 نجوم</option>
          <option value="3">3 نجوم</option>
          <option value="2">2 نجوم</option>
          <option value="1">1 نجمة</option>
        </select>

        <select
          value={sortBy}
          onChange={(e) => setSortBy(e.target.value)}
          className="w-full rounded-xl border border-gray-300 px-3 py-2 text-right bg-white"
        >
          <option value="newest">الأحدث</option>
          <option value="highest">الأعلى تقييمًا</option>
          <option value="lowest">الأقل تقييمًا</option>
        </select>

        <button
          onClick={onRefresh}
          disabled={loading}
          className={`rounded-xl px-4 py-2 font-extrabold border transition
            ${loading ? "opacity-60 cursor-not-allowed" : "hover:bg-gray-50"}
            bg-white border-gray-200`}
        >
          {loading ? "جارٍ التحديث..." : "تحديث"}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/ReviewCard.jsx">
// src/pages/barberPanel/reviews/ReviewCard.jsx
function starsLabel(n) {
  const v = Math.max(0, Math.min(5, Number(n || 0)));
  return "★".repeat(v) + "☆".repeat(5 - v);
}

function prettyName(name) {
  const s = String(name || "").trim();
  if (!s) return "زبون";
  const parts = s.split(/\s+/).filter(Boolean);
  if (parts.length <= 1) return parts[0];
  const first = parts[0];
  const lastInitial = parts[parts.length - 1][0] || "";
  return `${first} ${lastInitial}.`;
}

export default function ReviewCard({
  r,
  isBlocked,
  onArchive,
  onBlock,
  onUnblock,
}) {
  const id = r.id;
  const name = prettyName(r.customerName || r.userName || r.displayName);
  const phoneKey = r.phoneKey || r.phone || r.phoneNumber || "";
  const rating = Number(r.rating ?? r.stars ?? 0);
  const msg = (r.message || r.text || r.comment || "").trim();

  return (
    <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
      <div className="flex items-start justify-between gap-3">
        <div className="text-right">
          <div className="font-extrabold text-gray-900">{name}</div>
          <div className="text-xs text-gray-500 mt-0.5">
            {phoneKey ? `رقم: ${phoneKey}` : "بدون رقم"}
          </div>
        </div>

        <div className="text-right">
          <div className="text-lg font-black text-gray-900">
            {starsLabel(rating)}
          </div>
          <div className="text-xs text-gray-500">({rating || 0}/5)</div>
        </div>
      </div>

      {msg ? (
        <div className="mt-3 text-sm text-gray-800 bg-gray-50 border border-gray-200 rounded-xl p-3 text-right">
          {msg}
        </div>
      ) : (
        <div className="mt-3 text-sm text-gray-400 text-right">بدون تعليق</div>
      )}

      <div className="mt-4 flex flex-wrap gap-2 justify-end">
        <button
          onClick={() => onArchive(id)}
          className="px-3 py-2 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 font-extrabold text-sm"
        >
          أرشفة
        </button>

        {phoneKey ? (
          isBlocked ? (
            <button
              onClick={() => onUnblock(phoneKey)}
              className="px-3 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 font-extrabold text-sm"
            >
              إلغاء الحظر
            </button>
          ) : (
            <button
              onClick={() => onBlock(phoneKey, id)}
              className="px-3 py-2 rounded-xl border border-rose-200 bg-rose-50 text-rose-800 hover:bg-rose-100 font-extrabold text-sm"
            >
              حظر الرقم
            </button>
          )
        ) : null}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/ReviewsList.jsx">
// src/pages/barberPanel/reviews/ReviewsList.jsx
import ReviewCard from "./ReviewCard";

export default function ReviewsList({
  items,
  loading,
  hasMore,
  onLoadMore,
  blockedSet,
  onArchive,
  onBlock,
  onUnblock,
}) {
  if (loading && (!items || items.length === 0)) {
    return (
      <div className="bg-white border border-gray-200 rounded-2xl p-6 text-center shadow-sm">
        جارٍ تحميل التقييمات...
      </div>
    );
  }

  if (!items || items.length === 0) {
    return (
      <div className="bg-white border border-gray-200 rounded-2xl p-6 text-center shadow-sm text-gray-600">
        لا يوجد تقييمات مطابقة.
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {items.map((r) => (
        <ReviewCard
          key={r.id}
          r={r}
          isBlocked={blockedSet?.has(String(r.phoneKey || ""))}
          onArchive={onArchive}
          onBlock={onBlock}
          onUnblock={onUnblock}
        />
      ))}

      <div className="pt-2">
        {hasMore ? (
          <button
            onClick={onLoadMore}
            disabled={loading}
            className={`w-full rounded-2xl px-4 py-3 font-extrabold border transition
              ${loading ? "opacity-60 cursor-not-allowed" : "hover:bg-gray-50"}
              bg-white border-gray-200`}
          >
            {loading ? "جارٍ التحميل..." : "تحميل المزيد"}
          </button>
        ) : (
          <div className="text-center text-xs text-gray-500">
            وصلت للنهاية ✅
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/ReviewsManagerPage.jsx">

</file>

<file path="src/pages/barberPanel/reviews/SummaryCards.jsx">
// src/pages/barberPanel/reviews/SummaryCards.jsx
function StatCard({ title, value, hint }) {
  return (
    <div className="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
      <div className="text-xs text-gray-500 font-bold">{title}</div>
      <div className="mt-1 text-2xl font-black text-gray-900">{value}</div>
      {hint ? <div className="mt-1 text-xs text-gray-500">{hint}</div> : null}
    </div>
  );
}

export default function SummaryCards({ count, avg, byStar }) {
  const avgFixed = Number.isFinite(avg) ? avg.toFixed(2) : "0.00";
  const five = Number(byStar?.[5] || 0);
  const four = Number(byStar?.[4] || 0);
  const three = Number(byStar?.[3] || 0);

  return (
    <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
      <StatCard
        title="عدد التقييمات"
        value={count}
        hint="التقييمات النشطة فقط"
      />
      <StatCard title="المتوسط" value={avgFixed} hint="حسب التقييمات النشطة" />
      <StatCard title="5 نجوم" value={five} />
      <StatCard title="4–3 نجوم" value={four + three} />
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/TabsBar.jsx">
// src/pages/barberPanel/reviews/TabsBar.jsx
export default function TabsBar({ tab, setTab, counts }) {
  const items = [
    { key: "reviews", label: "التقييمات", count: counts?.reviews ?? 0 },
    { key: "blocked", label: "الأرقام المحظورة", count: counts?.blocked ?? 0 },
    { key: "archived", label: "الأرشيف", count: counts?.archived ?? 0 },
  ];

  return (
    <div className="bg-white border border-gray-200 rounded-2xl p-2 shadow-sm flex gap-2 justify-between">
      {items.map((it) => {
        const active = tab === it.key;
        return (
          <button
            key={it.key}
            onClick={() => setTab(it.key)}
            className={`flex-1 rounded-xl px-3 py-2 text-sm font-extrabold transition flex items-center justify-center gap-2
              ${active ? "bg-gold text-primary" : "bg-transparent hover:bg-gray-50 text-gray-800"}`}
          >
            <span>{it.label}</span>
            <span
              className={`text-xs px-2 py-0.5 rounded-full border
              ${active ? "border-white/50 bg-white/20 text-primary" : "border-gray-200 bg-gray-50 text-gray-700"}`}
            >
              {it.count}
            </span>
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/UndoToast.jsx">
// src/pages/barberPanel/reviews/UndoToast.jsx
export default function UndoToast({ undo, onUndo, onClose }) {
  if (!undo) return null;

  return (
    <div className="fixed bottom-5 left-1/2 -translate-x-1/2 z-[9999]">
      <div className="bg-gray-900 text-white rounded-2xl px-4 py-3 shadow-lg flex items-center gap-3">
        <div className="text-sm">
          تم أرشفة تقييم {undo.name ? `(${undo.name})` : ""}.
        </div>

        <button
          className="px-3 py-1.5 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 font-black text-sm"
          onClick={onUndo}
        >
          تراجع
        </button>

        <button
          className="px-3 py-1.5 rounded-xl bg-white/0 hover:bg-white/10 font-black text-sm"
          onClick={onClose}
          aria-label="Close"
        >
          ✕
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/reviews/useReviewsManager.js">
// src/pages/barberPanel/reviews/useReviewsManager.js
import { useEffect, useMemo, useRef, useState } from "react";
import { db } from "../../../firebase";
import {
  collection,
  deleteDoc,
  doc,
  getDoc,
  getDocs,
  limit,
  orderBy,
  query,
  runTransaction,
  serverTimestamp,
  setDoc,
  startAfter,
} from "firebase/firestore";

const BARBER_ID = "arfat";
const ARCHIVE_KEEP_DAYS = 14;
const UNDO_MS = 7000;

function addDaysDate(days) {
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d;
}

function safeLower(v) {
  return (v || "").toString().toLowerCase();
}

function prettyName(name) {
  const s = String(name || "").trim();
  if (!s) return "زبون";
  const parts = s.split(/\s+/).filter(Boolean);
  if (parts.length <= 1) return parts[0];
  const first = parts[0];
  const lastInitial = parts[parts.length - 1][0] || "";
  return `${first} ${lastInitial}.`;
}

function safeSummary(data) {
  return (
    data || {
      count: 0,
      sum: 0,
      byStar: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
      tagCounts: {},
    }
  );
}

function decSummary(cur, rating, tags = []) {
  const r = Number(rating || 0);
  const next = {
    ...cur,
    count: Math.max(0, Number(cur.count || 0) - 1),
    sum: Math.max(0, Number(cur.sum || 0) - r),
    byStar: { ...(cur.byStar || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }) },
    tagCounts: { ...(cur.tagCounts || {}) },
  };
  if (r >= 1 && r <= 5)
    next.byStar[r] = Math.max(0, Number(next.byStar[r] || 0) - 1);

  (Array.isArray(tags) ? tags : []).forEach((k) => {
    next.tagCounts[k] = Math.max(0, Number(next.tagCounts[k] || 0) - 1);
    if (next.tagCounts[k] === 0) delete next.tagCounts[k];
  });

  return next;
}

function incSummary(cur, rating, tags = []) {
  const r = Number(rating || 0);
  const next = {
    ...cur,
    count: Number(cur.count || 0) + 1,
    sum: Number(cur.sum || 0) + r,
    byStar: { ...(cur.byStar || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }) },
    tagCounts: { ...(cur.tagCounts || {}) },
  };
  if (r >= 1 && r <= 5) next.byStar[r] = Number(next.byStar[r] || 0) + 1;

  (Array.isArray(tags) ? tags : []).forEach((k) => {
    next.tagCounts[k] = Number(next.tagCounts[k] || 0) + 1;
  });

  return next;
}

export function useReviewsManager() {
  const [tab, setTab] = useState("reviews"); // reviews | blocked | archived

  // Active reviews
  const [reviews, setReviews] = useState([]);
  const [loadingReviews, setLoadingReviews] = useState(false);
  const [lastDoc, setLastDoc] = useState(null);
  const [hasMore, setHasMore] = useState(true);

  // Archived
  const [archived, setArchived] = useState([]);
  const [loadingArchived, setLoadingArchived] = useState(false);

  // Blocked
  const [blocked, setBlocked] = useState([]);
  const [loadingBlocked, setLoadingBlocked] = useState(false);

  // Filters / sort
  const [qText, setQText] = useState("");
  const [stars, setStars] = useState("all");
  const [sortBy, setSortBy] = useState("newest"); // newest | highest | lowest

  // Summary
  const [summary, setSummary] = useState({
    count: 0,
    sum: 0,
    byStar: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
    tagCounts: {},
  });
  const [loadingSummary, setLoadingSummary] = useState(false);

  // Undo toast
  const [undo, setUndo] = useState(null); // { id, name }
  const undoTimerRef = useRef(null);

  const reviewsCol = collection(db, "barbers", BARBER_ID, "reviews");
  const summaryRef = doc(db, "barbers", BARBER_ID, "meta", "reviewsSummary");

  const count = Number(summary.count || 0);
  const avg = count > 0 ? summary.sum / count : 0;

  const fetchSummary = async () => {
    if (loadingSummary) return;
    setLoadingSummary(true);
    try {
      const ss = await getDoc(summaryRef);
      if (ss.exists()) setSummary((p) => ({ ...p, ...ss.data() }));
    } catch (e) {
      console.error("fetchSummary error:", e);
    } finally {
      setLoadingSummary(false);
    }
  };

  const fetchReviews = async ({ reset = false } = {}) => {
    if (loadingReviews) return;
    setLoadingReviews(true);

    try {
      let qBase = query(reviewsCol, orderBy("createdAt", "desc"), limit(50));

      if (!reset && lastDoc) {
        qBase = query(
          reviewsCol,
          orderBy("createdAt", "desc"),
          startAfter(lastDoc),
          limit(50),
        );
      }

      const snap = await getDocs(qBase);
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

      // active فقط
      const onlyActive = docs.filter(
        (r) => (r.status || "active") === "active",
      );

      if (reset) setReviews(onlyActive);
      else setReviews((p) => [...p, ...onlyActive]);

      setLastDoc(snap.docs.length ? snap.docs[snap.docs.length - 1] : null);
      setHasMore(snap.docs.length === 50);
    } catch (e) {
      console.error("fetchReviews error:", e);
    } finally {
      setLoadingReviews(false);
    }
  };

  const fetchBlocked = async () => {
    if (loadingBlocked) return;
    setLoadingBlocked(true);
    try {
      const ref = collection(db, "barbers", BARBER_ID, "blockedPhones");
      const snap = await getDocs(ref);
      setBlocked(snap.docs.map((d) => ({ id: d.id, ...d.data() })));
    } finally {
      setLoadingBlocked(false);
    }
  };

  const fetchArchived = async () => {
    if (loadingArchived) return;
    setLoadingArchived(true);
    try {
      const qAll = query(reviewsCol, orderBy("createdAt", "desc"), limit(200));
      const snap = await getDocs(qAll);
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      setArchived(docs.filter((r) => r.status === "archived"));
    } catch (e) {
      console.error("fetchArchived error:", e);
    } finally {
      setLoadingArchived(false);
    }
  };

  useEffect(() => {
    fetchReviews({ reset: true });
    fetchBlocked();
    fetchArchived();
    fetchSummary();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const blockPhoneEverywhere = async (phoneKey, reviewId) => {
    if (!phoneKey) return;

    await setDoc(
      doc(db, "barbers", BARBER_ID, "blockedPhones", String(phoneKey)),
      {
        phoneKey: String(phoneKey),
        from: "reviews",
        fromBarberId: BARBER_ID,
        reviewId: reviewId || null,
        blockedAt: serverTimestamp(),
      },
    );

    await setDoc(doc(db, "blockedPhones", String(phoneKey)), {
      phoneKey: String(phoneKey),
      from: "reviews",
      fromBarberId: BARBER_ID,
      reviewId: reviewId || null,
      blockedAt: serverTimestamp(),
    });

    await fetchBlocked();
  };

  const unblockPhoneEverywhere = async (phoneKey) => {
    if (!phoneKey) return;
    await deleteDoc(
      doc(db, "barbers", BARBER_ID, "blockedPhones", String(phoneKey)),
    );
    await deleteDoc(doc(db, "blockedPhones", String(phoneKey)));
    await fetchBlocked();
  };

  const archiveReview = async (reviewId) => {
    if (!reviewId) return;

    const rLocal = reviews.find((x) => x.id === reviewId);
    const nameForUndo = prettyName(
      rLocal?.customerName || rLocal?.userName || rLocal?.displayName,
    );

    await runTransaction(db, async (tx) => {
      const reviewRef = doc(db, "barbers", BARBER_ID, "reviews", reviewId);
      const [rSnap, sSnap] = await Promise.all([
        tx.get(reviewRef),
        tx.get(summaryRef),
      ]);
      if (!rSnap.exists()) return;

      const r = rSnap.data();
      if (r.status === "archived") return;

      const cur = safeSummary(sSnap.exists() ? sSnap.data() : null);
      const rating = r.rating ?? r.stars ?? 0;
      const tags = r.tags || [];
      const next = decSummary(cur, rating, tags);

      tx.set(
        reviewRef,
        {
          status: "archived",
          archivedAt: serverTimestamp(),
          purgeAt: addDaysDate(ARCHIVE_KEEP_DAYS),
        },
        { merge: true },
      );

      tx.set(
        summaryRef,
        { ...next, updatedAt: serverTimestamp() },
        { merge: true },
      );
    });

    setReviews((p) => p.filter((x) => x.id !== reviewId));
    await fetchArchived();
    await fetchSummary();

    setUndo({ id: reviewId, name: nameForUndo });
    if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
    undoTimerRef.current = setTimeout(() => {
      setUndo(null);
      undoTimerRef.current = null;
    }, UNDO_MS);
  };

  const restoreReview = async (reviewId) => {
    if (!reviewId) return;

    await runTransaction(db, async (tx) => {
      const reviewRef = doc(db, "barbers", BARBER_ID, "reviews", reviewId);
      const [rSnap, sSnap] = await Promise.all([
        tx.get(reviewRef),
        tx.get(summaryRef),
      ]);
      if (!rSnap.exists()) return;

      const r = rSnap.data();
      if (r.status !== "archived") return;

      const cur = safeSummary(sSnap.exists() ? sSnap.data() : null);
      const rating = r.rating ?? r.stars ?? 0;
      const tags = r.tags || [];
      const next = incSummary(cur, rating, tags);

      tx.set(
        reviewRef,
        { status: "active", restoredAt: serverTimestamp(), purgeAt: null },
        { merge: true },
      );

      tx.set(
        summaryRef,
        { ...next, updatedAt: serverTimestamp() },
        { merge: true },
      );
    });

    await fetchReviews({ reset: true });
    await fetchArchived();
    await fetchSummary();
  };

  const undoArchive = async () => {
    if (!undo?.id) return;
    const id = undo.id;
    setUndo(null);
    await restoreReview(id);
  };

  const deleteArchivedPermanently = async (reviewId) => {
    if (!reviewId) return;
    await deleteDoc(doc(db, "barbers", BARBER_ID, "reviews", reviewId));
    await fetchArchived();
    await fetchSummary();
  };

  // ===== Derived / filtered list =====
  const filteredReviews = useMemo(() => {
    let list = Array.isArray(reviews) ? [...reviews] : [];

    // stars filter
    if (stars !== "all") {
      const s = Number(stars);
      list = list.filter((r) => Number(r.rating ?? r.stars ?? 0) === s);
    }

    // search
    const q = safeLower(qText).trim();
    if (q) {
      list = list.filter((r) => {
        const name = safeLower(r.customerName || r.userName || r.displayName);
        const phone = safeLower(r.phoneKey || r.phone || r.phoneNumber);
        const msg = safeLower(r.message || r.text || r.comment);
        return name.includes(q) || phone.includes(q) || msg.includes(q);
      });
    }

    // sort
    if (sortBy === "highest") {
      list.sort(
        (a, b) =>
          Number(b.rating ?? b.stars ?? 0) - Number(a.rating ?? a.stars ?? 0),
      );
    } else if (sortBy === "lowest") {
      list.sort(
        (a, b) =>
          Number(a.rating ?? a.stars ?? 0) - Number(b.rating ?? b.stars ?? 0),
      );
    } else {
      // newest is already from firestore, keep stable
    }

    return list;
  }, [reviews, qText, stars, sortBy]);

  return {
    tab,
    setTab,

    // data
    reviews,
    filteredReviews,
    archived,
    blocked,
    summary,
    count,
    avg,

    // loading
    loadingReviews,
    loadingArchived,
    loadingBlocked,
    loadingSummary,

    // pagination
    hasMore,

    // filters
    qText,
    setQText,
    stars,
    setStars,
    sortBy,
    setSortBy,

    // actions
    fetchReviews,
    fetchArchived,
    fetchBlocked,
    fetchSummary,

    blockPhoneEverywhere,
    unblockPhoneEverywhere,

    archiveReview,
    restoreReview,
    undoArchive,
    deleteArchivedPermanently,

    // undo toast
    undo,
    setUndo,
  };
}
</file>

<file path="src/pages/barberPanel/ReviewsAdminPage.jsx">

</file>

<file path=".firebase/hosting.ZGlzdA.cache">
vite.svg,1747330434585,699a02e0e68a579f687d364bbbe7633161244f35af068220aee37b1b33dfb3c7
index.html,1751098345638,2cbbe115efbe89db527d62aebac1c9781f1a7b7366433488f7fc786a744365ba
firebase-messaging-sw.js,1748979911513,34bb62433fa55e7641d773e9f1bc5fd639d2fda7d98477860c2ee853670269cf
barber-logo.png,1748548510517,e5439aacd923a773119376936257b3b66dee5ffbc5ad81d34808493d6aa96a44
barber-hero.jpg,1747436939025,3dc48cfc9433a1a64c8167b341d33595be149535e54b7590a89645831d2dd1c1
cuts/p6.jpg,1747911021199,f0e5c36ffa6c9960979350c20a236e1d918885338e3c92c3c408a0d5ecf9ce7f
cuts/p5.jpg,1747442191484,c56fed6bcce93b6b7b46fbaffba771b24427090dfa0ad7554845d7e034bd4181
cuts/p4.jpg,1747442190840,9536e44a2bd260281b06ac03e67aa7dd6051ea40a23bb97f9d0bbdf1727f18fd
cuts/p3.jpg,1747911020836,f96585e718079b4f74aa828a05bd99a92ed041860766b461ad5bd98411ec416b
cuts/p2.jpg,1747911020729,3662caa220956cdccd86dea74fb6a7e304abaef7b88449997aacafd2d53932b4
cuts/p1.jpg,1747911020836,386e6c54266e2fc7e834d265fadcc060e023d0bde9283621788bc15fed1151ba
assets/poppins-latin-900-normal-By5LX1Cr.woff,1751098345638,f886da4a17d390859466fbfec6d9ba9ae991fc7b897a8576f9f0ffcbda70e92c
assets/poppins-latin-900-normal-BmL1zqjw.woff2,1751098345630,f0023bdacf1ad0856cdfe8f73fab3ad3b34370afcae0cb70042b5953dd8cbddf
assets/poppins-latin-800-normal-YoItoZZV.woff,1751098345638,0096854c06d1f69fb68d3691639de26909e715f3056de916900ce23369508691
assets/poppins-latin-800-normal-Bd8-pIP1.woff2,1751098345630,b16195c149ae6b148f5d3589d6dd2673b5d132c10b8f280d588def69df9fc68c
assets/poppins-latin-700-normal-Qrb0O0WB.woff2,1751098345630,f5bc6a88ffeafac714d83a7d7847bb1661ebbf456b66ea8cf45c70560110a5a0
assets/poppins-latin-700-normal-BVuQR_eA.woff,1751098345638,ec4f2d72a1e93cd57c01b47ff12a8dba990cbd25b2a2f99d75772e85e28b7a78
assets/poppins-latin-600-normal-zEkxB9Mr.woff2,1751098345630,f833aad68fb85e97807e14cd10ead246f61cc7f40b70841c359bc8c4bdeb9dfa
assets/poppins-latin-600-normal-BJdTmd5m.woff,1751098345638,7bd7a11a3d18c65e3b158f576aadabba50ee691bdbbee70ae32a90332c493c32
assets/poppins-latin-500-normal-DGXqpDMm.woff,1751098345638,a1707c0b9929df1ec3ca20fd49c10a6ac0a49123e51ba369856f33708f1c2b89
assets/poppins-latin-500-normal-C8OXljZJ.woff2,1751098345630,c64abb7ce048dde09f2864e41f7695ac1820e819035ea3495cbda12cdba7cbf3
assets/poppins-latin-400-normal-cpxAROuN.woff2,1751098345630,5f9b987ff38cc1aac77f609e7cdc137f99f88148af67f629c77ea1f1b47e4cc0
assets/poppins-latin-400-normal-BOb3E3N0.woff,1751098345638,467bc3df224083b8d4fce46e01a6e5d6ffff249058fcb3dbc3ad9a1e51483bf6
assets/poppins-latin-300-normal-Dku2WoCh.woff2,1751098345630,2d66af8ce67f10573556562a289412cc4a45294d361d085ce6b7219f2c7bb237
assets/poppins-latin-300-normal-DCNuMXUj.woff,1751098345638,d131ac55376b0043c0e8b910287a435a3eed9121bfdabf7066b606af9e745c06
assets/poppins-latin-200-normal-BxK-3Qw6.woff,1751098345638,f52eee8b339185cb9f56bb6bbad6eece4d5e26aae31324b703fc7e7d00cfbcc7
assets/poppins-latin-200-normal-B8tqA5oA.woff2,1751098345630,ff749390198c797058ba3e12b0f5a02119abece5f63f646eb5d3c172da6249e0
assets/poppins-latin-100-normal-PssVh1UL.woff,1751098345638,10b15f5d510b3efe49f5e7d172f7f7b9536fa28b8f8e07e721c1b9a3d5ea1bd1
assets/poppins-latin-100-normal-CY-M_i9k.woff2,1751098345630,bfab3bb3356a2c87c2e508dc049d84f29088b5eb28920dfba902a57968a5cac0
assets/index-Io8CuPLN.css,1751098345638,92a03b13d707d8ee7b46b5b468c8aae19ad51ac9ce6646e43db999b9c7b45918
assets/index-DwFfJgGe.js,1751098345638,eb8f078330383b07be3b72330ee49b406b7656e5e150b9cfdb1e4ed80ee14905
assets/cairo-arabic-900-normal-DrpAh93K.woff2,1751098345630,8a8dac570887fabb0315a1db136a09d479ba1e94dd5e0092f2192371a5742c11
assets/cairo-arabic-900-normal-CPyu-sEz.woff,1751098345638,c9893b51cfd959d29556e121c268397d2ebc439d65b83dc6ab6f6a421345f2d4
assets/cairo-arabic-800-normal-F7Hlgj_V.woff2,1751098345630,48fda493d60a63335f1283f137f4b98455e65ee79e616840f8d625d74dff7b25
assets/cairo-arabic-800-normal-CEqOMnLm.woff,1751098345638,e3f46e76b33657dd61e3b553ce7e154637b8a9968c34666f3be12412fdba09e4
assets/cairo-arabic-700-normal-C1Bm1EwF.woff,1751098345630,5affa5005e1b02b944389093f381b9ee590ac0815cf09e92c25efeb0d5a8a227
assets/cairo-arabic-700-normal-BSE79iNS.woff2,1751098345630,38fac832b3fd7533a27c6086978840e85ed6dfd5744e8bc9387dceaae4b21c26
assets/cairo-arabic-600-normal-ZVfwAX8N.woff2,1751098345630,2c63fb32393e06d8abf8665b62cb5dbd92ed435b799530eb7269af33561cb27f
assets/cairo-arabic-600-normal-DKFBrmZX.woff,1751098345638,fcbc7bc87f0ee834c6f1e0afd7169d18286a36de0053a47d53d9ec34eeb3b587
assets/cairo-arabic-500-normal-mpB2FoB6.woff2,1751098345630,b47025ce6942931e410e201c64afc24817c2c656d8f59657a47f130c2a02ec2c
assets/cairo-arabic-500-normal-BatuEmvC.woff,1751098345630,57c6673423194ff012cd078a6546a87f2a16cb8b7cd46420625175780c1c6ae6
assets/cairo-arabic-400-normal-h-BtS9qV.woff2,1751098345630,20df07e198920a8315ac134ba9a6997c596149648379f15a704e139cf3ffd88a
assets/cairo-arabic-400-normal-CI-r9s-3.woff,1751098345638,3cf9989d96db6a2559b61a8a667c2920148c27de905620b1d68e3782b460cbb8
assets/cairo-arabic-300-normal-DARKBJn2.woff2,1751098345630,0f6bcdd6be1e3401a061b8094f50766c81f98e3f608ca4f1b58eea1a20db762a
assets/cairo-arabic-300-normal-BdDK-t4x.woff,1751098345630,ef85d3d75ad7adde94dab3494fb9561473dc4ac6ee313102797459eeea0e01c1
assets/cairo-arabic-200-normal-DaYaWc48.woff2,1751098345630,f1c3405ff4f2ad245e3f670ed77e5f8c6c675640a0500cb351f2af60e37bee8b
assets/cairo-arabic-200-normal-26Jx3DfQ.woff,1751098345638,db1459e79bb9f6dc7c1923250a785b1959161d88f4d2a610495559f28166d9a4
assets/arfatblacklogo-DCre-YlQ.png,1751098345638,774221960419f415f84d04d3f6b7fd7446d157cd080d5716547f17626dea0271
</file>

<file path=".firebaserc">
{
  "projects": {
    "default": "arfatbarber"
  }
}
</file>

<file path=".github/workflows/booking-reminders.yml">
name: Booking Reminders (FCM)

on:
  schedule:
    - cron: "*/5 * * * *" # كل 5 دقائق
  workflow_dispatch: {}

concurrency:
  group: booking-reminders
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run reminders
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: node scripts/notifications/runReminders.js
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'

export default [
  { ignores: ['dist'] },
  {
    files: ['**/*.{js,jsx}'],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...js.configs.recommended.rules,
      ...reactHooks.configs.recommended.rules,
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
      'react-refresh/only-export-components': [
        'warn',
        { allowConstantExport: true },
      ],
    },
  },
]
</file>

<file path="et --hard a2865d4">
[33ma2865d4[m[33m ([m[1;36mHEAD[m[33m -> [m[1;32mmain[m[33m, [m[1;31morigin/main[m[33m)[m making admin booking faster by changing the useefeect
[33md87efe3[m the passing time in BokSec is now unreadable and translate step
[33mce8f93d[m ŮŮŘŞ Ř§ŘŽŘą ŘŞŘ­ŘŻŮŘŤŘ§ŘŞ
[33m4e5f1c9[m hiding passed hours
[33m508285a[m ŘŞŘ˛Ř¨ŮŘˇ Ř§ŮŘ§Ř­ŘľŘ§ŘŚŮŘ§ŘŞ Ř´ŮŮŮŘ§
[33m8857b30[m ŘŞŘ˛Ř¨ŮŘˇ Ř§ŮŘ§Ř­ŘľŘ§ŘŚŮŘ§ŘŞ Ř´ŮŮŮŘ§
[33mfe87ce6[m ŘŞŘ˛Ř¨ŮŘˇ Ř§ŮŘ§Ř­ŘľŘ§ŘŚŮŘ§ŘŞ Ř´ŮŮŮŘ§
[33m6820b74[m ŘŞŘšŘŻŮŮ ŮŮŘ­Ů Ř§ŮŘ­ŘŹŮŘ˛Ř§ŘŞ ŮŘ´ŮŮ Ř§ŘąŘŞŘ¨
[33m072d30a[m ŘŞŘšŮŮŮ Ř§ŮŘ§ŮŮŘ§ŘŞ Ř§ŮŮŘ­ŘŹŮŘ˛Ů Ř¨Ř§ŮŘ§Ř­ŮŘą ŮŮŘłŘŽ Ř§ŮŮŮŘŻ
[33mf632a8f[m ahsaiat
[33m8f21a7f[m ŘŞŘšŘˇŮŮ Ř§ŮŘ§Ů
[33m3c1b5a7[m firbase problem solved
[33m1e7e622[m sunday problem
[33m8fb9650[m ŘŞŘšŘŻŮŮ ŮŮŘ­Ů Ř§ŮŘ­ŘŹŮŘ˛Ř§ŘŞ
[33m8b09db8[m Ř˛ŮŘ§ŘŻŮ ŘŹŮŮŮ Ř§ŘŽŘŞŘą ŘŞŘ§ŘąŮŘŽ Ř§ŮŘ­ŘŹŘ˛
[33m859c016[m calendar
[33m9890949[m steps in reservation
[33m0d1ac1d[m finishng
[33m72436fa[m detailhng
[33m4c0a4bf[m valid numbers just accepted that started with 05
[33m5f1040d[m up button adding
[33m002ba00[m phone number detiction editing
[33mb77bc3e[m cashe
[33m24863eb[m  Update BookingSection to disable past and closed days
[33mdca74aa[m  Fix: prevent FCM crash on mobile
[33me3abcbc[m  Fix Firebase config (apiKey + storageBucket)
[33mbcf7b7c[m  Update title and favicon for Arfat Barber
[33mc8b3c60[m ŘąŮŘš Ř˘ŘŽŘą ŮŘłŘŽŘŠ ŮŮ Ř§ŮŮŮŘŻ - ŘŞŘ­ŘŻŮŘŤ ŮŮŘ§ŘŚŮ
[33m7c197b9[m hours editing
[33m6ae05d5[m Fix FaScissors icon error and update BarberPanel component
[33m6a0fdc3[m ŘŞŘ­ŘŻŮŘŤŘ§ŘŞ ŮŮŘ­ŘŠ Ř§ŮŘ­ŮŘ§Ů ŮŘš ŘŞŘłŘŹŮŮ Ř§ŮŘŽŘąŮŘŹ
[33m6d1995e[m Add Vercel rewrites for React routing
[33m383bd27[m Add Vercel rewrites for React routing
[33ma1c235e[m control pannel
[33m0b0fce0[m add worcing hours
[33mfa5608d[m deleting the third reservation button
[33m08b3464[m Refactor Contact section, switch to Waze, remove About from Home, and full multi-language support
[33m5a8e4ff[m  ŘŞŘ­ŘŻŮŘŤŘ§ŘŞ: ŘŻŘšŮ ŮŘşŘ§ŘŞ ŮŘ§ŘŽŘŞŮŘ§Řą Ř§ŮŘŽŘŻŮŘŠ Ř¨Ř§ŮŘ­ŘŹŘ˛ + ŘĽŘ˛Ř§ŮŘŠ Ř˛Řą ŮŮ Contact
[33mab4ba7f[m Update logo and styles
[33m19ef96f[m  ŘĽŘśŘ§ŮŘŠ ŘłŮŘ§ŮŘŻŘą Instagram Ř§Ř­ŘŞŘąŘ§ŮŮ
[33mb55da8c[m first commit
</file>

<file path="et --hard HEAD~3">
[33mec2e8ef[m[33m ([m[1;36mHEAD[m[33m -> [m[1;32mmain[m[33m, [m[1;31morigin/main[m[33m)[m puting the fields in the form on the right way
[33mfc54ee0[m hiding passed hours
[33m820b153[m hiding passed hours
[33m4e5f1c9[m hiding passed hours
[33m508285a[m ŘŞŘ˛Ř¨ŮŘˇ Ř§ŮŘ§Ř­ŘľŘ§ŘŚŮŘ§ŘŞ Ř´ŮŮŮŘ§
[33m8857b30[m ŘŞŘ˛Ř¨ŮŘˇ Ř§ŮŘ§Ř­ŘľŘ§ŘŚŮŘ§ŘŞ Ř´ŮŮŮŘ§
[33mfe87ce6[m ŘŞŘ˛Ř¨ŮŘˇ Ř§ŮŘ§Ř­ŘľŘ§ŘŚŮŘ§ŘŞ Ř´ŮŮŮŘ§
[33m6820b74[m ŘŞŘšŘŻŮŮ ŮŮŘ­Ů Ř§ŮŘ­ŘŹŮŘ˛Ř§ŘŞ ŮŘ´ŮŮ Ř§ŘąŘŞŘ¨
[33m072d30a[m ŘŞŘšŮŮŮ Ř§ŮŘ§ŮŮŘ§ŘŞ Ř§ŮŮŘ­ŘŹŮŘ˛Ů Ř¨Ř§ŮŘ§Ř­ŮŘą ŮŮŘłŘŽ Ř§ŮŮŮŘŻ
[33mf632a8f[m ahsaiat
[33m8f21a7f[m ŘŞŘšŘˇŮŮ Ř§ŮŘ§Ů
[33m3c1b5a7[m firbase problem solved
[33m1e7e622[m sunday problem
[33m8fb9650[m ŘŞŘšŘŻŮŮ ŮŮŘ­Ů Ř§ŮŘ­ŘŹŮŘ˛Ř§ŘŞ
[33m8b09db8[m Ř˛ŮŘ§ŘŻŮ ŘŹŮŮŮ Ř§ŘŽŘŞŘą ŘŞŘ§ŘąŮŘŽ Ř§ŮŘ­ŘŹŘ˛
[33m859c016[m calendar
[33m9890949[m steps in reservation
[33m0d1ac1d[m finishng
[33m72436fa[m detailhng
[33m4c0a4bf[m valid numbers just accepted that started with 05
[33m5f1040d[m up button adding
[33m002ba00[m phone number detiction editing
[33mb77bc3e[m cashe
[33m24863eb[m  Update BookingSection to disable past and closed days
[33mdca74aa[m  Fix: prevent FCM crash on mobile
[33me3abcbc[m  Fix Firebase config (apiKey + storageBucket)
[33mbcf7b7c[m  Update title and favicon for Arfat Barber
[33mc8b3c60[m ŘąŮŘš Ř˘ŘŽŘą ŮŘłŘŽŘŠ ŮŮ Ř§ŮŮŮŘŻ - ŘŞŘ­ŘŻŮŘŤ ŮŮŘ§ŘŚŮ
[33m7c197b9[m hours editing
[33m6ae05d5[m Fix FaScissors icon error and update BarberPanel component
[33m6a0fdc3[m ŘŞŘ­ŘŻŮŘŤŘ§ŘŞ ŮŮŘ­ŘŠ Ř§ŮŘ­ŮŘ§Ů ŮŘš ŘŞŘłŘŹŮŮ Ř§ŮŘŽŘąŮŘŹ
[33m6d1995e[m Add Vercel rewrites for React routing
[33m383bd27[m Add Vercel rewrites for React routing
[33ma1c235e[m control pannel
[33m0b0fce0[m add worcing hours
[33mfa5608d[m deleting the third reservation button
[33m08b3464[m Refactor Contact section, switch to Waze, remove About from Home, and full multi-language support
[33m5a8e4ff[m  ŘŞŘ­ŘŻŮŘŤŘ§ŘŞ: ŘŻŘšŮ ŮŘşŘ§ŘŞ ŮŘ§ŘŽŘŞŮŘ§Řą Ř§ŮŘŽŘŻŮŘŠ Ř¨Ř§ŮŘ­ŘŹŘ˛ + ŘĽŘ˛Ř§ŮŘŠ Ř˛Řą ŮŮ Contact
[33mab4ba7f[m Update logo and styles
[33m19ef96f[m  ŘĽŘśŘ§ŮŘŠ ŘłŮŘ§ŮŘŻŘą Instagram Ř§Ř­ŘŞŘąŘ§ŮŮ
[33mb55da8c[m first commit
</file>

<file path="functions/.gitignore">
node_modules/
*.local
</file>

<file path="postcss.config.cjs">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="README.md">
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh

## Expanding the ESLint configuration

If you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.
</file>

<file path="scripts/notifications/config.js">
// scripts/notifications/config.js

/**
 * إعدادات نظام الإشعارات
 * هذا الملف فقط إعدادات — بدون منطق
 * أي تعديل مستقبلي (توقيت/إلغاء/إضافة تذكير) يتم من هنا
 */

export const CONFIG = {
  // اسم collection الحجوزات في Firestore
  COLLECTION: "bookings",

  /**
   * GitHub Action يعمل كل 5 دقائق
   * WINDOW_MIN = نافذة أمان (± دقائق)
   * عشان ما نضيّع إشعار إذا صار تأخير بسيط
   */
  WINDOW_MIN: 6,

  /**
   * إشعار "عند الحجز"
   * نبحث عن حجوزات جديدة خلال آخر X دقائق
   */
  LOOKBACK_CREATE_MIN: 45,

  /**
   * التذكيرات قبل الموعد
   * minutesBefore = كم دقيقة قبل الدور
   * key = الحقل الذي نعلّم فيه أن الإشعار انبعت
   */
  REMINDERS: [
    { key: "r24hSentAt", minutesBefore: 24 * 60 }, // قبل 24 ساعة
    { key: "r2hSentAt", minutesBefore: 2 * 60 }, // قبل ساعتين
    { key: "r30mSentAt", minutesBefore: 30 }, // قبل 30 دقيقة
  ],
};
</file>

<file path="scripts/notifications/firebaseAdmin.js">
// scripts/notifications/firebaseAdmin.js

/* eslint-disable no-undef */
/* eslint-disable no-unused-vars */

/**
 * هذا الملف يُستخدم فقط في بيئة Node.js (GitHub Actions)
 * وليس داخل المتصفح
 */

import admin from "firebase-admin";

let initialized = false;

export function getAdmin() {
  // إذا تهيّأ قبل، رجّعه مباشرة
  if (initialized) {
    return admin;
  }

  const json = process.env.FIREBASE_SERVICE_ACCOUNT_JSON;
  if (!json) {
    throw new Error(
      "FIREBASE_SERVICE_ACCOUNT_JSON is missing. Add it to GitHub Secrets.",
    );
  }

  let serviceAccount;
  try {
    serviceAccount = JSON.parse(json);
  } catch {
    // ما نستخدم err عشان ESLint
    throw new Error("Invalid FIREBASE_SERVICE_ACCOUNT_JSON (not valid JSON)");
  }

  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });

  initialized = true;
  return admin;
}
</file>

<file path="scripts/notifications/firestoreBookings.js">
// scripts/notifications/firestoreBookings.js

/**
 * هذا الملف مسؤول عن:
 * - قراءة الحجوزات من Firestore
 * - تحديد أي حجوزات لازم ينبعت لها إشعار الآن
 * - تحديث flags داخل الحجز بعد الإرسال
 *
 * لا يوجد FCM هنا
 * لا يوجد Templates
 * فقط Firestore logic
 */

import { getAdmin } from "./firebaseAdmin.js";
import { CONFIG } from "./config.js";

// الوقت الحالي بالـ ms
function nowMs() {
  return Date.now();
}

/**
 * الحجوزات الجديدة لإشعار "عند الحجز"
 * نبحث عن حجوزات:
 * - انشأت خلال آخر LOOKBACK_CREATE_MIN
 * - notify.onCreateSentAt == null
 */
export async function getNewBookingsForOnCreate() {
  const admin = getAdmin();
  const db = admin.firestore();

  const fromMs = nowMs() - CONFIG.LOOKBACK_CREATE_MIN * 60 * 1000;

  const snap = await db
    .collection(CONFIG.COLLECTION)
    .where("createdAtMs", ">=", fromMs)
    .where("notify.onCreateSentAt", "==", null)
    .get();

  return snap.docs.map((d) => ({
    id: d.id,
    ...d.data(),
  }));
}

/**
 * الحجوزات التي تحتاج تذكير
 * minutesBefore = 24h / 2h / 30m
 */
export async function getBookingsForReminder(minutesBefore) {
  const admin = getAdmin();
  const db = admin.firestore();

  const windowMs = CONFIG.WINDOW_MIN * 60 * 1000;
  const targetMs = nowMs() + minutesBefore * 60 * 1000;

  const fromMs = targetMs - windowMs;
  const toMs = targetMs + windowMs;

  // تحديد أي flag نستخدم
  let flagField = "notify.r30mSentAt";
  if (minutesBefore === 24 * 60) flagField = "notify.r24hSentAt";
  if (minutesBefore === 2 * 60) flagField = "notify.r2hSentAt";

  const snap = await db
    .collection(CONFIG.COLLECTION)
    .where("timestamp", ">=", fromMs)
    .where("timestamp", "<=", toMs)
    .where(flagField, "==", null)
    .get();

  return {
    flagField,
    bookings: snap.docs.map((d) => ({
      id: d.id,
      ...d.data(),
    })),
  };
}

/**
 * تحديث الحجز بعد الإرسال
 * updates مثال:
 * { "notify.r30mSentAt": Date.now() }
 */
export async function markBookingUpdated(bookingId, updates) {
  const admin = getAdmin();
  const db = admin.firestore();

  await db.collection(CONFIG.COLLECTION).doc(bookingId).update(updates);
}
</file>

<file path="scripts/notifications/sendFcm.js">
// scripts/notifications/sendFcm.js

/**
 * هذا الملف مسؤول فقط عن:
 * - إرسال إشعارات FCM
 * - دعم إرسال متعدد (multicast)
 * - تنظيف tokens غير الصالحة
 *
 * لا يوجد Firestore هنا
 * لا يوجد Templates
 */

import { getAdmin } from "./firebaseAdmin.js";

/**
 * إرسال إشعار لمجموعة tokens
 * @param {string[]} tokens
 * @param {{ title: string, body: string, data?: Record<string,string> }} payload
 */
export async function sendToTokens(tokens, payload) {
  if (!Array.isArray(tokens) || tokens.length === 0) {
    return { sent: 0, invalid: [] };
  }

  const admin = getAdmin();
  const messaging = admin.messaging();

  // FCM يسمح بحد أقصى 500 token في الإرسال الواحد
  const chunks = [];
  for (let i = 0; i < tokens.length; i += 500) {
    chunks.push(tokens.slice(i, i + 500));
  }

  let sent = 0;
  const invalid = [];

  for (const chunk of chunks) {
    const res = await messaging.sendEachForMulticast({
      tokens: chunk,
      notification: {
        title: payload.title,
        body: payload.body,
      },
      data: payload.data || {},
    });

    sent += res.successCount;

    // جمع الـ tokens غير الصالحة
    res.responses.forEach((r, idx) => {
      if (!r.success) {
        const code = r.error?.code || "";
        if (
          code.includes("registration-token-not-registered") ||
          code.includes("invalid-argument")
        ) {
          invalid.push(chunk[idx]);
        }
      }
    });
  }

  return { sent, invalid };
}
</file>

<file path="scripts/notifications/sendTestNotification.js">

</file>

<file path="scripts/notifications/templates.js">
// scripts/notifications/templates.js

/**
 * هذا الملف مسؤول فقط عن:
 * - نصوص الإشعارات
 * - شكل الرسالة
 *
 * لا يوجد Firestore
 * لا يوجد إرسال
 * فقط Templates
 */

// تنسيق الوقت للعرض
function prettyTime(time) {
  return time || "";
}

/**
 * إشعار "عند الحجز"
 */
export function buildOnCreatePayload(booking) {
  const code = booking.bookingCode || "";
  const title = "✅ تم تأكيد الحجز";
  const body = `كود الحجز: ${code} • ${booking.selectedDate} ${prettyTime(
    booking.selectedTime,
  )} • ${booking.selectedService || ""}`;

  return {
    title,
    body,
    data: {
      type: "BOOKING_CREATED",
      bookingId: booking.id || "",
      bookingCode: code,
    },
  };
}

/**
 * إشعار تذكير قبل الموعد
 */
export function buildReminderPayload(booking, minutesBefore) {
  const code = booking.bookingCode || "";
  const title = "⏰ تذكير بالموعد";
  const body = `بعد ${minutesBefore} دقيقة • ${booking.selectedDate} ${prettyTime(
    booking.selectedTime,
  )} • ${booking.selectedService || ""} • كود: ${code}`;

  return {
    title,
    body,
    data: {
      type: "BOOKING_REMINDER",
      bookingId: booking.id || "",
      bookingCode: code,
      minutesBefore: String(minutesBefore),
    },
  };
}
</file>

<file path="src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/about/AboutContent.jsx">
import { useTranslation } from "react-i18next";
import { useEffect } from "react";
import AOS from "aos";
import "aos/dist/aos.css";
import { Link } from "react-router-dom";

function AboutContent() {
  const { t } = useTranslation();

  useEffect(() => {
    AOS.init({ duration: 1000 });
  }, []);

  return (
    <main className="font-body">

      {/* Hero */}
      <section className="h-[70vh] bg-cover bg-center flex items-center justify-center text-white relative" style={{ backgroundImage: "url('/barber.jpg')" }}>
        <div className="absolute inset-0 bg-black bg-opacity-60"></div>
        <div className="relative z-10 text-center px-4" data-aos="fade-up">
          <h1 className="text-4xl md:text-5xl font-heading text-gold font-bold mb-4">
            {t("about") || "About Us"}
          </h1>
          <p className="text-lg md:text-xl text-gray-200 max-w-2xl mx-auto">
            {t("about_text") || "Where precision meets passion — Arfat Barber is a name of trust and style."}
          </p>
        </div>
      </section>

      {/* من نحن */}
      <section className="py-20 px-6 md:px-20 bg-white text-darkText text-center">
        <h2 className="text-3xl font-heading font-bold mb-6 text-gold" data-aos="fade-up">Who We Are</h2>
        <p className="max-w-3xl mx-auto text-lg leading-relaxed" data-aos="fade-up" data-aos-delay="100">
          Arfat Barber isn't just a barbershop — it's a space of self-expression, confidence, and expert care. With years of experience and a passion for grooming, we offer premium services tailored to every style.
        </p>
      </section>

      {/* الرؤية والرسالة */}
      <section className="py-16 px-6 md:px-20 bg-gray-100 grid md:grid-cols-2 gap-8 text-darkText">
        <div className="bg-white p-8 rounded-lg shadow-md" data-aos="fade-right">
          <h3 className="text-xl font-bold text-gold mb-3 font-heading">💡 Our Vision</h3>
          <p>To be the region’s go-to destination for men who value style, comfort, and consistency.</p>
        </div>
        <div className="bg-white p-8 rounded-lg shadow-md" data-aos="fade-left">
          <h3 className="text-xl font-bold text-gold mb-3 font-heading">🎯 Our Mission</h3>
          <p>Empowering confidence through every haircut, every detail, and every customer interaction.</p>
        </div>
      </section>

      {/* لماذا نحن؟ */}
      <section className="py-20 px-6 md:px-20 bg-white text-center text-darkText">
        <h2 className="text-3xl font-heading font-bold mb-12 text-gold" data-aos="fade-up">Why Choose Us?</h2>
        <div className="grid md:grid-cols-3 gap-8">
          <div className="p-6 rounded-lg shadow-md border" data-aos="zoom-in">
            <h4 className="text-xl font-heading mb-2 text-primary">✂️ Skilled Barbers</h4>
            <p>Trained hands, sharp results — every time.</p>
          </div>
          <div className="p-6 rounded-lg shadow-md border" data-aos="zoom-in" data-aos-delay="100">
            <h4 className="text-xl font-heading mb-2 text-primary">🧼 Clean & Calm</h4>
            <p>We care about hygiene and customer comfort.</p>
          </div>
          <div className="p-6 rounded-lg shadow-md border" data-aos="zoom-in" data-aos-delay="200">
            <h4 className="text-xl font-heading mb-2 text-primary">📍 Great Location</h4>
            <p>Easy to reach, hard to forget.</p>
          </div>
        </div>
      </section>

      {/* دعوة للحجز */}
      <section className="py-20 px-6 md:px-20 bg-primary text-white text-center">
        <h2 className="text-3xl font-heading font-bold mb-6 text-gold" data-aos="fade-up">
          Ready for Your Next Look?
        </h2>
        <p className="mb-4" data-aos="fade-up" data-aos-delay="100">Join our list of happy clients. Book your session today!</p>
        <Link
          to="/booking-form"
          className="bg-gold hover:bg-yellow-400 text-primary font-semibold px-6 py-3 rounded-full shadow-md transition"
          data-aos="zoom-in"
          data-aos-delay="200"
        >
          {t("book_now") || "Book Now"}
        </Link>
      </section>

    </main>
  );
}

export default AboutContent;
</file>

<file path="src/components/booking/parts/DateField.jsx">
// src/components/booking/parts/DateField.jsx
import DatePicker from "react-datepicker";
import "react-datepicker/dist/react-datepicker.css";

function DateField({ valueYMD, onChangeYMD, t }) {
  // حوّل التاريخ النصي "yyyy-mm-dd" إلى كائن Date
  const selectedDate = valueYMD
    ? new Date(
        Number(valueYMD.split("-")[0]),
        Number(valueYMD.split("-")[1]) - 1,
        Number(valueYMD.split("-")[2])
      )
    : null;

  return (
    <DatePicker
      selected={selectedDate}
      onChange={(date) => {
        if (date) {
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, "0");
          const d = String(date.getDate()).padStart(2, "0");
          onChangeYMD(`${y}-${m}-${d}`);
        } else {
          onChangeYMD("");
        }
      }}
      dateFormat="yyyy-MM-dd"
      minDate={new Date()}
      filterDate={(date) => date.getDay() !== 0} // إلغاء أيام الأحد
      className="w-full border border-gray-300 p-3 rounded-xl focus:border-gold focus:ring-2 focus:ring-gold/40 transition"
      placeholderText={t("choose_date")}
      calendarClassName="z-50"
      required
    />
  );
}

export default DateField;
</file>

<file path="src/components/booking/parts/DateSelector.jsx">
// src/components/booking/DateSelector.jsx
import DatePicker from "react-datepicker";
import "react-datepicker/dist/react-datepicker.css";

function DateSelector({ selectedDate, onChange, placeholder }) {
  return (
    <DatePicker
      selected={selectedDate}
      onChange={onChange}
      dateFormat="yyyy-MM-dd"
      minDate={new Date()}                  /* يمنع أي تاريخ قبل اليوم */
      filterDate={(date) => date.getDay() !== 0}  /* يمنع أيام الأحد */
      className="w-full border border-gray-300 p-3 rounded-md"
      calendarClassName="z-50"
      placeholderText={placeholder}
      required
    />
  );
}

export default DateSelector;
</file>

<file path="src/components/booking/parts/ServiceOption.jsx">
// src/components/booking/parts/ServiceOption.jsx
import { FaCut } from "react-icons/fa";
import { GiBeard } from "react-icons/gi";
import Card from "../../ui/Card";

const ICONS = {
  haircut: FaCut,
  beard: GiBeard,
};

export default function ServiceOption({
  id,
  title,
  desc,
  icon = "haircut",
  selected = false,
  onSelect,
  rtl = false,
}) {
  const Icon = ICONS[icon] || FaCut;

  return (
    <Card
      selected={selected}
      onClick={() => onSelect?.(id)}
      className={`h-full ${rtl ? "text-right" : ""}`}
    >
      <div className="flex items-center gap-3">
        <div className="shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-xl bg-yellow-100 text-yellow-700">
          <Icon className="h-5 w-5" />
        </div>

        <div className="flex-1">
          <h3 className="text-base font-semibold text-gray-900">{title}</h3>
          {desc ? <p className="text-sm text-gray-500 mt-1">{desc}</p> : null}
        </div>

        {/* مؤشر الاختيار */}
        <div
          className={`ml-2 h-5 w-5 rounded-full border-2 ${
            selected ? "border-yellow-400 bg-yellow-400" : "border-gray-300"
          }`}
          aria-hidden="true"
        />
      </div>
    </Card>
  );
}
</file>

<file path="src/components/booking/parts/TimeSelector.jsx">
// src/components/booking/TimeSelector.jsx
export default function TimeSelector({
  selectedDate,
  selectedTime,
  onSelectTime,
  availableTimes,
  workingHours,
  t,
}) {
  if (!selectedDate) return null;

  const [yyyy, mm, dd] = selectedDate.split("-");
  const dateObj = new Date(Number(yyyy), Number(mm) - 1, Number(dd));
  const weekday = dateObj.toLocaleDateString("en-US", { weekday: "long" });
  const hours = workingHours[weekday];

  if (!hours) {
    return <p className="text-red-500">{t("closed_day")}</p>;
  }

  return (
    <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
      {availableTimes.map((time) => {
        const isSelected = selectedTime === time;
        return (
          <button
            key={time}
            type="button"
            onClick={() => onSelectTime(time)}
            className={`py-2 px-3 rounded-md text-sm font-medium border transition
              ${
                isSelected
                  ? "bg-gold text-primary border-gold shadow"
                  : "bg-gray-100 text-gray-800 border-gray-300 hover:bg-gold hover:text-primary"
              }`}
          >
            {time}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="src/components/booking/parts/TimeSlots.jsx">
function TimeSlots({ availableTimes, selectedTime, onSelect }) {
  if (availableTimes.length === 0) return null;

  return (
    <div className="grid grid-cols-3 gap-2">
      {availableTimes.map((time) => (
        <button
          key={time}
          type="button"
          onClick={() => onSelect(time)}
          className={`p-2 border rounded-md text-sm font-semibold transition duration-200 ${
            selectedTime === time
              ? "bg-primary text-light"
              : "bg-gray-100 hover:bg-gray-200"
          }`}
        >
          {time}
        </button>
      ))}
    </div>
  );
}

export default TimeSlots;
</file>

<file path="src/components/booking/parts/UpcomingBookings.jsx">
// src/components/booking/parts/UpcomingBookings.jsx
import { format } from "date-fns";
import { ar, enUS } from "date-fns/locale";

function UpcomingBookings({ bookings, phoneNumber, t, language }) {
  if (!phoneNumber || bookings.length === 0) return null;

  // ✅ فلترة الحجوزات: فقط لنفس رقم الهاتف + مش ملغية + جاية
  const upcoming = bookings
    .filter((b) => b.phoneNumber === phoneNumber) // ← أضفنا هذا السطر
    .filter((b) => !b.cancelledAt)
    .filter((b) => {
      const normalized = `${b.selectedDate}T${b.selectedTime}`;
      const bookingDateTime = new Date(normalized);

      // بداية اليوم (00:00)
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      return !isNaN(bookingDateTime.getTime()) && bookingDateTime >= today;
    })
    .sort((a, b) => {
      const aTime = new Date(`${a.selectedDate}T${a.selectedTime}`);
      const bTime = new Date(`${b.selectedDate}T${b.selectedTime}`);
      return aTime - bTime;
    });

  if (upcoming.length === 0) return null;

  return (
    <div className="mt-6 bg-white p-5 border rounded-2xl shadow-md">
      <h4 className="font-bold mb-4 text-gold text-lg">
        {t("your_upcoming_bookings")}
      </h4>

      <ul className="space-y-3">
        {upcoming.map((b, idx) => {
          const bookingDate = new Date(`${b.selectedDate}T${b.selectedTime}`);
          const locale = language === "ar" ? ar : enUS;

          const formattedDate = format(
            bookingDate,
            "EEEE, dd/MM/yyyy - HH:mm",
            { locale }
          );

          return (
            <li
              key={idx}
              className="flex items-center justify-between bg-gray-50 border rounded-lg px-4 py-2 hover:bg-gray-100 transition"
            >
              <div>
                <p className="font-semibold text-primary">{formattedDate}</p>
                <p className="text-sm text-gray-600">{b.selectedService}</p>
              </div>
              <span className="text-xs px-2 py-1 bg-gold text-primary rounded-full">
                {t("confirmed")}
              </span>
            </li>
          );
        })}
      </ul>
    </div>
  );
}

export default UpcomingBookings;
</file>

<file path="src/components/booking/workingHours.js">
// src/constants/workingHours.js
const workingHours = {
  Sunday: null,
  Monday: { from: "12:00", to: "20:00" },
  Tuesday: { from: "12:00", to: "20:00" },
  Wednesday: { from: "12:00", to: "20:00" },
  Thursday: { from: "12:00", to: "22:00" },
  Friday: { from: "13:30", to: "22:00" },
  Saturday: { from: "11:00", to: "19:30" },
};
export default workingHours;
</file>

<file path="src/components/CalendarGrid.jsx">
// src/components/CalendarGrid.jsx
import { useState, useEffect } from "react";
import { collection, getDocs, setDoc, deleteDoc, doc } from "firebase/firestore";
import { db } from "../firebase";
import {
  startOfMonth,
  endOfMonth,
  eachDayOfInterval,
  format
} from "date-fns";

export default function CalendarGrid() {
  // State للأيام المحظورة
  const [blockedDays, setBlockedDays] = useState([]);

  // 1️⃣ جلب blockedDays من Firestore عند الظهور
  useEffect(() => {
    const fetchBlocked = async () => {
      try {
        const snap = await getDocs(collection(db, "blockedDays"));
        setBlockedDays(snap.docs.map(d => d.id));
      } catch (err) {
        console.error("خطأ بجلب الأيام المحجورة:", err);
      }
    };
    fetchBlocked();
  }, []);

  // 2️⃣ توليد كل أيام الشهر الحالي
  const today = new Date();
  const start = startOfMonth(today);
  const end   = endOfMonth(today);
  const allDays = eachDayOfInterval({ start, end });

  // 3️⃣ دالة تبديل حالة اليوم
  const toggleBlocked = async (isoDate) => {
    const ref = doc(db, "blockedDays", isoDate);
    if (blockedDays.includes(isoDate)) {
      await deleteDoc(ref);
      setBlockedDays(prev => prev.filter(d => d !== isoDate));
    } else {
      await setDoc(ref, {});
      setBlockedDays(prev => [...prev, isoDate]);
    }
  };

  return (
    <div className="mt-6">
      <h3 className="text-xl font-semibold mb-2">إدارة أيام الإغلاق</h3>
      <div className="grid grid-cols-7 gap-1">
        {allDays.map(day => {
          const iso = format(day, "yyyy-MM-dd");
          const isBlocked = blockedDays.includes(iso);
          return (
            <div
              key={iso}
              onClick={() => toggleBlocked(iso)}
              className={`
                p-2 text-center cursor-pointer select-none
                ${isBlocked ? "bg-red-400" : "bg-green-300"}
                hover:opacity-80 rounded
              `}
            >
              {day.getDate()}
            </div>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="src/components/reviews/BarberRatingSection.jsx">
import { useEffect, useState } from "react";
import SectionTitle from "../common/SectionTitle";
import { db } from "../../firebase";
import {
  collection,
  doc,
  getDoc,
  getDocs,
  limit,
  orderBy,
  query,
  runTransaction,
  serverTimestamp,
} from "firebase/firestore";
import { Star, MessageSquare, TrendingUp } from "lucide-react";
import {
  toILPhoneE164,
  isILPhoneE164,
  normalizeDigits,
} from "../../utils/phone";

/* ================== CONFIG ================== */
const BARBER_ID = "arfat";
const DEV_DISABLE_REVIEW_GUARDS = true;

/* ================== HELPERS ================== */
function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

/* ================== STARS ================== */
function StarRow({ value, onChange, readonly = false, size = 22 }) {
  const v = clamp(Number(value || 0), 0, 5);
  return (
    <div className="flex flex-row-reverse items-center gap-1">
      {[1, 2, 3, 4, 5].map((i) => {
        const active = i <= v;
        return (
          <button
            key={i}
            type="button"
            disabled={readonly}
            onClick={() => !readonly && onChange?.(i)}
            className={`p-1 rounded-lg ${
              readonly ? "cursor-default" : "hover:bg-gold/10"
            }`}
          >
            <Star
              style={{ width: size, height: size }}
              className={active ? "text-gold" : "text-gray-300"}
              fill={active ? "currentColor" : "none"}
            />
          </button>
        );
      })}
    </div>
  );
}

/* ================== TAGS ================== */
const TAGS = [
  { k: "clean", label: "نظافة" },
  { k: "on_time", label: "دقة بالمواعيد" },
  { k: "pro", label: "احتراف" },
  { k: "speed", label: "سرعة" },
  { k: "price", label: "سعر مناسب" },
  { k: "respect", label: "تعامل محترم" },
  { k: "hair_quality", label: "جودة قص الشعر" },
  { k: "vibe", label: "جو المكان" },
];

/* ================== REVIEW CARD ================== */
function ReviewCard({ r }) {
  const rating = Number(r.rating || 0);
  const comment = r.comment || "";
  const tags = Array.isArray(r.tags) ? r.tags : [];

  // ✅ اسم الزبون (للجديد) + fallback للقديم
  const name = String(
    r.customerName || r.userName || r.displayName || "",
  ).trim();

  const tagLabel = (k) => TAGS.find((t) => t.k === k)?.label || k;

  return (
    <div className="rounded-2xl border bg-white p-4 shadow-sm">
      <div className="flex flex-row-reverse justify-between">
        {/* ✅ بدل "زبون" */}
        <div className="text-right font-bold">{name || "زبون"}</div>
        <StarRow value={rating} readonly size={18} />
      </div>

      {tags.length > 0 && (
        <div className="mt-3 flex flex-row-reverse flex-wrap gap-2">
          {tags.map((k) => (
            <span
              key={k}
              className="text-xs px-2 py-1 rounded-full bg-[#f6f2ea] border border-gold/20"
            >
              {tagLabel(k)}
            </span>
          ))}
        </div>
      )}

      <p className="mt-3 text-sm text-right text-gray-700">
        {comment || "(بدون تعليق)"}
      </p>
    </div>
  );
}

/* ================== MAIN ================== */
export default function BarberRatingSection() {
  const [loading, setLoading] = useState(true);
  const [summary, setSummary] = useState({
    count: 0,
    sum: 0,
    byStar: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
  });
  const [latest, setLatest] = useState([]);

  const [open, setOpen] = useState(false);

  // ✅ جديد: اسم الزبون
  const [customerName, setCustomerName] = useState("");

  const [phone, setPhone] = useState("");
  const [rating, setRating] = useState(5);
  const [tags, setTags] = useState([]);
  const [comment, setComment] = useState("");
  const [submitting, setSubmitting] = useState(false);

  const count = Number(summary.count || 0);
  const avg = count > 0 ? summary.sum / count : 0;

  const summaryRef = doc(db, "barbers", BARBER_ID, "meta", "reviewsSummary");
  const reviewsCol = collection(db, "barbers", BARBER_ID, "reviews");

  /* ================== FETCH ================== */
  useEffect(() => {
    (async () => {
      setLoading(true);
      const ss = await getDoc(summaryRef);
      if (ss.exists()) setSummary(ss.data());

      const q = query(reviewsCol, orderBy("createdAt", "desc"), limit(3));
      const snap = await getDocs(q);
      setLatest(snap.docs.map((d) => ({ id: d.id, ...d.data() })));
      setLoading(false);
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  /* ================== SUBMIT ================== */
  async function submitReview() {
    // ✅ اسم ورقم مطلوبين
    const nameTrimmed = customerName.trim();
    if (!nameTrimmed) return;

    const phoneKey =
      toILPhoneE164(phone) && isILPhoneE164(toILPhoneE164(phone))
        ? toILPhoneE164(phone)
        : normalizeDigits(phone);

    if (!phoneKey) return;

    setSubmitting(true);

    await runTransaction(db, async (tx) => {
      const sSnap = await tx.get(summaryRef);
      const cur = sSnap.exists()
        ? sSnap.data()
        : { count: 0, sum: 0, byStar: {} };

      const reviewRef = doc(reviewsCol);

      tx.set(reviewRef, {
        rating,
        tags,
        comment,
        status: "active",
        createdAt: serverTimestamp(),

        // ✅ جديد: اسم الزبون
        customerName: nameTrimmed,

        // (اختياري) تخزين المفتاح لتسهيل الإدارة لاحقًا
        phoneKey,
      });

      tx.set(
        summaryRef,
        {
          count: cur.count + 1,
          sum: cur.sum + rating,
          byStar: {
            ...cur.byStar,
            [rating]: (cur.byStar?.[rating] || 0) + 1,
          },
        },
        { merge: true },
      );
    });

    // ✅ Reset
    setOpen(false);
    setCustomerName("");
    setPhone("");
    setComment("");
    setTags([]);
    setRating(5);
    setSubmitting(false);

    // ✅ Refresh latest (حتى يظهر الاسم فورًا)
    const q = query(reviewsCol, orderBy("createdAt", "desc"), limit(3));
    const snap = await getDocs(q);
    setLatest(snap.docs.map((d) => ({ id: d.id, ...d.data() })));

    const ss = await getDoc(summaryRef);
    if (ss.exists()) setSummary(ss.data());
  }

  /* ================== UI ================== */
  return (
    <section
      id="ratings"
      dir="rtl"
      className="relative bg-white px-4 py-20 font-body overflow-hidden"
    >
      {/* ديكور خفيف جداً (شكل فقط) */}
      <div className="pointer-events-none absolute inset-0">
        <div className="absolute -top-20 right-10 w-64 h-64 rounded-full bg-gold/10 blur-3xl" />
      </div>

      <SectionTitle
        icon={
          <div className="w-10 h-10 rounded-full bg-gold/15 flex items-center justify-center">
            <TrendingUp className="w-6 h-6 text-gold" />
          </div>
        }
      >
        تقييمات وتجربة الزبائن
      </SectionTitle>

      <div className="max-w-3xl mx-auto mt-6 bg-[#fcfaf7] p-6 rounded-3xl shadow-lg border border-gold/10 ring-1 ring-black/5 transition-transform duration-300 hover:-translate-y-1">
        <div className="text-right">
          <div className="text-4xl font-black">
            {count ? avg.toFixed(1) : "—"}
          </div>
          <StarRow value={Math.round(avg)} readonly />
          <div className="text-sm text-gray-600">{count} تقييم</div>
        </div>

        <div className="mt-6">
          <div className="flex justify-between items-center">
            <div className="font-bold">آخر الآراء</div>
            <button
              onClick={() => setOpen(!open)}
              className="bg-gold px-4 py-2 rounded-xl font-bold"
            >
              <MessageSquare className="inline w-4 h-4 ml-1" />
              اكتب تقييم
            </button>
          </div>

          {loading ? (
            <div className="mt-4 text-gray-500">جارٍ التحميل…</div>
          ) : (
            <div className="mt-4 grid gap-3 md:grid-cols-3">
              {latest.map((r) => (
                <ReviewCard key={r.id} r={r} />
              ))}
            </div>
          )}
        </div>

        {open && (
          <div className="mt-6 border-t pt-6">
            {/* ✅ جديد: اسم الزبون (نفس ستايل رقم الهاتف) */}
            <input
              className="w-full border rounded-xl px-4 py-2 mb-3"
              placeholder="اسمك"
              value={customerName}
              onChange={(e) => setCustomerName(e.target.value)}
            />

            <input
              className="w-full border rounded-xl px-4 py-2 mb-3"
              placeholder="رقم الهاتف"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
            />

            <StarRow value={rating} onChange={setRating} />

            <textarea
              className="w-full border rounded-xl px-4 py-2 mt-3"
              placeholder="تعليق (اختياري)"
              value={comment}
              onChange={(e) => setComment(e.target.value)}
            />

            <button
              onClick={submitReview}
              disabled={submitting}
              className="mt-4 w-full bg-primary text-white py-3 rounded-xl font-bold"
            >
              إرسال التقييم
            </button>
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="src/components/shared/Spinner.jsx">
function Spinner() {
  return (
    <div className="flex justify-center items-center py-4">
      <div className="w-8 h-8 border-4 border-gold border-t-transparent rounded-full animate-spin"></div>
    </div>
  );
}

export default Spinner;
</file>

<file path="src/components/ui/Button.jsx">
// src/components/ui/Button.jsx
export default function Button({
  children,
  type = "button",
  onClick,
  variant = "gold", // gold | outlineGold | ghost
  size = "lg", // sm | md | lg | xl
  disabled = false,
  loading = false,
  fullWidth = false,
  className = "",
}) {
  const base =
    "inline-flex items-center justify-center select-none rounded-2xl border " +
    "transition duration-200 ease-out will-change-transform " +
    "focus:outline-none focus:ring-2 focus:ring-offset-2 " +
    "disabled:opacity-60 disabled:cursor-not-allowed";

  const variants = {
    gold:
      // ذهبي متدرّج + نص داكن (متناسق مع موقعك)
      "bg-gradient-to-r from-[#FACC15] to-[#eab308] text-[#1F2937] " +
      "border-yellow-400 shadow-[0_6px_20px_rgba(250,204,21,0.35)] " +
      "hover:brightness-[1.03] hover:shadow-[0_10px_28px_rgba(250,204,21,0.45)] " +
      "active:scale-[0.98] focus:ring-yellow-400",
    outlineGold:
      "bg-white text-[#1F2937] border-yellow-400 " +
      "hover:bg-yellow-50 focus:ring-yellow-300 active:scale-[0.98]",
    ghost:
      "bg-transparent text-[#1F2937] border-transparent " +
      "hover:bg-gray-100 focus:ring-gray-300 active:scale-[0.98]",
  };

  const sizes = {
    sm: "text-sm px-3 py-1.5",
    md: "text-base px-4 py-2",
    lg: "text-base px-5 py-3",
    xl: "text-lg px-6 py-3.5",
  };

  return (
    <button
      type={type}
      onClick={onClick}
      disabled={disabled || loading}
      className={[
        base,
        variants[variant],
        sizes[size],
        fullWidth ? "w-full" : "",
        "relative overflow-hidden", // لمعان لطيف
        className,
      ].join(" ")}
    >
      {/* لمعان خفيف يمر عند الهوفر */}
      <span
        aria-hidden
        className="pointer-events-none absolute inset-0 opacity-0 hover:opacity-10 transition"
        style={{
          background:
            "linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.9) 45%, rgba(255,255,255,0) 90%)",
          transform: "translateX(-120%)",
        }}
        onAnimationEnd={(e) =>
          (e.currentTarget.style.transform = "translateX(-120%)")
        }
      />
      {/* محتوى الزر */}
      <span className="inline-flex items-center gap-2">
        {loading ? (
          <svg
            className="animate-spin h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            aria-hidden="true"
          >
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              strokeWidth="4"
            />
            <path
              className="opacity-90"
              d="M4 12a8 8 0 018-8"
              stroke="currentColor"
              strokeWidth="4"
              strokeLinecap="round"
            />
          </svg>
        ) : null}
        <span>{children}</span>
      </span>
    </button>
  );
}
</file>

<file path="src/components/ui/Card.jsx">
// src/components/ui/Card.jsx
export default function Card({
  children,
  onClick,
  selected = false,
  disabled = false,
  className = "",
  role = "button",
  tabIndex = 0,
}) {
  const base =
    "rounded-2xl border bg-white p-4 shadow-sm transition cursor-pointer select-none " +
    "hover:shadow-md focus:outline-none focus:ring-2 focus:ring-yellow-400";
  const selectedCls = selected
    ? "border-yellow-400 ring-1 ring-yellow-400 shadow-[0_8px_24px_rgba(250,204,21,0.25)]"
    : "border-gray-200";
  const disabledCls = disabled ? "opacity-50 cursor-not-allowed" : "";

  return (
    <div
      role={role}
      tabIndex={tabIndex}
      onClick={disabled ? undefined : onClick}
      className={`${base} ${selectedCls} ${disabledCls} ${className}`}
    >
      {children}
    </div>
  );
}
</file>

<file path="src/constants/barberDefaultWeeklyHours.js">
// src/constants/barberDefaultWeeklyHours.js
// Default weekly hours (matches the screenshot concept).
// Note: we store as {from, to} where from < to to avoid confusion.
// Display will be Arabic-friendly "من ... إلى ...".

const barberDefaultWeeklyHours = {
  Sunday: null, // مغلق طوال اليوم

  // الإثنين - الأربعاء: 12:00 → 20:00
  Monday: { from: "12:00", to: "20:00" },
  Tuesday: { from: "12:00", to: "20:00" },
  Wednesday: { from: "12:00", to: "20:00" },

  // الخميس: 12:00 → 22:00
  Thursday: { from: "12:00", to: "22:00" },

  // الجمعة: 13:30 → 22:00
  Friday: { from: "13:30", to: "22:00" },

  // السبت: 11:00 → 19:30
  Saturday: { from: "11:00", to: "19:30" },
};

export default barberDefaultWeeklyHours;
</file>

<file path="src/constants/workingHours.js">
// src/constants/workingHours.js
import barberDefaultWeeklyHours from "./barberDefaultWeeklyHours";

// نخلي "workingHours" هو نفس الافتراضي الرسمي للحلاق
export default barberDefaultWeeklyHours;
</file>

<file path="src/hooks/useWeeklyWorkingHours.js">
// src/hooks/useWeeklyWorkingHours.js
import { useEffect, useMemo, useState } from "react";
import { doc, getDoc, onSnapshot, setDoc } from "firebase/firestore";
import { db } from "../firebase";
import defaultWorkingHours from "../constants/workingHours";

/** تحقق بسيط من HH:mm */
function isHHmm(v) {
  return typeof v === "string" && /^\d{2}:\d{2}$/.test(v);
}

function sanitizeWeeklyHours(input, fallback) {
  const out = { ...fallback };
  if (!input || typeof input !== "object") return out;

  for (const day of Object.keys(fallback)) {
    const v = input[day];

    if (v === null) {
      out[day] = null;
      continue;
    }

    const from = v?.from;
    const to = v?.to;

    // لازم يكونوا HH:mm وبترتيب منطقي
    if (isHHmm(from) && isHHmm(to)) {
      // مقارنة زمنية بسيطة باستخدام Date
      const a = new Date(`2000-01-01T${from}:00`);
      const b = new Date(`2000-01-01T${to}:00`);
      if (a < b) out[day] = { from, to };
      else out[day] = fallback[day] ?? null;
    } else {
      out[day] = fallback[day] ?? null;
    }
  }

  return out;
}

/**
 * useWeeklyWorkingHours:
 * - يقرأ barberSettings/hours.weekly
 * - لو مش موجود/فيه مشكلة -> يرجع defaultWorkingHours
 * - (optional) createIfMissing: ينشئ doc لأول مرة بدون ما يغيّر شي ثاني
 */
export default function useWeeklyWorkingHours({
  live = true,
  createIfMissing = true,
} = {}) {
  const [weeklyHours, setWeeklyHours] = useState(defaultWorkingHours);
  const [loadingWeekly, setLoadingWeekly] = useState(true);

  useEffect(() => {
    const ref = doc(db, "barberSettings", "hours");

    let unsub = null;
    let alive = true;

    async function ensureExists() {
      try {
        const snap = await getDoc(ref);
        if (!alive) return;

        if (!snap.exists() && createIfMissing) {
          await setDoc(ref, { weekly: defaultWorkingHours }, { merge: true });
        }

        const weekly = snap.exists() ? snap.data()?.weekly : null;
        setWeeklyHours(sanitizeWeeklyHours(weekly, defaultWorkingHours));
      } catch (e) {
        console.warn("useWeeklyWorkingHours getDoc error:", e);
        setWeeklyHours(defaultWorkingHours);
      } finally {
        if (alive) setLoadingWeekly(false);
      }
    }

    if (!live) {
      ensureExists();
      return () => {
        alive = false;
      };
    }

    // LIVE sync
    setLoadingWeekly(true);
    unsub = onSnapshot(
      ref,
      async (snap) => {
        if (!alive) return;

        if (!snap.exists() && createIfMissing) {
          try {
            await setDoc(ref, { weekly: defaultWorkingHours }, { merge: true });
            // eslint-disable-next-line no-unused-vars
          } catch (e) {
            // ignore
          }
          setWeeklyHours(defaultWorkingHours);
          setLoadingWeekly(false);
          return;
        }

        const weekly = snap.exists() ? snap.data()?.weekly : null;
        setWeeklyHours(sanitizeWeeklyHours(weekly, defaultWorkingHours));
        setLoadingWeekly(false);
      },
      (err) => {
        console.warn("useWeeklyWorkingHours onSnapshot error:", err);
        setWeeklyHours(defaultWorkingHours);
        setLoadingWeekly(false);
      }
    );

    return () => {
      alive = false;
      if (unsub) unsub();
    };
  }, [live, createIfMissing]);

  return useMemo(
    () => ({ weeklyHours, loadingWeekly }),
    [weeklyHours, loadingWeekly]
  );
}
</file>

<file path="src/pages/adminBookings/AdminBookingsPage.jsx">
// src/pages/adminBookings/AdminBookingsPage.jsx
import { useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";
import { FaSyncAlt } from "react-icons/fa";
import { e164ToLocalPretty } from "../../utils/phone";

import Toolbar from "./Toolbar";
import DayGroup from "./DayGroup";
import PastSection from "./PastSection";
import { safeLower } from "./helpers";
import { useAdminBookingsData } from "./useAdminBookingsData";

export default function AdminBookingsPage() {
  const navigate = useNavigate();

  const { upcoming, recentPast, loading, lastUpdated, actions } =
    useAdminBookingsData();

  // UI state
  const [searchTerm, setSearchTerm] = useState("");
  const [serviceFilter, setServiceFilter] = useState("all");
  const [sortMode, setSortMode] = useState("soonest");
  const [showPast, setShowPast] = useState(true);

  // ✅ Compact + expanded
  const [compactMode, setCompactMode] = useState(true);
  const [expandedIds, setExpandedIds] = useState({});
  const toggleExpanded = (id) => {
    setExpandedIds((prev) => ({ ...prev, [id]: !prev[id] }));
  };

  // ✅ Toolbar collapsible
  const [toolsOpen, setToolsOpen] = useState(false);

  // Filter upcoming
  const filteredUpcoming = useMemo(() => {
    const term = safeLower(searchTerm).trim();
    let list = [...upcoming];

    if (serviceFilter !== "all") {
      list = list.filter((b) => b.selectedService === serviceFilter);
    }

    if (term) {
      list = list.filter((b) => {
        const name = safeLower(b.fullName);
        const phonePretty = safeLower(e164ToLocalPretty(b.phoneNumber));
        const phoneRaw = safeLower(b.phoneNumber);
        return (
          name.includes(term) ||
          phonePretty.includes(term) ||
          phoneRaw.includes(term)
        );
      });
    }

    if (sortMode === "newest") {
      list.sort((a, b) => {
        const da =
          typeof a.createdAt === "string"
            ? new Date(a.createdAt)
            : a.createdAt?.toDate?.() ?? new Date(0);
        const dbb =
          typeof b.createdAt === "string"
            ? new Date(b.createdAt)
            : b.createdAt?.toDate?.() ?? new Date(0);
        return dbb - da;
      });
    } else {
      list.sort((a, b) => {
        const da = new Date(`${a.selectedDate}T${a.selectedTime}:00`);
        const dbb = new Date(`${b.selectedDate}T${b.selectedTime}:00`);
        return da - dbb;
      });
    }

    return list;
  }, [upcoming, searchTerm, serviceFilter, sortMode]);

  // Filter past
  const filteredPast = useMemo(() => {
    const term = safeLower(searchTerm).trim();
    let list = [...recentPast];

    if (serviceFilter !== "all") {
      list = list.filter(
        (b) => (b.selectedService ?? "both") === serviceFilter
      );
    }

    if (term) {
      list = list.filter((b) => {
        const name = safeLower(b.fullName);
        const phonePretty = safeLower(e164ToLocalPretty(b.phoneNumber));
        const phoneRaw = safeLower(b.phoneNumber);
        return (
          name.includes(term) ||
          phonePretty.includes(term) ||
          phoneRaw.includes(term)
        );
      });
    }

    list.sort((a, b) => {
      const da = b.cancelledAt
        ? new Date(b.cancelledAt)
        : new Date(`${b.selectedDate}T${b.selectedTime}:00`);
      const dbb = a.cancelledAt
        ? new Date(a.cancelledAt)
        : new Date(`${a.selectedDate}T${a.selectedTime}:00`);
      return da - dbb;
    });

    return list;
  }, [recentPast, searchTerm, serviceFilter]);

  const upcomingByDate = useMemo(() => {
    return Object.entries(
      filteredUpcoming.reduce((acc, b) => {
        (acc[b.selectedDate] = acc[b.selectedDate] || []).push(b);
        return acc;
      }, {})
    ).sort(([a], [b]) => a.localeCompare(b));
  }, [filteredUpcoming]);

  const nextId = filteredUpcoming[0]?.id ?? null;

  return (
    <section className="min-h-screen bg-gray-100 pt-24 p-4 font-body" dir="rtl">
      <div className="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6 space-y-4">
        {/* Top Bar */}
        <div className="flex items-center justify-between gap-3">
          <button
            onClick={() => navigate(-1)}
            className="text-blue-700 hover:text-blue-900 text-sm font-semibold"
          >
            ← الرجوع
          </button>

          <div className="flex-1">
            <div className="flex items-center justify-center gap-2 flex-wrap">
              <h1 className="text-lg sm:text-xl font-extrabold text-gold">
                لوحة الحجوزات
              </h1>

              <span className="text-[11px] font-bold px-3 py-1 rounded-full border bg-emerald-50 text-emerald-800 border-emerald-200">
                القادمة: {filteredUpcoming.length}
              </span>

              <span className="text-[11px] font-bold px-3 py-1 rounded-full border bg-yellow-50 text-yellow-900 border-yellow-200">
                السجل: {filteredPast.length}
              </span>
            </div>
          </div>

          <div className="hidden sm:flex items-center gap-2 text-[11px] text-gray-400">
            <FaSyncAlt className="opacity-70" />
            <span>
              {lastUpdated
                ? `آخر تحديث: ${String(lastUpdated.getHours()).padStart(
                    2,
                    "0"
                  )}:${String(lastUpdated.getMinutes()).padStart(2, "0")}`
                : "آخر تحديث: —"}
            </span>
          </div>
        </div>

        {/* ✅ Toolbar (collapsible + نفس ارتفاع المضغوط) */}
        <Toolbar
          toolsOpen={toolsOpen}
          setToolsOpen={setToolsOpen}
          searchTerm={searchTerm}
          setSearchTerm={setSearchTerm}
          serviceFilter={serviceFilter}
          setServiceFilter={setServiceFilter}
          sortMode={sortMode}
          setSortMode={setSortMode}
          compactMode={compactMode}
          setCompactMode={setCompactMode}
        />

        {loading ? (
          <div className="space-y-3">
            <div className="h-20 rounded-2xl bg-gray-100 border border-gray-200 animate-pulse" />
            <div className="h-28 rounded-2xl bg-gray-100 border border-gray-200 animate-pulse" />
            <div className="h-28 rounded-2xl bg-gray-100 border border-gray-200 animate-pulse" />
          </div>
        ) : (
          <div className="space-y-4">
            {/* Upcoming */}
            <div className="rounded-2xl border border-gray-200 bg-white p-3 sm:p-4">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-base sm:text-lg font-extrabold text-gray-900">
                  📆 الحجوزات القادمة
                </h2>
                <span className="text-[11px] font-bold bg-emerald-50 text-emerald-800 border border-emerald-200 rounded-full px-3 py-1">
                  {filteredUpcoming.length} موعد
                </span>
              </div>

              {filteredUpcoming.length === 0 ? (
                <div className="rounded-xl bg-gray-50 border border-gray-200 p-6 text-center">
                  <p className="text-gray-900 font-extrabold">
                    لا توجد حجوزات.
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    أي حجز جديد سيظهر هنا تلقائيًا.
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  {upcomingByDate.map(([date, bookings]) => (
                    <DayGroup
                      key={date}
                      date={date}
                      bookings={bookings}
                      nextId={nextId}
                      compactMode={compactMode}
                      expandedIds={expandedIds}
                      toggleExpanded={toggleExpanded}
                      onCancel={(b) => actions.cancelBooking(b)}
                    />
                  ))}
                </div>
              )}
            </div>

            {/* Past */}
            <PastSection
              showPast={showPast}
              setShowPast={setShowPast}
              filteredPast={filteredPast}
              compactMode={compactMode}
              expandedIds={expandedIds}
              toggleExpanded={toggleExpanded}
              onRestore={(b) => actions.restoreBooking(b, upcoming)}
              onDelete={(b) => actions.deleteBookingForever(b)}
            />

            <div className="text-center text-[11px] text-gray-400">
              بحث بالاسم/الهاتف → اتصال → وإذا لزم: إلغاء/استرجاع/حذف.
            </div>
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="src/pages/adminBookings/BookingCard.jsx">
// src/pages/adminBookings/BookingCard.jsx
import { FaClock, FaPhone, FaCut, FaTimesCircle } from "react-icons/fa";
import { e164ToLocalPretty } from "../../utils/phone";
import { formatDateTime, serviceBadgeClasses, serviceLabel } from "./helpers";

export default function BookingCard({
  booking,
  isNext,
  compactMode,
  expanded,
  onToggleExpanded,
  onCancel,
}) {
  const name = booking.fullName || "بدون اسم";

  // ✅ لون الوقت (بدل الأسود)
  const timePill = "bg-indigo-600 text-white border-indigo-600"; // مريح + واضح

  // =========================
  // ✅ COMPACT MODE
  // =========================
  if (compactMode) {
    // ✅ إذا Expanded: لا نعرض السطر العلوي أبداً (حتى ما يصير دابليكيت)
    if (expanded) {
      return (
        <div
          className={`rounded-2xl bg-white border shadow-sm p-3 sm:p-4 ${
            isNext
              ? "border-emerald-300 ring-1 ring-emerald-100"
              : "border-gray-200"
          }`}
        >
          <div className="flex items-start justify-between gap-3">
            <h3 className="text-lg sm:text-xl font-black text-gray-900 leading-tight break-words">
              {name}
            </h3>

            <div className="shrink-0 flex items-center gap-2">
              {isNext && (
                <span className="text-[11px] font-extrabold px-3 py-1 rounded-full border bg-emerald-50 text-emerald-800 border-emerald-200">
                  التالي
                </span>
              )}
              <span
                className={`inline-flex items-center gap-2 text-xs font-extrabold rounded-full px-3 py-1 border ${timePill}`}
              >
                <FaClock className="opacity-90" />
                {booking.selectedTime}
              </span>
            </div>
          </div>

          <div className="mt-3 flex flex-wrap items-center gap-2">
            <a
              href={`tel:${booking.phoneNumber}`}
              className="inline-flex items-center gap-2 text-sm font-extrabold px-4 py-2 rounded-xl border border-blue-200 bg-blue-50 text-blue-800 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-200"
              aria-label={`اتصال بالزبون ${name}`}
              title="اتصال"
            >
              <FaPhone className="opacity-80" />
              اتصال
              <span className="font-semibold opacity-90">
                {e164ToLocalPretty(booking.phoneNumber)}
              </span>
            </a>

            {booking.selectedService && (
              <span
                className={`inline-flex items-center gap-2 text-xs font-bold rounded-full px-3 py-1 border ${serviceBadgeClasses(
                  booking.selectedService
                )}`}
                aria-label="الخدمة"
              >
                <FaCut className="opacity-80" />
                {serviceLabel(booking.selectedService)}
              </span>
            )}
          </div>

          <div className="mt-2 text-[11px] text-gray-500">
            تم الحجز: {formatDateTime(booking.createdAt)}
          </div>

          <div className="mt-3 flex flex-col sm:flex-row gap-2">
            <button
              type="button"
              onClick={onCancel}
              className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-200"
              aria-label="إلغاء الحجز"
            >
              <FaTimesCircle />
              إلغاء
            </button>

            <button
              type="button"
              onClick={onToggleExpanded}
              className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 hover:bg-gray-100"
            >
              إغلاق
            </button>
          </div>
        </div>
      );
    }

    // ✅ Compact collapsed: سطر واحد (اسم + وقت)
    return (
      <div
        className={`rounded-2xl border bg-white shadow-sm ${
          isNext
            ? "border-emerald-300 ring-1 ring-emerald-100"
            : "border-gray-200"
        }`}
      >
        <button
          type="button"
          onClick={onToggleExpanded}
          className="w-full text-right px-3 py-3 flex items-center justify-between gap-3"
          aria-label="فتح تفاصيل الحجز"
          title="فتح/إغلاق"
        >
          <div className="min-w-0 flex items-center gap-2">
            {isNext && (
              <span className="text-[11px] font-extrabold px-2 py-0.5 rounded-full border bg-emerald-50 text-emerald-800 border-emerald-200 shrink-0">
                التالي
              </span>
            )}

            <span className="text-sm sm:text-base font-black text-gray-900 truncate">
              {name}
            </span>
          </div>

          <div className="shrink-0 flex items-center gap-2">
            <span
              className={`inline-flex items-center gap-2 text-xs font-extrabold rounded-full px-3 py-1 border ${timePill}`}
            >
              <FaClock className="opacity-90" />
              {booking.selectedTime}
            </span>

            <span className="text-[11px] text-gray-400">فتح</span>
          </div>
        </button>
      </div>
    );
  }

  // =========================
  // ✅ COMFORT MODE
  // =========================
  return (
    <div
      className={`rounded-2xl bg-white border shadow-sm p-3 sm:p-4 ${
        isNext
          ? "border-emerald-300 ring-1 ring-emerald-100"
          : "border-gray-200"
      }`}
    >
      <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
        <div className="space-y-2 flex-1 min-w-0">
          {/* ✅ الاسم كامل (بدون 3 نقاط) */}
          <div className="flex items-start justify-between gap-3">
            <h3 className="text-lg sm:text-xl font-black text-gray-900 leading-tight break-words">
              {name}
            </h3>

            <div className="shrink-0 flex items-center gap-2">
              {isNext && (
                <span className="text-[11px] font-extrabold px-3 py-1 rounded-full border bg-emerald-50 text-emerald-800 border-emerald-200">
                  التالي
                </span>
              )}
              <span
                className={`inline-flex items-center gap-2 text-xs font-extrabold rounded-full px-3 py-1 border ${timePill}`}
              >
                <FaClock className="opacity-90" />
                {booking.selectedTime}
              </span>
            </div>
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <a
              href={`tel:${booking.phoneNumber}`}
              className="inline-flex items-center gap-2 text-sm font-extrabold px-4 py-2 rounded-xl border border-blue-200 bg-blue-50 text-blue-800 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-200"
              aria-label={`اتصال بالزبون ${name}`}
              title="اتصال"
            >
              <FaPhone className="opacity-80" />
              اتصال
              <span className="font-semibold opacity-90">
                {e164ToLocalPretty(booking.phoneNumber)}
              </span>
            </a>

            <span
              className={`inline-flex items-center gap-2 text-xs font-bold rounded-full px-3 py-1 border ${serviceBadgeClasses(
                booking.selectedService
              )}`}
              aria-label="الخدمة"
            >
              <FaCut className="opacity-80" />
              {serviceLabel(booking.selectedService)}
            </span>
          </div>

          <div className="text-[11px] text-gray-500">
            تم الحجز: {formatDateTime(booking.createdAt)}
          </div>
        </div>

        <div className="sm:pt-0">
          <button
            onClick={onCancel}
            className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-200"
            aria-label="إلغاء الحجز"
          >
            <FaTimesCircle />
            إلغاء
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/adminBookings/DayGroup.jsx">
// src/pages/adminBookings/DayGroup.jsx
import BookingCard from "./BookingCard";
import { formatDateArabic, getDateLabel } from "./helpers";

export default function DayGroup({
  date,
  bookings,
  nextId,
  compactMode,
  expandedIds,
  toggleExpanded,
  onCancel,
}) {
  const label = getDateLabel(date);

  // ✅ عدّل الرقم إذا الهيدر عندك أعلى/أقل بالموبايل
  const HEADER_OFFSET_PX = 80;

  const accent =
    label === "اليوم"
      ? "bg-emerald-500"
      : label === "بكرا"
      ? "bg-sky-500"
      : "bg-indigo-500";

  const badge =
    label === "اليوم"
      ? "bg-emerald-50 text-emerald-800 border-emerald-200"
      : label === "بكرا"
      ? "bg-sky-50 text-sky-800 border-sky-200"
      : "bg-slate-50 text-slate-800 border-slate-200";

  return (
    <div className="rounded-2xl bg-gray-50 border border-gray-200">
      {/* ✅ Header واحد: واضح كبداية يوم + Sticky أثناء السكرول */}
      <div
        className="sticky px-3 pt-3 z-10"
        style={{ top: `${HEADER_OFFSET_PX}px` }}
      >
        <div className="rounded-2xl bg-white border border-gray-200 shadow-sm overflow-hidden">
          <div className="flex items-center justify-between px-3 py-2">
            <div className="flex items-center gap-3 min-w-0">
              <div className={`w-2 h-10 rounded-full ${accent}`} />

              <div className="min-w-0 leading-tight">
                <div className="text-sm sm:text-base font-extrabold text-gray-900 truncate">
                  {formatDateArabic(date)}
                </div>

                {/* ✅ واضح كبداية يوم */}
                <div className="text-[11px] text-gray-500 mt-0.5">
                  {bookings.length} حجوزات
                </div>
              </div>

              {label ? (
                <span
                  className={`shrink-0 text-[11px] font-bold rounded-full px-3 py-1 border ${badge}`}
                >
                  {label}
                </span>
              ) : null}
            </div>

            {/* ✅ شريط جانبي قوي للتمييز أثناء السكرول */}
            <div className={`w-1.5 h-10 rounded-full ${accent}`} />
          </div>
        </div>
      </div>

      {/* List */}
      <div className="p-3 space-y-3 pt-3">
        {bookings.map((b) => {
          const isNext = b.id === nextId;
          const expanded = Boolean(expandedIds[b.id]);

          return (
            <BookingCard
              key={b.id}
              booking={b}
              isNext={isNext}
              compactMode={compactMode}
              expanded={expanded}
              onToggleExpanded={() => toggleExpanded(b.id)}
              onCancel={() => onCancel(b)}
            />
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/adminBookings/helpers.js">
// src/pages/adminBookings/helpers.js
export function formatDateArabic(dateStr) {
  const d = new Date(dateStr);
  return `${String(d.getDate()).padStart(2, "0")}/${String(
    d.getMonth() + 1
  ).padStart(2, "0")}/${d.getFullYear()}`;
}

export function formatDateTime(value) {
  const d =
    typeof value === "string" ? new Date(value) : value?.toDate?.() ?? value;
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, "0");
  const min = String(d.getMinutes()).padStart(2, "0");
  return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
}

export function getDateLabel(dateStr) {
  const today = new Date().toISOString().slice(0, 10);
  const tomorrow = new Date(Date.now() + 86400000).toISOString().slice(0, 10);
  if (dateStr === today) return "اليوم";
  if (dateStr === tomorrow) return "بكرا";
  return "";
}

export function serviceLabel(key) {
  return key === "haircut"
    ? "قص شعر"
    : key === "beard"
    ? "تعليم لحية"
    : "قص + لحية";
}

export function serviceBadgeClasses(key) {
  if (key === "haircut") return "bg-blue-50 text-blue-700 border-blue-200";
  if (key === "beard") return "bg-purple-50 text-purple-700 border-purple-200";
  return "bg-amber-50 text-amber-800 border-amber-200";
}

export function safeLower(v) {
  return (v ?? "").toString().toLowerCase();
}

export function dayBadgeClasses(label) {
  if (label === "اليوم")
    return "bg-emerald-50 text-emerald-700 border-emerald-200";
  if (label === "بكرا") return "bg-sky-50 text-sky-700 border-sky-200";
  return "bg-gray-50 text-gray-700 border-gray-200";
}
</file>

<file path="src/pages/adminBookings/PastSection.jsx">
// src/pages/adminBookings/PastSection.jsx
import { useState } from "react";
import {
  FaCalendarAlt,
  FaClock,
  FaPhone,
  FaTrash,
  FaUndo,
  FaChevronDown,
  FaChevronUp,
} from "react-icons/fa";
import { e164ToLocalPretty } from "../../utils/phone";
import {
  formatDateArabic,
  formatDateTime,
  serviceBadgeClasses,
  serviceLabel,
} from "./helpers";

export default function PastSection({
  showPast,
  setShowPast,
  filteredPast,
  onRestore,
  onDelete,
  compactMode,
}) {
  const [expandedPastIds, setExpandedPastIds] = useState({});

  const togglePastExpanded = (id) => {
    setExpandedPastIds((p) => ({ ...p, [id]: !p[id] }));
  };

  const timePillClasses =
    "inline-flex items-center gap-2 text-xs font-extrabold rounded-full px-3 py-1 border " +
    "bg-indigo-600 text-white border-indigo-600";

  return (
    <div className="rounded-2xl border border-amber-200 bg-amber-50/60 p-3 sm:p-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <h2 className="text-base sm:text-lg font-extrabold text-amber-900">
            🕘 السجل (منتهية / ملغية)
          </h2>
          <span className="text-[11px] font-bold bg-white text-amber-900 border border-amber-200 rounded-full px-3 py-1">
            {filteredPast.length}
          </span>
        </div>

        <button
          onClick={() => setShowPast((s) => !s)}
          className="text-sm font-extrabold text-amber-900 hover:text-amber-950"
          aria-label="عرض أو إخفاء السجل"
        >
          {showPast ? "إخفاء السجل" : `عرض السجل (${filteredPast.length})`}
        </button>
      </div>

      {!showPast ? (
        <div className="mt-3 text-xs text-amber-800/70">
          السجل مطوي لتسهيل الشغل. افتحه عند الحاجة.
        </div>
      ) : filteredPast.length === 0 ? (
        <div className="rounded-xl bg-white border border-amber-200 p-6 text-center mt-3">
          <p className="text-amber-950 font-extrabold">لا يوجد سجل.</p>
          <p className="text-xs text-amber-800/70 mt-1">
            الإلغاءات والمنتهية ستظهر هنا.
          </p>
        </div>
      ) : (
        <div className="space-y-3 mt-3">
          {filteredPast.map((b) => {
            const name = b.fullName || "بدون اسم";
            const expanded = Boolean(expandedPastIds[b.id]);

            // ✅ مضغوط للسجل
            if (compactMode) {
              return (
                <div
                  key={b.id}
                  className="rounded-2xl bg-white border border-amber-200 shadow-sm"
                >
                  <button
                    type="button"
                    onClick={() => togglePastExpanded(b.id)}
                    className="w-full text-right px-3 py-3 flex items-center justify-between gap-3"
                    aria-label="فتح تفاصيل السجل"
                  >
                    <span className="text-sm sm:text-base font-black text-gray-900 truncate">
                      {name}
                    </span>

                    <div className="shrink-0 flex items-center gap-2">
                      <span className={timePillClasses}>
                        <FaClock className="opacity-90" />
                        {b.selectedTime}
                      </span>

                      <span className="text-[11px] text-amber-900 inline-flex items-center gap-1">
                        {expanded ? <FaChevronUp /> : <FaChevronDown />}
                        {expanded ? "إغلاق" : "تفاصيل"}
                      </span>
                    </div>
                  </button>

                  {expanded && (
                    <div className="px-3 pb-3">
                      <div className="flex flex-wrap items-center gap-2 mb-2">
                        <a
                          href={`tel:${b.phoneNumber}`}
                          className="inline-flex items-center gap-2 text-sm font-extrabold px-4 py-2 rounded-xl border border-blue-200 bg-blue-50 text-blue-800 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-200"
                          title="اتصال"
                        >
                          <FaPhone className="opacity-80" />
                          اتصال
                          <span className="font-semibold opacity-90">
                            {e164ToLocalPretty(b.phoneNumber)}
                          </span>
                        </a>

                        {b.selectedService && (
                          <span
                            className={`inline-flex items-center gap-2 text-xs font-bold rounded-full px-3 py-1 border ${serviceBadgeClasses(
                              b.selectedService
                            )}`}
                          >
                            {serviceLabel(b.selectedService)}
                          </span>
                        )}

                        <span className="inline-flex items-center gap-2 text-sm text-gray-700">
                          <FaCalendarAlt className="text-gray-400" />
                          {formatDateArabic(b.selectedDate)}
                        </span>
                      </div>

                      {b.cancelledAt && (
                        <div className="text-[11px] font-semibold text-red-700 bg-red-50 border border-red-200 rounded-xl px-3 py-2 inline-block mb-3">
                          🚫 تم الإلغاء: {formatDateTime(b.cancelledAt)}
                        </div>
                      )}

                      <div className="flex flex-col sm:flex-row gap-2 sm:items-center sm:justify-end">
                        {b.cancelledAt && (
                          <button
                            onClick={() => onRestore(b)}
                            className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                            aria-label="استرجاع الحجز"
                          >
                            <FaUndo />
                            استرجاع
                          </button>
                        )}

                        <button
                          onClick={() => onDelete(b)}
                          className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200"
                          aria-label="حذف نهائي"
                        >
                          <FaTrash />
                          حذف نهائي
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              );
            }

            // ✅ مريح للسجل (زي قبل بس مع لون القسم)
            return (
              <div
                key={b.id}
                className="rounded-2xl bg-white border border-amber-200 shadow-sm p-3 sm:p-4"
              >
                <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                  <div className="space-y-2 flex-1 min-w-0">
                    <div className="flex items-start justify-between gap-3">
                      <h3 className="text-lg sm:text-xl font-black text-gray-900 leading-snug whitespace-normal break-words">
                        {name}
                      </h3>

                      <span className={timePillClasses}>
                        <FaClock className="opacity-90" />
                        {b.selectedTime}
                      </span>
                    </div>

                    <div className="flex flex-wrap items-center gap-2">
                      <a
                        href={`tel:${b.phoneNumber}`}
                        className="inline-flex items-center gap-2 text-sm font-extrabold px-4 py-2 rounded-xl border border-blue-200 bg-blue-50 text-blue-800 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-200"
                        title="اتصال"
                      >
                        <FaPhone className="opacity-80" />
                        اتصال
                        <span className="font-semibold opacity-90">
                          {e164ToLocalPretty(b.phoneNumber)}
                        </span>
                      </a>

                      {b.selectedService && (
                        <span
                          className={`inline-flex items-center gap-2 text-xs font-bold rounded-full px-3 py-1 border ${serviceBadgeClasses(
                            b.selectedService
                          )}`}
                        >
                          {serviceLabel(b.selectedService)}
                        </span>
                      )}

                      <span className="inline-flex items-center gap-2 text-sm text-gray-700">
                        <FaCalendarAlt className="text-gray-400" />
                        {formatDateArabic(b.selectedDate)}
                      </span>
                    </div>

                    {b.cancelledAt && (
                      <div className="text-[11px] font-semibold text-red-700 bg-red-50 border border-red-200 rounded-xl px-3 py-2 inline-block">
                        🚫 تم الإلغاء: {formatDateTime(b.cancelledAt)}
                      </div>
                    )}
                  </div>

                  <div className="flex flex-col gap-2 sm:items-end">
                    {b.cancelledAt && (
                      <button
                        onClick={() => onRestore(b)}
                        className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-800 hover:bg-emerald-100 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                        aria-label="استرجاع الحجز"
                      >
                        <FaUndo />
                        استرجاع
                      </button>
                    )}

                    <button
                      onClick={() => onDelete(b)}
                      className="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm font-bold px-4 py-2 rounded-xl border border-gray-200 bg-gray-50 text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200"
                      aria-label="حذف نهائي"
                    >
                      <FaTrash />
                      حذف نهائي
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/pages/adminBookings/Toolbar.jsx">
// src/pages/adminBookings/Toolbar.jsx
import { useState } from "react";
import {
  FaSearch,
  FaFilter,
  FaTimes,
  FaChevronDown,
  FaChevronUp,
} from "react-icons/fa";

export default function Toolbar({
  searchTerm,
  setSearchTerm,
  serviceFilter,
  setServiceFilter,
  sortMode,
  setSortMode,
  compactMode,
  setCompactMode,
}) {
  // ✅ افتراضيًا مغلق (حسب طلبك)
  const [open, setOpen] = useState(false);

  return (
    <div className="rounded-2xl border border-gray-200 bg-white shadow-sm">
      {/* ✅ Bar صغير (بنفس روح ارتفاع الدور المضغوط) */}
      <div className="px-3 py-3 flex items-center justify-between gap-3">
        <button
          type="button"
          onClick={() => setOpen((s) => !s)}
          className="inline-flex items-center gap-2 text-sm font-extrabold text-gray-900"
          aria-label="فتح/إغلاق أدوات البحث"
        >
          {open ? (
            <FaChevronUp className="opacity-70" />
          ) : (
            <FaChevronDown className="opacity-70" />
          )}
          أدوات البحث
          {searchTerm.trim() ||
          serviceFilter !== "all" ||
          sortMode !== "soonest" ? (
            <span className="text-[11px] font-bold px-2 py-0.5 rounded-full bg-amber-50 border border-amber-200 text-amber-900">
              مفعّل
            </span>
          ) : null}
        </button>

        {/* Compact toggle (يبقى ظاهر دائمًا) */}
        <div className="flex items-center gap-2">
          <span className="text-[11px] font-bold text-gray-600">مضغوط</span>
          <button
            type="button"
            onClick={() => setCompactMode((s) => !s)}
            aria-label="تبديل العرض المضغوط"
            title="تبديل العرض"
          >
            <div
              className={`relative w-14 h-7 rounded-full transition-colors flex items-center ${
                compactMode ? "bg-emerald-500" : "bg-gray-300"
              }`}
            >
              <div
                className={`absolute top-0.5 left-0.5 w-6 h-6 rounded-full bg-white shadow-md transition-transform ${
                  compactMode ? "translate-x-7" : "translate-x-0"
                }`}
              />
            </div>
          </button>
        </div>
      </div>

      {/* ✅ المحتوى القابل للفتح */}
      {open && (
        <div className="border-t border-gray-200 bg-gray-50 p-3 rounded-b-2xl">
          <div className="flex flex-col gap-3">
            {/* Search */}
            <div>
              <label className="text-[11px] text-gray-500 flex items-center gap-2 mb-1">
                <FaSearch className="opacity-70" />
                بحث سريع (اسم / هاتف)
              </label>

              <div className="relative">
                <input
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  placeholder="اكتب اسم الزبون أو رقم الهاتف..."
                  className="w-full rounded-xl border border-gray-200 px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-gray-200 bg-white"
                  aria-label="بحث بالاسم أو رقم الهاتف"
                />

                {searchTerm.trim() && (
                  <button
                    type="button"
                    onClick={() => setSearchTerm("")}
                    className="absolute left-2 top-1/2 -translate-y-1/2 rounded-lg px-2 py-1 text-gray-500 hover:text-gray-900 hover:bg-gray-100"
                    aria-label="مسح البحث"
                    title="مسح"
                  >
                    <FaTimes />
                  </button>
                )}
              </div>
            </div>

            {/* Filters */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-[11px] text-gray-500 flex items-center gap-2 mb-1">
                  <FaFilter className="opacity-70" />
                  الخدمة
                </label>
                <select
                  value={serviceFilter}
                  onChange={(e) => setServiceFilter(e.target.value)}
                  className="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white outline-none focus:ring-2 focus:ring-gray-200"
                  aria-label="فلترة حسب الخدمة"
                >
                  <option value="all">الكل</option>
                  <option value="haircut">قص شعر</option>
                  <option value="beard">تعليم لحية</option>
                  <option value="both">قص + لحية</option>
                </select>
              </div>

              <div>
                <label className="text-[11px] text-gray-500 mb-1 block">
                  الترتيب
                </label>
                <select
                  value={sortMode}
                  onChange={(e) => setSortMode(e.target.value)}
                  className="w-full rounded-xl border border-gray-200 px-3 py-2 text-sm bg-white outline-none focus:ring-2 focus:ring-gray-200"
                  aria-label="ترتيب الحجوزات"
                >
                  <option value="soonest">أقرب موعد</option>
                  <option value="newest">أحدث حجز</option>
                </select>
              </div>
            </div>

            {/* Quick reset */}
            {(searchTerm.trim() ||
              serviceFilter !== "all" ||
              sortMode !== "soonest") && (
              <button
                type="button"
                onClick={() => {
                  setSearchTerm("");
                  setServiceFilter("all");
                  setSortMode("soonest");
                }}
                className="w-full rounded-xl border border-gray-200 bg-white hover:bg-gray-100 text-sm font-bold py-2"
              >
                تصفير الأدوات
              </button>
            )}
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/pages/adminBookings/useAdminBookingsData.js">
// src/pages/adminBookings/useAdminBookingsData.js
import { useEffect, useMemo, useState } from "react";
import { db } from "../../firebase";
import {
  collection,
  query,
  where,
  getDocs,
  doc,
  updateDoc,
  deleteDoc,
  deleteField,
} from "firebase/firestore";

export function useAdminBookingsData() {
  const [upcoming, setUpcoming] = useState([]);
  const [recentPast, setRecentPast] = useState([]);
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState(null);

  useEffect(() => {
    let alive = true;

    async function fetchAndClassify() {
      try {
        const now = new Date();
        const snap = await getDocs(query(collection(db, "bookings")));

        const up = [];
        const past = [];

        for (const d of snap.docs) {
          const data = d.data();
          const when = new Date(`${data.selectedDate}T${data.selectedTime}:00`);
          const diffH = (now - when) / (1000 * 60 * 60);

          // نفس منطقك: بعد 2 ساعات من الموعد => حذف نهائي
          if (diffH > 2) {
            await deleteDoc(doc(db, "bookings", d.id));
            continue;
          }

          if (data.cancelledAt || diffH >= 0) {
            past.push({ id: d.id, ...data });
          } else {
            up.push({ id: d.id, ...data });
          }
        }

        up.sort((a, b) => {
          const da = new Date(`${a.selectedDate}T${a.selectedTime}:00`);
          const dbb = new Date(`${b.selectedDate}T${b.selectedTime}:00`);
          return da - dbb;
        });

        if (!alive) return;
        setUpcoming(up);
        setRecentPast(past);
        setLoading(false);
        setLastUpdated(new Date());
      } catch (e) {
        console.error("fetchAndClassify error:", e);
        if (!alive) return;
        setLoading(false);
      }
    }

    fetchAndClassify();
    const interval = setInterval(() => fetchAndClassify(), 60000);

    return () => {
      alive = false;
      clearInterval(interval);
    };
  }, []);

  const actions = useMemo(() => {
    return {
      async cancelBooking(b) {
        const cancelledAt = new Date().toISOString();
        await updateDoc(doc(db, "bookings", b.id), { cancelledAt });
        setUpcoming((u) => u.filter((x) => x.id !== b.id));
        setRecentPast((p) => [{ ...b, cancelledAt }, ...p]);
      },

      async restoreBooking(b, upcomingList) {
        // 1) لا تسترجع إذا في upcoming بنفس الموعد
        if (
          upcomingList.some(
            (x) =>
              x.selectedDate === b.selectedDate &&
              x.selectedTime === b.selectedTime
          )
        ) {
          alert("لا يمكن استرجاع هذا الحجز؛ الموعد محجوز حالياً.");
          return;
        }

        // 2) تحقق من فايرستور: أي حجز غير ملغي على نفس الموعد؟
        const conflictQ = query(
          collection(db, "bookings"),
          where("selectedDate", "==", b.selectedDate),
          where("selectedTime", "==", b.selectedTime)
        );
        const conflictSnap = await getDocs(conflictQ);
        const activeConflicts = conflictSnap.docs
          .map((d) => d.data())
          .filter((data) => !data.cancelledAt);

        if (activeConflicts.length > 0) {
          alert("لا يمكن استرجاع هذا الحجز؛ تم حجز هذا الموعد من قبل.");
          return;
        }

        // UI optimistic
        setRecentPast((p) => p.filter((x) => x.id !== b.id));
        setUpcoming((u) =>
          [...u, b].sort((a, c) => {
            const da = new Date(`${a.selectedDate}T${a.selectedTime}:00`);
            const dc = new Date(`${c.selectedDate}T${c.selectedTime}:00`);
            return da - dc;
          })
        );

        await updateDoc(doc(db, "bookings", b.id), {
          cancelledAt: deleteField(),
        });

        // مثل كودك السابق (حتى لو مو ضروري): نخليه عشان ما نغيّر سلوك
        window.location.reload();
      },

      async deleteBookingForever(b) {
        const ok = window.confirm("متأكد بدك حذف نهائي؟ (ما بنقدر نرجّعه)");
        if (!ok) return;
        await deleteDoc(doc(db, "bookings", b.id));
        setRecentPast((p) => p.filter((x) => x.id !== b.id));
      },
    };
  }, []);

  return {
    upcoming,
    recentPast,
    loading,
    lastUpdated,
    actions,
  };
}
</file>

<file path="src/pages/AdminBookingsV2.jsx">
import { useEffect, useState } from "react";
import { db } from "../firebase";
import { collection, getDocs, doc, updateDoc} from "firebase/firestore";
import { FaPhone, FaClock, FaCut, FaUser } from "react-icons/fa";

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("ar-EG", { weekday: "long", year: "numeric", month: "2-digit", day: "2-digit" });
}

function getTimeLeft(dateStr, timeStr) {
  const now = new Date();
  const target = new Date(`${dateStr}T${timeStr}:00`);
  const diffMin = Math.round((target - now) / 60000);
  return diffMin > 0 ? `بعد ${diffMin} دقيقة` : `الآن`;
}

export default function AdminBookingsStyled() {
  const [grouped, setGrouped] = useState({});

  useEffect(() => {
    const fetch = async () => {
      const snap = await getDocs(collection(db, "bookings"));
      const upcoming = {};
      const now = new Date();

      for (const docSnap of snap.docs) {
        const data = docSnap.data();
        if (data.cancelledAt) continue;

        const dateKey = data.selectedDate;
        const timeObj = new Date(`${dateKey}T${data.selectedTime}:00`);
        if (timeObj < now) continue;

        if (!upcoming[dateKey]) upcoming[dateKey] = [];
        upcoming[dateKey].push({ id: docSnap.id, ...data });
      }

      for (const date in upcoming) {
        upcoming[date].sort((a, b) => a.selectedTime.localeCompare(b.selectedTime));
      }

      setGrouped(upcoming);
    };

    fetch();
    const interval = setInterval(fetch, 60000);
    return () => clearInterval(interval);
  }, []);

  const handleCancel = async (b) => {
    await updateDoc(doc(db, "bookings", b.id), { cancelledAt: new Date().toISOString() });
    setGrouped(prev => {
      const updated = { ...prev };
      updated[b.selectedDate] = updated[b.selectedDate].filter(x => x.id !== b.id);
      return updated;
    });
  };

  return (
    <section className="min-h-screen bg-[#f7f8fc] py-20 px-4 font-ar" dir="rtl">
      <div className="max-w-6xl mx-auto space-y-8">
        <h1 className="text-3xl font-bold text-yellow-700">📋 لوحة الحجوزات الجديدة</h1>

        {Object.keys(grouped).length === 0 ? (
          <p className="text-center text-gray-500">لا توجد حجوزات قادمة.</p>
        ) : (
          Object.entries(grouped).sort().map(([date, bookings]) => (
            <div key={date} className="bg-white shadow-md border rounded-2xl p-4 space-y-3">
              <div className="text-lg font-bold text-yellow-700 mb-2">📅 {formatDate(date)}</div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {bookings.map(b => (
                  <div key={b.id} className="border rounded-xl p-3 flex justify-between items-center bg-gray-50">
                    <div className="text-sm space-y-1">
                      <p><FaUser className="inline mr-1 text-gold" /> {b.fullName}</p>
                      <p><FaPhone className="inline mr-1 text-gray-500" /> {b.phoneNumber}</p>
                      <p><FaClock className="inline mr-1 text-gray-500" /> {b.selectedTime} ⏳ {getTimeLeft(b.selectedDate, b.selectedTime)}</p>
                      <p><FaCut className="inline mr-1 text-gray-500" /> {b.selectedService}</p>
                    </div>
                    <div className="flex flex-col gap-2 text-sm text-right">
                      <button onClick={() => handleCancel(b)} className="text-red-600 hover:underline">إلغاء</button>
                      <a href={`tel:${b.phoneNumber}`} className="text-pink-600 hover:underline">اتصال</a>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ))
        )}
      </div>
    </section>
  );
}
</file>

<file path="src/pages/BarberPanel.old.jsx">
// src/pages/BarberPanel.jsx
import { useState, useEffect, useMemo } from "react";
import { useTranslation } from "react-i18next";
import { useNavigate, Link } from "react-router-dom";
import { db } from "../firebase";
import {
  doc,
  getDoc,
  setDoc,
  updateDoc,
  arrayUnion,
  arrayRemove,
  collection,
  query,
  where,
  getDocs,
  deleteDoc,
  onSnapshot,
} from "firebase/firestore";
import { e164ToLocalPretty } from "../utils/phone";

// ✅ حسب مشروعك (زي ما بالصورة): الملف هون
import workingHours from "../components/booking/workingHours";

// ========= helpers =========
function safeInt(v, fallback = 0) {
  const n = Number(v);
  return Number.isFinite(n) ? Math.trunc(n) : fallback;
}

function addDaysYMD(ymd, days) {
  const d = new Date(`${ymd}T00:00:00`);
  d.setDate(d.getDate() + (Number(days) || 0));
  return d.toISOString().slice(0, 10);
}

function getWeekdayNameEN(ymd) {
  const d = new Date(`${ymd}T00:00:00`);
  return d.toLocaleDateString("en-US", { weekday: "long" });
}

function addMinutesToHHMM(hhmm, minsToAdd) {
  const [h, m] = String(hhmm || "00:00")
    .split(":")
    .map(Number);
  const base = new Date();
  base.setHours(h || 0, m || 0, 0, 0);
  base.setMinutes(base.getMinutes() + (Number(minsToAdd) || 0));
  const HH = String(base.getHours()).padStart(2, "0");
  const MM = String(base.getMinutes()).padStart(2, "0");
  return `${HH}:${MM}`;
}

/**
 * ✅ أدوار 30 دقيقة (النهاية غير شاملة)
 * مثال: 12:00 -> 20:00 => آخر دور 19:30
 */
function generateSlots30Min(from, to) {
  if (!from || !to) return [];
  const [fh, fm] = from.split(":").map(Number);
  const [th, tm] = to.split(":").map(Number);

  const cur = new Date();
  cur.setHours(fh, fm, 0, 0);

  const end = new Date();
  end.setHours(th, tm, 0, 0);

  const out = [];
  while (cur < end) {
    out.push(cur.toTimeString().slice(0, 5));
    cur.setMinutes(cur.getMinutes() + 30);
  }
  return out;
}

function applyExtraSlots(baseSlots, extraSlots) {
  const n = safeInt(extraSlots, 0);
  if (!n) return baseSlots;

  if (n > 0) {
    const last = baseSlots[baseSlots.length - 1];
    const extras = [];
    for (let i = 1; i <= n; i++) extras.push(addMinutesToHHMM(last, i * 30));
    return [...baseSlots, ...extras];
  }

  const cut = Math.abs(n);
  return baseSlots.slice(0, Math.max(0, baseSlots.length - cut));
}

// ========= DateDropdown =========
function DateDropdown({ selectedDate, onChange }) {
  const [options, setOptions] = useState([]);

  useEffect(() => {
    const temp = [];
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    // ✅ خليها 14 يوم عشان الحلاق يقدر يختار "الأسبوع الجاي" بسهولة
    for (let i = 0; i < 14; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      const iso = d.toISOString().slice(0, 10);

      const daysAr = [
        "الأحد",
        "الإثنين",
        "الثلاثاء",
        "الأربعاء",
        "الخميس",
        "الجمعة",
        "السبت",
      ];
      let label = daysAr[d.getDay()];
      if (d.toDateString() === today.toDateString()) label += " (اليوم)";
      else if (d.toDateString() === tomorrow.toDateString()) label += " (بكرا)";

      temp.push({ value: iso, label });
    }

    setOptions(temp);
  }, []);

  return (
    <select
      value={selectedDate}
      onChange={(e) => onChange(e.target.value)}
      className="w-full px-4 py-3 border border-gray-300 bg-white rounded-xl focus:outline-none focus:ring-2 focus:ring-gold transition mb-4"
    >
      <option value="" disabled>
        اختر التاريخ من القائمة
      </option>
      {options.map(({ value, label }) => (
        <option key={value} value={value}>
          {label}
        </option>
      ))}
    </select>
  );
}

export default function BarberPanel() {
  const { t, i18n } = useTranslation();
  const navigate = useNavigate();
  const isArabic = i18n.language === "ar";
  const fontClass = isArabic ? "font-ar" : "font-body";

  const [selectedDate, setSelectedDate] = useState("");
  const [blockedTimes, setBlockedTimes] = useState([]);
  const [selectedTimes, setSelectedTimes] = useState([]);
  const [bookings, setBookings] = useState([]);
  const [statusMessage, setStatusMessage] = useState("");
  const [isDayBlocked, setIsDayBlocked] = useState(false);
  const [loadingBlock, setLoadingBlock] = useState(false);

  // إعداد: حجز واحد لكل رقم/يوم
  const [limitOnePerDay, setLimitOnePerDay] = useState(false);
  const [loadingSettings, setLoadingSettings] = useState(true);
  const [savingSettings, setSavingSettings] = useState(false);

  // ✅ extra slots (slotExtras)
  const [extraSlots, setExtraSlots] = useState(0);
  const [loadingExtras, setLoadingExtras] = useState(false);
  const [savingExtras, setSavingExtras] = useState(false);

  // نطاق تطبيق التعديل
  const [applyMode, setApplyMode] = useState("THIS_DATE"); // THIS_DATE | SAME_WEEKDAY_UNTIL | EVERY_DAY_UNTIL
  const [applyUntil, setApplyUntil] = useState("");

  // ====== حالة اليوم (blockedDays) ======
  useEffect(() => {
    if (!selectedDate) return;
    (async () => {
      try {
        const ref = doc(db, "blockedDays", selectedDate);
        const snap = await getDoc(ref);
        setIsDayBlocked(snap.exists());
      } catch {
        setIsDayBlocked(false);
      }
    })();
  }, [selectedDate]);

  const toggleDay = async () => {
    if (!selectedDate) return;
    setLoadingBlock(true);
    const ref = doc(db, "blockedDays", selectedDate);
    try {
      if (isDayBlocked) {
        await deleteDoc(ref);
        setIsDayBlocked(false);
      } else {
        const bookingsSnap = await getDocs(
          query(
            collection(db, "bookings"),
            where("selectedDate", "==", selectedDate)
          )
        );
        const activeBookings = bookingsSnap.docs.filter(
          (d) => !d.data().cancelledAt
        );
        if (activeBookings.length > 0) {
          alert("⚠️ لا يمكن تعطيل هذا اليوم لأن هناك حجوزات لم يتم إلغاؤها.");
          return;
        }
        await setDoc(ref, {});
        setIsDayBlocked(true);
      }
    } catch (e) {
      console.error(e);
    }
    setLoadingBlock(false);
  };

  // ====== تسجيل خروج تلقائي ======
  useEffect(() => {
    let timer;
    const resetTimer = () => {
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => {
        localStorage.removeItem("barberUser");
        alert("⚠️ تم تسجيل الخروج بسبب عدم النشاط لمدة ساعتين.");
        navigate("/login");
      }, 2 * 60 * 60 * 1000);
    };
    resetTimer();
    const handleActivity = () => resetTimer();
    window.addEventListener("click", handleActivity);
    window.addEventListener("keydown", handleActivity);
    return () => {
      clearTimeout(timer);
      window.removeEventListener("click", handleActivity);
      window.removeEventListener("keydown", handleActivity);
    };
  }, [navigate]);

  // ====== جلب الحجوزات لحظيًا ======
  useEffect(() => {
    const q = query(collection(db, "bookings"));
    const unsub = onSnapshot(
      q,
      (snap) => setBookings(snap.docs.map((d) => ({ id: d.id, ...d.data() }))),
      (err) => console.error("خطأ بجلب الحجوزات (onSnapshot):", err)
    );
    return () => unsub();
  }, []);

  // ====== جلب إعداد limitOnePerDay ======
  useEffect(() => {
    const fetchSettings = async () => {
      try {
        const ref = doc(db, "barberSettings", "global");
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          const value =
            typeof data.limitOneBookingPerDayPerPhone === "boolean"
              ? data.limitOneBookingPerDayPerPhone
              : !!data.limitOneBookingPerDay;
          setLimitOnePerDay(value);
        } else setLimitOnePerDay(false);
      } catch (err) {
        console.error("خطأ بجلب إعدادات الحلاق:", err);
        setLimitOnePerDay(false);
      } finally {
        setLoadingSettings(false);
      }
    };
    fetchSettings();
  }, []);

  const handleToggleLimitOnePerDay = async () => {
    if (loadingSettings || savingSettings) return;
    try {
      setSavingSettings(true);
      const ref = doc(db, "barberSettings", "global");
      await setDoc(
        ref,
        { limitOneBookingPerDayPerPhone: !limitOnePerDay },
        { merge: true }
      );
      setLimitOnePerDay((p) => !p);
    } catch (err) {
      console.error("خطأ بتحديث الإعداد:", err);
      alert("حدث خطأ أثناء تحديث الإعداد. حاول مرة أخرى.");
    } finally {
      setSavingSettings(false);
    }
  };

  // ====== الأوقات المحظورة (blockedTimes) ======
  useEffect(() => {
    if (!selectedDate) {
      setBlockedTimes([]);
      setSelectedTimes([]);
      setStatusMessage("");
      return;
    }
    (async () => {
      try {
        const ref = doc(db, "blockedTimes", selectedDate);
        const snap = await getDoc(ref);
        if (snap.exists()) setBlockedTimes(snap.data().times || []);
        else setBlockedTimes([]);
        setSelectedTimes([]);
        setStatusMessage("");
      } catch (err) {
        console.error("خطأ بجلب الأوقات المحظورة:", err);
        setBlockedTimes([]);
      }
    })();
  }, [selectedDate]);

  const handleToggleTime = async (time) => {
    const isTimeBooked = bookings.some(
      (b) =>
        b.selectedDate === selectedDate &&
        b.selectedTime === time &&
        !b.cancelledAt
    );

    if (isTimeBooked) {
      setStatusMessage("هذه الساعة محجوزة ولا يمكن تعديلها.");
      return;
    }

    if (blockedTimes.includes(time)) {
      const updated = blockedTimes.filter((t) => t !== time);
      setBlockedTimes(updated);
      try {
        const ref = doc(db, "blockedTimes", selectedDate);
        await updateDoc(ref, { times: arrayRemove(time) });
        setStatusMessage("✅ تم استرجاع الساعة بنجاح");
      } catch (err) {
        console.error("خطأ باسترجاع الساعة:", err);
        setStatusMessage("حدث خطأ، حاول مرة أخرى.");
      }
      setTimeout(() => setStatusMessage(""), 2500);
      return;
    }

    setSelectedTimes((prev) =>
      prev.includes(time) ? prev.filter((t) => t !== time) : [...prev, time]
    );
    setStatusMessage("");
  };

  const handleApplyBlock = async () => {
    if (!selectedDate || selectedTimes.length === 0) {
      setStatusMessage("اختر ساعة واحدة على الأقل للحظر.");
      return;
    }

    for (const time of selectedTimes) {
      const booked = bookings.some(
        (b) =>
          b.selectedDate === selectedDate &&
          b.selectedTime === time &&
          !b.cancelledAt
      );
      if (booked) {
        setStatusMessage(`الساعة ${time} محجوزة.`);
        return;
      }
    }

    try {
      const ref = doc(db, "blockedTimes", selectedDate);
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { times: [] });
      for (const time of selectedTimes)
        await updateDoc(ref, { times: arrayUnion(time) });
      setBlockedTimes([...blockedTimes, ...selectedTimes]);
      setSelectedTimes([]);
      setStatusMessage("✅ تم حظر الأوقات بنجاح");
    } catch (err) {
      console.error("خطأ بتطبيق الحظر:", err);
      setStatusMessage("حدث خطأ، حاول مرة أخرى.");
    }
    setTimeout(() => setStatusMessage(""), 2500);
  };

  // ====== ✅ جلب extraSlots لليوم المختار ======
  useEffect(() => {
    if (!selectedDate) {
      setExtraSlots(0);
      setApplyMode("THIS_DATE");
      setApplyUntil("");
      return;
    }

    let alive = true;
    (async () => {
      setLoadingExtras(true);
      try {
        const snap = await getDoc(doc(db, "slotExtras", selectedDate));
        if (!alive) return;

        setExtraSlots(snap.exists() ? safeInt(snap.data()?.extraSlots, 0) : 0);

        // افتراضي واضح وبسيط
        setApplyMode("THIS_DATE");
        setApplyUntil("");
      } catch (e) {
        console.error("fetch slotExtras error:", e);
        if (alive) setExtraSlots(0);
      } finally {
        if (alive) setLoadingExtras(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [selectedDate]);

  // =====================================================================
  // ✅✅ المهم: شبكة ساعات الحلاق = workingHours + extraSlots فقط
  // ممنوع نعمل union مع bookings/blockedTimes لأنه يخلق ساعات "برا الدوام"
  // =====================================================================
  const timesForBarberGrid = useMemo(() => {
    if (!selectedDate) return [];
    const weekday = getWeekdayNameEN(selectedDate);
    const hours = workingHours?.[weekday] || null;
    if (!hours?.from || !hours?.to) return [];

    const base = generateSlots30Min(hours.from, hours.to);
    return applyExtraSlots(base, extraSlots);
  }, [selectedDate, extraSlots]);

  // فلترة الماضي لليوم الحالي فقط (نفس منطق الزبون)
  const todayStr = useMemo(() => new Date().toLocaleDateString("sv-SE"), []);
  const isToday = selectedDate && selectedDate === todayStr;

  const gridTimesFiltered = useMemo(() => {
    if (!timesForBarberGrid.length) return [];
    if (!isToday) return timesForBarberGrid;
    const now = new Date();
    return timesForBarberGrid.filter(
      (time) => new Date(`${selectedDate}T${time}:00`) > now
    );
  }, [timesForBarberGrid, isToday, selectedDate]);

  // ====== أحدث الحجوزات ======
  const activeBookings = useMemo(
    () => bookings.filter((b) => !b.cancelledAt),
    [bookings]
  );

  const recentBookings = useMemo(() => {
    const getBookingCreationDate = (b) => {
      if (b.createdAt && typeof b.createdAt.toDate === "function")
        return b.createdAt.toDate();
      if (b.createdAt instanceof Date) return b.createdAt;
      try {
        if (b.selectedDate && b.selectedTime)
          return new Date(`${b.selectedDate}T${b.selectedTime}:00`);
      } catch {
        // ignore
      }
      return new Date(0);
    };

    return [...activeBookings]
      .sort((a, b) => getBookingCreationDate(a) - getBookingCreationDate(b))
      .slice(-5)
      .reverse();
  }, [activeBookings]);

  // ====== ✅ تطبيق تعديل extraSlots (اليوم/نفس يوم الأسبوع/كل الأيام) ======
  const applyExtraSlotsChange = async (nextValue) => {
    if (!selectedDate) return;

    const value = safeInt(nextValue, 0);

    // حماية بسيطة
    if (value < -10 || value > 10) {
      alert("⚠️ مسموح من -10 إلى +10 فقط (كل رقم = 30 دقيقة).");
      return;
    }

    const weekdayOfSelected = getWeekdayNameEN(selectedDate);

    const buildTargets = () => {
      if (applyMode === "THIS_DATE") return [selectedDate];

      if (!applyUntil) return null;

      const start = selectedDate;
      const end = applyUntil;
      if (end < start) return null;

      const targets = [];
      let d = start;
      while (d <= end) {
        if (applyMode === "EVERY_DAY_UNTIL") {
          targets.push(d);
        } else if (applyMode === "SAME_WEEKDAY_UNTIL") {
          const wd = getWeekdayNameEN(d);
          if (wd === weekdayOfSelected) targets.push(d);
        }
        d = addDaysYMD(d, 1);
      }
      return targets;
    };

    const targets = buildTargets();
    if (!targets) {
      alert("⚠️ اختَر تاريخ نهاية صحيح (لازم يكون بعد/يساوي تاريخ البداية).");
      return;
    }

    // منع تقليل أدوار إذا رح ينحذف دور عليه حجز
    if (value < 0) {
      for (const ymd of targets) {
        const weekday = getWeekdayNameEN(ymd);
        const hours = workingHours?.[weekday] || null;
        if (!hours?.from || !hours?.to) continue;

        const base = generateSlots30Min(hours.from, hours.to);

        const currentExtraSnap = await getDoc(doc(db, "slotExtras", ymd));
        const currentExtra = currentExtraSnap.exists()
          ? safeInt(currentExtraSnap.data()?.extraSlots, 0)
          : 0;

        const currentSlots = applyExtraSlots(base, currentExtra);
        const nextSlots = applyExtraSlots(base, value);

        const removed = currentSlots.filter((s) => !nextSlots.includes(s));
        if (removed.length) {
          const hasBookingOnRemoved = activeBookings.some(
            (b) => b.selectedDate === ymd && removed.includes(b.selectedTime)
          );
          if (hasBookingOnRemoved) {
            alert(
              `⚠️ لا يمكن تقليل الأدوار في ${ymd} لأن هناك حجز على دور سيتم حذفه.\n(حلّها: الغِ الحجز أو غيّر التعديل)`
            );
            return;
          }
        }
      }
    }

    try {
      setSavingExtras(true);

      const writes = targets.map((ymd) =>
        setDoc(
          doc(db, "slotExtras", ymd),
          { extraSlots: value },
          { merge: true }
        )
      );
      await Promise.all(writes);

      setExtraSlots(value);

      setStatusMessage(
        applyMode === "THIS_DATE"
          ? `✅ تم تطبيق التعديل على ${selectedDate}`
          : applyMode === "SAME_WEEKDAY_UNTIL"
          ? `✅ تم تطبيق التعديل على كل ${weekdayOfSelected} حتى ${applyUntil}`
          : `✅ تم تطبيق التعديل على كل الأيام حتى ${applyUntil}`
      );
    } catch (e) {
      console.error("save slotExtras error:", e);
      alert("حدث خطأ أثناء حفظ التعديل. حاول مرة أخرى.");
    } finally {
      setSavingExtras(false);
      setTimeout(() => setStatusMessage(""), 2500);
    }
  };

  const dayIsClosedByHours = useMemo(() => {
    if (!selectedDate) return false;
    const weekday = getWeekdayNameEN(selectedDate);
    const hours = workingHours?.[weekday] || null;
    return !hours?.from || !hours?.to;
  }, [selectedDate]);

  return (
    <div className={`min-h-screen bg-gray-100 p-6 ${fontClass}`} dir="rtl">
      <div className="h-16"></div>

      <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        <div className="flex flex-col md:flex-row items-center justify-between bg-white px-8 py-6 border-b">
          <h1 className="text-3xl font-semibold text-gray-800">
            إدارة الساعات
          </h1>

          <div className="mt-4 md:mt-0 flex flex-wrap items-center gap-3 text-sm">
            <button
              onClick={() => navigate("/admin-bookings")}
              className="text-blue-600 hover:underline transition-colors"
            >
              لوحة الحجوزات
            </button>

            <Link
              to="/blocked-phones"
              className="text-yellow-700 hover:underline transition-colors"
            >
              الأرقام المحظورة
            </Link>

            <button
              onClick={() => {
                if (window.confirm("هل أنت متأكد أنك تريد تسجيل الخروج؟")) {
                  localStorage.removeItem("barberUser");
                  navigate("/login");
                }
              }}
              className="text-red-600 hover:underline transition-colors"
            >
              تسجيل الخروج
            </button>

            <button
              onClick={() => navigate("/dashboard")}
              className="text-green-700 hover:underline transition-colors"
            >
              الإحصائيات
            </button>
          </div>
        </div>

        {/* اختيار التاريخ + حالة اليوم */}
        <div className="p-8">
          <label className="block mb-3 text-lg font-medium text-gray-700">
            اختر التاريخ
          </label>

          <DateDropdown
            selectedDate={selectedDate}
            onChange={setSelectedDate}
          />

          <input
            type="date"
            value={selectedDate}
            onChange={(e) => setSelectedDate(e.target.value)}
            className="w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-50 text-gray-800 focus:outline-none focus:ring-2 focus:ring-gold transition mb-4"
            min={new Date().toISOString().split("T")[0]}
          />

          {selectedDate && (
            <div className="flex items-center justify-between mb-4">
              <span>حالة اليوم:</span>
              <button
                onClick={toggleDay}
                disabled={loadingBlock}
                className={`px-4 py-2 rounded text-white font-semibold transition ${
                  isDayBlocked
                    ? "bg-red-500 hover:bg-red-600"
                    : "bg-green-500 hover:bg-green-600"
                }`}
              >
                {loadingBlock
                  ? "جاري..."
                  : isDayBlocked
                  ? "تفعيل اليوم"
                  : "تعطيل اليوم"}
              </button>
            </div>
          )}

          {!selectedDate && (
            <p className="mt-2 text-sm text-gray-500">
              يمكنك استخدام القائمة أو التقويم لاختيار أي تاريخ.
            </p>
          )}

          {selectedDate && dayIsClosedByHours && (
            <p className="mt-3 text-sm text-red-600 font-medium">
              هذا اليوم مغلق
            </p>
          )}
        </div>

        {/* لوحة الساعات (مطابقة للزبون) */}
        {selectedDate && !dayIsClosedByHours && !isDayBlocked && (
          <div className="p-8 pt-4 border-t bg-gray-50">
            <h2 className="text-xl font-semibold text-gray-700 mb-4">
              الأوقات (مطابقة للزبون):
            </h2>

            <div className="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-6">
              {gridTimesFiltered.map((time) => {
                const booked = bookings.some(
                  (b) =>
                    b.selectedDate === selectedDate &&
                    b.selectedTime === time &&
                    !b.cancelledAt
                );
                const isBlocked = blockedTimes.includes(time);
                const isSelected = selectedTimes.includes(time);

                return (
                  <button
                    key={time}
                    onClick={() => handleToggleTime(time)}
                    disabled={booked}
                    className={`py-2 rounded-xl text-sm font-medium text-center transition-all duration-200 ${
                      booked
                        ? "bg-red-700 text-white cursor-not-allowed"
                        : isBlocked
                        ? "bg-red-200 text-red-800"
                        : isSelected
                        ? "bg-yellow-300 text-gray-900 ring-2 ring-yellow-500"
                        : "bg-green-100 text-green-800 hover:bg-green-200"
                    }`}
                    title={
                      booked
                        ? "هذه الساعة محجوزة"
                        : isBlocked
                        ? "هذه الساعة محظورة"
                        : "اضغط للحظر/الإلغاء"
                    }
                  >
                    {time}
                  </button>
                );
              })}
            </div>

            {selectedTimes.length > 0 ? (
              <button
                onClick={handleApplyBlock}
                className="w-full bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500"
              >
                {t("remove_selected_times") ||
                  "تطبيق الحظر على الساعات المحددة"}
              </button>
            ) : (
              <p className="text-sm text-gray-500">
                اختر ساعة أو أكثر ثم اضغط لحظرها.
              </p>
            )}
          </div>
        )}

        {selectedDate && isDayBlocked && (
          <div className="p-8 pt-4 border-t bg-yellow-50 text-center text-red-600 font-semibold text-lg">
            تم تعطيل هذا اليوم بالكامل. لا يمكن تعديل أو حظر الساعات حتى يتم
            تفعيله من جديد.
          </div>
        )}

        {/* ✅ كرت زيادة/نقص الأدوار — تحت الساعات */}
        {selectedDate && !dayIsClosedByHours && !isDayBlocked && (
          <div className="px-8 pb-8">
            <div className="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 mt-6">
              <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                  <h2 className="text-base font-bold text-slate-900">
                    ➕➖ زيادة/نقص عدد الأدوار (كل دور = 30 دقيقة)
                  </h2>
                  <p className="text-xs text-slate-500 mt-1">
                    هذا لا يغيّر ساعات العمل الأساسية. فقط يضيف/ينقص أدوار
                    إضافية في نهاية اليوم.
                  </p>
                </div>

                <div className="flex items-center gap-2">
                  <button
                    type="button"
                    disabled={loadingExtras || savingExtras}
                    onClick={() => applyExtraSlotsChange(extraSlots - 1)}
                    className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-900 font-bold disabled:opacity-60"
                    title="(-1) ينقص آخر دور"
                  >
                    -1
                  </button>

                  <div className="min-w-[90px] text-center">
                    <div className="text-xs text-slate-500">القيمة الحالية</div>
                    <div className="text-xl font-extrabold text-slate-900">
                      {loadingExtras
                        ? "…"
                        : extraSlots >= 0
                        ? `+${extraSlots}`
                        : `${extraSlots}`}
                    </div>
                  </div>

                  <button
                    type="button"
                    disabled={loadingExtras || savingExtras}
                    onClick={() => applyExtraSlotsChange(extraSlots + 1)}
                    className="px-4 py-2 rounded-xl bg-amber-400 hover:bg-amber-500 text-slate-900 font-extrabold disabled:opacity-60"
                    title="(+1) يزيد دور واحد بعد آخر دور"
                  >
                    +1
                  </button>
                </div>
              </div>

              <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div className="bg-slate-50 border border-slate-200 rounded-xl p-3">
                  <label className="block text-xs font-bold text-slate-700 mb-2">
                    نطاق التطبيق
                  </label>
                  <select
                    value={applyMode}
                    onChange={(e) => setApplyMode(e.target.value)}
                    className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-gold"
                  >
                    <option value="THIS_DATE">هذا اليوم فقط</option>
                    <option value="SAME_WEEKDAY_UNTIL">
                      نفس يوم الأسبوع لحد تاريخ
                    </option>
                    <option value="EVERY_DAY_UNTIL">كل الأيام لحد تاريخ</option>
                  </select>

                  <div className="mt-2 text-[11px] text-slate-600 leading-relaxed">
                    {applyMode === "THIS_DATE" && (
                      <span>
                        ✅ التعديل يُطبَّق فقط على هذا التاريخ:{" "}
                        <b>{selectedDate}</b>
                      </span>
                    )}
                    {applyMode === "SAME_WEEKDAY_UNTIL" && (
                      <span>
                        ✅ يطبَّق على <b>نفس يوم الأسبوع</b> من{" "}
                        <b>{selectedDate}</b> حتى تاريخ النهاية.
                      </span>
                    )}
                    {applyMode === "EVERY_DAY_UNTIL" && (
                      <span>
                        ✅ يطبَّق على <b>كل الأيام</b> من <b>{selectedDate}</b>{" "}
                        حتى تاريخ النهاية.
                      </span>
                    )}
                  </div>
                </div>

                <div className="bg-slate-50 border border-slate-200 rounded-xl p-3">
                  <label className="block text-xs font-bold text-slate-700 mb-2">
                    تاريخ النهاية (إذا اخترت “لحد تاريخ”)
                  </label>
                  <input
                    type="date"
                    value={applyUntil}
                    onChange={(e) => setApplyUntil(e.target.value)}
                    disabled={applyMode === "THIS_DATE"}
                    min={selectedDate || undefined}
                    className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-gold disabled:opacity-60"
                  />

                  <button
                    type="button"
                    disabled={loadingExtras || savingExtras}
                    onClick={() => applyExtraSlotsChange(0)}
                    className="mt-3 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-100 text-sm font-bold disabled:opacity-60"
                    title="يرجع للوضع الطبيعي"
                  >
                    رجّع للوضع الطبيعي (0)
                  </button>
                </div>
              </div>

              <div className="mt-3 text-xs text-slate-600 bg-amber-50 border border-amber-200 rounded-xl p-3">
                <b>معلومة مهمة:</b>
                <br />
                (+1) = يزيد <b>دور واحد</b> بعد آخر دور.
                <br />
                (-1) = ينقص <b>آخر دور</b>.
                <br />
                إذا كان هناك <b>حجز</b> على دور سيتم حذفه، النظام يمنع التقليل
                حتى لا ينكسر شيء.
              </div>
            </div>
          </div>
        )}

        {statusMessage && (
          <div className="p-4 bg-green-100 border border-green-300 text-green-800 text-center font-medium">
            {statusMessage}
          </div>
        )}
      </div>

      {/* أحدث الحجوزات */}
      {recentBookings.length > 0 && (
        <div className="max-w-3xl mx-auto mt-6 text-xs sm:text-sm">
          <div className="bg-white rounded-2xl shadow-md border border-slate-200 p-4 sm:p-5 text-slate-900">
            <div className="flex items-center justify-between gap-2 mb-3">
              <div className="flex items-center gap-2">
                <span className="text-lg">📅</span>
                <div className="flex flex-col">
                  <h2 className="font-semibold text-slate-900">
                    أحدث الحجوزات (رقم موحّد)
                  </h2>
                  <span className="text-[11px] text-slate-500">
                    آخر {recentBookings.length} حجوزات فعّالة
                  </span>
                </div>
              </div>
            </div>

            <div className="mt-2 border-t border-slate-100 divide-y divide-slate-100">
              {recentBookings.map((b, idx) => (
                <div
                  key={b.id}
                  className="py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 hover:bg-slate-50 rounded-xl px-2"
                >
                  <div className="flex items-start gap-3">
                    <div className="mt-1">
                      <span className="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-100 text-[11px] text-slate-500">
                        {idx + 1}
                      </span>
                    </div>
                    <div className="flex flex-col">
                      <span className="font-semibold text-slate-900 text-sm sm:text-base">
                        {b.fullName || "بدون اسم"}
                      </span>
                      <div className="mt-1 inline-flex flex-wrap items-center gap-2 text-[11px]">
                        <span className="inline-flex items-center rounded-full bg-amber-50 px-3 py-0.5 border border-amber-200 text-amber-800">
                          {b.selectedDate || "—"}
                        </span>
                        <span className="inline-flex items-center rounded-full bg-sky-50 px-3 py-0.5 border border-sky-200 text-sky-700">
                          {b.selectedTime || "—"}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-2 sm:justify-end sm:min-w-[150px] text-[11px] sm:text-xs">
                    <span className="text-slate-500">الرقم الموحّد:</span>
                    <span className="font-mono text-sm text-slate-900">
                      {e164ToLocalPretty(b.phoneNumber)}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* إعداد حجز واحد لكل رقم/يوم */}
      <div className="max-w-3xl mx-auto mt-6">
        <div className="bg-white rounded-2xl shadow p-4 border border-gray-200 text-center">
          <h2 className="text-sm font-semibold text-gray-800 mb-2">
            وضع حجز واحد لكل رقم / يوم
          </h2>

          <div className="flex items-center justify-center gap-4 mb-2">
            <span className="text-xs font-semibold text-gray-700">
              {limitOnePerDay ? "مُفَعَّل" : "مُعَطَّل"}
            </span>

            <button
              type="button"
              onClick={handleToggleLimitOnePerDay}
              disabled={loadingSettings || savingSettings}
              className="disabled:opacity-60 disabled:cursor-not-allowed"
            >
              <div
                className={`relative w-16 h-8 rounded-full transition-colors flex items-center ${
                  limitOnePerDay ? "bg-emerald-500" : "bg-gray-300"
                }`}
              >
                <div
                  className={`absolute top-0.5 left-0.5 w-7 h-7 rounded-full bg-white shadow-md transition-transform ${
                    limitOnePerDay ? "translate-x-8" : "translate-x-0"
                  }`}
                />
              </div>
            </button>
          </div>

          <p className="text-xs text-gray-500">
            {limitOnePerDay
              ? "مُفعَّل: لا يمكن لنفس الرقم حجز أكثر من موعد في نفس اليوم."
              : "مُعطَّل: يمكن لنفس الرقم حجز أكثر من موعد في نفس اليوم."}
          </p>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/DateDropdown.jsx">
// src/pages/barberPanel/components/DateDropdown.jsx
import { useEffect, useState } from "react";

export default function DateDropdown({ selectedDate, onChange }) {
  const [options, setOptions] = useState([]);

  useEffect(() => {
    const temp = [];
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    for (let i = 0; i < 14; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() + i);
      const iso = d.toISOString().slice(0, 10);

      const daysAr = [
        "الأحد",
        "الإثنين",
        "الثلاثاء",
        "الأربعاء",
        "الخميس",
        "الجمعة",
        "السبت",
      ];
      let label = daysAr[d.getDay()];
      if (d.toDateString() === today.toDateString()) label += " (اليوم)";
      else if (d.toDateString() === tomorrow.toDateString()) label += " (بكرا)";

      temp.push({ value: iso, label });
    }

    setOptions(temp);
  }, []);

  return (
    <select
      value={selectedDate}
      onChange={(e) => onChange(e.target.value)}
      className="w-full px-4 py-3 border border-gray-300 bg-white rounded-xl focus:outline-none focus:ring-2 focus:ring-gold transition mb-4"
    >
      <option value="" disabled>
        اختر التاريخ من القائمة
      </option>
      {options.map(({ value, label }) => (
        <option key={value} value={value}>
          {label}
        </option>
      ))}
    </select>
  );
}
</file>

<file path="src/pages/barberPanel/components/ExtraSlotsCard.jsx">
// src/pages/barberPanel/components/ExtraSlotsCard.jsx
export default function ExtraSlotsCard({
  selectedDate,
  extraSlots,
  loadingExtras,
  savingExtras,
  applyMode,
  setApplyMode,
  applyUntil,
  setApplyUntil,
  onApply,
}) {
  return (
    <div className="bg-white border border-slate-200 rounded-2xl shadow-sm p-5 mt-6">
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 className="text-base font-bold text-slate-900">
            ➕➖ زيادة/نقص عدد الأدوار (كل دور = 30 دقيقة)
          </h2>
          <p className="text-xs text-slate-500 mt-1">
            هذا لا يغيّر ساعات العمل الأساسية. فقط يضيف/ينقص أدوار إضافية في
            نهاية اليوم.
          </p>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            disabled={loadingExtras || savingExtras}
            onClick={() => onApply(extraSlots - 1)}
            className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-900 font-bold disabled:opacity-60"
            title="(-1) ينقص آخر دور"
          >
            -1
          </button>

          <div className="min-w-[90px] text-center">
            <div className="text-xs text-slate-500">القيمة الحالية</div>
            <div className="text-xl font-extrabold text-slate-900">
              {loadingExtras
                ? "…"
                : extraSlots >= 0
                ? `+${extraSlots}`
                : `${extraSlots}`}
            </div>
          </div>

          <button
            type="button"
            disabled={loadingExtras || savingExtras}
            onClick={() => onApply(extraSlots + 1)}
            className="px-4 py-2 rounded-xl bg-amber-400 hover:bg-amber-500 text-slate-900 font-extrabold disabled:opacity-60"
            title="(+1) يزيد دور واحد بعد آخر دور"
          >
            +1
          </button>
        </div>
      </div>

      <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div className="bg-slate-50 border border-slate-200 rounded-xl p-3">
          <label className="block text-xs font-bold text-slate-700 mb-2">
            نطاق التطبيق
          </label>

          <select
            value={applyMode}
            onChange={(e) => setApplyMode(e.target.value)}
            className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-gold"
          >
            <option value="THIS_DATE">هذا اليوم فقط</option>
            <option value="SAME_WEEKDAY_UNTIL">
              نفس يوم الأسبوع لحد تاريخ
            </option>
            <option value="EVERY_DAY_UNTIL">كل الأيام لحد تاريخ</option>
          </select>

          <div className="mt-2 text-[11px] text-slate-600 leading-relaxed">
            {applyMode === "THIS_DATE" && (
              <span>
                ✅ التعديل يُطبَّق فقط على هذا التاريخ: <b>{selectedDate}</b>
              </span>
            )}
            {applyMode === "SAME_WEEKDAY_UNTIL" && (
              <span>
                ✅ يطبَّق على <b>نفس يوم الأسبوع</b> من <b>{selectedDate}</b>{" "}
                حتى تاريخ النهاية.
              </span>
            )}
            {applyMode === "EVERY_DAY_UNTIL" && (
              <span>
                ✅ يطبَّق على <b>كل الأيام</b> من <b>{selectedDate}</b> حتى
                تاريخ النهاية.
              </span>
            )}
          </div>
        </div>

        <div className="bg-slate-50 border border-slate-200 rounded-xl p-3">
          <label className="block text-xs font-bold text-slate-700 mb-2">
            تاريخ النهاية (إذا اخترت “لحد تاريخ”)
          </label>

          <input
            type="date"
            value={applyUntil}
            onChange={(e) => setApplyUntil(e.target.value)}
            disabled={applyMode === "THIS_DATE"}
            min={selectedDate || undefined}
            className="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm focus:outline-none focus:ring-2 focus:ring-gold disabled:opacity-60"
          />

          <button
            type="button"
            disabled={loadingExtras || savingExtras}
            onClick={() => onApply(0)}
            className="mt-3 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-100 text-sm font-bold disabled:opacity-60"
            title="يرجع للوضع الطبيعي"
          >
            رجّع للوضع الطبيعي (0)
          </button>
        </div>
      </div>

      <div className="mt-3 text-xs text-slate-600 bg-amber-50 border border-amber-200 rounded-xl p-3">
        <b>معلومة مهمة:</b>
        <br />
        (+1) = يزيد <b>دور واحد</b> بعد آخر دور.
        <br />
        (-1) = ينقص <b>آخر دور</b>.
        <br />
        إذا كان هناك <b>حجز</b> على دور سيتم حذفه، النظام يمنع التقليل حتى لا
        ينكسر شيء.
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/LimitOnePerDayCard.jsx">
// src/pages/barberPanel/components/LimitOnePerDayCard.jsx
export default function LimitOnePerDayCard({
  limitOnePerDay,
  loadingSettings,
  savingSettings,
  onToggle,
}) {
  return (
    <div className="max-w-3xl mx-auto mt-6">
      <div className="bg-white rounded-2xl shadow p-4 border border-gray-200 text-center">
        <h2 className="text-sm font-semibold text-gray-800 mb-2">
          وضع حجز واحد لكل رقم / يوم
        </h2>

        <div className="flex items-center justify-center gap-4 mb-2">
          <span className="text-xs font-semibold text-gray-700">
            {limitOnePerDay ? "مُفَعَّل" : "مُعَطَّل"}
          </span>

          <button
            type="button"
            onClick={onToggle}
            disabled={loadingSettings || savingSettings}
            className="disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <div
              className={`relative w-16 h-8 rounded-full transition-colors flex items-center ${
                limitOnePerDay ? "bg-emerald-500" : "bg-gray-300"
              }`}
            >
              <div
                className={`absolute top-0.5 left-0.5 w-7 h-7 rounded-full bg-white shadow-md transition-transform ${
                  limitOnePerDay ? "translate-x-8" : "translate-x-0"
                }`}
              />
            </div>
          </button>
        </div>

        <p className="text-xs text-gray-500">
          {limitOnePerDay
            ? "مُفعَّل: لا يمكن لنفس الرقم حجز أكثر من موعد في نفس اليوم."
            : "مُعطَّل: يمكن لنفس الرقم حجز أكثر من موعد في نفس اليوم."}
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/NotificationTestCard.jsx">
// src/pages/barberPanel/components/NotificationTestCard.jsx
import React, { useMemo, useState } from "react";
import {
  createTestNotificationRequest,
  getNotificationPermission,
  getOrRequestFcmToken,
  saveDeviceToken,
} from "../../../services/fcmTest";

function Pill({ tone = "neutral", children }) {
  const cls =
    tone === "success"
      ? "bg-emerald-50 text-emerald-800 border-emerald-200"
      : tone === "danger"
        ? "bg-rose-50 text-rose-800 border-rose-200"
        : tone === "info"
          ? "bg-sky-50 text-sky-800 border-sky-200"
          : "bg-slate-100 text-slate-700 border-slate-200";

  return (
    <span
      className={`inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-black border ${cls}`}
    >
      {children}
    </span>
  );
}

export default function NotificationTestCard() {
  const [busy, setBusy] = useState(false);
  const [msg, setMsg] = useState(null);

  const perm = useMemo(() => getNotificationPermission(), []);

  const permPill = useMemo(() => {
    if (perm === "unsupported") return <Pill tone="danger">غير مدعوم</Pill>;
    if (perm === "granted") return <Pill tone="success">مفعّل</Pill>;
    if (perm === "denied") return <Pill tone="danger">مرفوض</Pill>;
    return <Pill tone="info">مش مقرر</Pill>; // default
  }, [perm]);

  const clearMsgSoon = () => {
    setTimeout(() => setMsg(null), 3500);
  };

  const ensureTokenAndSave = async () => {
    const token = await getOrRequestFcmToken();
    if (!token) {
      setMsg({ tone: "danger", text: "تم رفض الإذن أو ما في Token." });
      clearMsgSoon();
      return null;
    }
    await saveDeviceToken(token);
    return token;
  };

  const onEnable = async () => {
    setBusy(true);
    setMsg(null);
    try {
      const token = await ensureTokenAndSave();
      if (token) {
        setMsg({
          tone: "success",
          text: "جاهز ✅ تم تفعيل الإشعارات وحفظ التوكن.",
        });
        clearMsgSoon();
      }
    } catch (e) {
      setMsg({
        tone: "danger",
        text: e?.message || "صار خطأ أثناء تفعيل الإشعارات.",
      });
    } finally {
      setBusy(false);
    }
  };

  const onTest = async () => {
    setBusy(true);
    setMsg(null);
    try {
      const token = await ensureTokenAndSave();
      if (!token) return;

      const { id } = await createTestNotificationRequest(token, {
        title: "🧪 Test Notification (Barber)",
        body: "إذا وصلتك، معناها الـ FCM pipeline شغّال ✅",
        data: { kind: "barber_test" },
      });

      setMsg({
        tone: "success",
        text: `تم إنشاء طلب تيست ✅ (id: ${id}). رح ينرسل مع GitHub Actions.`,
      });
      clearMsgSoon();
    } catch (e) {
      setMsg({
        tone: "danger",
        text: e?.message || "صار خطأ أثناء إنشاء طلب التيست.",
      });
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div className="flex items-center justify-between gap-3">
        <div>
          <div className="text-sm font-black text-slate-900">الإشعارات</div>
          <div className="text-xs text-slate-500">
            تفعيل + اختبار إرسال إشعار تجريبي (بدون حجز)
          </div>
        </div>
        {permPill}
      </div>

      {msg ? (
        <div
          className={`mt-3 rounded-xl border px-3 py-2 text-xs font-bold ${
            msg.tone === "success"
              ? "border-emerald-200 bg-emerald-50 text-emerald-800"
              : "border-rose-200 bg-rose-50 text-rose-800"
          }`}
        >
          {msg.text}
        </div>
      ) : null}

      <div className="mt-4 flex flex-col gap-2 sm:flex-row">
        <button
          type="button"
          disabled={busy}
          onClick={onEnable}
          className={`w-full sm:w-auto rounded-xl px-4 py-2 text-sm font-black border ${
            busy
              ? "bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed"
              : "bg-slate-900 text-white border-slate-900 hover:opacity-90"
          }`}
        >
          تفعيل الإشعارات / تحديث التوكن
        </button>

        <button
          type="button"
          disabled={busy}
          onClick={onTest}
          className={`w-full sm:w-auto rounded-xl px-4 py-2 text-sm font-black border ${
            busy
              ? "bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed"
              : "bg-white text-slate-900 border-slate-300 hover:bg-slate-50"
          }`}
        >
          🧪 Test Notification
        </button>
      </div>

      <div className="mt-3 text-[11px] text-slate-500 leading-5">
        ملاحظة: الإرسال الفعلي بيتم من GitHub Actions (Firebase Admin)، مش من
        المتصفح.
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/RecentBookingsCard.jsx">
// src/pages/barberPanel/components/RecentBookingsCard.jsx
import { e164ToLocalPretty } from "../../../utils/phone";

export default function RecentBookingsCard({ recentBookings }) {
  if (!recentBookings?.length) return null;

  return (
    <div className="max-w-3xl mx-auto mt-6 text-xs sm:text-sm">
      <div className="bg-white rounded-2xl shadow-md border border-slate-200 p-4 sm:p-5 text-slate-900">
        <div className="flex items-center justify-between gap-2 mb-3">
          <div className="flex items-center gap-2">
            <span className="text-lg">📅</span>
            <div className="flex flex-col">
              <h2 className="font-semibold text-slate-900">
                أحدث الحجوزات (رقم موحّد)
              </h2>
              <span className="text-[11px] text-slate-500">
                آخر {recentBookings.length} حجوزات فعّالة
              </span>
            </div>
          </div>
        </div>

        <div className="mt-2 border-t border-slate-100 divide-y divide-slate-100">
          {recentBookings.map((b, idx) => (
            <div
              key={b.id}
              className="py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 hover:bg-slate-50 rounded-xl px-2"
            >
              <div className="flex items-start gap-3">
                <div className="mt-1">
                  <span className="inline-flex items-center justify-center w-7 h-7 rounded-full bg-slate-100 text-[11px] text-slate-500">
                    {idx + 1}
                  </span>
                </div>

                <div className="flex flex-col">
                  <span className="font-semibold text-slate-900 text-sm sm:text-base">
                    {b.fullName || "بدون اسم"}
                  </span>

                  <div className="mt-1 inline-flex flex-wrap items-center gap-2 text-[11px]">
                    <span className="inline-flex items-center rounded-full bg-amber-50 px-3 py-0.5 border border-amber-200 text-amber-800">
                      {b.selectedDate || "—"}
                    </span>
                    <span className="inline-flex items-center rounded-full bg-sky-50 px-3 py-0.5 border border-sky-200 text-sky-700">
                      {b.selectedTime || "—"}
                    </span>
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-2 sm:justify-end sm:min-w-[150px] text-[11px] sm:text-xs">
                <span className="text-slate-500">الرقم الموحّد:</span>
                <span className="font-mono text-sm text-slate-900">
                  {e164ToLocalPretty(b.phoneNumber)}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/TimesGrid.jsx">
// src/pages/barberPanel/components/TimesGrid.jsx
export default function TimesGrid({
  times,
  selectedDate,
  bookings,
  blockedTimes,
  selectedTimes,
  onToggleTime,
}) {
  return (
    <div className="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-6">
      {times.map((time) => {
        const booked = bookings.some(
          (b) =>
            b.selectedDate === selectedDate &&
            b.selectedTime === time &&
            !b.cancelledAt
        );

        const isBlocked = blockedTimes.includes(time);
        const isSelected = selectedTimes.includes(time);

        return (
          <button
            key={time}
            onClick={() => onToggleTime(time)}
            disabled={booked}
            className={`py-2 rounded-xl text-sm font-medium text-center transition-all duration-200 ${
              booked
                ? "bg-red-700 text-white cursor-not-allowed"
                : isBlocked
                ? "bg-red-200 text-red-800"
                : isSelected
                ? "bg-yellow-300 text-gray-900 ring-2 ring-yellow-500"
                : "bg-green-100 text-green-800 hover:bg-green-200"
            }`}
            title={
              booked
                ? "هذه الساعة محجوزة"
                : isBlocked
                ? "هذه الساعة محظورة"
                : "اضغط للحظر/الإلغاء"
            }
          >
            {time}
          </button>
        );
      })}
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/WeeklyHoursEditor.jsx">
// src/pages/barberPanel/components/WeeklyHoursEditor.jsx
import { useEffect, useMemo, useRef, useState } from "react";
import { doc, setDoc } from "firebase/firestore";
import { db } from "../../../firebase";
import defaultWorkingHours from "../../../constants/workingHours";

const DAYS = [
  { key: "Sunday", ar: "الأحد" },
  { key: "Monday", ar: "الإثنين" },
  { key: "Tuesday", ar: "الثلاثاء" },
  { key: "Wednesday", ar: "الأربعاء" },
  { key: "Thursday", ar: "الخميس" },
  { key: "Friday", ar: "الجمعة" },
  { key: "Saturday", ar: "السبت" },
];

function isHHmm(v) {
  return typeof v === "string" && /^\d{2}:\d{2}$/.test(v);
}
function toMinutes(hhmm) {
  const [h, m] = hhmm.split(":").map((x) => parseInt(x, 10));
  return h * 60 + m;
}
function normalize(h) {
  const out = {};
  for (const d of DAYS) out[d.key] = h?.[d.key] ?? null;
  return out;
}
function formatRange(v) {
  if (!v) return "مغلق";
  if (!v.from || !v.to) return "—";
  return `${v.from} → ${v.to}`;
}
function validateWeekly(weekly) {
  const errors = {};
  for (const d of DAYS) {
    const v = weekly[d.key];
    if (v === null) continue;

    if (!isHHmm(v.from) || !isHHmm(v.to)) {
      errors[d.key] = "صيغة الوقت لازم تكون HH:mm";
      continue;
    }
    const a = toMinutes(v.from);
    const b = toMinutes(v.to);
    if (!(a < b)) {
      errors[d.key] = '"من" لازم تكون أصغر من "إلى"';
      continue;
    }
  }
  return errors;
}

function Button({ children, className = "", ...props }) {
  return (
    <button
      {...props}
      className={
        "px-3 py-2 rounded-xl text-sm font-extrabold transition disabled:opacity-60 disabled:cursor-not-allowed " +
        className
      }
    >
      {children}
    </button>
  );
}

function Pill({ children, tone = "neutral" }) {
  const map = {
    neutral: "bg-slate-100 text-slate-700 border-slate-200",
    success: "bg-emerald-50 text-emerald-700 border-emerald-200",
    danger: "bg-rose-50 text-rose-700 border-rose-200",
    info: "bg-sky-50 text-sky-700 border-sky-200",
    warn: "bg-amber-50 text-amber-800 border-amber-200",
  };
  return (
    <span
      className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-extrabold border ${map[tone]}`}
    >
      {children}
    </span>
  );
}

function SkeletonRow() {
  return (
    <div className="rounded-2xl border border-slate-200 bg-white overflow-hidden">
      <div className="p-4 flex items-center justify-between gap-4">
        <div className="space-y-2">
          <div className="h-4 w-28 bg-slate-200 rounded animate-pulse" />
          <div className="h-3 w-44 bg-slate-100 rounded animate-pulse" />
        </div>
        <div className="h-8 w-20 bg-slate-100 rounded-xl animate-pulse" />
      </div>
    </div>
  );
}

export default function WeeklyHoursEditor({
  weeklyHours,
  loadingWeekly,
  isArabic = true,
  onStateChange,
}) {
  const [draft, setDraft] = useState(() => normalize(weeklyHours));
  const [saving, setSaving] = useState(false);
  const [msg, setMsg] = useState("");
  const [expandedDay, setExpandedDay] = useState(null);

  // لالتقاط آخر حفظ (لـ StatusCard في الصفحة لو بدك)
  const [lastSavedAt, setLastSavedAt] = useState(null);

  // snapshot مرجعي لقياس التغييرات
  const baseRef = useRef(normalize(weeklyHours));

  useEffect(() => {
    const next = normalize(weeklyHours);
    setDraft(next);
    baseRef.current = next;
    setLastSavedAt(null);
  }, [weeklyHours]);

  const hasChanges = useMemo(() => {
    return JSON.stringify(baseRef.current) !== JSON.stringify(normalize(draft));
  }, [draft]);

  const errors = useMemo(() => validateWeekly(normalize(draft)), [draft]);
  const hasErrors = useMemo(() => Object.keys(errors).length > 0, [errors]);

  const openDaysCount = useMemo(() => {
    return DAYS.reduce((acc, d) => acc + (draft?.[d.key] ? 1 : 0), 0);
  }, [draft]);

  // ابلغ الصفحة بحالة المحرر (StatusCard)
  useEffect(() => {
    onStateChange?.({
      hasChanges,
      hasErrors,
      lastSavedAt,
    });
  }, [hasChanges, hasErrors, lastSavedAt, onStateChange]);

  // تأكيد عند الخروج لو في تغييرات
  useEffect(() => {
    const handler = (e) => {
      if (!hasChanges) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", handler);
    return () => window.removeEventListener("beforeunload", handler);
  }, [hasChanges]);

  const toast = (text, timeout = 2200) => {
    setMsg(text);
    window.clearTimeout(toast._t);
    toast._t = window.setTimeout(() => setMsg(""), timeout);
  };

  const toggleExpanded = (dayKey) => {
    setExpandedDay((cur) => (cur === dayKey ? null : dayKey));
  };

  const setDayClosed = (dayKey, closed) => {
    setDraft((p) => ({
      ...p,
      [dayKey]: closed ? null : { from: "12:00", to: "20:00" },
    }));
  };

  const setDayField = (dayKey, field, value) => {
    setDraft((p) => {
      const cur = p[dayKey];
      if (cur === null) return p;
      return { ...p, [dayKey]: { ...cur, [field]: value } };
    });
  };

  const applyDayToAllOpen = (sourceDayKey) => {
    const src = draft?.[sourceDayKey];
    if (!src || src === null) return;

    setDraft((p) => {
      const next = { ...p };
      for (const d of DAYS) {
        if (next[d.key] !== null) next[d.key] = { from: src.from, to: src.to };
      }
      return next;
    });

    toast(
      isArabic
        ? "✅ تم تطبيق ساعات اليوم على كل الأيام المفتوحة"
        : "✅ Applied to all open days",
    );
  };

  const applyTemplate6Days = () => {
    setDraft((p) => {
      const next = { ...p };
      for (const d of DAYS) {
        if (d.key === "Saturday") next[d.key] = null;
        else next[d.key] = next[d.key] ?? { from: "12:00", to: "20:00" };
      }
      return next;
    });
    toast(isArabic ? "✅ تم تطبيق قالب 6 أيام" : "✅ Applied 6-day template");
  };

  const openAll = () => {
    setDraft((p) => {
      const next = { ...p };
      for (const d of DAYS)
        next[d.key] = next[d.key] ?? { from: "12:00", to: "20:00" };
      return next;
    });
    toast(isArabic ? "✅ تم فتح كل الأيام" : "✅ Opened all days");
  };

  const closeSaturday = () => {
    setDraft((p) => ({ ...p, Saturday: null }));
    toast(isArabic ? "✅ تم إغلاق السبت" : "✅ Closed Saturday");
  };

  const save = async () => {
    if (hasErrors) {
      toast(
        isArabic
          ? "⚠️ في أخطاء بالساعات. أصلحها قبل الحفظ."
          : "⚠️ Fix errors before saving.",
        2600,
      );
      return;
    }
    if (!hasChanges) return;

    try {
      setSaving(true);
      setMsg("");

      await setDoc(
        doc(db, "barberSettings", "hours"),
        { weekly: normalize(draft) },
        { merge: true },
      );

      baseRef.current = normalize(draft);
      setLastSavedAt(new Date().toLocaleTimeString());
      toast(
        isArabic ? "✅ تم حفظ ساعات الأسبوع" : "✅ Saved weekly hours",
        2200,
      );
    } catch (e) {
      console.error("save weekly hours error:", e);
      toast(
        isArabic
          ? "❌ صار خطأ بالحفظ. جرّب مرة ثانية."
          : "❌ Save failed. Try again.",
        2600,
      );
    } finally {
      setSaving(false);
    }
  };

  const resetToDefault = async () => {
    const ok = window.confirm(
      isArabic
        ? "راح نرجّع ساعات الأسبوع للوضع الافتراضي. متأكد؟"
        : "Reset weekly hours to default. Are you sure?",
    );
    if (!ok) return;

    try {
      setSaving(true);
      setMsg("");

      await setDoc(
        doc(db, "barberSettings", "hours"),
        { weekly: defaultWorkingHours },
        { merge: true },
      );

      // نحدّث الدرفت فوراً لUX سريع (والـ hook رح يزامن لاحقاً)
      setDraft(normalize(defaultWorkingHours));
      baseRef.current = normalize(defaultWorkingHours);
      setLastSavedAt(new Date().toLocaleTimeString());

      toast(
        isArabic
          ? "✅ تم إرجاع ساعات الأسبوع للوضع الافتراضي"
          : "✅ Reset to default",
        2400,
      );
    } catch (e) {
      console.error("reset weekly hours error:", e);
      toast(
        isArabic
          ? "❌ صار خطأ. جرّب مرة ثانية."
          : "❌ Reset failed. Try again.",
        2600,
      );
    } finally {
      setSaving(false);
    }
  };

  // ✅ Sticky Save Bar (نفس vibe الحجوزات)
  const StickyBar = (
    <div className="sticky bottom-4 z-10">
      <div className="rounded-2xl border border-slate-200 bg-white shadow-xl p-3 sm:p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div className="flex flex-wrap items-center gap-2">
          <Pill tone="info">
            {isArabic
              ? `أيام مفتوحة: ${openDaysCount}/7`
              : `Open days: ${openDaysCount}/7`}
          </Pill>

          {loadingWeekly ? (
            <Pill tone="neutral">{isArabic ? "تحميل..." : "Loading..."}</Pill>
          ) : null}

          {hasErrors ? (
            <Pill tone="danger">{isArabic ? "يوجد أخطاء" : "Errors"}</Pill>
          ) : hasChanges ? (
            <Pill tone="warn">
              {isArabic ? "تغييرات غير محفوظة" : "Unsaved changes"}
            </Pill>
          ) : (
            <Pill tone="success">{isArabic ? "محفوظ" : "Saved"}</Pill>
          )}

          <span className="text-xs text-slate-500 font-bold">
            {isArabic
              ? "هذه الساعات تظهر للزبائن في صفحة الحجز."
              : "These hours affect what customers can book."}
          </span>
        </div>

        <div className="flex items-center gap-2 justify-end">
          <Button
            type="button"
            disabled={saving || loadingWeekly}
            onClick={resetToDefault}
            className="bg-white hover:bg-slate-100 border border-slate-200 text-slate-900"
          >
            {isArabic ? "رجّع الافتراضي" : "Reset"}
          </Button>

          <Button
            type="button"
            disabled={saving || loadingWeekly || !hasChanges || hasErrors}
            onClick={save}
            className="bg-emerald-500 hover:bg-emerald-600 text-white"
          >
            {saving
              ? isArabic
                ? "جاري الحفظ..."
                : "Saving..."
              : isArabic
                ? "حفظ"
                : "Save"}
          </Button>
        </div>
      </div>
    </div>
  );

  return (
    <div className="px-4 sm:px-6 lg:px-8 pb-10">
      {/* Card Header + Quick Actions */}
      <div className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden mt-6">
        <div className="p-4 sm:p-5 border-b border-slate-100 bg-slate-50">
          <div className="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
            <div>
              <h2 className="text-base sm:text-lg font-black text-slate-900">
                🗓️ {isArabic ? "ساعات الأسبوع" : "Weekly hours"}
              </h2>
              <p className="text-xs text-slate-600 mt-1 leading-5">
                {isArabic
                  ? "اضغط على اليوم لتفتح التعديل. تأكد أن 'من' أصغر من 'إلى'."
                  : "Tap a day to edit. Make sure “from” is earlier than “to”."}
              </p>
            </div>

            {/* Quick Actions */}
            <div className="flex flex-wrap gap-2">
              <Button
                type="button"
                disabled={saving}
                onClick={applyTemplate6Days}
                className="bg-white hover:bg-slate-100 border border-slate-200 text-slate-900"
              >
                {isArabic ? "قالب 6 أيام" : "6-day template"}
              </Button>
              <Button
                type="button"
                disabled={saving}
                onClick={closeSaturday}
                className="bg-white hover:bg-slate-100 border border-slate-200 text-slate-900"
              >
                {isArabic ? "إغلاق السبت" : "Close Saturday"}
              </Button>
              <Button
                type="button"
                disabled={saving}
                onClick={openAll}
                className="bg-white hover:bg-slate-100 border border-slate-200 text-slate-900"
              >
                {isArabic ? "فتح الكل" : "Open all"}
              </Button>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-4 sm:p-5">
          {loadingWeekly ? (
            <div className="space-y-3">
              <SkeletonRow />
              <SkeletonRow />
              <SkeletonRow />
              <SkeletonRow />
              <SkeletonRow />
            </div>
          ) : (
            <div className="space-y-2">
              {DAYS.map((d) => {
                const v = draft[d.key];
                const closed = v === null;
                const err = errors[d.key];
                const expanded = expandedDay === d.key;

                return (
                  <div
                    key={d.key}
                    className={`rounded-2xl border bg-white overflow-hidden ${
                      err ? "border-rose-300" : "border-slate-200"
                    }`}
                  >
                    <button
                      type="button"
                      onClick={() => toggleExpanded(d.key)}
                      className="w-full text-right p-3 sm:p-4 flex items-center justify-between gap-3 hover:bg-slate-50"
                    >
                      <div className="flex flex-col items-start">
                        <div className="font-black text-slate-900">{d.ar}</div>
                        <div className="text-xs text-slate-600 mt-1">
                          {closed ? (
                            <span className="inline-flex items-center gap-2">
                              <span className="w-2 h-2 rounded-full bg-rose-400" />
                              {isArabic ? "مغلق" : "Closed"}
                            </span>
                          ) : (
                            <span className="inline-flex items-center gap-2">
                              <span className="w-2 h-2 rounded-full bg-emerald-400" />
                              {formatRange(v)}
                            </span>
                          )}
                        </div>
                        {err ? (
                          <div className="mt-1 text-xs font-bold text-rose-700">
                            {err}
                          </div>
                        ) : null}
                      </div>

                      <div className="flex items-center gap-2">
                        {closed ? (
                          <Pill tone="danger">
                            {isArabic ? "مغلق" : "Closed"}
                          </Pill>
                        ) : (
                          <Pill tone="success">
                            {isArabic ? "مفتوح" : "Open"}
                          </Pill>
                        )}
                        <span className="text-slate-400 font-black">
                          {expanded ? "▲" : "▼"}
                        </span>
                      </div>
                    </button>

                    {expanded && (
                      <div className="px-3 sm:px-4 pb-4">
                        <div className="pt-2 flex items-center justify-between gap-3">
                          <label className="inline-flex items-center gap-2 text-xs font-extrabold text-slate-700">
                            <input
                              type="checkbox"
                              checked={!closed}
                              onChange={(e) =>
                                setDayClosed(d.key, !e.target.checked)
                              }
                            />
                            {isArabic ? "مفتوح" : "Open"}
                          </label>

                          <Button
                            type="button"
                            disabled={closed}
                            onClick={() => applyDayToAllOpen(d.key)}
                            className={`border ${
                              closed
                                ? "bg-slate-100 text-slate-400 border-slate-200"
                                : "bg-white hover:bg-slate-50 text-slate-900 border-slate-200"
                            }`}
                          >
                            {isArabic
                              ? "تطبيق للأيام المفتوحة"
                              : "Apply to open days"}
                          </Button>
                        </div>

                        <div className="mt-3 grid grid-cols-2 gap-2">
                          <div className="flex flex-col gap-1">
                            <span className="text-xs font-bold text-slate-600">
                              {isArabic ? "من" : "From"}
                            </span>
                            <input
                              type="time"
                              step="1800"
                              disabled={closed}
                              value={closed ? "" : v.from}
                              onChange={(e) =>
                                setDayField(d.key, "from", e.target.value)
                              }
                              className={`px-3 py-2 rounded-xl border text-sm font-extrabold ${
                                closed
                                  ? "bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed"
                                  : err
                                    ? "bg-white border-rose-300 text-slate-900"
                                    : "bg-white border-slate-200 text-slate-900"
                              }`}
                            />
                          </div>

                          <div className="flex flex-col gap-1">
                            <span className="text-xs font-bold text-slate-600">
                              {isArabic ? "إلى" : "To"}
                            </span>
                            <input
                              type="time"
                              step="1800"
                              disabled={closed}
                              value={closed ? "" : v.to}
                              onChange={(e) =>
                                setDayField(d.key, "to", e.target.value)
                              }
                              className={`px-3 py-2 rounded-xl border text-sm font-extrabold ${
                                closed
                                  ? "bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed"
                                  : err
                                    ? "bg-white border-rose-300 text-slate-900"
                                    : "bg-white border-slate-200 text-slate-900"
                              }`}
                            />
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}

          {msg && (
            <div className="mt-4 text-sm font-extrabold text-slate-900 bg-amber-50 border border-amber-200 rounded-2xl p-3">
              {msg}
            </div>
          )}
        </div>
      </div>

      {/* Sticky Save Bar */}
      {StickyBar}
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/hooks/useBlockedDay.js">
// src/pages/barberPanel/hooks/useBlockedDay.js
import { useEffect, useState } from "react";
import {
  collection,
  deleteDoc,
  doc,
  getDoc,
  getDocs,
  query,
  setDoc,
  where,
} from "firebase/firestore";
import { db } from "../../../firebase";

export default function useBlockedDay(selectedDate) {
  const [isDayBlocked, setIsDayBlocked] = useState(false);
  const [loadingBlock, setLoadingBlock] = useState(false);

  useEffect(() => {
    if (!selectedDate) {
      setIsDayBlocked(false);
      return;
    }

    let alive = true;
    (async () => {
      try {
        const ref = doc(db, "blockedDays", selectedDate);
        const snap = await getDoc(ref);
        if (!alive) return;
        setIsDayBlocked(snap.exists());
      } catch {
        if (!alive) return;
        setIsDayBlocked(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, [selectedDate]);

  const toggleDay = async () => {
    if (!selectedDate) return;
    setLoadingBlock(true);

    const ref = doc(db, "blockedDays", selectedDate);

    try {
      if (isDayBlocked) {
        await deleteDoc(ref);
        setIsDayBlocked(false);
        return;
      }

      // قبل ما نغلق اليوم: تأكد ما في حجوزات فعالة
      const bookingsSnap = await getDocs(
        query(
          collection(db, "bookings"),
          where("selectedDate", "==", selectedDate)
        )
      );

      const activeBookings = bookingsSnap.docs.filter(
        (d) => !d.data().cancelledAt
      );
      if (activeBookings.length > 0) {
        alert("⚠️ لا يمكن تعطيل هذا اليوم لأن هناك حجوزات لم يتم إلغاؤها.");
        return;
      }

      await setDoc(ref, {});
      setIsDayBlocked(true);
    } catch (e) {
      console.error("toggleDay error:", e);
    } finally {
      setLoadingBlock(false);
    }
  };

  return { isDayBlocked, loadingBlock, toggleDay, setIsDayBlocked };
}
</file>

<file path="src/pages/barberPanel/hooks/useBlockedTimes.js">
// src/pages/barberPanel/hooks/useBlockedTimes.js
import { useEffect, useState } from "react";
import {
  arrayRemove,
  arrayUnion,
  doc,
  getDoc,
  setDoc,
  updateDoc,
} from "firebase/firestore";
import { db } from "../../../firebase";

export default function useBlockedTimes({
  selectedDate,
  bookings,
  setStatusMessage,
}) {
  const [blockedTimes, setBlockedTimes] = useState([]);
  const [selectedTimes, setSelectedTimes] = useState([]);

  useEffect(() => {
    if (!selectedDate) {
      setBlockedTimes([]);
      setSelectedTimes([]);
      return;
    }

    let alive = true;

    (async () => {
      try {
        const ref = doc(db, "blockedTimes", selectedDate);
        const snap = await getDoc(ref);
        if (!alive) return;

        setBlockedTimes(snap.exists() ? snap.data()?.times || [] : []);
        setSelectedTimes([]);
      } catch (err) {
        console.error("fetch blockedTimes error:", err);
        if (!alive) return;
        setBlockedTimes([]);
        setSelectedTimes([]);
      }
    })();

    return () => {
      alive = false;
    };
  }, [selectedDate]);

  const isBooked = (time) =>
    bookings.some(
      (b) =>
        b.selectedDate === selectedDate &&
        b.selectedTime === time &&
        !b.cancelledAt
    );

  const handleToggleTime = async (time) => {
    if (!selectedDate) return;

    if (isBooked(time)) {
      setStatusMessage?.("هذه الساعة محجوزة ولا يمكن تعديلها.");
      return;
    }

    // استرجاع محظور
    if (blockedTimes.includes(time)) {
      const updated = blockedTimes.filter((t) => t !== time);
      setBlockedTimes(updated);

      try {
        const ref = doc(db, "blockedTimes", selectedDate);
        await updateDoc(ref, { times: arrayRemove(time) });
        setStatusMessage?.("✅ تم استرجاع الساعة بنجاح");
      } catch (err) {
        console.error("restore blocked time error:", err);
        setStatusMessage?.("حدث خطأ، حاول مرة أخرى.");
      }

      setTimeout(() => setStatusMessage?.(""), 2500);
      return;
    }

    // اختيار للحظر
    setSelectedTimes((prev) =>
      prev.includes(time) ? prev.filter((t) => t !== time) : [...prev, time]
    );
    setStatusMessage?.("");
  };

  const handleApplyBlock = async () => {
    if (!selectedDate || selectedTimes.length === 0) {
      setStatusMessage?.("اختر ساعة واحدة على الأقل للحظر.");
      return;
    }

    for (const time of selectedTimes) {
      if (isBooked(time)) {
        setStatusMessage?.(`الساعة ${time} محجوزة.`);
        return;
      }
    }

    try {
      const ref = doc(db, "blockedTimes", selectedDate);
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { times: [] });

      for (const time of selectedTimes) {
        await updateDoc(ref, { times: arrayUnion(time) });
      }

      setBlockedTimes((prev) => [...prev, ...selectedTimes]);
      setSelectedTimes([]);
      setStatusMessage?.("✅ تم حظر الأوقات بنجاح");
    } catch (err) {
      console.error("apply block error:", err);
      setStatusMessage?.("حدث خطأ، حاول مرة أخرى.");
    }

    setTimeout(() => setStatusMessage?.(""), 2500);
  };

  return {
    blockedTimes,
    selectedTimes,
    setSelectedTimes,
    handleToggleTime,
    handleApplyBlock,
  };
}
</file>

<file path="src/pages/barberPanel/hooks/useBookingsLive.js">
// src/pages/barberPanel/hooks/useBookingsLive.js
import { useEffect, useMemo, useState } from "react";
import { collection, onSnapshot, query } from "firebase/firestore";
import { db } from "../../../firebase";

export default function useBookingsLive() {
  const [bookings, setBookings] = useState([]);

  useEffect(() => {
    const q = query(collection(db, "bookings"));
    const unsub = onSnapshot(
      q,
      (snap) => setBookings(snap.docs.map((d) => ({ id: d.id, ...d.data() }))),
      (err) => console.error("Bookings onSnapshot error:", err)
    );
    return () => unsub();
  }, []);

  const activeBookings = useMemo(
    () => bookings.filter((b) => !b.cancelledAt),
    [bookings]
  );

  const recentBookings = useMemo(() => {
    const getBookingCreationDate = (b) => {
      if (b.createdAt && typeof b.createdAt.toDate === "function")
        return b.createdAt.toDate();
      if (b.createdAt instanceof Date) return b.createdAt;
      try {
        if (b.selectedDate && b.selectedTime)
          return new Date(`${b.selectedDate}T${b.selectedTime}:00`);
      } catch {
        /* empty */
      }
      return new Date(0);
    };

    return [...activeBookings]
      .sort((a, b) => getBookingCreationDate(a) - getBookingCreationDate(b))
      .slice(-5)
      .reverse();
  }, [activeBookings]);

  return { bookings, activeBookings, recentBookings };
}
</file>

<file path="src/pages/barberPanel/hooks/useLimitOnePerDaySetting.js">
// src/pages/barberPanel/hooks/useLimitOnePerDaySetting.js
import { useEffect, useState } from "react";
import { doc, getDoc, setDoc } from "firebase/firestore";
import { db } from "../../../firebase";

export default function useLimitOnePerDaySetting() {
  const [limitOnePerDay, setLimitOnePerDay] = useState(false);
  const [loadingSettings, setLoadingSettings] = useState(true);
  const [savingSettings, setSavingSettings] = useState(false);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        const ref = doc(db, "barberSettings", "global");
        const snap = await getDoc(ref);

        if (!alive) return;

        if (snap.exists()) {
          const data = snap.data();
          const value =
            typeof data.limitOneBookingPerDayPerPhone === "boolean"
              ? data.limitOneBookingPerDayPerPhone
              : !!data.limitOneBookingPerDay;
          setLimitOnePerDay(value);
        } else {
          setLimitOnePerDay(false);
        }
      } catch (err) {
        console.error("fetch barberSettings error:", err);
        if (!alive) return;
        setLimitOnePerDay(false);
      } finally {
        if (alive) setLoadingSettings(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, []);

  const toggleLimitOnePerDay = async () => {
    if (loadingSettings || savingSettings) return;

    try {
      setSavingSettings(true);
      const ref = doc(db, "barberSettings", "global");
      await setDoc(
        ref,
        { limitOneBookingPerDayPerPhone: !limitOnePerDay },
        { merge: true }
      );
      setLimitOnePerDay((p) => !p);
    } catch (err) {
      console.error("update barberSettings error:", err);
      alert("حدث خطأ أثناء تحديث الإعداد. حاول مرة أخرى.");
    } finally {
      setSavingSettings(false);
    }
  };

  return {
    limitOnePerDay,
    loadingSettings,
    savingSettings,
    toggleLimitOnePerDay,
  };
}
</file>

<file path="src/pages/barberPanel/hooks/useSlotExtrasLive.js">
// src/pages/barberPanel/hooks/useSlotExtrasLive.js
import { useEffect, useState } from "react";
import { doc, onSnapshot, setDoc, getDoc } from "firebase/firestore";
import { db } from "../../../firebase";
import {
  safeInt,
  generateSlots30Min,
  applyExtraSlots,
} from "../../../utils/slots";
import { getWeekdayNameEN } from "../utils/dates";
import { buildTargets } from "../utils/targets";

export default function useSlotExtrasLive({
  selectedDate,
  workingHours,
  activeBookings,
}) {
  const [extraSlots, setExtraSlots] = useState(0);
  const [loadingExtras, setLoadingExtras] = useState(false);
  const [savingExtras, setSavingExtras] = useState(false);

  useEffect(() => {
    if (!selectedDate) {
      setExtraSlots(0);
      setLoadingExtras(false);
      return;
    }

    setLoadingExtras(true);

    const ref = doc(db, "slotExtras", selectedDate);
    const unsub = onSnapshot(
      ref,
      (snap) => {
        setExtraSlots(snap.exists() ? safeInt(snap.data()?.extraSlots, 0) : 0);
        setLoadingExtras(false);
      },
      (err) => {
        console.error("slotExtras onSnapshot error:", err);
        setExtraSlots(0);
        setLoadingExtras(false);
      }
    );

    return () => unsub();
  }, [selectedDate]);

  const applyExtraSlotsChange = async ({
    nextValue,
    applyMode,
    applyUntil,
    setStatusMessage,
    selectedDate,
  }) => {
    if (!selectedDate) return;

    const value = safeInt(nextValue, 0);
    if (value < -10 || value > 10) {
      alert("⚠️ مسموح من -10 إلى +10 فقط (كل رقم = 30 دقيقة).");
      return;
    }

    const targets = buildTargets({ applyMode, selectedDate, applyUntil });
    if (!targets) {
      alert("⚠️ اختَر تاريخ نهاية صحيح (لازم يكون بعد/يساوي تاريخ البداية).");
      return;
    }

    // منع تقليل أدوار إذا رح ينحذف دور عليه حجز
    if (value < 0) {
      for (const ymd of targets) {
        const weekday = getWeekdayNameEN(ymd);
        const hours = workingHours?.[weekday] || null;
        if (!hours?.from || !hours?.to) continue;

        const base = generateSlots30Min(hours.from, hours.to);

        const currentExtraSnap = await getDoc(doc(db, "slotExtras", ymd));
        const currentExtra = currentExtraSnap.exists()
          ? safeInt(currentExtraSnap.data()?.extraSlots, 0)
          : 0;

        const currentSlots = applyExtraSlots(base, currentExtra);
        const nextSlots = applyExtraSlots(base, value);

        const removed = currentSlots.filter((s) => !nextSlots.includes(s));
        if (removed.length) {
          const hasBookingOnRemoved = activeBookings.some(
            (b) => b.selectedDate === ymd && removed.includes(b.selectedTime)
          );
          if (hasBookingOnRemoved) {
            alert(
              `⚠️ لا يمكن تقليل الأدوار في ${ymd} لأن هناك حجز على دور سيتم حذفه.\n(حلّها: الغِ الحجز أو غيّر التعديل)`
            );
            return;
          }
        }
      }
    }

    try {
      setSavingExtras(true);
      await Promise.all(
        targets.map((ymd) =>
          setDoc(
            doc(db, "slotExtras", ymd),
            { extraSlots: value },
            { merge: true }
          )
        )
      );

      // ملاحظة: extraSlots رح يتحدث لحاله من onSnapshot
      const weekdayOfSelected = getWeekdayNameEN(selectedDate);

      setStatusMessage?.(
        applyMode === "THIS_DATE"
          ? `✅ تم تطبيق التعديل على ${selectedDate}`
          : applyMode === "SAME_WEEKDAY_UNTIL"
          ? `✅ تم تطبيق التعديل على كل ${weekdayOfSelected} حتى ${applyUntil}`
          : `✅ تم تطبيق التعديل على كل الأيام حتى ${applyUntil}`
      );
    } catch (e) {
      console.error("save slotExtras error:", e);
      alert("حدث خطأ أثناء حفظ التعديل. حاول مرة أخرى.");
    } finally {
      setSavingExtras(false);
      setTimeout(() => setStatusMessage?.(""), 2500);
    }
  };

  return {
    extraSlots,
    loadingExtras,
    savingExtras,
    applyExtraSlotsChange,
  };
}
</file>

<file path="src/pages/barberPanel/RecentBookingsCard.jsx">

</file>

<file path="src/pages/barberPanel/ReviewsManagerPage.jsx">
// src/pages/barberPanel/ReviewsManagerPage.jsx
import { useEffect, useMemo, useRef, useState } from "react";
import { db } from "../../firebase";
import {
  collection,
  deleteDoc,
  doc,
  getDoc,
  getDocs,
  limit,
  orderBy,
  query,
  runTransaction,
  serverTimestamp,
  setDoc,
  startAfter,
} from "firebase/firestore";

const BARBER_ID = "arfat";
const ARCHIVE_KEEP_DAYS = 14; // ✅ مدة بقاء التقييم بعد "حذفه" (مثل الأدوار الملغاة)
const UNDO_MS = 7000; // ✅ مدة التراجع بعد الحذف المؤقت

function addDaysTimestamp(days) {
  const d = new Date();
  d.setDate(d.getDate() + days);
  return d;
}

function starsLabel(n) {
  const v = Math.max(0, Math.min(5, Number(n || 0)));
  return "★".repeat(v) + "☆".repeat(5 - v);
}

function safeLower(v) {
  return (v || "").toString().toLowerCase();
}

function prettyName(name) {
  const s = String(name || "").trim();
  if (!s) return "زبون";
  const parts = s.split(/\s+/).filter(Boolean);
  if (parts.length <= 1) return parts[0];
  const first = parts[0];
  const lastInitial = parts[parts.length - 1][0] || "";
  return `${first} ${lastInitial}.`;
}

export default function ReviewsManagerPage() {
  const [tab, setTab] = useState("reviews"); // reviews | blocked | archived

  // Reviews (active)
  const [reviews, setReviews] = useState([]);
  const [loadingReviews, setLoadingReviews] = useState(false);
  const [lastDoc, setLastDoc] = useState(null);
  const [hasMore, setHasMore] = useState(true);

  // Archived
  const [archived, setArchived] = useState([]);
  const [loadingArchived, setLoadingArchived] = useState(false);

  // Search/filter/sort
  const [qText, setQText] = useState("");
  const [stars, setStars] = useState("all");
  const [sortBy, setSortBy] = useState("newest"); // newest | highest | lowest

  // Blocked
  const [blocked, setBlocked] = useState([]);
  const [loadingBlocked, setLoadingBlocked] = useState(false);

  // Summary (stats)
  const [summary, setSummary] = useState({
    count: 0,
    sum: 0,
    byStar: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
    tagCounts: {},
  });
  const [loadingSummary, setLoadingSummary] = useState(false);

  // Undo toast for archive
  const [undo, setUndo] = useState(null); // { id, name }
  const undoTimerRef = useRef(null);

  const reviewsCol = collection(db, "barbers", BARBER_ID, "reviews");
  const summaryRef = doc(db, "barbers", BARBER_ID, "meta", "reviewsSummary");

  const count = Number(summary.count || 0);
  const avg = count > 0 ? summary.sum / count : 0;

  const fetchSummary = async () => {
    if (loadingSummary) return;
    setLoadingSummary(true);
    try {
      const ss = await getDoc(summaryRef);
      if (ss.exists()) setSummary((p) => ({ ...p, ...ss.data() }));
    } catch (e) {
      console.error("fetchSummary error:", e);
    } finally {
      setLoadingSummary(false);
    }
  };

  // ===== Fetch ACTIVE Reviews =====
  const fetchReviews = async ({ reset = false } = {}) => {
    if (loadingReviews) return;
    setLoadingReviews(true);

    try {
      let qBase = query(reviewsCol, orderBy("createdAt", "desc"), limit(50));

      if (!reset && lastDoc) {
        qBase = query(
          reviewsCol,
          orderBy("createdAt", "desc"),
          startAfter(lastDoc),
          limit(50),
        );
      }

      const snap = await getDocs(qBase);
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

      // ✅ فقط active
      const onlyActive = docs.filter(
        (r) => (r.status || "active") === "active",
      );

      if (reset) setReviews(onlyActive);
      else setReviews((p) => [...p, ...onlyActive]);

      setLastDoc(snap.docs[snap.docs.length - 1] || null);
      setHasMore(snap.docs.length === 50);
    } catch (e) {
      console.error("fetchReviews error:", e);
    } finally {
      setLoadingReviews(false);
    }
  };

  // ===== Fetch Blocked (barber-scoped) =====
  const fetchBlocked = async () => {
    if (loadingBlocked) return;
    setLoadingBlocked(true);
    try {
      const ref = collection(db, "barbers", BARBER_ID, "blockedPhones");
      const snap = await getDocs(ref);
      setBlocked(snap.docs.map((d) => ({ id: d.id, ...d.data() })));
    } finally {
      setLoadingBlocked(false);
    }
  };

  // ===== Fetch ARCHIVED Reviews (Prototype بدون Index) =====
  const fetchArchived = async () => {
    if (loadingArchived) return;
    setLoadingArchived(true);
    try {
      const qAll = query(reviewsCol, orderBy("createdAt", "desc"), limit(200));
      const snap = await getDocs(qAll);
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));

      const onlyArchived = docs.filter((r) => r.status === "archived");
      setArchived(onlyArchived);
    } catch (e) {
      console.error("fetchArchived error:", e);
    } finally {
      setLoadingArchived(false);
    }
  };

  useEffect(() => {
    fetchReviews({ reset: true });
    fetchBlocked();
    fetchArchived();
    fetchSummary();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ===== Block/Unblock (barber + global) =====
  const blockPhoneEverywhere = async (phoneKey, reviewId) => {
    if (!phoneKey) return;

    await setDoc(
      doc(db, "barbers", BARBER_ID, "blockedPhones", String(phoneKey)),
      {
        phoneKey: String(phoneKey),
        from: "reviews",
        fromBarberId: BARBER_ID,
        reviewId: reviewId || null,
        blockedAt: serverTimestamp(),
      },
    );

    await setDoc(doc(db, "blockedPhones", String(phoneKey)), {
      phoneKey: String(phoneKey),
      from: "reviews",
      fromBarberId: BARBER_ID,
      reviewId: reviewId || null,
      blockedAt: serverTimestamp(),
    });

    await fetchBlocked();
  };

  const unblockPhoneEverywhere = async (phoneKey) => {
    if (!phoneKey) return;

    await deleteDoc(
      doc(db, "barbers", BARBER_ID, "blockedPhones", String(phoneKey)),
    );
    await deleteDoc(doc(db, "blockedPhones", String(phoneKey)));

    await fetchBlocked();
  };

  // ===== Summary helpers =====
  function safeSummary(data) {
    return (
      data || {
        count: 0,
        sum: 0,
        byStar: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
        tagCounts: {},
      }
    );
  }

  function decSummary(cur, rating, tags = []) {
    const r = Number(rating || 0);
    const next = {
      ...cur,
      count: Math.max(0, Number(cur.count || 0) - 1),
      sum: Math.max(0, Number(cur.sum || 0) - r),
      byStar: { ...(cur.byStar || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }) },
      tagCounts: { ...(cur.tagCounts || {}) },
    };

    if (r >= 1 && r <= 5)
      next.byStar[r] = Math.max(0, Number(next.byStar[r] || 0) - 1);

    (Array.isArray(tags) ? tags : []).forEach((k) => {
      next.tagCounts[k] = Math.max(0, Number(next.tagCounts[k] || 0) - 1);
      if (next.tagCounts[k] === 0) delete next.tagCounts[k];
    });

    return next;
  }

  function incSummary(cur, rating, tags = []) {
    const r = Number(rating || 0);
    const next = {
      ...cur,
      count: Number(cur.count || 0) + 1,
      sum: Number(cur.sum || 0) + r,
      byStar: { ...(cur.byStar || { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }) },
      tagCounts: { ...(cur.tagCounts || {}) },
    };

    if (r >= 1 && r <= 5) next.byStar[r] = Number(next.byStar[r] || 0) + 1;

    (Array.isArray(tags) ? tags : []).forEach((k) => {
      next.tagCounts[k] = Number(next.tagCounts[k] || 0) + 1;
    });

    return next;
  }

  // ===== Archive Review (instead of delete) + UNDO =====
  const archiveReview = async (reviewId) => {
    if (!reviewId) return;

    // اسم للـUndo (لو موجود)
    const rLocal = reviews.find((x) => x.id === reviewId);
    const nameForUndo = prettyName(
      rLocal?.customerName || rLocal?.userName || rLocal?.displayName,
    );

    await runTransaction(db, async (tx) => {
      const reviewRef = doc(db, "barbers", BARBER_ID, "reviews", reviewId);

      const [rSnap, sSnap] = await Promise.all([
        tx.get(reviewRef),
        tx.get(summaryRef),
      ]);
      if (!rSnap.exists()) return;

      const r = rSnap.data();
      if (r.status === "archived") return;

      const cur = safeSummary(sSnap.exists() ? sSnap.data() : null);
      const rating = r.rating ?? r.stars ?? 0;
      const tags = r.tags || [];

      const next = decSummary(cur, rating, tags);

      tx.set(
        reviewRef,
        {
          status: "archived",
          archivedAt: serverTimestamp(),
          purgeAt: addDaysTimestamp(ARCHIVE_KEEP_DAYS),
        },
        { merge: true },
      );

      tx.set(
        summaryRef,
        {
          ...next,
          updatedAt: serverTimestamp(),
        },
        { merge: true },
      );
    });

    // UI update
    setReviews((p) => p.filter((x) => x.id !== reviewId));
    await fetchArchived();
    await fetchSummary();

    // UNDO toast
    setUndo({ id: reviewId, name: nameForUndo });
    if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
    undoTimerRef.current = setTimeout(() => {
      setUndo(null);
      undoTimerRef.current = null;
    }, UNDO_MS);
  };

  // ===== Restore Review =====
  const restoreReview = async (reviewId) => {
    if (!reviewId) return;

    await runTransaction(db, async (tx) => {
      const reviewRef = doc(db, "barbers", BARBER_ID, "reviews", reviewId);

      const [rSnap, sSnap] = await Promise.all([
        tx.get(reviewRef),
        tx.get(summaryRef),
      ]);
      if (!rSnap.exists()) return;

      const r = rSnap.data();
      if (r.status !== "archived") return;

      const cur = safeSummary(sSnap.exists() ? sSnap.data() : null);
      const rating = r.rating ?? r.stars ?? 0;
      const tags = r.tags || [];

      const next = incSummary(cur, rating, tags);

      tx.set(
        reviewRef,
        {
          status: "active",
          restoredAt: serverTimestamp(),
          purgeAt: null,
        },
        { merge: true },
      );

      tx.set(
        summaryRef,
        {
          ...next,
          updatedAt: serverTimestamp(),
        },
        { merge: true },
      );
    });

    await fetchReviews({ reset: true });
    await fetchArchived();
    await fetchSummary();
  };

  const undoArchive = async () => {
    if (!undo?.id) return;
    const id = undo.id;
    setUndo(null);
    if (undoTimerRef.current) clearTimeout(undoTimerRef.current);
    undoTimerRef.current = null;
    await restoreReview(id);
  };

  // ===== Hard delete archived (manual) =====
  const deleteArchivedPermanently = async (reviewId) => {
    if (!reviewId) return;
    await deleteDoc(doc(db, "barbers", BARBER_ID, "reviews", reviewId));
    setArchived((p) => p.filter((x) => x.id !== reviewId));
  };

  // ===== Filtered ACTIVE Reviews (client-side) =====
  const filteredReviews = useMemo(() => {
    const t = safeLower(qText).trim();

    let rows = reviews.filter((r) => {
      const rStars = Number(r.rating || r.stars || 0);

      const phone = r.phoneKey || r.phoneE164 || r.phone || "";
      const msg = r.comment || r.message || r.text || "";
      const name = r.customerName || r.userName || r.displayName || "";

      const matchStars = stars === "all" ? true : rStars === Number(stars);
      const matchText =
        !t ||
        safeLower(phone).includes(t) ||
        safeLower(msg).includes(t) ||
        safeLower(name).includes(t);

      return matchStars && matchText;
    });

    // ✅ sort
    if (sortBy === "highest") {
      rows = [...rows].sort(
        (a, b) =>
          Number(b.rating || b.stars || 0) - Number(a.rating || a.stars || 0),
      );
    } else if (sortBy === "lowest") {
      rows = [...rows].sort(
        (a, b) =>
          Number(a.rating || a.stars || 0) - Number(b.rating || b.stars || 0),
      );
    } else {
      // newest: خليه زي ما هو (createdAt desc أصلاً)
    }

    return rows;
  }, [reviews, qText, stars, sortBy]);

  return (
    <div className="w-full max-w-4xl mx-auto p-4">
      <div className="flex items-center justify-between gap-3 mb-4">
        <h1 className="text-xl font-black">إدارة التقييمات</h1>

        <div className="flex gap-2 flex-wrap">
          <button
            className={`px-3 py-2 rounded-lg text-sm font-black border ${
              tab === "reviews" ? "bg-black text-white" : "bg-white"
            }`}
            onClick={() => setTab("reviews")}
          >
            التقييمات
          </button>
          <button
            className={`px-3 py-2 rounded-lg text-sm font-black border ${
              tab === "blocked" ? "bg-black text-white" : "bg-white"
            }`}
            onClick={() => setTab("blocked")}
          >
            الأرقام المحظورة
          </button>
          <button
            className={`px-3 py-2 rounded-lg text-sm font-black border ${
              tab === "archived" ? "bg-black text-white" : "bg-white"
            }`}
            onClick={() => setTab("archived")}
          >
            محذوفة مؤقتًا
          </button>
        </div>
      </div>

      {/* ✅ Stats (تبويب reviews فقط) */}
      {tab === "reviews" && (
        <div className="bg-white border rounded-xl p-4 mb-4">
          <div className="flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
            <div className="text-right">
              <div className="text-3xl font-black">
                {count ? avg.toFixed(1) : "—"}
              </div>
              <div className="text-sm opacity-80">{count} تقييم</div>
            </div>

            <div className="flex-1">
              <div className="text-sm font-black mb-2">توزيع النجوم</div>
              <div className="space-y-1">
                {[5, 4, 3, 2, 1].map((s) => {
                  const n = Number(summary.byStar?.[s] || 0);
                  const pct = count ? Math.round((n / count) * 100) : 0;
                  return (
                    <div key={s} className="flex items-center gap-2">
                      <div className="w-10 text-sm font-black">{s}★</div>
                      <div className="flex-1 h-2 rounded-full bg-gray-100 overflow-hidden">
                        <div
                          className="h-2 bg-black"
                          style={{ width: `${pct}%` }}
                        />
                      </div>
                      <div className="w-16 text-xs opacity-80 text-left">
                        {n} ({pct}%)
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <button
              className="px-3 py-2 rounded-lg border text-sm font-black"
              onClick={fetchSummary}
              disabled={loadingSummary}
              title="تحديث الإحصائيات"
            >
              {loadingSummary ? "..." : "تحديث"}
            </button>
          </div>
        </div>
      )}

      {tab === "reviews" && (
        <>
          <div className="bg-white border rounded-xl p-3 mb-4">
            <div className="flex flex-col md:flex-row gap-2 md:items-center md:justify-between">
              <input
                className="border rounded-lg px-3 py-2 w-full md:w-1/2"
                placeholder="بحث (اسم / رقم / نص التقييم)"
                value={qText}
                onChange={(e) => setQText(e.target.value)}
              />

              <div className="flex gap-2 w-full md:w-auto">
                <select
                  className="border rounded-lg px-3 py-2 w-full md:w-48"
                  value={stars}
                  onChange={(e) => setStars(e.target.value)}
                >
                  <option value="all">كل النجوم</option>
                  <option value="5">5 نجوم</option>
                  <option value="4">4 نجوم</option>
                  <option value="3">3 نجوم</option>
                  <option value="2">2 نجوم</option>
                  <option value="1">1 نجمة</option>
                </select>

                <select
                  className="border rounded-lg px-3 py-2 w-full md:w-48"
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  title="ترتيب"
                >
                  <option value="newest">الأحدث</option>
                  <option value="highest">الأعلى تقييمًا</option>
                  <option value="lowest">الأقل تقييمًا</option>
                </select>
              </div>
            </div>
          </div>

          <div className="space-y-3">
            {filteredReviews.map((r) => {
              const phoneKey = r.phoneKey || r.phoneE164 || r.phone || null;
              const rStars = Number(r.rating || r.stars || 0);
              const msg = r.comment || r.message || r.text || "";

              // ✅ الاسم من البيانات
              const displayName = prettyName(
                r.customerName || r.userName || r.displayName,
              );

              const isBlocked = !!blocked.find(
                (b) => b.id === String(phoneKey),
              );

              return (
                <div key={r.id} className="bg-white border rounded-xl p-4">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      {/* ✅ بدل "زبون" */}
                      <div className="font-black truncate">{displayName}</div>

                      <div className="text-sm opacity-80">
                        {starsLabel(rStars)}
                      </div>

                      {phoneKey ? (
                        <div className="text-xs opacity-70 mt-1">
                          {String(phoneKey)}
                        </div>
                      ) : (
                        <div className="text-xs text-rose-600 mt-1 font-bold">
                          لا يوجد رقم داخل بيانات التقييم (لن يمكن الحظر)
                        </div>
                      )}
                    </div>

                    <div className="flex flex-wrap gap-2 justify-end">
                      <button
                        className="px-3 py-2 rounded-lg border text-sm font-black"
                        onClick={() => archiveReview(r.id)}
                      >
                        حذف (مؤقت)
                      </button>

                      {!isBlocked ? (
                        <button
                          className="px-3 py-2 rounded-lg border text-sm font-black"
                          disabled={!phoneKey}
                          onClick={() =>
                            blockPhoneEverywhere(String(phoneKey), r.id)
                          }
                        >
                          حظر الرقم
                        </button>
                      ) : (
                        <button
                          className="px-3 py-2 rounded-lg border text-sm font-black"
                          onClick={() =>
                            unblockPhoneEverywhere(String(phoneKey))
                          }
                        >
                          فك الحظر
                        </button>
                      )}
                    </div>
                  </div>

                  {msg ? (
                    <p className="mt-3 text-sm leading-relaxed">{msg}</p>
                  ) : null}
                </div>
              );
            })}

            {filteredReviews.length === 0 && (
              <div className="bg-white border rounded-xl p-6 text-center opacity-80">
                لا يوجد تقييمات.
              </div>
            )}
          </div>

          <div className="mt-4 flex justify-center">
            {hasMore ? (
              <button
                className="px-4 py-2 rounded-lg border font-black"
                onClick={() => fetchReviews({ reset: false })}
                disabled={loadingReviews}
              >
                {loadingReviews ? "جاري التحميل..." : "تحميل المزيد"}
              </button>
            ) : (
              <div className="text-sm opacity-70">لا يوجد المزيد.</div>
            )}
          </div>
        </>
      )}

      {tab === "blocked" && (
        <div className="bg-white border rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-black">الأرقام المحظورة</div>
            <button
              className="px-3 py-2 rounded-lg border text-sm font-black"
              onClick={fetchBlocked}
            >
              تحديث
            </button>
          </div>

          {loadingBlocked ? (
            <div className="opacity-70">جاري التحميل...</div>
          ) : blocked.length === 0 ? (
            <div className="opacity-80">لا يوجد أرقام محظورة.</div>
          ) : (
            <div className="space-y-2">
              {blocked.map((b) => (
                <div
                  key={b.id}
                  className="flex items-center justify-between border rounded-lg p-3"
                >
                  <div className="font-mono text-sm">{b.id}</div>
                  <button
                    className="px-3 py-2 rounded-lg border text-sm font-black"
                    onClick={() => unblockPhoneEverywhere(b.id)}
                  >
                    فك الحظر
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {tab === "archived" && (
        <div className="bg-white border rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-black">
              محذوفة مؤقتًا (تبقى {ARCHIVE_KEEP_DAYS} يوم)
            </div>
            <button
              className="px-3 py-2 rounded-lg border text-sm font-black"
              onClick={fetchArchived}
            >
              تحديث
            </button>
          </div>

          {loadingArchived ? (
            <div className="opacity-70">جاري التحميل...</div>
          ) : archived.length === 0 ? (
            <div className="opacity-80">لا يوجد تقييمات مؤرشفة.</div>
          ) : (
            <div className="space-y-3">
              {archived.map((r) => {
                const phoneKey = r.phoneKey || r.phoneE164 || r.phone || "";
                const rStars = Number(r.rating || r.stars || 0);
                const msg = r.comment || r.message || r.text || "";
                const displayName = prettyName(
                  r.customerName || r.userName || r.displayName,
                );

                return (
                  <div key={r.id} className="border rounded-xl p-4">
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        {/* ✅ بدل "زبون" */}
                        <div className="font-black">{displayName}</div>

                        <div className="text-sm opacity-80">
                          {starsLabel(rStars)}
                        </div>
                        <div className="text-xs opacity-70 mt-1">
                          {String(phoneKey)}
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2">
                        <button
                          className="px-3 py-2 rounded-lg border text-sm font-black"
                          onClick={() => restoreReview(r.id)}
                        >
                          استرجاع
                        </button>
                        <button
                          className="px-3 py-2 rounded-lg border text-sm font-black"
                          onClick={() => deleteArchivedPermanently(r.id)}
                        >
                          حذف نهائي
                        </button>
                      </div>
                    </div>

                    {msg ? (
                      <p className="mt-3 text-sm leading-relaxed">{msg}</p>
                    ) : null}

                    {r.purgeAt ? (
                      <div className="mt-2 text-xs opacity-70">
                        حذف تلقائي بعد:{" "}
                        {typeof r.purgeAt?.toDate === "function"
                          ? r.purgeAt.toDate().toLocaleString()
                          : new Date(r.purgeAt).toLocaleString()}
                      </div>
                    ) : null}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* ✅ Undo Toast */}
      {undo?.id && (
        <div className="fixed bottom-4 left-4 right-4 max-w-4xl mx-auto">
          <div className="bg-black text-white rounded-xl p-4 flex items-center justify-between gap-3">
            <div className="text-sm font-bold">
              تم حذف تقييم ({undo.name}) مؤقتًا. تراجع؟
            </div>
            <button
              className="px-3 py-2 rounded-lg border border-white text-sm font-black"
              onClick={undoArchive}
            >
              تراجع
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/utils/dates.js">
// src/pages/barberPanel/utils/dates.js

export function addDaysYMD(ymd, days) {
  const d = new Date(`${ymd}T00:00:00`);
  d.setDate(d.getDate() + (Number(days) || 0));
  return d.toISOString().slice(0, 10);
}

export function getWeekdayNameEN(ymd) {
  const d = new Date(`${ymd}T00:00:00`);
  return d.toLocaleDateString("en-US", { weekday: "long" });
}

export function todayYMD() {
  return new Date().toLocaleDateString("sv-SE"); // YYYY-MM-DD
}
</file>

<file path="src/pages/barberPanel/utils/targets.js">
// src/pages/barberPanel/utils/targets.js
import { addDaysYMD, getWeekdayNameEN } from "./dates";

/**
 * applyMode:
 * - THIS_DATE
 * - SAME_WEEKDAY_UNTIL
 * - EVERY_DAY_UNTIL
 */
export function buildTargets({ applyMode, selectedDate, applyUntil }) {
  if (applyMode === "THIS_DATE") return [selectedDate];

  if (!applyUntil) return null;
  if (applyUntil < selectedDate) return null;

  const weekdayOfSelected = getWeekdayNameEN(selectedDate);
  const targets = [];

  let d = selectedDate;
  while (d <= applyUntil) {
    if (applyMode === "EVERY_DAY_UNTIL") {
      targets.push(d);
    } else if (applyMode === "SAME_WEEKDAY_UNTIL") {
      const wd = getWeekdayNameEN(d);
      if (wd === weekdayOfSelected) targets.push(d);
    }
    d = addDaysYMD(d, 1);
  }

  return targets;
}
</file>

<file path="src/pages/barberPanel/utils/weeklyHours.js">
// src/pages/barberPanel/utils/weeklyHours.js
export * from "./weeklyHoursUX";
</file>

<file path="src/pages/BookingForm.jsx">
import BookingSection from "../components/booking/BookingSection.jsx";

function BookingForm() {
  return (
    <main>
      <BookingSection />
    </main>
  );
}

export default BookingForm;
</file>

<file path="src/pages/BookingIntro.jsx">
import { useTranslation } from "react-i18next";
import { Link } from "react-router-dom";

function BookingIntro() {
  const { t, i18n } = useTranslation();
  const isArabic = i18n.language === "ar";
  const fontClass = isArabic ? "font-ar" : "font-heading";

  const workingHours = [
    { day: 'Sunday', hours: 'Closed' },
    { day: 'Monday', hours: 'Closed' },
    { day: 'Tuesday', hours: '12:00 – 21:00' },
    { day: 'Wednesday', hours: '12:00 – 21:00' },
    { day: 'Thursday', hours: '12:00 – 22:00' },
    { day: 'Friday', hours: '13:00 – 23:30' },
    { day: 'Saturday', hours: '11:00 – 19:30' },
  ];

  return (
    <section className={`min-h-screen bg-primary text-light ${fontClass} flex flex-col items-center justify-start pt-24 px-4`}>
      {/* صورة الحلاق والعنوان */}
      <div className="text-center" data-aos="fade-up">
        <img
          src="/barber.jpg"
          alt="Arfat Barber"
          className="w-48 h-48 rounded-full object-cover shadow-md mx-auto"
        />
        <h1 className="text-3xl mt-4 text-gold">Arfat Barber</h1>
        <p className="text-sm text-gray-400">Professional Grooming Experience</p>
      </div>

      {/* ساعات العمل */}
      <div className="mt-10 w-full max-w-md" data-aos="fade-up" data-aos-delay="100">
        <h2 className="text-xl font-semibold mb-4 text-center text-gold">{t('working_hours')}</h2>
        <ul className="bg-white text-darkText rounded-lg shadow-md divide-y divide-gray-200">
          {workingHours.map(({ day, hours }) => (
            <li key={day} className="flex justify-between p-3 px-5">
              <span>{t(day)}</span>
              <span className={hours === 'Closed' ? 'text-red-500' : ''}>{hours}</span>
            </li>
          ))}
        </ul>
      </div>

      {/* زر ابدأ الحجز */}
      <div className="mt-10" data-aos="zoom-in" data-aos-delay="400">
        <Link
          to="/booking-form"
          className="bg-gold text-primary px-6 py-3 rounded-full font-semibold 
                     transition-all duration-300 shadow-sm 
                     hover:bg-darkText hover:text-light 
                     hover:shadow-lg hover:scale-105"
        >
          {t("start_booking") || "Start Booking"}
        </Link>
      </div>
    </section>
  );
}

export default BookingIntro;
</file>

<file path="src/pages/InstagramCallback.jsx">
import { useEffect } from "react";
import { useNavigate } from "react-router-dom";

function InstagramCallback() {
  const navigate = useNavigate();

  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get("code");

    if (code) {
      // 🔥 ترسل الكود لسيرفرك (لتبديل الكود بـ access token وبيانات المستخدم)
      fetch("https://<YOUR_BACKEND_ENDPOINT>/auth/instagram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code }),
      })
        .then((res) => res.json())
        .then((data) => {
          // 🔐 خزن بيانات الحلاق في localStorage
          localStorage.setItem("barberUser", JSON.stringify(data.user));
          // ✅ توجيه المستخدم لصفحة الحلاق بعد تسجيل الدخول
          navigate("/barber");
        })
        .catch((err) => {
          console.error("Instagram Login Error:", err);
          navigate("/login"); // فشل؟ رجعه لصفحة الدخول
        });
    } else {
      navigate("/login"); // ما فيه كود؟ رجعه لصفحة الدخول
    }
  }, [navigate]);

  return (
    <div className="min-h-screen flex items-center justify-center">
      جاري تسجيل الدخول عبر إنستغرام...
    </div>
  );
}

export default InstagramCallback;
</file>

<file path="src/pages/products/ProductsPage.jsx">
// src/pages/products/ProductsPage.jsx
import React, { useEffect, useMemo, useState } from "react";

// نفس فكرة الترجمة البسيطة (Fallback)
const useLanguage = () => ({
  lang: "ar",
  dir: "rtl",
  t: {
    productsPremiumRibbon: "منتجات مميّزة",
    productsHeroTitle1: "منتجات احترافية",
    productsHeroTitle2: "للعناية والتصفيف",
    productsHeroSubtitle:
      "تشكيلة مختارة بعناية من أفضل منتجات العناية بالشعر واللحية والأدوات.",
    featured: "مميّز",
    allProducts: "كل المنتجات",
    hairCare: "عناية بالشعر",
    beardCare: "عناية باللحية",
    styling: "تصفيف",
    tools: "أدوات",
    bundles: "باندلز",
    outOfStock: "غير متوفر",
    buy: "اطلب",
    emptyProducts: "لا توجد منتجات ضمن هذا التصنيف",
    productsCtaTitle: "بدك ترشيحات مناسبة لإلك؟",
    productsCtaSubtitle: "فريقنا بيساعدك تختار الأفضل لنوع شعرك واحتياجك.",
    contactUs: "تواصل معنا",
  },
});

// داتا تجريبية محلية (غيّرها لاحقًا بـ fetch)
const PRODUCTS_SEED = [
  {
    id: "p1",
    name: "Shampoo Pro Clean",
    brand: "ARFAT",
    description: "شامبو لطيف ينظف بعمق ويحافظ على رطوبة الشعر.",
    price: 39.9,
    image_url:
      "https://images.unsplash.com/photo-1585386959984-a41552231656?q=80&w=1200",
    category: "hair_care",
    featured: true,
    in_stock: true,
  },
  {
    id: "p2",
    name: "Beard Oil Classic",
    brand: "ARFAT",
    description: "زيت لحية يمنح نعومة ولمعان مع رائحة خفيفة.",
    price: 49.0,
    image_url:
      "https://images.unsplash.com/photo-1604908176997-43191f2f4a3e?q=80&w=1200",
    category: "beard_care",
    featured: false,
    in_stock: true,
  },
  {
    id: "p3",
    name: "Matte Styling Clay",
    brand: "ARFAT",
    description: "كلاي بتثبيت قوي ولمسة نهائية مطفية.",
    price: 45.0,
    image_url:
      "https://images.unsplash.com/photo-1629196912807-4d6adad13e32?q=80&w=1200",
    category: "styling",
    featured: true,
    in_stock: false,
  },
  {
    id: "p4",
    name: "Wide Comb",
    brand: "ARFAT",
    description: "مشط واسع الأسنان لفك التشابك بدون شد.",
    price: 19.0,
    image_url:
      "https://images.unsplash.com/photo-1598550476439-6847785fcea3?q=80&w=1200",
    category: "tools",
    featured: false,
    in_stock: true,
  },
  {
    id: "p5",
    name: "Beard Care Bundle",
    brand: "ARFAT",
    description: "باقة زيت + مشط + بلسم للحية.",
    price: 99.0,
    image_url:
      "https://images.unsplash.com/photo-1600853155996-c5e4ecc6f5e2?q=80&w=1200",
    category: "bundles",
    featured: true,
    in_stock: true,
  },
  {
    id: "p6",
    name: "Leave-in Conditioner",
    brand: "ARFAT",
    description: "كريم يترك على الشعر لتغذية يومية خفيفة.",
    price: 42.0,
    image_url:
      "https://images.unsplash.com/photo-1605497788044-5a32c7078486?q=80&w=1200",
    category: "hair_care",
    featured: false,
    in_stock: true,
  },
];

async function fetchProducts() {
  await new Promise((r) => setTimeout(r, 300));
  return PRODUCTS_SEED;
}
function formatPrice(v, lang = "ar", currency = "USD") {
  try {
    return new Intl.NumberFormat(lang === "ar" ? "ar-EG" : "en-US", {
      style: "currency",
      currency,
    }).format(+v || 0);
  } catch {
    return `$${v ?? 0}`;
  }
}
function buildWhatsAppLink({ name, price, brand }) {
  const text = `مرحبًا، أريد هذا المنتج:\n• الاسم: ${name}\n• الماركة: ${
    brand || "-"
  }\n• السعر: ${price}\n— أرسِلوا لي التفاصيل وطريقة الاستلام.`;
  return `https://wa.me/?text=${encodeURIComponent(text)}`;
}

export default function ProductsPage() {
  const { lang, t, dir } = useLanguage();
  const [selectedCategory, setSelectedCategory] = useState("all");
  const [products, setProducts] = useState([]);
  const [status, setStatus] = useState("loading");

  useEffect(() => {
    let m = true;
    fetchProducts()
      .then((d) => {
        if (m) {
          setProducts(d);
          setStatus("success");
        }
      })
      .catch(() => m && setStatus("error"));
    return () => {
      m = false;
    };
  }, []);

  const labels = useMemo(
    () => ({
      premiumRibbon: t.productsPremiumRibbon,
      heroTitle1: t.productsHeroTitle1,
      heroTitle2: t.productsHeroTitle2,
      heroSubtitle: t.productsHeroSubtitle,
      featured: t.featured,
      allProducts: t.allProducts,
      hair_care: t.hairCare,
      beard_care: t.beardCare,
      styling: t.styling,
      tools: t.tools,
      bundles: t.bundles,
      outOfStock: t.outOfStock,
      buy: t.buy,
      emptyState: t.emptyProducts,
      ctaTitle: t.productsCtaTitle,
      ctaSubtitle: t.productsCtaSubtitle,
      ctaButton: t.contactUs,
    }),
    [t]
  );

  const categories = [
    { value: "all", label: labels.allProducts },
    { value: "hair_care", label: labels.hair_care },
    { value: "beard_care", label: labels.beard_care },
    { value: "styling", label: labels.styling },
    { value: "tools", label: labels.tools },
    { value: "bundles", label: labels.bundles },
  ];

  const filtered =
    selectedCategory === "all"
      ? products
      : products.filter((p) => p.category === selectedCategory);
  const featured = products.filter((p) => p.featured);

  return (
    <div className="min-h-screen bg-[#f8f8f8] text-primary" dir={dir}>
      {/* HERO (بنفس روح BookingSection: خلفية فاتحة ونص ذهبي) */}
      <section className="py-16 px-4 text-center">
        <div className="inline-block mb-6 px-4 py-2 bg-gold/10 border border-gold/20 rounded-full">
          <span className="text-gold text-sm font-semibold tracking-wider">
            {labels.premiumRibbon}
          </span>
        </div>
        <h1 className="text-4xl md:text-5xl font-extrabold mb-3">
          <span className="block">{labels.heroTitle1}</span>
          <span className="block text-transparent bg-clip-text bg-gradient-to-r from-gold to-yellow-400">
            {labels.heroTitle2}
          </span>
        </h1>
        <p className="text-base md:text-lg text-gray-600 max-w-2xl mx-auto">
          {labels.heroSubtitle}
        </p>
      </section>

      {/* ERROR */}
      {status === "error" && (
        <section className="px-4 pb-10">
          <div className="max-w-4xl mx-auto rounded-2xl border border-red-200 bg-red-50 p-5 text-red-700">
            حصل خطأ أثناء جلب المنتجات. جرّب تحديث الصفحة.
          </div>
        </section>
      )}

      {/* FEATURED (كروت بيضاء بحدود رمادية خفيفة) */}
      {status === "success" && featured.length > 0 && (
        <section className="pb-6 px-4">
          <div className="max-w-7xl mx-auto">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-6 h-6 rounded-full bg-gold" />
              <h2 className="text-2xl md:text-3xl font-bold">
                {labels.featured}
              </h2>
            </div>
            <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {featured.slice(0, 3).map((p) => {
                const price = formatPrice(p.price, lang);
                return (
                  <div
                    key={p.id}
                    className="rounded-2xl overflow-hidden bg-white border border-gray-100 hover:border-gold/60 transition shadow-sm"
                  >
                    <div className="aspect-square overflow-hidden bg-gray-50">
                      {p.image_url ? (
                        <img
                          src={p.image_url}
                          alt={p.name}
                          className="w-full h-full object-cover"
                          loading="lazy"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-gray-400">
                          —
                        </div>
                      )}
                    </div>
                    <div className="p-6">
                      <div className="flex items-start justify-between gap-3 mb-2">
                        <div className="flex-1">
                          {p.brand && (
                            <p className="text-xs text-gold font-semibold tracking-wider mb-1">
                              {p.brand}
                            </p>
                          )}
                          <h3 className="text-lg md:text-xl font-bold line-clamp-2">
                            {p.name}
                          </h3>
                        </div>
                        <span className="text-xs px-2 py-1 rounded-full bg-gold text-primary font-semibold">
                          {labels.featured}
                        </span>
                      </div>
                      {p.description && (
                        <p className="text-gray-600 text-sm mb-4 line-clamp-2">
                          {p.description}
                        </p>
                      )}
                      <div className="flex items-center justify-between">
                        <span className="text-2xl font-extrabold text-gold">
                          {price}
                        </span>
                        {!p.in_stock && (
                          <span className="text-xs px-2 py-1 rounded border border-red-200 text-red-600">
                            {labels.outOfStock}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </section>
      )}

      {/* FILTERS */}
      <section className="py-10 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="flex flex-wrap gap-2 justify-center mb-8">
            {categories.map((c) => {
              const isActive = selectedCategory === c.value;
              const count =
                c.value === "all"
                  ? products.length
                  : products.filter((p) => p.category === c.value).length;
              return (
                <button
                  key={c.value}
                  onClick={() => setSelectedCategory(c.value)}
                  className={`px-4 py-2 rounded-full border text-sm transition
                    ${
                      isActive
                        ? "bg-gradient-to-r from-gold to-yellow-400 text-primary border-yellow-300 shadow"
                        : "bg-white border-gray-200 text-gray-700 hover:bg-gray-50"
                    }`}
                  aria-pressed={isActive}
                >
                  {c.label}
                  <span
                    className={`ms-2 text-[10px] px-2 py-0.5 rounded-full
                    ${
                      isActive
                        ? "bg-white/60 text-primary/80"
                        : "bg-gray-100 text-gray-600"
                    }`}
                  >
                    {count}
                  </span>
                </button>
              );
            })}
          </div>

          {/* GRID */}
          {status === "loading" ? (
            <div className="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
              {Array.from({ length: 8 }).map((_, i) => (
                <div
                  key={i}
                  className="bg-white border border-gray-100 rounded-2xl overflow-hidden shadow-sm"
                >
                  <div className="aspect-square animate-pulse bg-gray-100" />
                  <div className="p-4 space-y-3">
                    <div className="h-3 w-24 bg-gray-100 rounded animate-pulse" />
                    <div className="h-4 w-full bg-gray-100 rounded animate-pulse" />
                    <div className="h-3 w-3/4 bg-gray-100 rounded animate-pulse" />
                    <div className="h-6 w-20 bg-gray-100 rounded animate-pulse" />
                  </div>
                </div>
              ))}
            </div>
          ) : filtered.length === 0 ? (
            <div className="text-center py-16 text-gray-600">
              <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100" />
              <p className="text-lg md:text-xl">{labels.emptyState}</p>
            </div>
          ) : (
            <div className="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
              {filtered.map((p) => {
                const price = formatPrice(p.price, lang);
                const walink = buildWhatsAppLink({
                  name: p.name,
                  brand: p.brand,
                  price,
                });
                return (
                  <div
                    key={p.id}
                    className="bg-white border border-gray-100 hover:border-gold/60 transition rounded-2xl overflow-hidden h-full flex flex-col shadow-sm"
                  >
                    <div className="aspect-square overflow-hidden bg-gray-50">
                      {p.image_url ? (
                        <img
                          src={p.image_url}
                          alt={p.name}
                          className="w-full h-full object-cover"
                          loading="lazy"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-gray-400">
                          —
                        </div>
                      )}
                    </div>
                    <div className="p-5 flex-1 flex flex-col">
                      <div className="flex items-start justify-between gap-3 mb-2">
                        {p.brand ? (
                          <p className="text-[11px] text-gold font-semibold uppercase tracking-wider">
                            {p.brand}
                          </p>
                        ) : (
                          <span />
                        )}
                        {p.category && (
                          <span className="text-[11px] capitalize px-2 py-0.5 rounded border border-gray-200 text-gray-700 bg-gray-50">
                            {{
                              hair_care: labels.hair_care,
                              beard_care: labels.beard_care,
                              styling: labels.styling,
                              tools: labels.tools,
                              bundles: labels.bundles,
                            }[p.category] || p.category.replace("_", " ")}
                          </span>
                        )}
                      </div>

                      <h3 className="text-base md:text-lg font-bold mb-2 line-clamp-2">
                        {p.name}
                      </h3>
                      {p.description && (
                        <p className="text-gray-600 text-sm mb-4 line-clamp-2 flex-1">
                          {p.description}
                        </p>
                      )}

                      <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                        <span className="text-xl md:text-2xl font-extrabold text-gold">
                          {price}
                        </span>
                        {p.in_stock ? (
                          <button
                            onClick={() => window.open(walink, "_blank")}
                            className="px-3 py-2 rounded-xl font-bold text-sm
                                       bg-gradient-to-r from-gold to-yellow-400 text-primary
                                       hover:shadow-md transition"
                            aria-label={labels.buy}
                          >
                            {labels.buy}
                          </button>
                        ) : (
                          <span className="text-xs px-2 py-1 rounded border border-red-200 text-red-600">
                            {labels.outOfStock}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </section>

      {/* CTA بنفس روحية زر التأكيد بالـBooking */}
      <section className="py-16 px-4">
        <div className="max-w-4xl mx-auto text-center bg-white border border-gray-100 rounded-2xl p-10 shadow-sm">
          <h2 className="text-3xl md:text-4xl font-extrabold mb-3">
            {labels.ctaTitle}
          </h2>
          <p className="text-base md:text-lg text-gray-600 mb-6">
            {labels.ctaSubtitle}
          </p>
          <button
            className="w-full sm:w-auto font-bold px-8 py-3 rounded-xl
                       bg-gradient-to-r from-gold to-yellow-400 text-primary
                       hover:shadow-lg transition"
            onClick={() => {
              const el = document.getElementById("contact");
              if (el)
                el.scrollIntoView({ behavior: "smooth", block: "center" });
            }}
          >
            {labels.ctaButton}
          </button>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="src/services/barberWeeklyHours.js">
// src/services/barberWeeklyHours.js
import { doc, getDoc, serverTimestamp, setDoc } from "firebase/firestore";
import { db } from "../firebase";

const DOC_PATH = ["barberSettings", "hours"];

// Reads the doc { weekly, updatedAt }
export async function getWeeklyHoursDoc() {
  const ref = doc(db, ...DOC_PATH);
  const snap = await getDoc(ref);
  return snap.exists() ? snap.data() : null;
}

// Ensures default exists only if doc is missing OR weekly missing
export async function ensureDefaultWeeklyHours(defaultWeekly) {
  const ref = doc(db, ...DOC_PATH);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    await setDoc(
      ref,
      { weekly: defaultWeekly, updatedAt: serverTimestamp() },
      { merge: true },
    );
    return { weekly: defaultWeekly, ensured: true };
  }

  const data = snap.data() || {};
  if (!data.weekly) {
    await setDoc(
      ref,
      { weekly: defaultWeekly, updatedAt: serverTimestamp() },
      { merge: true },
    );
    return { weekly: defaultWeekly, ensured: true };
  }

  return { weekly: data.weekly, ensured: false };
}

export async function saveWeeklyHours(weekly) {
  const ref = doc(db, ...DOC_PATH);
  await setDoc(ref, { weekly, updatedAt: serverTimestamp() }, { merge: true });
}

export async function resetWeeklyHoursToDefault(defaultWeekly) {
  const ref = doc(db, ...DOC_PATH);
  await setDoc(
    ref,
    { weekly: defaultWeekly, updatedAt: serverTimestamp() },
    { merge: true },
  );
}
</file>

<file path="src/services/fcmTest.js">
// src/services/fcmTest.js
//
// مجاني 100% (بدون سيرفر دائم وبدون Billing):
// - يجيب FCM token للجهاز (Web FCM)
// - يحفظ التوكن في Firestore (بدون تكرار)
// - ينشئ طلب Test Notification في Firestore (pending)
//   ليتم التقاطه وإرساله من GitHub Actions (Firebase Admin + Secret)

import { getMessaging, getToken } from "firebase/messaging";
import { app, db } from "../firebase";
import {
  addDoc,
  collection,
  doc,
  serverTimestamp,
  setDoc,
} from "firebase/firestore";

// ✅ نفس الـ VAPID KEY اللي عندك بالمشروع (App.jsx / useBookingSubmit.js)
const VAPID_KEY =
  "BMSKYpj6OfL2RinVjw4jUNlL-Hbi1Ev4eiTibIKlvFwqSULUm42ricVJRcKbptmiepuDbl3andf-F2tf7Cmr-U8";

// Collections
// نخزن الأجهزة (docId = token) لمنع duplicates
const DEVICE_TOKENS_COL = "deviceTokens";

// طلبات التيست (كل ضغط زر يعمل addDoc)
// GitHub Actions يقرأ pending ويرسل
const TEST_NOTIFS_COL = "testNotifications";

// ---------- identity helper (بدون فرض Auth) ----------
function getLocalIdentity() {
  try {
    const raw = localStorage.getItem("barberUser");
    if (raw) {
      const u = JSON.parse(raw);
      return {
        role: "barber",
        username: u?.username ? String(u.username) : null,
      };
    }
  } catch {
    // ignore
  }
  return { role: "unknown", username: null };
}

// ---------- permission helper ----------
export function getNotificationPermission() {
  if (!("Notification" in window)) return "unsupported";
  return Notification.permission; // "granted" | "denied" | "default"
}

// ---------- token ----------
/**
 * يطلب إذن الإشعارات + يرجع FCM token
 * يرجع null إذا المستخدم رفض أو ما طلع token
 */
export async function getOrRequestFcmToken() {
  if (!("Notification" in window)) {
    throw new Error("Notifications are not supported in this browser.");
  }

  const permission = await Notification.requestPermission();
  if (permission !== "granted") return null;

  const messaging = getMessaging(app);

  // ملاحظة: getToken قد يرمي خطأ إذا SW أو إعدادات Web Push مش جاهزة
  const token = await getToken(messaging, { vapidKey: VAPID_KEY });

  if (token) {
    try {
      localStorage.setItem("fcmToken", token);
    } catch {
      // ignore
    }
  }

  return token || null;
}

/**
 * يحفظ token في Firestore إذا لم يكن موجودًا (docId = token)
 * يرجع { token, existed }
 */
export async function saveDeviceToken(token) {
  if (!token) throw new Error("Missing FCM token.");

  const ident = getLocalIdentity();
  const ref = doc(db, "deviceTokens", token);

  // اكتب مباشرة بدون قراءة
  await setDoc(
    ref,
    {
      token,
      role: ident.role,
      username: ident.username,
      userAgent: navigator.userAgent || null,
      platform: navigator.platform || null,
      updatedAt: serverTimestamp(),
    },
    { merge: true }, // يسمح بإعادة الكتابة
  );

  return { token, existed: null };
}

// ---------- test request ----------
/**
 * ينشئ طلب إشعار تجريبي (pending) في Firestore
 * هذا هو الاسم اللي NotificationTestCard.jsx بستوردو
 */
export async function createTestNotificationRequest(token, payload) {
  if (!token) throw new Error("Missing FCM token.");

  const ident = getLocalIdentity();

  const title = payload?.title || "🧪 Test Notification";
  const body =
    payload?.body || "If you received this, Notifications pipeline works ✅";

  const data = payload?.data || {};

  const docRef = await addDoc(collection(db, TEST_NOTIFS_COL), {
    status: "pending", // pending | sent | failed
    token,
    notification: { title, body },
    data,
    role: ident.role,
    username: ident.username,
    createdAt: serverTimestamp(),
  });

  return { id: docRef.id };
}
</file>

<file path="src/utils/cancelGuard.js">
// ثابت: نافذة الإلغاء بالدقائق
export const CANCELLATION_WINDOW_MIN = 50;

// فرق الدقائق بين تاريخين
export function diffMinutes(fromDate, toDate) {
  const ms = toDate.getTime() - fromDate.getTime();
  return Math.floor(ms / 60000);
}

/**
 * تحقّق إمكانية الإلغاء (حد ثابت 50 دقيقة).
 * @param {Date} startAt - وقت الموعد (Date من Firestore Timestamp via toDate())
 * @returns {{ok: boolean, reason?: string}}
 */
export function canCancelFixed(startAt) {
  if (!(startAt instanceof Date) || isNaN(startAt)) {
    return { ok: false, reason: "بيانات الموعد غير صالحة." };
  }
  const now = new Date();
  const left = diffMinutes(now, startAt);
  if (left < CANCELLATION_WINDOW_MIN) {
    return {
      ok: false,
      reason: `لا يمكن الإلغاء: تبقّى أقل من ${CANCELLATION_WINDOW_MIN} دقيقة على موعدك.`,
    };
  }
  return { ok: true };
}
</file>

<file path="src/utils/phone.jsx">
// src/utils/phone.js

// 1) تحويل الأرقام العربية/الفارسية إلى إنجليزية
export function normalizeDigits(str = "") {
  const map = {
    "٠": "0",
    "١": "1",
    "٢": "2",
    "٣": "3",
    "٤": "4",
    "٥": "5",
    "٦": "6",
    "٧": "7",
    "٨": "8",
    "٩": "9",
    "۰": "0",
    "۱": "1",
    "۲": "2",
    "۳": "3",
    "۴": "4",
    "۵": "5",
    "۶": "6",
    "۷": "7",
    "۸": "8",
    "۹": "9",
  };
  return String(str).replace(/[٠-٩۰-۹]/g, (d) => map[d] || d);
}

// 2) إزالة كل شيء عدا + والأرقام
export function stripNonPhoneChars(str = "") {
  return String(str).replace(/[^\d+]/g, "");
}

// 3) تحويل أي صيغة شائعة إلى قياسية لإسرائيل: 9725XXXXXXXX (بدون +)
export function normalizeILToCanonical(raw = "") {
  let s = normalizeDigits(raw).trim();
  s = stripNonPhoneChars(s);

  if (s.startsWith("+")) s = s.slice(1); // +972... -> 972...
  if (s.startsWith("00972")) s = "972" + s.slice(5); // 00972... -> 972...
  if (s.startsWith("9720")) s = "972" + s.slice(4); // 9720X -> 972X
  if (s.startsWith("0")) s = "972" + s.slice(1); // 05... -> 9725...
  if (/^5\d{8}$/.test(s)) s = "972" + s; // 5XXXXXXXX -> 9725...

  return s; // متوقع: 9725XXXXXXXX (11 رقم)
}

// 4) بناء متغيّرات محتملة لبحث متوافق مع بيانات قديمة
export function buildILPhoneVariants(input = "") {
  const variants = new Set();

  const raw = normalizeDigits(input);
  const rawNoSpacesDashes = raw.replace(/[\s-]/g, "");
  const justDigitsPlus = stripNonPhoneChars(raw);
  const canonical = normalizeILToCanonical(justDigitsPlus);

  variants.add(canonical); // 9725XXXXXXXX
  variants.add("+" + canonical); // +9725XXXXXXXX
  variants.add("0" + canonical.slice(3)); // 05XXXXXXXX
  variants.add("00972" + canonical.slice(3)); // 009725XXXXXXXX
  variants.add(justDigitsPlus); // الإدخال بدون محارف غريبة
  if (justDigitsPlus.startsWith("+")) variants.add(justDigitsPlus.slice(1));
  variants.add(rawNoSpacesDashes); // إزالة المسافات/الشرطات

  return Array.from(variants).slice(0, 10); // حد Firestore 'in'
}

// 5) فحص سريع لأن الرقم يبدو موبايل IL صالح (اختياري)
export function isLikelyILMobile(canonical = "") {
  return /^9725\d{8}$/.test(canonical);
}
</file>

<file path="src/utils/slots.js">
// src/utils/slots.js

export function safeInt(v, fallback = 0) {
  const n = Number(v);
  return Number.isFinite(n) ? Math.trunc(n) : fallback;
}

export function addMinutesToHHMM(hhmm, minsToAdd) {
  const [h, m] = String(hhmm || "00:00")
    .split(":")
    .map(Number);

  const base = new Date();
  base.setHours(h || 0, m || 0, 0, 0);
  base.setMinutes(base.getMinutes() + (Number(minsToAdd) || 0));

  const HH = String(base.getHours()).padStart(2, "0");
  const MM = String(base.getMinutes()).padStart(2, "0");
  return `${HH}:${MM}`;
}

/**
 * ✅ أدوار 30 دقيقة (النهاية غير شاملة)
 * مثال: 12:00 -> 20:00 => آخر دور 19:30
 */
export function generateSlots30Min(from, to) {
  if (!from || !to) return [];
  const [fh, fm] = String(from).split(":").map(Number);
  const [th, tm] = String(to).split(":").map(Number);

  const cur = new Date();
  cur.setHours(fh || 0, fm || 0, 0, 0);

  const end = new Date();
  end.setHours(th || 0, tm || 0, 0, 0);

  const out = [];
  while (cur <= end) {
    out.push(cur.toTimeString().slice(0, 5));
    cur.setMinutes(cur.getMinutes() + 30);
  }
  return out;
}

export function applyExtraSlots(baseSlots, extraSlots) {
  const n = safeInt(extraSlots, 0);
  if (!n) return baseSlots;

  if (baseSlots.length === 0) return [];

  if (n > 0) {
    const last = baseSlots[baseSlots.length - 1];
    const extras = [];
    for (let i = 1; i <= n; i++) extras.push(addMinutesToHHMM(last, i * 30));
    return [...baseSlots, ...extras];
  }

  const cut = Math.abs(n);
  return baseSlots.slice(0, Math.max(0, baseSlots.length - cut));
}
</file>

<file path="src/utils/timeSlots.js">
// src/utils/timeSlots.js

/**
 * يولّد أدوار كل 30 دقيقة بين from و to
 * - from/to بصيغة "HH:mm"
 * - includeEnd: لو true بيشمل خانة to نفسها (الافتراضي false عشان ما نطلع دور على وقت الإغلاق بالضبط)
 */
export function generateTimeSlots30(from, to, { includeEnd = false } = {}) {
  if (!from || !to) return [];

  const [fh, fm] = String(from).split(":").map(Number);
  const [th, tm] = String(to).split(":").map(Number);
  if (![fh, fm, th, tm].every((n) => Number.isFinite(n))) return [];

  const start = new Date();
  start.setHours(fh, fm, 0, 0);

  const end = new Date();
  end.setHours(th, tm, 0, 0);

  // لو from بعد to (غلط) نرجّع فاضي
  if (start > end) return [];

  const out = [];
  const cur = new Date(start);

  while (cur < end || (includeEnd && cur <= end)) {
    out.push(cur.toTimeString().slice(0, 5));
    cur.setMinutes(cur.getMinutes() + 30);
  }

  return out;
}

/** يزيد وقت "HH:mm" بعدد دقائق (مثلاً 30) ويرجع "HH:mm" */
export function addMinutesHHmm(hhmm, minutesToAdd) {
  const [h, m] = String(hhmm || "00:00")
    .split(":")
    .map(Number);
  if (!Number.isFinite(h) || !Number.isFinite(m)) return hhmm;

  const d = new Date();
  d.setHours(h, m, 0, 0);
  d.setMinutes(d.getMinutes() + (Number(minutesToAdd) || 0));
  return d.toTimeString().slice(0, 5);
}

export function getWeekdayNameEN(dateYMD) {
  // dateYMD: "YYYY-MM-DD"
  try {
    const [y, mo, da] = dateYMD.split("-").map(Number);
    const d = new Date(y, mo - 1, da);
    if (!(d instanceof Date) || isNaN(d)) return "";
    return d.toLocaleDateString("en-US", { weekday: "long" });
  } catch {
    return "";
  }
}

export function isTodayYMD(dateYMD) {
  const today = new Date().toLocaleDateString("sv-SE"); // YYYY-MM-DD
  return dateYMD === today;
}
</file>

<file path="src/utils/validators.js">
// src/utils/validators.js

// src/utils/validators.js

// 1) تحويل الأرقام الشرقية (العربية/الفارسية) إلى ASCII
const easternToAscii = (s = "") =>
  s
    // عربية-هندية U+0660..U+0669  (٠١٢٣٤٥٦٧٨٩)
    .replace(/[\u0660-\u0669]/g, (d) => String(d.charCodeAt(0) - 0x0660))
    // فارسية U+06F0..U+06F9 (۰۱۲۳۴۵۶۷۸۹)
    .replace(/[\u06F0-\u06F9]/g, (d) => String(d.charCodeAt(0) - 0x06f0));

// 2) إزالة أي شيء غير رقم (بعد تحويل الشرقية إلى ASCII)
export const normalizePhone = (v) =>
  easternToAscii(v || "").replace(/[^\p{Nd}]/gu, "");

// 3) الفحص النهائي: يبدأ بـ 05 وطوله 10 أرقام
export const isPhoneValid = (v) => {
  const digits = normalizePhone(v);
  return /^05\d{8}$/.test(digits);
};

// اسم: حرفين فأكثر (أحرف عربية/لاتينية + مسافات/'-)
export const isNameValid = (v) => {
  if (typeof v !== "string") return false;
  const s = v.trim();
  if (s.length < 2) return false;
  return /^[\p{L}\s'-]{2,}$/u.test(s);
};

export const isDateValid = (v) => typeof v === "string" && v.trim().length > 0;
export const isTimeValid = (v) => typeof v === "string" && v.trim().length > 0;
export const isServiceValid = (v) =>
  typeof v === "string" && v.trim().length > 0;

export const validateForm = (form) => {
  const errors = {};
  if (!isNameValid(form.fullName)) errors.fullName = "invalid_name";
  if (!isPhoneValid(form.phoneNumber)) errors.phoneNumber = "invalid_phone";
  if (!isDateValid(form.selectedDate)) errors.selectedDate = "invalid_date";
  if (!isTimeValid(form.selectedTime)) errors.selectedTime = "invalid_time";
  if (!isServiceValid(form.selectedService))
    errors.selectedService = "invalid_service";
  return errors;
};
</file>

<file path="src/utils/workingHours.js">
// src/utils/workingHours.js

export const DAYS = [
  "Sunday",
  "Monday",
  "Tuesday",
  "Wednesday",
  "Thursday",
  "Friday",
  "Saturday",
];

export function isHHmm(v) {
  return typeof v === "string" && /^\d{2}:\d{2}$/.test(v);
}

export function toMinutes(hhmm) {
  const [h, m] = hhmm.split(":").map((x) => parseInt(x, 10));
  return h * 60 + m;
}

export function isRangeValid(from, to) {
  if (!isHHmm(from) || !isHHmm(to)) return false;
  return toMinutes(from) < toMinutes(to);
}

// يضمن شكل أسبوعي ثابت + يرجّع fallback لو غلط
export function sanitizeWeeklyHours(input, fallback) {
  const out = { ...fallback };
  if (!input || typeof input !== "object") return out;

  for (const day of Object.keys(fallback)) {
    const v = input[day];

    if (v === null) {
      out[day] = null;
      continue;
    }

    if (v && typeof v === "object") {
      const from = isHHmm(v.from) ? v.from : fallback[day]?.from ?? null;
      const to = isHHmm(v.to) ? v.to : fallback[day]?.to ?? null;

      if (from && to && isRangeValid(from, to)) out[day] = { from, to };
      else out[day] = fallback[day] ?? null;

      continue;
    }

    out[day] = fallback[day] ?? null;
  }

  return out;
}

// normalize اللي بدنا نخزّنه بالـ DB
export function normalizeWeeklyHours(weekly, fallback) {
  return sanitizeWeeklyHours(weekly, fallback);
}

export function isTimeWithinDayRange(hhmm, range) {
  if (!range?.from || !range?.to) return false;
  if (!isHHmm(hhmm)) return false;
  const t = toMinutes(hhmm);
  return t >= toMinutes(range.from) && t < toMinutes(range.to);
}
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr

# Ignore local environment files
.env*
!*.example
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="firebase.json">
{
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ]
    }
  ],
  "hosting": {
    "public": "dist",               
    "ignore": ["firebase.json", "**/.*", "**/node_modules/**"],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ],
    "headers": [
      {
        "source": "/(.*)",
        "headers": [
          { "key": "Cache-Control", "value": "no-cache, no-store, must-revalidate" },
          { "key": "Pragma", "value": "no-cache" },
          { "key": "Expires", "value": "0" }
        ]
      }
    ]
  }
}
</file>

<file path="functions/index.js">
/* eslint-disable */

const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();

exports.sendBookingNotification = functions.firestore
  .document("bookings/{bookingId}")
  .onCreate(async (snap, context) => {
    const booking = snap.data();

    const token = booking.fcmToken;
    const name = booking.fullName || "زبون";
    const time = booking.selectedTime || "بدون وقت";
    const date = booking.selectedDate || "بدون تاريخ";

    // استخراج اسم اليوم من التاريخ (بالعربية)
    const weekdayName = new Date(date).toLocaleDateString("ar-EG", {
      weekday: "long",
    });

    if (!token) {
      console.log("🚫 لا يوجد fcmToken في الحجز");
      return null;
    }

    const message = {
      notification: {
        title: "✂️ تم تأكيد حجزك!",
        body: `موعدك الساعة ${time} ليوم ${weekdayName} – نراك قريبًا في Arfat Barber!`,
      },
      token: token,
    };

    try {
      const response = await admin.messaging().send(message);
      console.log("✅ إشعار تم إرساله:", response);
    } catch (error) {
      console.error("❌ فشل إرسال الإشعار:", error);
    }

    return null;
  });
</file>

<file path="functions/package.json">
{
  "name": "functions",
  "description": "Cloud Functions for Firebase",
  "type": "commonjs",
  "scripts": {
    "serve": "firebase emulators:start --only functions",
    "shell": "firebase functions:shell",
    "start": "npm run shell",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
  "node": "18"
},
  "main": "index.js",
  "dependencies": {
    "firebase-admin": "^12.6.0",
    "firebase-functions": "^6.0.1"
  },
  "devDependencies": {
    "firebase-functions-test": "^3.1.0"
  },
  "private": true
}
</file>

<file path="scripts/notifications/runReminders.js">
/* eslint-disable no-undef */
/* eslint-disable no-unused-vars */

/**
 * هذا هو الملف الرئيسي:
 * - يقرأ الحجوزات من Firestore
 * - يحدد أي إشعار لازم ينرسل
 * - يبعث الإشعارات عبر FCM
 * - يحدّث flags لمنع التكرار
 *
 * يُشغّل من GitHub Actions فقط (Node.js)
 */

import { CONFIG } from "./config.js";
import {
  getNewBookingsForOnCreate,
  getBookingsForReminder,
  markBookingUpdated,
} from "./firestoreBookings.js";
import { buildOnCreatePayload, buildReminderPayload } from "./templates.js";
import { sendToTokens } from "./sendFcm.js";

// ✅ NEW: test notifications runner
import runTestNotifications from "./runTestNotifications.js";

// إزالة التكرار
function unique(arr) {
  return Array.from(new Set(arr || []));
}

// استخراج كل الـ tokens
function extractTokens(booking) {
  const arr = Array.isArray(booking.fcmTokens) ? booking.fcmTokens : [];
  const legacy = booking.fcmToken ? [booking.fcmToken] : [];
  return unique([...arr, ...legacy]);
}

// إشعار "عند الحجز"
async function processOnCreate() {
  const bookings = await getNewBookingsForOnCreate();
  let totalSent = 0;

  for (const booking of bookings) {
    const tokens = extractTokens(booking);

    if (tokens.length === 0) {
      await markBookingUpdated(booking.id, {
        "notify.onCreateSentAt": Date.now(),
      });
      continue;
    }

    const payload = buildOnCreatePayload(booking);
    const { sent, invalid } = await sendToTokens(tokens, payload);

    totalSent += sent;

    await markBookingUpdated(booking.id, {
      "notify.onCreateSentAt": Date.now(),
      ...(invalid.length
        ? {
            fcmTokens: tokens.filter((t) => !invalid.includes(t)),
          }
        : {}),
    });
  }

  console.log(`[onCreate] processed=${bookings.length} sent=${totalSent}`);
}

// إشعارات التذكير
async function processReminders() {
  for (const r of CONFIG.REMINDERS) {
    const { bookings, flagField } = await getBookingsForReminder(
      r.minutesBefore,
    );

    let totalSent = 0;

    for (const booking of bookings) {
      const tokens = extractTokens(booking);

      if (tokens.length === 0) {
        await markBookingUpdated(booking.id, {
          [flagField]: Date.now(),
        });
        continue;
      }

      const payload = buildReminderPayload(booking, r.minutesBefore);
      const { sent, invalid } = await sendToTokens(tokens, payload);

      totalSent += sent;

      await markBookingUpdated(booking.id, {
        [flagField]: Date.now(),
        ...(invalid.length
          ? {
              fcmTokens: tokens.filter((t) => !invalid.includes(t)),
            }
          : {}),
      });
    }

    console.log(
      `[reminder ${r.minutesBefore}m] processed=${bookings.length} sent=${totalSent}`,
    );
  }
}

// التشغيل
(async function main() {
  try {
    await processOnCreate();
    await processReminders();

    // ✅ NEW: process pending test notifications (Barber/Admin)
    await runTestNotifications();

    console.log("✅ reminders run completed");
  } catch (err) {
    console.error("❌ reminders run failed:", err);
    process.exit(1); // Node.js فقط
  }
})();
</file>

<file path="scripts/notifications/runTestNotifications.js">
/* eslint-env node */
// scripts/notifications/runTestNotifications.js

import { getAdmin } from "./firebaseAdmin.js";

export default async function runTestNotifications() {
  const admin = getAdmin();

  const db = admin.firestore();
  const messaging = admin.messaging();

  const snap = await db
    .collection("testNotifications")
    .where("status", "==", "pending")
    .limit(20)
    .get();

  if (snap.empty) {
    console.log("ℹ️ No pending test notifications.");
    return;
  }

  for (const doc of snap.docs) {
    const t = doc.data();

    // لازم يكون عندك token محفوظ من الويب
    const token = t?.token;
    if (!token) {
      await doc.ref.set(
        {
          status: "failed",
          error: "Missing token",
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        },
        { merge: true },
      );
      continue;
    }

    const payload = {
      notification: {
        title: t?.title || "Test Notification ✅",
        body: t?.body || "Push is working (sent from GitHub Actions).",
      },
      data: t?.data || {},
      token,
    };

    try {
      const res = await messaging.send(payload);
      await doc.ref.set(
        {
          status: "sent",
          messageId: res,
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        },
        { merge: true },
      );
      console.log("✅ Sent test notification:", doc.id, res);
    } catch (err) {
      await doc.ref.set(
        {
          status: "failed",
          error: String(err?.message || err),
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        },
        { merge: true },
      );
      console.log("❌ Failed test notification:", doc.id, err);
    }
  }
}
</file>

<file path="src/components/BackToTopButton.jsx">
// src/components/layout/BackToTopButton.jsx

import { useEffect, useState } from "react";
import { FaChevronUp } from "react-icons/fa";

function BackToTopButton() {
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const handleScroll = () => {
      if (window.pageYOffset > 300) {
        setVisible(true);
      } else {
        setVisible(false);
      }
    };
    window.addEventListener("scroll", handleScroll);
    return () => window.removeEventListener("scroll", handleScroll);
  }, []);

  const scrollToTop = () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  return (
    <button
      onClick={scrollToTop}
      title="العودة للأعلى"
      className={`
        fixed bottom-20 right-5 z-50 flex items-center justify-center
        w-12 h-12 rounded-full
        bg-gold text-white text-xl
        shadow-lg
        transform transition-all duration-300
        ${visible ? "opacity-100 scale-100" : "opacity-0 scale-75 pointer-events-none"}
        hover:bg-yellow-500
      `}
    >
      <FaChevronUp />
    </button>
  );
}

export default BackToTopButton;
</file>

<file path="src/components/booking/parts/PhoneInput.jsx">
// src/components/booking/parts/PhoneInput.jsx
import React, { forwardRef } from "react";

const PhoneInput = forwardRef(function PhoneInput(
  {
    value,
    onChange,
    onBlur,
    placeholder,
    inputMode = "tel",
    className = "",
    isInvalid = false,
    isValid = false,
    ...rest
  },
  ref
) {
  const base =
    "w-full p-3 rounded-xl border transition focus:ring-2 outline-none";
  const state = isInvalid
    ? "border-red-500 focus:ring-red-300"
    : isValid
    ? "border-emerald-500 focus:ring-emerald-300"
    : "border-gray-300 focus:border-gold focus:ring-gold/40";

  return (
    <input
      ref={ref}
      type="tel"
      value={value}
      onChange={(e) => onChange?.(e.target.value)}
      onBlur={onBlur}
      placeholder={placeholder}
      inputMode={inputMode}
      className={`${base} ${state} ${className}`}
      {...rest}
    />
  );
});

export default PhoneInput;
</file>

<file path="src/components/common/SectionTitle.jsx">
// src/components/common/SectionTitle.jsx
export default function SectionTitle({ children, icon }) {
  return (
    <div className="text-center mb-10">
      <div className="flex items-center justify-center gap-3">
        {icon && (
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-gold/10 text-gold">
            {icon}
          </div>
        )}
        <h2 className="text-3xl md:text-4xl font-extrabold text-gold tracking-wide">
          {children}
        </h2>
      </div>
      <span className="block w-24 h-[3px] bg-gold mx-auto mt-3 rounded-full shadow-sm"></span>
    </div>
  );
}
</file>

<file path="src/components/layout/FloatingWhatsappButton.jsx">
import { FaWhatsapp } from "react-icons/fa";

function FloatingWhatsappButton() {
  return (
    <a
      href="https://wa.me/972549896985" // ← غيّر الرقم لرقمك الحقيقي
      target="_blank"
      rel="noopener noreferrer"
      className="fixed bottom-5 right-5 z-50 bg-green-500 hover:bg-green-600 text-white p-3 rounded-full shadow-lg transition-all duration-300"
      title="Chat on WhatsApp"
    >
      <FaWhatsapp size={24} />
    </a>
  );
}

export default FloatingWhatsappButton;
</file>

<file path="src/components/layout/LanguageSwitcher.jsx">
import { useTranslation } from "react-i18next";

function LanguageSwitcher() {
  const { i18n } = useTranslation();

  const changeLanguage = (lng) => {
    i18n.changeLanguage(lng);
    document.documentElement.dir = lng === "ar" || lng === "he" ? "rtl" : "ltr";
    document.documentElement.lang = lng;
    localStorage.setItem("lang", lng);
  };

  return (
    <div className="relative">
      <select
        onChange={(e) => changeLanguage(e.target.value)}
        value={i18n.language}
        className="bg-white text-primary px-3 py-2 rounded-md border text-sm shadow focus:outline-none"
      >
        <option value="en">English</option>
        <option value="ar">عربي</option>
        <option value="he">עברית</option>
      </select>
    </div>
  );
}

export default LanguageSwitcher;
</file>

<file path="src/components/shared/SecretBarberButton.jsx">
// ✅ SecretBarberButton.jsx
import { useNavigate } from "react-router-dom";

function SecretBarberButton() {
  const navigate = useNavigate();

  return (
    <div className="w-full text-center mt-6">
      <button
        onClick={() => navigate("/login")}
        title="دخول الحلاق"
        className="font-heading text-gold text-2xl md:text-3xl tracking-wide hover:text-yellow-300 transition-all"
        style={{ fontWeight: 700, letterSpacing: "1px" }}
      >
        Arfat Barber
      </button>
    </div>
  );
}

export default SecretBarberButton;
</file>

<file path="src/hooks/useBookingSubmit.js">
// src/hooks/useBookingSubmit.js
import { useState, useEffect, useRef } from "react";
import { getMessaging, getToken } from "firebase/messaging";
import { app, db } from "../firebase"; // 👈 أضفنا db هنا
import { doc, getDoc } from "firebase/firestore"; // 👈 نقرأ إعداد من Firestore مباشرة

import {
  isPhoneBlocked,
  hasExistingBookings,
  hasActiveConflict,
  createBooking,
  fetchActiveBookingsByDate, // 👈 نستخدم فانكشن موجودة أصلاً
} from "../services/bookingService";

import { toILPhoneE164, isILPhoneE164 } from "../utils/phone";

export default function useBookingSubmit(form, setForm, t) {
  const [submitted, setSubmitted] = useState(false);
  const [showSuccessMessage, setShowSuccessMessage] = useState(false);
  const [code, setCode] = useState("");
  const messageRef = useRef(null);

  const { fullName, phoneNumber, selectedDate, selectedTime, selectedService } =
    form;
  const [step, setStep] = useState(0);
  const [progress, setProgress] = useState(0);

  useEffect(() => {
    let current = 0;
    if (fullName) current++;
    if (phoneNumber) current++;
    if (selectedDate) current++;
    if (selectedTime) current++;
    if (selectedService) current++;
    setStep(current);
    setProgress((current / 5) * 100);
  }, [fullName, phoneNumber, selectedDate, selectedTime, selectedService]);

  useEffect(() => {
    if (submitted && messageRef.current) {
      messageRef.current.scrollIntoView({ behavior: "smooth" });
    }
  }, [submitted]);

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (
      !fullName ||
      !phoneNumber ||
      !selectedDate ||
      !selectedTime ||
      !selectedService
    ) {
      alert(t("fill_required_fields"));
      return;
    }

    // تطبيع الهاتف لصيغة E.164
    const phoneE164 = toILPhoneE164(phoneNumber);
    if (!isILPhoneE164(phoneE164)) {
      alert(t("invalid_phone") || "رقم الهاتف غير صالح");
      return;
    }

    // FCM (اختياري)
    let fcmToken = "";
    try {
      const messaging = getMessaging(app);
      fcmToken = await getToken(messaging, {
        vapidKey:
          "BMSKYpj6OfL2RinVjw4jUNlL-Hbi1Ev4eiTibIKlvFwqSULUm42ricVJRcKbptmiepuDbl3andf-F2tf7Cmr-U8",
      });
    } catch (err) {
      console.warn("FCM token error", err);
    }

    // محظور؟
    if (await isPhoneBlocked(phoneE164)) {
      alert("🚫 هذا الرقم محظور من الحجز. يرجى التواصل مع الحلاق.");
      return;
    }

    // ⚙️ قراءة إعداد "حجز واحد لكل رقم في اليوم" مباشرة من Firestore
    let limitOnePerDay = false;
    try {
      const settingsRef = doc(db, "barberSettings", "global");
      const settingsSnap = await getDoc(settingsRef);
      if (settingsSnap.exists()) {
        const data = settingsSnap.data();
        limitOnePerDay =
          typeof data.limitOneBookingPerDayPerPhone === "boolean"
            ? data.limitOneBookingPerDayPerPhone
            : !!data.limitOneBookingPerDay;
      }
    } catch (err) {
      console.warn("limitOnePerDay settings read error:", err);
      // لو في خطأ ما نمنع الحجز عشان ما نخرب التجربة
    }

    if (limitOnePerDay) {
      // نجيب كل حجوزات هذا اليوم، ثم نتحقق إذا هذا الرقم عنده حجز فعّال
      try {
        const dayBookings = await fetchActiveBookingsByDate(selectedDate);
        const hasSameDay = dayBookings.some((b) => b.phoneNumber === phoneE164);
        if (hasSameDay) {
          alert(
            t("phone_already_booked_today") ||
              "لديك حجز مسبق لهذا اليوم بهذا الرقم. إذا أردت تعديل الحجز، يرجى التواصل مع الحلاق."
          );
          return;
        }
      } catch (err) {
        console.warn("same-day booking check error:", err);
        // لو صار خطأ في التحقق، ما نمنع الحجز
      }
    }

    // لديه حجوزات سابقة؟ (أي يوم) – نفس السلوك القديم
    if (await hasExistingBookings(phoneE164)) {
      const confirmNew = window.confirm(
        "⚠️ يوجد لديك حجوزات سابقة برقم الهاتف هذا. هل تريد إضافة حجز جديد؟"
      );
      if (!confirmNew) return;
    }

    // تعارض نفس الوقت؟
    if (await hasActiveConflict(selectedDate, selectedTime)) {
      alert(
        t("time_already_booked") ||
          "هذه الساعة محجوزة بالفعل، يرجى اختيار ساعة أخرى."
      );
      return;
    }

    try {
      const bookingCode = Math.random().toString(36).substring(2, 8);
      setCode(bookingCode);
      const bookingDateTime = new Date(`${selectedDate}T${selectedTime}:00`);
      const timestamp = bookingDateTime.getTime();

      await createBooking({
        fullName,
        phoneNumber: phoneE164, // نخزّن دائمًا E.164
        selectedDate,
        selectedTime,
        selectedService,
        bookingCode,
        timestamp,
        reminderSent_60: false,
        reminderSent_30: false,
        fcmToken,
      });

      setSubmitted(true);
      setShowSuccessMessage(true);
      setTimeout(() => setShowSuccessMessage(false), 16000);

      setForm({
        fullName: "",
        phoneNumber: "",
        selectedDate: "",
        selectedTime: "",
        selectedService: "",
      });
    } catch (err) {
      console.error("createBooking error:", err);
      alert("حدث خطأ أثناء حفظ الحجز، يرجى المحاولة لاحقًا.");
    }
  };

  return {
    handleSubmit,
    submitted,
    showSuccessMessage,
    setShowSuccessMessage,
    code,
    step,
    progress,
    messageRef,
  };
}
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

html[dir="rtl"] {
  direction: rtl;
  text-align: right;
}

html[dir="ltr"] {
  direction: ltr;
  text-align: left;
}
</file>

<file path="src/main.jsx">
// ✅ 5. main.jsx
import React from "react";
import { createRoot } from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App";
import "./index.css";
import "@fontsource/poppins/latin.css"; // للإنجليزي
import "@fontsource/cairo/arabic.css"; // للعربي

createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="src/pages/barberPanel/components/StickySaveBar.jsx">
// src/pages/barberPanel/components/StickySaveBar.jsx
import React from "react";

export default function StickySaveBar({
  isArabic = true,
  disabled = false,
  saving = false,
  dirty = false,
  hasErrors = false,
  onSave,
  onReset,
}) {
  const t = isArabic
    ? {
        save: "حفظ التغييرات",
        saving: "جاري الحفظ...",
        reset: "إرجاع افتراضي",
        unsaved: "تغييرات غير محفوظة",
        saved: "كل شيء محفوظ",
        errors: "يوجد أخطاء",
        tip: "لن يتم تطبيق أي تغيير إلا بعد الضغط على حفظ.",
      }
    : {
        save: "Save changes",
        saving: "Saving…",
        reset: "Reset default",
        unsaved: "Unsaved changes",
        saved: "All saved",
        errors: "Has errors",
        tip: "Nothing applies unless you press Save.",
      };

  const badge = () => {
    if (hasErrors) {
      return (
        <span className="inline-flex items-center gap-2 rounded-2xl border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-black text-rose-800">
          <span className="text-base leading-none">⚠️</span>
          {t.errors}
        </span>
      );
    }
    if (dirty) {
      return (
        <span className="inline-flex items-center gap-2 rounded-2xl border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-black text-amber-900">
          <span className="text-base leading-none">✳️</span>
          {t.unsaved}
        </span>
      );
    }
    return (
      <span className="inline-flex items-center gap-2 rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-black text-emerald-800">
        <span className="text-base leading-none">✅</span>
        {t.saved}
      </span>
    );
  };

  return (
    <div className="fixed left-0 right-0 bottom-0 z-30">
      {/* Blur background */}
      <div className="pointer-events-none absolute inset-0 bg-white/70 backdrop-blur-md border-t border-slate-200" />
      <div className="relative max-w-xl mx-auto px-4 py-3">
        <div className="rounded-3xl border border-slate-200 bg-white shadow-xl px-4 py-3">
          <div className="flex items-center justify-between gap-3">
            <div className="flex flex-col gap-2">
              {badge()}
              <div className="text-[11px] font-black text-slate-500 leading-4">
                {t.tip}
              </div>
            </div>

            <div className="flex items-center gap-2">
              {/* Reset */}
              <button
                type="button"
                onClick={onReset}
                disabled={saving}
                className="h-11 px-4 rounded-2xl bg-white border border-slate-200 text-slate-900 text-sm font-black hover:bg-slate-50 transition disabled:opacity-60"
              >
                {t.reset}
              </button>

              {/* Save */}
              <button
                type="button"
                onClick={onSave}
                disabled={disabled || saving}
                className={[
                  "h-11 px-5 rounded-2xl text-sm font-black transition",
                  disabled || saving
                    ? "bg-slate-200 text-slate-500 cursor-not-allowed"
                    : "bg-slate-900 text-white hover:bg-slate-800",
                ].join(" ")}
              >
                {saving ? t.saving : t.save}
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Safe spacing to avoid content hidden behind bar */}
      <div className="h-20" />
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/WeeklyDayCard.jsx">
// src/pages/barberPanel/components/WeeklyDayCard.jsx
export default function WeeklyDayCard({
  day,
  isArabic,
  value,
  error,
  expanded,
  onExpand,
  onToggleOpen,
  onChange,
}) {
  const open = value !== null;
  const title = isArabic ? day.ar : day.en || day.key;

  // ✅ حماية: لو صار open بس value ناقص لأي سبب
  const safeValue = open
    ? {
        from: value?.from ?? "09:00",
        to: value?.to ?? "17:00",
      }
    : null;

  const timeText = !open
    ? isArabic
      ? "مغلق طوال اليوم"
      : "Closed all day"
    : isArabic
      ? `من ${safeValue.from} إلى ${safeValue.to}`
      : `${safeValue.from} → ${safeValue.to}`;

  const statusChip = open
    ? isArabic
      ? "مفتوح"
      : "Open"
    : isArabic
      ? "مغلق"
      : "Closed";

  return (
    <div
      className={[
        "rounded-2xl border bg-white shadow-sm overflow-hidden",
        error ? "border-rose-300" : "border-slate-200",
      ].join(" ")}
    >
      {/* Header Row (expand only) */}
      <button
        type="button"
        onClick={onExpand}
        className="w-full px-4 py-4 flex items-center justify-between gap-3 hover:bg-slate-50 transition"
      >
        <div className="flex items-center gap-3">
          <span
            className={[
              "w-2.5 h-2.5 rounded-full",
              open ? "bg-emerald-500" : "bg-rose-500",
            ].join(" ")}
          />
          <div className="flex flex-col items-start">
            <div className="text-base font-black text-slate-900">{title}</div>
            <div className="text-sm font-bold text-slate-700 mt-1">
              {timeText}
            </div>

            {/* error short */}
            {error ? (
              <div className="text-xs font-black text-rose-700 mt-1">
                {error}
              </div>
            ) : null}
          </div>
        </div>

        <div className="flex items-center gap-2">
          <span
            className={[
              "px-2.5 py-1 rounded-full text-xs font-black border",
              open
                ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                : "bg-slate-100 text-slate-700 border-slate-200",
            ].join(" ")}
          >
            {statusChip}
          </span>

          <span className="text-slate-400 font-black text-lg leading-none">
            {expanded ? "▲" : "▼"}
          </span>
        </div>
      </button>

      {/* Expand Section */}
      {expanded ? (
        <div className="px-4 pb-4">
          {/* Toggle Open/Closed */}
          <div className="flex items-center justify-between">
            <label className="inline-flex items-center gap-2 text-sm font-black text-slate-700">
              <input
                type="checkbox"
                checked={open}
                onChange={(e) => onToggleOpen(e.target.checked)}
              />
              {isArabic ? "مفتوح" : "Open"}
            </label>

            {/* small hint */}
            <div className="text-xs font-black text-slate-500">
              {open
                ? isArabic
                  ? "اختر وقت البداية والنهاية"
                  : "Set start and end time"
                : isArabic
                  ? "هذا اليوم مغلق ولن يظهر للحجز"
                  : "This day is closed and won’t be bookable"}
            </div>
          </div>

          {/* Error banner inside edit */}
          {error ? (
            <div className="mt-3 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm font-black text-rose-800">
              ⚠️ {error}
            </div>
          ) : null}

          {/* Time Inputs */}
          <div className="mt-3 grid grid-cols-2 gap-3">
            <div>
              <div className="text-xs font-black text-slate-600 mb-1">
                {isArabic ? "من" : "From"}
              </div>
              <input
                type="time"
                step="1800"
                disabled={!open}
                value={open ? safeValue.from : ""}
                onChange={(e) => onChange({ from: e.target.value })}
                className={[
                  "w-full px-3 py-3 rounded-2xl border text-base font-black outline-none transition",
                  !open
                    ? "bg-slate-100 border-slate-200 text-slate-400"
                    : error
                      ? "bg-white border-rose-300 text-slate-900 focus:ring-2 focus:ring-rose-200"
                      : "bg-white border-slate-200 text-slate-900 focus:ring-2 focus:ring-slate-200",
                ].join(" ")}
              />
            </div>

            <div>
              <div className="text-xs font-black text-slate-600 mb-1">
                {isArabic ? "إلى" : "To"}
              </div>
              <input
                type="time"
                step="1800"
                disabled={!open}
                value={open ? safeValue.to : ""}
                onChange={(e) => onChange({ to: e.target.value })}
                className={[
                  "w-full px-3 py-3 rounded-2xl border text-base font-black outline-none transition",
                  !open
                    ? "bg-slate-100 border-slate-200 text-slate-400"
                    : error
                      ? "bg-white border-rose-300 text-slate-900 focus:ring-2 focus:ring-rose-200"
                      : "bg-white border-slate-200 text-slate-900 focus:ring-2 focus:ring-slate-200",
                ].join(" ")}
              />
            </div>
          </div>

          {/* Closed helper */}
          {!open ? (
            <div className="mt-3 text-xs font-black text-slate-500 leading-5">
              {isArabic
                ? "لفتح اليوم فعّل (مفتوح) ثم عدّل الساعات."
                : "To open this day, enable Open and set the hours."}
            </div>
          ) : null}
        </div>
      ) : null}
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/WeeklyHoursEditSheet.jsx">
// src/pages/barberPanel/components/WeeklyHoursEditSheet.jsx
import { useMemo, useState } from "react";
import WeeklyHoursEditorMobile from "./WeeklyHoursEditorMobile";
import { normalizeWeekly } from "../utils/weeklyHoursUX";

/**
 * ✅ DE-MODALIZED VERSION
 * كان هذا الملف Sheet/Modal.
 * هسا صار Inline wrapper (Card) عشان:
 * - ما نستخدم مودالات
 * - ما نخرب أي import موجود بالمشروع
 * - يضل فيه Confirm إذا في تغييرات غير محفوظة
 */
export default function WeeklyHoursEditSheet({
  isArabic,
  initialWeekly,
  onClose,
}) {
  const base = useMemo(() => normalizeWeekly(initialWeekly), [initialWeekly]);
  const [dirty, setDirty] = useState(false);

  const closeWithConfirm = () => {
    if (dirty) {
      const ok = window.confirm(
        isArabic
          ? "لديك تغييرات غير محفوظة. هل تريد الخروج بدون حفظ؟"
          : "You have unsaved changes. Leave without saving?",
      );
      if (!ok) return;
    }
    onClose?.();
  };

  return (
    <div className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
      {/* Header */}
      <div className="px-5 py-4 border-b border-slate-200 bg-white">
        <div className="flex items-start justify-between gap-3">
          <div>
            <div className="text-lg font-black text-slate-900">
              {isArabic ? "تعديل ساعات العمل الأسبوعية" : "Edit weekly hours"}
            </div>
            <div className="text-sm font-bold text-slate-600 mt-1 leading-5">
              {isArabic
                ? "عدّل الساعات ثم اضغط حفظ. يمكنك الإلغاء للرجوع بدون حفظ."
                : "Edit then press Save. You can cancel to discard changes."}
            </div>
          </div>

          {onClose ? (
            <button
              type="button"
              onClick={closeWithConfirm}
              className="h-10 px-4 rounded-2xl bg-white border border-slate-200 shadow-sm text-sm font-black hover:bg-slate-50"
            >
              {isArabic ? "إلغاء" : "Cancel"}
            </button>
          ) : null}
        </div>

        {/* Safety line */}
        <div className="mt-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-2 text-xs font-black text-slate-700">
          ℹ️{" "}
          {isArabic
            ? "لن يتم تطبيق أي تغيير إلا بعد الضغط على زر الحفظ."
            : "No change applies unless you press Save."}
        </div>
      </div>

      {/* Content */}
      <div className="px-4 pt-4 pb-4">
        <WeeklyHoursEditorMobile
          isArabic={isArabic}
          loading={false}
          initialWeekly={base}
          onDirtyChange={setDirty}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/components/WeeklyHoursReadOnly.jsx">
// src/pages/barberPanel/components/WeeklyHoursReadOnly.jsx
import { DAYS, getTodayKey, formatRange } from "../utils/weeklyHoursUX";

// ✅ Fallback لو في مشروعك لسا بيستخدم formatRangeArabic
import { formatRangeArabic as _formatRangeArabic } from "../utils/weeklyHoursUX";

function Badge({ tone = "neutral", children }) {
  const cls =
    tone === "success"
      ? "bg-emerald-50 text-emerald-800 border-emerald-200"
      : tone === "danger"
        ? "bg-rose-50 text-rose-800 border-rose-200"
        : tone === "info"
          ? "bg-sky-50 text-sky-800 border-sky-200"
          : "bg-slate-100 text-slate-700 border-slate-200";

  return (
    <span
      className={`inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-xs font-black border ${cls}`}
    >
      {children}
    </span>
  );
}

function DayRow({ dayName, isToday, rightText, open }) {
  return (
    <div
      className={[
        "rounded-2xl border border-slate-200 bg-white",
        isToday ? "ring-1 ring-slate-200 bg-slate-50" : "",
      ].join(" ")}
    >
      <div className="px-4 py-4">
        {/* ✅ 3-column grid ثابت للموبايل */}
        <div className="grid grid-cols-[auto,auto,1fr] items-center gap-3">
          {/* Day name (right in RTL) */}
          <div className="text-base font-black text-slate-900 whitespace-nowrap">
            {dayName}
          </div>

          {/* Chips (fixed width-ish) */}
          <div className="flex items-center gap-2 whitespace-nowrap">
            {isToday ? (
              <span className="px-2.5 py-1 rounded-full text-xs font-black border bg-sky-50 text-sky-800 border-sky-200">
                اليوم
              </span>
            ) : null}

            <span
              className={[
                "px-2.5 py-1 rounded-full text-xs font-black border",
                open
                  ? "bg-emerald-50 text-emerald-800 border-emerald-200"
                  : "bg-rose-50 text-rose-800 border-rose-200",
              ].join(" ")}
            >
              {open ? "مفتوح" : "مغلق"}
            </span>
          </div>

          {/* Time (takes remaining space, no ugly wrap) */}
          <div className="text-sm font-black text-slate-800 text-left truncate tabular-nums">
            {rightText}
          </div>
        </div>
      </div>
    </div>
  );
}

export default function WeeklyHoursReadOnly({
  weekly,
  loading,
  showHeader = true,
  updatedText,
  onEdit,
  onResetToDefault,
  // ✅ اختياري (لا يكسر شي لو ما انبعت)
  isArabic = true,
}) {
  const todayKey = getTodayKey();
  const todayDay = DAYS.find((d) => d.key === todayKey);
  const todayValue = weekly?.[todayKey] ?? null;

  // ✅ استخدم formatRange الجديد لو موجود، وإلا fallback للعربي القديم
  const rangeText = (v) => {
    try {
      if (typeof formatRange === "function") return formatRange(v, isArabic);
      return _formatRangeArabic(v);
    } catch {
      return _formatRangeArabic(v);
    }
  };

  const headerSubtitle = updatedText
    ? isArabic
      ? `آخر تعديل: ${updatedText}`
      : `Last edit: ${updatedText}`
    : isArabic
      ? "عدّل ساعات وأيام العمل بشكل واضح ومقصود."
      : "Set your weekly schedule clearly and intentionally.";

  return (
    <div className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
      {showHeader ? (
        <div className="px-5 py-4 border-b border-slate-200 bg-white flex items-start justify-between gap-4">
          <div>
            <div className="text-lg font-black text-slate-900">
              {isArabic ? "ساعات العمل الأسبوعية" : "Weekly working hours"}
            </div>
            <div className="text-xs font-black text-slate-500 mt-1">
              {headerSubtitle}
            </div>
          </div>

          <div className="flex items-center gap-2">
            {onResetToDefault ? (
              <button
                onClick={onResetToDefault}
                className="px-4 py-2 rounded-2xl border border-slate-200 bg-slate-50 hover:bg-slate-100 text-slate-800 text-sm font-black transition"
              >
                {isArabic ? "افتراضي" : "Default"}
              </button>
            ) : null}

            {onEdit ? (
              <button
                onClick={onEdit}
                className="px-4 py-2 rounded-2xl bg-slate-900 hover:bg-slate-800 text-white text-sm font-black transition"
              >
                {isArabic ? "تعديل" : "Edit"}
              </button>
            ) : null}
          </div>
        </div>
      ) : null}

      <div className="p-4 bg-white">
        {loading ? (
          <div className="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm font-black text-slate-600">
            {isArabic ? "جاري التحميل..." : "Loading…"}
          </div>
        ) : (
          <>
            {/* ✅ Today Summary */}
            <div className="rounded-3xl border border-slate-200 bg-slate-50 px-4 py-4 mb-4">
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-sm font-black text-slate-900">
                    {isArabic ? "ملخص اليوم" : "Today summary"}
                  </div>
                  <div className="text-xs font-black text-slate-600 mt-1">
                    {isArabic
                      ? `${todayDay?.ar ?? "اليوم"} • ${rangeText(todayValue)}`
                      : `${todayDay?.en ?? "Today"} • ${rangeText(todayValue)}`}
                  </div>
                </div>

                <Badge tone={todayValue ? "success" : "danger"}>
                  {todayValue
                    ? isArabic
                      ? "مفتوح اليوم"
                      : "Open today"
                    : isArabic
                      ? "مغلق اليوم"
                      : "Closed today"}
                </Badge>
              </div>
            </div>

            {/* Days list */}
            <div className="space-y-2">
              {DAYS.map((d) => {
                const v = weekly?.[d.key] ?? null;
                const isToday = d.key === todayKey;
                return (
                  <DayRow
                    key={d.key}
                    dayName={d.ar}
                    isToday={isToday}
                    rightText={rangeText(v)}
                    open={!!v}
                  />
                );
              })}
            </div>
          </>
        )}

        <div className="mt-4 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3">
          <div className="text-xs font-black text-slate-700 leading-5">
            ℹ️{" "}
            {isArabic
              ? "التغييرات تؤثر فقط على الحجوزات الجديدة. الحجوزات المؤكدة لا تتغير."
              : "Changes affect new bookings only. Confirmed bookings do not change."}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/WeeklyHoursPage.jsx">
// src/pages/barberPanel/WeeklyHoursPage.jsx
import { useEffect, useMemo, useState, useCallback } from "react";
import { useNavigate } from "react-router-dom";
import { useTranslation } from "react-i18next";

import barberDefaultWeeklyHours from "../../constants/barberDefaultWeeklyHours";
import WeeklyHoursReadOnly from "./components/WeeklyHoursReadOnly";
import WeeklyHoursEditorMobile from "./components/WeeklyHoursEditorMobile";
import { isRtlLang, normalizeWeekly } from "./utils/weeklyHoursUX";

import {
  ensureDefaultWeeklyHours,
  getWeeklyHoursDoc,
  resetWeeklyHoursToDefault,
} from "../../services/barberWeeklyHours";

function formatUpdatedAt(updatedAt) {
  if (!updatedAt) return null;
  try {
    const d = updatedAt.toDate ? updatedAt.toDate() : new Date(updatedAt);
    return d.toLocaleString();
  } catch {
    return null;
  }
}

export default function WeeklyHoursPage() {
  const nav = useNavigate();
  const { i18n } = useTranslation();

  const isArabic = String(i18n.language || "")
    .toLowerCase()
    .startsWith("ar");
  const rtl = isRtlLang(i18n.language);

  const [loading, setLoading] = useState(true);
  const [weekly, setWeekly] = useState(
    normalizeWeekly(barberDefaultWeeklyHours),
  );
  const [updatedAt, setUpdatedAt] = useState(null);

  // ✅ Inline Edit mode (بدون مودال)
  const [editMode, setEditMode] = useState(false);
  const [dirty, setDirty] = useState(false);

  const reloadFromServer = useCallback(async () => {
    try {
      setLoading(true);
      const ensured = await ensureDefaultWeeklyHours(barberDefaultWeeklyHours);
      const docData = await getWeeklyHoursDoc();

      const srcWeekly =
        docData?.weekly || ensured?.weekly || barberDefaultWeeklyHours;

      setWeekly(normalizeWeekly(srcWeekly));
      setUpdatedAt(docData?.updatedAt || null);
    } catch (e) {
      console.error(e);
      setWeekly(normalizeWeekly(barberDefaultWeeklyHours));
      setUpdatedAt(null);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    let alive = true;

    (async () => {
      try {
        setLoading(true);
        const ensured = await ensureDefaultWeeklyHours(
          barberDefaultWeeklyHours,
        );
        const docData = await getWeeklyHoursDoc();

        if (!alive) return;

        const srcWeekly =
          docData?.weekly || ensured?.weekly || barberDefaultWeeklyHours;

        setWeekly(normalizeWeekly(srcWeekly));
        setUpdatedAt(docData?.updatedAt || null);
      } catch (e) {
        console.error(e);
        if (!alive) return;
        setWeekly(normalizeWeekly(barberDefaultWeeklyHours));
        setUpdatedAt(null);
      } finally {
        if (alive) setLoading(false);
      }
    })();

    return () => {
      alive = false;
    };
  }, []);

  const updatedText = useMemo(() => formatUpdatedAt(updatedAt), [updatedAt]);

  // ✅ زر الرجوع لصفحة الحلاق
  const onBackToBarber = async () => {
    if (editMode && dirty) {
      const ok = window.confirm(
        isArabic
          ? "لديك تغييرات غير محفوظة. هل تريد الخروج بدون حفظ؟"
          : "You have unsaved changes. Leave without saving?",
      );
      if (!ok) return;
    }
    nav("/barber"); // عدّل المسار إذا عندك مختلف
  };

  const onResetToDefault = async () => {
    const ok = window.confirm(
      isArabic
        ? "هل تريد إرجاع ساعات العمل للوضع الافتراضي؟"
        : "Reset working hours to default?",
    );
    if (!ok) return;

    try {
      setLoading(true);
      await resetWeeklyHoursToDefault(barberDefaultWeeklyHours);
      const docData = await getWeeklyHoursDoc();
      setWeekly(normalizeWeekly(docData?.weekly || barberDefaultWeeklyHours));
      setUpdatedAt(docData?.updatedAt || null);
    } catch (e) {
      console.error(e);
      alert(
        isArabic ? "فشل الإرجاع. حاول مرة أخرى." : "Reset failed. Try again.",
      );
    } finally {
      setLoading(false);
    }
  };

  const onToggleEditMode = async () => {
    // entering edit
    if (!editMode) {
      setEditMode(true);
      setDirty(false);
      return;
    }

    // leaving edit
    if (dirty) {
      const ok = window.confirm(
        isArabic
          ? "لديك تغييرات غير محفوظة. هل تريد الخروج بدون حفظ؟"
          : "You have unsaved changes. Leave without saving?",
      );
      if (!ok) return;
    }

    setEditMode(false);
    setDirty(false);

    // ✅ Refresh بعد الخروج حتى يتحدث updatedAt + weekly في حال تم حفظ من داخل المحرر
    await reloadFromServer();
  };

  return (
    <div
      dir={rtl ? "rtl" : "ltr"}
      className="min-h-screen bg-[#f8f8f8] px-4 pt-4 pb-6"
    >
      <div className="max-w-xl mx-auto pt-24">
        {/* ✅ Premium Top Bar */}
        <div className="bg-white rounded-3xl border border-slate-200 shadow-sm p-3">
          <div className="flex items-center gap-3">
            {/* Back */}
            <button
              onClick={onBackToBarber}
              className="h-11 w-11 rounded-2xl bg-white border border-slate-200 hover:bg-slate-50 transition font-black"
              aria-label={isArabic ? "رجوع" : "Back"}
              title={isArabic ? "رجوع" : "Back"}
            >
              {rtl ? "→" : "←"}
            </button>

            {/* Title */}
            <div className="flex-1">
              <div className="text-lg font-black text-slate-900">
                {isArabic ? "ساعات العمل" : "Working hours"}
              </div>
              <div className="text-xs font-black text-slate-500 mt-0.5">
                {updatedText
                  ? isArabic
                    ? `آخر تعديل: ${updatedText}`
                    : `Last edit: ${updatedText}`
                  : "—"}
              </div>
            </div>

            {/* Secondary: Default */}
            <button
              onClick={onResetToDefault}
              disabled={loading}
              className="h-11 px-4 rounded-2xl bg-white border border-slate-200 text-slate-900 text-sm font-black hover:bg-slate-50 transition disabled:opacity-60"
            >
              {isArabic ? "افتراضي" : "Default"}
            </button>

            {/* Primary: Edit / Done */}
            <button
              onClick={onToggleEditMode}
              disabled={loading}
              className={[
                "h-11 px-4 rounded-2xl text-sm font-black transition disabled:opacity-60",
                editMode
                  ? "bg-white border border-slate-200 text-slate-900 hover:bg-slate-50"
                  : "bg-slate-900 text-white hover:bg-slate-800",
              ].join(" ")}
            >
              {editMode
                ? isArabic
                  ? "تم"
                  : "Done"
                : isArabic
                  ? "تعديل"
                  : "Edit"}
            </button>
          </div>

          {/* Tiny helper line */}
          <div className="mt-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-2 text-xs font-black text-slate-700 leading-5">
            ℹ️{" "}
            {isArabic
              ? editMode
                ? "التعديل يتم داخل نفس الصفحة. لن يُطبّق أي شيء إلا بعد الضغط على حفظ."
                : "عرض ساعات الأسبوع. اضغط تعديل للتغيير."
              : editMode
                ? "Editing inline. Nothing applies unless you press Save."
                : "Viewing weekly hours. Press Edit to change."}
          </div>
        </div>

        {/* Content */}
        <div className="mt-10">
          {!editMode ? (
            <WeeklyHoursReadOnly
              weekly={weekly}
              isArabic={isArabic}
              loading={loading}
              updatedText={updatedText}
              onEdit={() => setEditMode(true)}
              onResetToDefault={onResetToDefault}
              showHeader={false} // ✅ لا تكرار للهيدر
            />
          ) : (
            <div className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
              <div className="px-5 py-4 border-b border-slate-200 bg-white">
                <div className="text-lg font-black text-slate-900">
                  {isArabic
                    ? "تعديل ساعات العمل الأسبوعية"
                    : "Edit weekly hours"}
                </div>
                <div className="text-xs font-black text-slate-500 mt-1">
                  {isArabic
                    ? "افتح/أغلق الأيام وعدّل From/To. احفظ من الشريط السفلي."
                    : "Open/close days and adjust From/To. Save from the bottom bar."}
                </div>
              </div>

              <div className="p-4">
                <WeeklyHoursEditorMobile
                  loading={loading}
                  initialWeekly={weekly}
                  onDirtyChange={setDirty}
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/NotFound.jsx">
import { useTranslation } from "react-i18next";

function NotFound() {
  const { t } = useTranslation();

  return (
    <div className="min-h-screen bg-primary text-light flex flex-col items-center justify-center text-center px-4 font-body">
      <h1 className="text-6xl font-heading text-gold mb-4">404</h1>
      <p className="text-xl md:text-2xl mb-6">
        {t("not_found_message") || "Oops! The page you're looking for doesn't exist."}
      </p>
      <a
        href="/"
        className="bg-gold text-primary px-6 py-3 rounded-full font-semibold hover:bg-darkText hover:text-light transition"
      >
        {t("go_home") || "Go Back Home"}
      </a>
    </div>
  );
}

export default NotFound;
</file>

<file path="src/utils/dateTime.js">
// src/utils/dateTime.js
export function localYMD(d = new Date()) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

export function makeDateFromYMDHM(ymd, hhmm) {
  const [yyyy, mm, dd] = ymd.split("-").map(Number);
  const [hh, min] = hhmm.split(":").map(Number);
  return new Date(yyyy, mm - 1, dd, hh, min, 0, 0);
}

export function generateTimeSlots(from, to) {
  const slots = [];
  const [fh, fm] = from.split(":").map(Number);
  const [th, tm] = to.split(":").map(Number);
  const cur = new Date();
  cur.setHours(fh, fm, 0, 0);
  const end = new Date();
  end.setHours(th, tm, 0, 0);
  while (cur <= end) {
    slots.push(cur.toTimeString().slice(0, 5));
    cur.setMinutes(cur.getMinutes() + 30);
  }
  return slots;
}

export function getWeekdayFromYMD(ymd) {
  const [y, m, d] = ymd.split("-").map(Number);
  return new Date(y, m - 1, d).toLocaleDateString("en-US", { weekday: "long" });
}

export function getOpeningStatus(workingHours) {
  const now = new Date();
  const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
  const hours = workingHours[dayName];
  if (!hours) return "close";
  const [fh, fm] = hours.from.split(":").map(Number);
  const [th, tm] = hours.to.split(":").map(Number);
  const from = new Date();
  from.setHours(fh, fm, 0, 0);
  const to = new Date();
  to.setHours(th, tm, 0, 0);
  const mOpen = (from - now) / 60000;
  const mClose = (to - now) / 60000;
  if (now < from && mOpen <= 60 && mOpen > 0) return "opening_soon";
  if (now >= from && now <= to && mClose <= 60 && mClose > 0)
    return "closing_soon";
  if (now >= from && now < to) return "open";
  return "close";
}
</file>

<file path="src/utils/phone.js">
// src/utils/phone.js

// 1) تحويل الأرقام العربية/الفارسية إلى إنجليزية
export function normalizeDigits(str = "") {
  const map = {
    "٠": "0",
    "١": "1",
    "٢": "2",
    "٣": "3",
    "٤": "4",
    "٥": "5",
    "٦": "6",
    "٧": "7",
    "٨": "8",
    "٩": "9",
    "۰": "0",
    "۱": "1",
    "۲": "2",
    "۳": "3",
    "۴": "4",
    "۵": "5",
    "۶": "6",
    "۷": "7",
    "۸": "8",
    "۹": "9",
  };
  return String(str).replace(/[٠-٩۰-۹]/g, (d) => map[d] ?? d);
}

// 2) إزالة كل شيء عدا + والأرقام
export function stripNonPhoneChars(str = "") {
  return String(str).replace(/[^\d+]/g, "");
}

/**
 * 3) تحويل أي صيغة شائعة إلى E.164 لإسرائيل: +9725XXXXXXXX
 * يقبل: 05xxxxxxxx / 5xxxxxxxx / 9725xxxxxxxx / +9725xxxxxxxx / 00…
 */
export function toILPhoneE164(raw = "") {
  let s = normalizeDigits(raw).trim();
  s = stripNonPhoneChars(s);

  // 00 → +
  if (s.startsWith("00")) s = "+" + s.slice(2);

  // جاهز؟
  if (/^\+9725\d{8}$/.test(s)) return s;
  if (/^9725\d{8}$/.test(s)) return "+" + s;

  // 05xxxxxxxx → +9725xxxxxxxx
  if (/^05\d{8}$/.test(s)) return s.replace(/^0/, "+972");

  // 5xxxxxxxx → +9725xxxxxxxx
  if (/^5\d{8}$/.test(s)) return "+972" + s;

  // غير صالح
  return "";
}

// 4) فحص أن الناتج فعلاً رقم موبايل IL صالح
export function isILPhoneE164(p) {
  return /^\+9725\d{8}$/.test(p || "");
}

// 5) مقارنة أرقام بعد التطبيع
export function sameILPhone(a, b) {
  return toILPhoneE164(a) === toILPhoneE164(b);
}

// 6) (اختياري للعرض) تحويل E.164 إلى 05x-xxx-xxxx
export function e164ToLocalPretty(p) {
  const m = /^\+972(5\d)(\d{3})(\d{4})$/.exec(p || "");
  return m ? `0${m[1]}-${m[2]}-${m[3]}` : p || "";
}
</file>

<file path="vercel.json">
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "Cache-Control", "value": "no-cache, no-store, must-revalidate" },
        { "key": "Pragma", "value": "no-cache" },
        { "key": "Expires", "value": "0" }
      ]
    }
  ],
  "rewrites": [
    { "source": "/(.*)", "destination": "/" }
  ]
}
</file>

<file path="index.html">
<!doctype html>
<html lang="en">
  <head>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />

    <meta charset="UTF-8" />
<link rel="icon" type="image/png" href="/barber-logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Arfat Barber | Classic Cuts. Modern Vibes</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="public/firebase-messaging-sw.js">
/* global importScripts, firebase */
importScripts('https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.11.0/firebase-messaging-compat.js');

firebase.initializeApp({
  apiKey: "AIzaSyCRpZf2RKFWk7aT8rF5CEEDVkjblJg5uC8",
  authDomain: "arfatbarber.firebaseapp.com",
  projectId: "arfatbarber",
  storageBucket: "arfatbarber.appspot.com",
  messagingSenderId: "275175753990",
  appId: "1:275175753990:web:20bd913d8fef6da6c37687"
});

const messaging = firebase.messaging();

messaging.onBackgroundMessage(function(payload) {
  console.log('[firebase-messaging-sw.js] Received background message ', payload);
  self.registration.showNotification(payload.notification.title, {
    body: payload.notification.body,
    icon: '/barber-logo.png' // أيقونة اختيارية
  });
});
</file>

<file path="src/components/booking/parts/OpeningStatusCard.jsx">
// src/components/booking/parts/OpeningStatusCard.jsx
import React from "react";
import { FaClock, FaDoorOpen, FaDoorClosed } from "react-icons/fa";
import { useTranslation } from "react-i18next";

/**
 * Props:
 * - status?: { isOpen?: boolean, nextOpen?: Date }  (اختياري)
 * - workingHours: { Sunday:null|{from,to}, Monday:..., ... }
 */
export default function OpeningStatusCard({ status, workingHours }) {
  const { t, i18n } = useTranslation();
  const dir = i18n.dir();

  // ترتيب الأيام (مفاتيح كائن ساعات العمل)
  const dayKeys = [
    "Sunday",
    "Monday",
    "Tuesday",
    "Wednesday",
    "Thursday",
    "Friday",
    "Saturday",
  ];

  // أسماء الأيام من الترجمة (مصفوفة)
  const dayLabels = t("weekdays", { returnObjects: true });

  const now = new Date();
  const todayIdx = now.getDay(); // 0=Sunday
  const todayKey = dayKeys[todayIdx];
  const todayHours = workingHours?.[todayKey] || null;

  const toTodayTime = (hhmm) => {
    const [h, m] = String(hhmm || "00:00")
      .split(":")
      .map(Number);
    const d = new Date();
    d.setHours(h || 0, m || 0, 0, 0);
    return d;
  };

  // هل مفتوح الآن؟ (لو status?.isOpen موجود نستخدمه، وإلا نحسب)
  const isOpenNow =
    typeof status?.isOpen === "boolean"
      ? status.isOpen
      : (() => {
          if (!todayHours) return false;
          const from = toTodayTime(todayHours.from);
          const to = toTodayTime(todayHours.to);
          return now >= from && now <= to;
        })();

  // إغلاق اليوم (إن كان مفتوحًا)
  const closesAtText = isOpenNow && todayHours ? todayHours.to : null;

  // موعد الفتح القادم (لو مغلق الآن)
  const nextOpen = (() => {
    // لو اليوم فيه ساعات لكن قبل الفتح
    if (todayHours) {
      const from = toTodayTime(todayHours.from);
      if (now < from) return { dayIdx: todayIdx, from: todayHours.from };
    }
    // أول يوم قادم فيه ساعات
    for (let offset = 1; offset <= 7; offset++) {
      const idx = (todayIdx + offset) % 7;
      const key = dayKeys[idx];
      const hours = workingHours?.[key];
      if (hours && hours.from) return { dayIdx: idx, from: hours.from };
    }
    return null;
  })();

  const statusLine = isOpenNow
    ? {
        text: t("shop_open_now"),
        sub: closesAtText ? `${t("open_until")} ${closesAtText}` : null,
        color: "text-emerald-600",
        icon: <FaDoorOpen className="text-emerald-600" />,
      }
    : {
        text: t("shop_closed_now"),
        sub: nextOpen
          ? `${t("opens_at")} ${dayLabels?.[nextOpen.dayIdx]} ${nextOpen.from}`
          : null,
        color: "text-rose-600",
        icon: <FaDoorClosed className="text-rose-600" />,
      };

  return (
    <div
      className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
      dir={dir}
      lang={i18n.language}
    >
      {/* الرأس */}
      <div className="flex items-center gap-2 px-5 pt-4">
        <FaClock className="text-[#3B82F6]" />
        <h3 className="text-lg font-bold text-[#1F2937]">
          {t("working_hours")}
        </h3>
      </div>

      {/* سطر الحالة */}
      <div className="px-5 pb-3">
        <p
          className={`mt-1 text-sm font-semibold ${statusLine.color} flex items-center gap-2`}
        >
          {statusLine.icon}
          <span>{statusLine.text}</span>
        </p>
        {statusLine.sub && (
          <p className="text-xs text-gray-500 mt-1">{statusLine.sub}</p>
        )}
      </div>

      {/* جدول الأيام */}
      <div className="px-3 pb-4">
        <ul className="divide-y divide-gray-100 rounded-xl overflow-hidden bg-white">
          {dayKeys.map((k, i) => {
            const hours = workingHours?.[k] || null;
            const isToday = i === todayIdx;
            const closed = !hours;

            return (
              <li
                key={k}
                className={`flex items-center justify-between px-4 py-3 ${
                  isToday ? "bg-slate-50" : "bg-white"
                }`}
              >
                <span
                  className={`text-sm ${
                    isToday ? "font-semibold text-[#1F2937]" : "text-gray-600"
                  }`}
                >
                  {dayLabels?.[i]}
                </span>

                {closed ? (
                  <span className="text-sm font-semibold text-rose-600">
                    {t("closed_all_day")}
                  </span>
                ) : (
                  <span
                    className={`text-sm ${
                      isToday ? "font-semibold text-gray-700" : "text-gray-700"
                    }`}
                  >
                    {hours.from} – {hours.to}
                  </span>
                )}
              </li>
            );
          })}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="src/components/booking/parts/ProgressBar.jsx">
// src/components/booking/parts/ProgressBar.jsx
import React, { useMemo } from "react";
import {
  FaUser,
  FaPhone,
  FaCalendarAlt,
  FaClock,
  FaCut,
  FaCheck,
} from "react-icons/fa";

/**
 * مؤشر بسيط بدون أرقام/بار:
 *  - step: الخطوة النشطة (1..6)
 *  - completed: كائن بولياني لكل خطوة {name,phone,date,time,service,confirm}
 *  - labels: أسماء اختيارية تظهر من sm+
 */
export default function ProgressBar({ step = 1, completed = {}, labels }) {
  const dir = (typeof document !== "undefined" && document?.dir) || "rtl";

  const Icons = useMemo(
    () => [FaUser, FaPhone, FaCalendarAlt, FaClock, FaCut, FaCheck],
    [],
  );
  const keys = ["name", "phone", "date", "time", "service", "confirm"];
  const total = Icons.length;
  const current = Math.min(Math.max(Number(step) || 1, 1), total);

  return (
    <div className="w-full" dir={dir} aria-label="Progress steps">
      <div className="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-gray-100 rounded-t-2xl -mt-6 -mx-6 px-6 pt-6">
        <ol className="flex items-end justify-between gap-3 sm:gap-4 select-none">
          {Icons.map((Icon, idx) => {
            const idx1 = idx + 1;
            const isActive = idx1 === current;
            const isDone = Boolean(completed[keys[idx]]);

            return (
              <li key={idx1} className="flex-1">
                <div className="relative flex flex-col items-center">
                  {/* ✓ مستقلة لكل خطوة */}
                  <div
                    className={`absolute -top-3 h-5 w-5 rounded-full flex items-center justify-center text-[11px]
                    ${
                      isDone
                        ? "bg-emerald-500 text-white shadow"
                        : "bg-slate-200 text-slate-400"
                    }`}
                    title={isDone ? "مكتملة" : "غير مكتملة"}
                  >
                    ✓
                  </div>

                  <div
                    className={`h-10 w-10 rounded-full border flex items-center justify-center
                      ${
                        isActive
                          ? "border-amber-400 bg-amber-50"
                          : isDone
                            ? "border-blue-500 bg-blue-50"
                            : "border-slate-300 bg-slate-50"
                      }`}
                    aria-current={isActive ? "step" : undefined}
                  >
                    <Icon
                      className={`${
                        isActive
                          ? "text-[#1F2937]"
                          : isDone
                            ? "text-blue-600"
                            : "text-slate-500"
                      } text-lg`}
                      aria-hidden
                    />
                  </div>

                  {labels?.[idx] && (
                    <span className="hidden sm:block text-[11px] text-slate-600 mt-2 truncate max-w-[90px]">
                      {labels[idx]}
                    </span>
                  )}
                </div>
              </li>
            );
          })}
        </ol>
      </div>
    </div>
  );
}
</file>

<file path="src/components/booking/parts/ServiceSelector.jsx">
// src/components/booking/parts/ServiceSelector.jsx
import ServiceOption from "./ServiceOption";
import { useTranslation } from "react-i18next";

// ✅ نخزن فقط المعرّف والأيقونة (بدون نص ثابت)
const SERVICES = [
  { id: "haircut", icon: "haircut" },
  { id: "beard", icon: "beard" },
];

export default function ServiceSelector({ selectedService, onSelect, rtl }) {
  const { t, i18n } = useTranslation();

  // اتجاه الواجهة
  const isRTL = rtl ?? i18n.dir() === "rtl";

  return (
    <div
      className="grid gap-4"
      style={{ gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))" }}
    >
      {SERVICES.map((s) => (
        <ServiceOption
          key={s.id}
          id={s.id}
          icon={s.icon}
          selected={selectedService === s.id}
          onSelect={onSelect}
          rtl={isRTL}
          // ✅ الاسم من الترجمة
          title={t(`services.${s.id}`)}
          // (اختياري) وصف من الترجمة لو موجود
          desc={t(`services_desc.${s.id}`, { defaultValue: "" })}
        />
      ))}
    </div>
  );
}
</file>

<file path="src/i18n.js">
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

import translationEN from './translations/en.json';
import translationAR from './translations/ar.json';
import translationHE from './translations/he.json';

const resources = {
  en: { translation: translationEN },
  ar: { translation: translationAR },
  he: { translation: translationHE },
};

i18n
  .use(initReactI18next)
  .init({
    resources,
lng: localStorage.getItem("lang") || "ar",
    fallbackLng: "en",
    interpolation: { escapeValue: false },
  });

i18n.on('languageChanged', (lng) => {
  document.documentElement.dir = lng === 'ar' || lng === 'he' ? 'rtl' : 'ltr';
  document.documentElement.lang = lng;
  localStorage.setItem("lang", lng);
});

export default i18n;
</file>

<file path="src/pages/barberPanel/components/WeeklyHoursEditorMobile.jsx">
// src/pages/barberPanel/components/WeeklyHoursEditorMobile.jsx
import { useEffect, useMemo, useRef, useState } from "react";
import WeeklyDayCard from "./WeeklyDayCard";
import StickySaveBar from "./StickySaveBar";

import {
  DAYS,
  deepEqual,
  normalizeWeekly,
  validateWeekly,
} from "../utils/weeklyHours";
import {
  saveWeeklyHours,
  resetWeeklyHoursToDefault,
} from "../../../services/barberWeeklyHours";
import defaultWorkingHours from "../../../constants/workingHours";

function nowTime() {
  try {
    return new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });
  } catch {
    return new Date().toLocaleTimeString();
  }
}

function clone(obj) {
  return JSON.parse(JSON.stringify(obj));
}

export default function WeeklyHoursEditorMobile({
  loading = false,
  initialWeekly,
  onDirtyChange,
  isArabic = true, // صفحة الحلاق غالباً عربي، لكن صار قابل للتغيير
}) {
  const [weekly, setWeekly] = useState(() => normalizeWeekly(initialWeekly));
  const baseRef = useRef(normalizeWeekly(initialWeekly));

  const [expanded, setExpanded] = useState(null);
  const [saving, setSaving] = useState(false);

  const [toast, setToast] = useState("");
  const toastTimerRef = useRef(null);

  const [lastSavedAt, setLastSavedAt] = useState(null);

  // ✅ لما تتغير initialWeekly (مثلاً دخول/خروج edit mode)
  useEffect(() => {
    const n = normalizeWeekly(initialWeekly);
    setWeekly(n);
    baseRef.current = n;
    setExpanded(null);
    setLastSavedAt(null);
  }, [initialWeekly]);

  const errors = useMemo(
    () => validateWeekly(weekly, isArabic),
    [weekly, isArabic],
  );
  const hasErrors = useMemo(() => Object.keys(errors).length > 0, [errors]);

  const dirty = useMemo(() => !deepEqual(baseRef.current, weekly), [weekly]);

  useEffect(() => {
    onDirtyChange?.(dirty);
  }, [dirty, onDirtyChange]);

  // ✅ تحذير عند إغلاق التبويب وفيه تغييرات غير محفوظة
  useEffect(() => {
    const handler = (e) => {
      if (!dirty) return;
      e.preventDefault();
      e.returnValue = "";
    };
    window.addEventListener("beforeunload", handler);
    return () => window.removeEventListener("beforeunload", handler);
  }, [dirty]);

  const t = useMemo(() => {
    const ar = {
      loading: "جاري التحميل...",
      hasErrors: "يوجد أخطاء لازم تتصلّح قبل الحفظ",
      dirty: "تغييرات غير محفوظة",
      saved: "محفوظ",
      lastSaved: "آخر حفظ",
      fixErrors: "أصلح الأخطاء قبل الحفظ.",
      savedOk: "✅ تم الحفظ",
      saveFail: "❌ فشل الحفظ",
      resetConfirm: "راح نرجّع ساعات الأسبوع للوضع الافتراضي. متأكد؟",
      resetOk: "✅ تم الإرجاع",
      resetFail: "❌ فشل الإرجاع",
    };
    const en = {
      loading: "Loading…",
      hasErrors: "Fix errors before saving",
      dirty: "Unsaved changes",
      saved: "Saved",
      lastSaved: "Last saved",
      fixErrors: "Fix errors before saving.",
      savedOk: "✅ Saved",
      saveFail: "❌ Save failed",
      resetConfirm: "Reset weekly hours to default. Continue?",
      resetOk: "✅ Reset done",
      resetFail: "❌ Reset failed",
    };
    return isArabic ? ar : en;
  }, [isArabic]);

  const showToast = (msg, ms = 2200) => {
    setToast(msg);
    if (toastTimerRef.current) window.clearTimeout(toastTimerRef.current);
    toastTimerRef.current = window.setTimeout(() => setToast(""), ms);
  };

  const status = useMemo(() => {
    if (loading) return { tone: "neutral", text: t.loading };
    if (hasErrors) return { tone: "danger", text: t.hasErrors };
    if (dirty) return { tone: "warn", text: t.dirty };
    return { tone: "success", text: t.saved };
  }, [loading, hasErrors, dirty, t]);

  const onToggleDay = (dayKey, open) => {
    setWeekly((p) => {
      if (!open) return { ...p, [dayKey]: null };

      // ✅ لما نفتح يوم مغلق: استخدم الافتراضي الرسمي لنفس اليوم (أو fallback)
      const def = defaultWorkingHours?.[dayKey] ?? {
        from: "12:00",
        to: "20:00",
      };
      return { ...p, [dayKey]: def };
    });
  };

  const onChangeDay = (dayKey, patch) => {
    setWeekly((p) => {
      const cur = p[dayKey];
      if (cur === null) return p;
      return { ...p, [dayKey]: { ...cur, ...patch } };
    });
  };

  const onSave = async () => {
    if (loading || saving) return;
    if (hasErrors) {
      showToast(t.fixErrors, 2400);
      return;
    }
    if (!dirty) return;

    try {
      setSaving(true);
      await saveWeeklyHours(weekly);

      // ✅ ثبّت baseline كنسخة (مش نفس المرجع)
      const n = normalizeWeekly(clone(weekly));
      baseRef.current = n;

      setLastSavedAt(nowTime());
      showToast(t.savedOk);
    } catch (e) {
      console.error(e);
      showToast(t.saveFail, 2400);
    } finally {
      setSaving(false);
    }
  };

  const onReset = async () => {
    if (loading || saving) return;

    const ok = window.confirm(t.resetConfirm);
    if (!ok) return;

    try {
      setSaving(true);

      // ✅ يرجّع Firestore للافتراضي الرسمي
      await resetWeeklyHoursToDefault(defaultWorkingHours);

      const n = normalizeWeekly(defaultWorkingHours);
      setWeekly(n);
      baseRef.current = n;

      setLastSavedAt(nowTime());
      showToast(t.resetOk);
    } catch (e) {
      console.error(e);
      showToast(t.resetFail, 2400);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="space-y-3">
      {/* Status */}
      <div
        className={[
          "rounded-2xl border px-4 py-3 text-sm font-extrabold flex items-center justify-between",
          status.tone === "success"
            ? "bg-emerald-50 border-emerald-200 text-emerald-800"
            : status.tone === "warn"
              ? "bg-amber-50 border-amber-200 text-amber-900"
              : status.tone === "danger"
                ? "bg-rose-50 border-rose-200 text-rose-800"
                : "bg-white border-slate-200 text-slate-700",
        ].join(" ")}
      >
        <span>{status.text}</span>
        <span className="text-xs font-black text-slate-500">
          {lastSavedAt ? `${t.lastSaved}: ${lastSavedAt}` : " "}
        </span>
      </div>

      {/* Days */}
      <div className="space-y-2 pb-60">
        {DAYS.map((d) => (
          <WeeklyDayCard
            key={d.key}
            day={{
              ...d,
              // ✅ لو بدك إنجليزي، وفره هنا بدون ما نكسر الكود القديم
              en: d.en || d.key,
            }}
            isArabic={isArabic}
            value={weekly[d.key]}
            error={errors[d.key]}
            expanded={expanded === d.key}
            onExpand={() => setExpanded((x) => (x === d.key ? null : d.key))}
            onToggleOpen={(open) => onToggleDay(d.key, open)}
            onChange={(patch) => onChangeDay(d.key, patch)}
          />
        ))}
      </div>

      {/* Toast */}
      {toast ? (
        <div className="fixed left-1/2 -translate-x-1/2 bottom-24 z-20">
          <div className="rounded-2xl bg-slate-900 text-white px-4 py-2 text-sm font-extrabold shadow-xl">
            {toast}
          </div>
        </div>
      ) : null}

      {/* Sticky Save */}
      <StickySaveBar
        isArabic={isArabic}
        disabled={loading || saving || !dirty || hasErrors}
        saving={saving}
        dirty={dirty}
        hasErrors={hasErrors}
        onSave={onSave}
        onReset={onReset}
      />
    </div>
  );
}
</file>

<file path="src/pages/barberPanel/utils/weeklyHoursUX.js">
// src/pages/barberPanel/utils/weeklyHoursUX.js

export const DAYS = [
  { key: "Sunday", ar: "الأحد", en: "Sunday" },
  { key: "Monday", ar: "الإثنين", en: "Monday" },
  { key: "Tuesday", ar: "الثلاثاء", en: "Tuesday" },
  { key: "Wednesday", ar: "الأربعاء", en: "Wednesday" },
  { key: "Thursday", ar: "الخميس", en: "Thursday" },
  { key: "Friday", ar: "الجمعة", en: "Friday" },
  { key: "Saturday", ar: "السبت", en: "Saturday" },
];

// ✅ RTL حسب اللغة، مش ثابت
export function isRtlLang(lang = "") {
  const l = String(lang || "").toLowerCase();
  return (
    l.startsWith("ar") ||
    l.startsWith("he") ||
    l.startsWith("fa") ||
    l.startsWith("ur")
  );
}

export function deepEqual(a, b) {
  return JSON.stringify(a) === JSON.stringify(b);
}

export function normalizeWeekly(weekly) {
  const out = {};
  for (const d of DAYS) out[d.key] = weekly?.[d.key] ?? null;
  return out;
}

function isHHmm(v) {
  return typeof v === "string" && /^\d{2}:\d{2}$/.test(v);
}

function toMinutes(hhmm) {
  const [h, m] = String(hhmm)
    .split(":")
    .map((x) => parseInt(x, 10));
  return h * 60 + m;
}

function msg(isArabic, ar, en) {
  return isArabic ? ar : en;
}

// ✅ bilingual validate
export function validateWeekly(weekly, isArabic = true) {
  const errors = {};
  for (const d of DAYS) {
    const v = weekly?.[d.key] ?? null;
    if (v === null) continue;

    if (!isHHmm(v.from) || !isHHmm(v.to)) {
      errors[d.key] = msg(
        isArabic,
        "صيغة الوقت لازم تكون HH:mm",
        "Time format must be HH:mm",
      );
      continue;
    }
    if (!(toMinutes(v.from) < toMinutes(v.to))) {
      errors[d.key] = msg(
        isArabic,
        '"من" لازم تكون قبل "إلى"',
        '"From" must be before "To"',
      );
      continue;
    }
  }
  return errors;
}

// ✅ range format (general)
export function formatRange(v, isArabic = true) {
  if (!v) return msg(isArabic, "مغلق طوال اليوم", "Closed all day");
  return isArabic ? `من ${v.from} إلى ${v.to}` : `${v.from} → ${v.to}`;
}

// backward compatibility
export function formatRangeArabic(v) {
  return formatRange(v, true);
}

export function getTodayKey() {
  const map = [
    "Sunday",
    "Monday",
    "Tuesday",
    "Wednesday",
    "Thursday",
    "Friday",
    "Saturday",
  ];
  return map[new Date().getDay()];
}
</file>

<file path="src/pages/BlockedPhones.jsx">
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import {
  collection,
  getDocs,
  deleteDoc,
  doc,
  setDoc,
} from "firebase/firestore";
import { db } from "../firebase";
import {
  toILPhoneE164,
  isILPhoneE164,
  e164ToLocalPretty,
} from "../utils/phone";

export default function BlockedPhones() {
  const navigate = useNavigate();
  const [blockedPhones, setBlockedPhones] = useState([]);
  const [newPhone, setNewPhone] = useState("");
  const [error, setError] = useState("");
  const [info, setInfo] = useState("");

  const fetchBlockedPhones = async () => {
    const snapshot = await getDocs(collection(db, "blockedPhones"));
    const phones = snapshot.docs.map((d) => ({ number: d.id }));
    setBlockedPhones(phones);
  };

  useEffect(() => {
    fetchBlockedPhones();
  }, []);

  const addPhone = async () => {
    setError("");
    setInfo("");

    const p = toILPhoneE164(newPhone.trim());
    if (!isILPhoneE164(p)) {
      setError("أدخل رقمًا صالحًا بصيغة 05XXXXXXXX أو +9725XXXXXXXX.");
      return;
    }

    await setDoc(doc(db, "blockedPhones", p), { blockedAt: Date.now() });
    setNewPhone("");
    setInfo("تم حظر الرقم بنجاح.");
    fetchBlockedPhones();
  };

  const removePhone = async (phone) => {
    setError("");
    setInfo("");
    await deleteDoc(doc(db, "blockedPhones", phone));
    setInfo("تم فك الحظر عن الرقم.");
    fetchBlockedPhones();
  };

  return (
    <div className="min-h-screen bg-gray-100 pt-24 px-4" dir="rtl">
      <div className="max-w-3xl mx-auto">
        {/* الكارد الرئيسي */}
        <div className="bg-white shadow-xl rounded-2xl border border-gray-200 p-8">
          {/* العنوان + الرجوع */}
          <div className="flex flex-row-reverse items-center justify-between mb-6">
            <button
              onClick={() => navigate(-1)}
              className="text-sm flex items-center gap-1 text-gray-600 hover:text-gray-800 transition"
            >
              <span className="text-lg">←</span> الرجوع
            </button>

            <div className="flex items-center gap-2">
              <span className="text-3xl">📵</span>
              <div>
                <h1 className="text-xl font-semibold text-gray-900">
                  الأرقام المحظورة
                </h1>
                <p className="text-xs text-gray-500">
                  إدارة الأرقام الممنوعة من الحجز
                </p>
              </div>
            </div>
          </div>

          {/* إضافة رقم */}
          <div className="bg-gray-50 border border-gray-200 rounded-xl p-5 mb-6">
            <label className="block text-sm font-medium mb-2 text-gray-700">
              إضافة رقم جديد إلى قائمة الحظر
            </label>

            <div className="flex flex-col md:flex-row gap-3">
              <input
                type="tel"
                placeholder="05X-XXXXXXX أو +9725XXXXXXXX"
                value={newPhone}
                onChange={(e) => setNewPhone(e.target.value)}
                className="flex-1 border border-gray-300 rounded-lg bg-white px-3 py-2 text-sm focus:ring-2 focus:ring-red-400 focus:border-red-400 outline-none"
              />
              <button
                onClick={addPhone}
                disabled={!newPhone.trim()}
                className="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg text-sm font-semibold transition disabled:opacity-60 disabled:cursor-not-allowed"
              >
                إضافة
              </button>
            </div>

            {error && (
              <p className="mt-2 text-xs text-red-600 flex items-center gap-1">
                ⚠️ {error}
              </p>
            )}

            {info && !error && (
              <p className="mt-2 text-xs text-emerald-600 flex items-center gap-1">
                ✅ {info}
              </p>
            )}
          </div>

          {/* الأرقام المحظورة */}
          {blockedPhones.length === 0 ? (
            <div className="text-center py-10 text-gray-500">
              <div className="text-4xl mb-2">😌</div>
              لا يوجد أرقام محظورة حاليًا.
            </div>
          ) : (
            <>
              <div className="text-xs text-gray-600 mb-3">
                عدد الأرقام المحظورة:{" "}
                <span className="font-semibold text-gray-800">
                  {blockedPhones.length}
                </span>
              </div>

              <ul className="space-y-3">
                {blockedPhones.map((item) => (
                  <li
                    key={item.number}
                    className="flex items-center justify-between bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm"
                  >
                    <span className="font-mono text-gray-900">
                      {e164ToLocalPretty(item.number)}
                    </span>

                    <button
                      onClick={() => removePhone(item.number)}
                      className="text-red-600 hover:text-red-700 hover:underline text-xs font-medium"
                    >
                      فك الحظر
                    </button>
                  </li>
                ))}
              </ul>
            </>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Login.jsx">
// src/pages/Login.jsx

import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { useTranslation } from "react-i18next";
import { db } from "../firebase";
import { collection, query, where, getDocs } from "firebase/firestore";

export default function Login() {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  const handleLogin = async (e) => {
    e.preventDefault();
    setError("");

    if (!username || !password) {
      setError(t("fill_required_fields") || "يرجى تعبئة جميع الحقول");
      return;
    }

    try {
      const q = query(collection(db, "users"), where("username", "==", username));
      const querySnapshot = await getDocs(q);

      if (querySnapshot.empty) {
        setError(t("wrong_username_or_password") || "اسم المستخدم أو كلمة المرور خاطئة");
        return;
      }

      let userDoc;
      querySnapshot.forEach((doc) => {
        userDoc = doc.data();
      });

      if (userDoc.password === password) {
        localStorage.setItem("barberUser", JSON.stringify({ username: userDoc.username }));
        navigate("/barber");
      } else {
        setError(t("wrong_username_or_password") || "اسم المستخدم أو كلمة المرور خاطئة");
      }
    } catch (err) {
      console.error(err);
      setError(t("login_error") || "حدث خطأ أثناء تسجيل الدخول");
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center px-4">
      {/* Spacer للهيدر الثابت */}
      <div className="h-16"></div>

      <div className="w-full max-w-sm bg-white rounded-2xl shadow-lg p-6">
        <h2 className="text-2xl font-semibold text-center text-gray-800 mb-6">
          {t("login") || "دخول"}
        </h2>

        {error && (
          <p className="text-red-600 text-sm mb-4 text-center">{error}</p>
        )}

        <form onSubmit={handleLogin} className="space-y-4">
          <input
            type="text"
            placeholder={t("username") || "اسم المستخدم"}
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            className="
              w-full bg-gray-50 border border-gray-300
              rounded-lg px-4 py-3
              focus:outline-none focus:ring-2 focus:ring-gold
              transition
            "
            required
          />

          <input
            type="password"
            placeholder={t("enter_password") || "كلمة المرور"}
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="
              w-full bg-gray-50 border border-gray-300
              rounded-lg px-4 py-3
              focus:outline-none focus:ring-2 focus:ring-gold
              transition
            "
            required
          />

          <button
            type="submit"
            className="
              w-full bg-gold text-white font-medium
              py-3 rounded-lg
              hover:bg-yellow-600 transition-colors
            "
          >
            {t("login") || "دخول"}
          </button>
          
        </form>
      </div>
    </div>
  );
}
</file>

<file path="src/services/bookingService.js">
// src/services/bookingService.js
import { db } from "../firebase";
import {
  doc,
  getDoc,
  collection,
  addDoc,
  serverTimestamp,
  query,
  where,
  getDocs,
  setDoc,
  increment,
  runTransaction,
} from "firebase/firestore";

import { toILPhoneE164 } from "../utils/phone";

// يوم محجوب بالكامل؟
export async function fetchBlockedDay(dateYMD) {
  const snap = await getDoc(doc(db, "blockedDays", dateYMD));
  return snap.exists();
}

// أوقات محجوبة لليوم
export async function fetchBlockedTimes(dateYMD) {
  const snap = await getDoc(doc(db, "blockedTimes", dateYMD));
  return snap.exists() ? snap.data().times || [] : [];
}

// حجوزات فعّالة لليوم
export async function fetchActiveBookingsByDate(dateYMD) {
  const q = query(
    collection(db, "bookings"),
    where("selectedDate", "==", dateYMD),
  );
  const snap = await getDocs(q);

  // ✅ تعديل آمن: رجّع id كمان (مفيد للإدارة/الإشعارات لاحقًا)
  return snap.docs
    .map((d) => ({ id: d.id, ...d.data() }))
    .filter((b) => !b.cancelledAt);
}

// رقم محظور؟ (E.164)
export async function isPhoneBlocked(inputPhone) {
  const phoneE164 = toILPhoneE164(inputPhone);
  const snap = await getDoc(doc(db, "blockedPhones", phoneE164));
  return snap.exists();
}

// هل له حجوزات سابقة؟ (E.164)
export async function hasExistingBookings(inputPhone) {
  const phoneE164 = toILPhoneE164(inputPhone);
  const q = query(
    collection(db, "bookings"),
    where("phoneNumber", "==", phoneE164),
  );
  const snap = await getDocs(q);
  return !snap.empty;
}

// تضارب على نفس التاريخ/الوقت؟
export async function hasActiveConflict(dateYMD, hhmm) {
  const q = query(
    collection(db, "bookings"),
    where("selectedDate", "==", dateYMD),
    where("selectedTime", "==", hhmm),
  );
  const snap = await getDocs(q);
  return snap.docs.map((d) => d.data()).some((b) => !b.cancelledAt);
}

// إنشاء الحجز + محاولة تحديث عدّاد الشهر (بدون ما نخرب الحجز لو فشل العداد)
export async function createBooking(payload) {
  // 1) احفظ الحجز (هذا هو الأهم)
  const ref = await addDoc(collection(db, "bookings"), {
    ...payload,
    cancelledAt: payload?.cancelledAt ?? null, // تأكيد وجوده
    createdAt: serverTimestamp(),
  });

  // 2) حاول حدّث العداد (إذا فشل ما نوقف المستخدم)
  try {
    const monthKey = String(payload?.selectedDate || "").slice(0, 7); // YYYY-MM
    if (!monthKey || monthKey.length !== 7) return ref.id;

    const monthRef = doc(db, "statsMonthly", monthKey);

    // total = عدد الحجوزات الفعّالة للشهر (Active)
    await setDoc(
      monthRef,
      { total: increment(1), updatedAt: serverTimestamp() },
      { merge: true },
    );
  } catch (err) {
    console.warn("statsMonthly increment failed (ignored):", err);
    // لا نرمي خطأ عشان ما نخرب تجربة الحجز
  }

  // ✅ جديد: رجّع bookingId (مفيد للإشعارات/الإدارة لاحقًا)
  return ref.id;
}

/**
 * إلغاء حجز: ينقص العداد فقط إذا الحجز كان فعّال (مش ملغي).
 * لازم تمرّر bookingId (doc id).
 */
export async function cancelBooking(bookingId) {
  const bookingRef = doc(db, "bookings", bookingId);

  try {
    await runTransaction(db, async (tx) => {
      const snap = await tx.get(bookingRef);
      if (!snap.exists()) throw new Error("Booking not found");

      const b = snap.data();

      // إذا ملغي أصلاً: لا تعمل شي (عشان ما ينقص مرتين)
      if (b.cancelledAt) return;

      const monthKey = String(b.selectedDate || "").slice(0, 7); // YYYY-MM
      if (!monthKey || monthKey.length !== 7) {
        // نلغي الحجز بدون ما نلمس العداد إذا الداتا ناقصة
        tx.update(bookingRef, { cancelledAt: serverTimestamp() });
        return;
      }

      const monthRef = doc(db, "statsMonthly", monthKey);

      // 1) علّم الحجز كملغي
      tx.update(bookingRef, { cancelledAt: serverTimestamp() });

      // 2) أنقص العداد الفعّال
      tx.set(
        monthRef,
        { total: increment(-1), updatedAt: serverTimestamp() },
        { merge: true },
      );
    });
  } catch (err) {
    // مهم: لو فشل الترانزاكشن، لا تسكت… لأنه ممكن يضل العداد غلط
    console.error("cancelBooking failed:", err);
    throw err;
  }
}
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: {
    extend: {
      fontFamily: {
        heading: ["Playfair Display", "serif"],
        body: ["Inter", "sans-serif"],
        ar: ["Cairo", "sans-serif"],
        tajawal: ["Tajawal", "sans-serif"],
        notokufi: ["Noto Kufi Arabic", "sans-serif"],
      },

      colors: {
        primary: "#1a1a1a", // 🖤 أسود ناعم راقٍ (خلفيات)
        beige: "#f0e6d2", // 🤍 بيج فخم (خلفيات فاتحة)
        gold: "#bfa063", // ✨ ذهبي فاخر (عناوين وأزرار بارزة)
        light: "#ffffff", // أبيض للنصوص على خلفية داكنة
        darkText: "#333333", // رمادي غامق للنصوص على بيج
      },

      // ✨ هون أضفنا الأنيميشن
      keyframes: {
        fadeInUp: {
          "0%": { opacity: 0, transform: "translateY(20px)" },
          "100%": { opacity: 1, transform: "translateY(0)" },
        },
        pulseGlow: {
          "0%, 100%": {
            transform: "scale(1)",
            boxShadow: "0 0 0 0 rgba(191, 160, 99, 0.7)",
          },
          "50%": {
            transform: "scale(1.05)",
            boxShadow: "0 0 20px 5px rgba(191, 160, 99, 0.5)",
          },
        },
      },
      animation: {
        fadeInUp: "fadeInUp 0.5s ease-out forwards",
        pulseGlow: "pulseGlow 1.5s infinite",
      },
    },
  },
  plugins: [],
};
</file>

<file path="src/components/booking/parts/SuccessModal.jsx">
// src/components/booking/SuccessModal.jsx
import { useState } from "react";

export default function SuccessModal({ visible, onClose, code, t }) {
  const [copied, setCopied] = useState(false);
  if (!visible) return null;

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(code);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch {
      // تجاهل بهدوء
    }
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm"
      onClick={onClose}
    >
      <div
        className="relative bg-white border border-green-400 text-green-700 px-6 py-8 rounded-2xl text-center text-lg flex flex-col items-center gap-4 shadow-2xl max-w-sm w-full mx-4"
        onClick={(e) => e.stopPropagation()}
      >
        <button
          onClick={onClose}
          className="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-xl font-bold"
          aria-label="إغلاق"
        >
          ×
        </button>

        <div className="text-xl font-bold">✅ {t("thank_you")}</div>

        <div className="bg-green-100 border border-dashed border-green-500 px-4 py-2 rounded-lg text-base font-semibold text-gray-800 flex items-center gap-2">
          🔐 {t("your_code")}: <span className="font-mono">{code}</span>
          <button
            onClick={handleCopy}
            className="ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition"
          >
            {copied ? "✅ تم النسخ!" : "نسخ"}
          </button>
        </div>

        <p className="text-sm text-gray-600">
          احتفظ بهذا الكود لتعديل أو إلغاء الحجز لاحقًا.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/components/home/ContactSection.jsx">
import { useTranslation } from "react-i18next";
import {
  FaInstagram,
  FaFacebook,
  FaTiktok,
  FaPhone,
} from "react-icons/fa";
import { SiWaze } from "react-icons/si"; // ✅ أيقونة Waze

function Footer() {
  const { t } = useTranslation();

  return (
    <footer className="bg-primary text-light text-center px-6 py-12 font-body">
      <div className="max-w-7xl mx-auto space-y-6">
        <h2 className="text-3xl md:text-4xl font-heading font-bold text-gold">
          {t("contact") || "Contact Us"}
        </h2>

        {/* ✅ الموقع مع رابط Waze */}
        <a
          href="https://waze.com/ul?ll=32.93047,35.27657&navigate=yes"
          target="_blank"
          rel="noopener noreferrer"
          className="flex items-center justify-center gap-2 text-gold hover:text-white transition text-lg"
        >
          <SiWaze size={22} className="text-gold" />
          {t("address") || "Ba'aneh - Ghaddara Street"}
        </a>

        {/* ✅ رقم الهاتف */}
        <a
          href="tel:+972549896985"
          className="flex items-center justify-center gap-2 text-gold hover:text-white transition text-lg"
        >
          <FaPhone size={20} />
          +972 54-989-6985
        </a>

        {/* ✅ أيقونات السوشيال ميديا */}
        <div className="flex justify-center gap-4">
          <a
            href="https://www.instagram.com/arafat_barber/"
            target="_blank"
            rel="noreferrer"
            className="w-10 h-10 flex items-center justify-center border-2 border-gold rounded-full text-gold hover:bg-gold hover:text-primary transition"
          >
            <FaInstagram size={20} />
          </a>
          <a
            href="https://facebook.com"
            target="_blank"
            rel="noreferrer"
            className="w-10 h-10 flex items-center justify-center border-2 border-gold rounded-full text-gold hover:bg-gold hover:text-primary transition"
          >
            <FaFacebook size={20} />
          </a>
          <a
            href="https://www.tiktok.com/@arfatbarber"
            target="_blank"
            rel="noreferrer"
            className="w-10 h-10 flex items-center justify-center border-2 border-gold rounded-full text-gold hover:bg-gold hover:text-primary transition"
          >
            <FaTiktok size={20} />
          </a>
        </div>

        {/* الحقوق */}
        <div className="text-xs text-gray-400 mt-6">
          <p>
            © {new Date().getFullYear()} Arfat Barber. {t("all_rights")}
          </p>
          <p className="text-gold">{t("footer_note")}</p>
        </div>
      </div>
    </footer>
  );
}

export default Footer;
</file>

<file path="src/components/home/HeroSection.jsx">
import { useTranslation } from "react-i18next";
import { useEffect } from "react";
import AOS from "aos";
import "aos/dist/aos.css";

function HeroSection() {
  const { t } = useTranslation();

  useEffect(() => {
    AOS.init({ duration: 1000 });
  }, []);

  const smoothScrollTo = (id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  const onCheckClick = (e) => {
    e.preventDefault();
    smoothScrollTo("check-booking");
  };

  const onBookClick = (e) => {
    e.preventDefault();
    smoothScrollTo("booking");
  };

  return (
    <section className="relative w-full h-screen overflow-hidden flex items-center justify-center">
      {/* الصورة الكاملة */}
      <img
        src="/barber-hero.jpg"
        alt="Barber Hero"
        className="absolute inset-0 w-full h-full object-cover object-center z-0"
      />

      {/* طبقة تعتيم */}
      <div className="absolute inset-0 bg-black bg-opacity-60 z-10"></div>

      {/* النص */}
      <div
        className="relative z-20 text-center px-4 max-w-2xl"
        data-aos="fade-up"
      >
        <h1 className="font-notokufi text-5xl md:text-6xl font-extrabold mb-4 leading-tight tracking-tight text-gold">
          {t("hero_title") || "أسلوب يليق بك، بكل بساطة"}
        </h1>

        <p className="text-lg md:text-xl mb-6 font-tajawal text-beige max-w-xl mx-auto">
          {t("hero_subtitle") || "لمحة مُظهرك، يناسبك ويعبر عنك"}
        </p>

        {/* Primary CTA */}
        <a
          href="#booking"
          onClick={onBookClick}
          className="inline-flex items-center justify-center bg-gold hover:bg-yellow-400 text-primary font-semibold px-6 py-3 rounded shadow-md transition focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-gold"
        >
          {t("book_now") || "Book Now"}
        </a>

        {/* Secondary CTA (Perfect: lightweight + doesn’t compete) */}
        <div className="mt-3">
          <a
            href="#check-booking"
            onClick={onCheckClick}
            className="inline-flex items-center gap-2 text-sm font-tajawal font-semibold text-beige/90 hover:text-gold transition underline underline-offset-4 decoration-white/30 hover:decoration-gold/60 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-gold rounded"
            aria-label={t("check_booking") || "تحقق من الحجز"}
          >
            <span aria-hidden="true">↓</span>
            <span>{t("check_booking") || "تحقق من الحجز"}</span>
          </a>

          {/* سطر ثقة صغير (اختياري، بس حلو جدًا للموبايل) */}
        </div>
      </div>
    </section>
  );
}

export default HeroSection;
</file>

<file path="src/firebase.js">
// ✅ firebase.js

import { initializeApp } from "firebase/app";
import { getFirestore } from "firebase/firestore";
import { getAuth } from "firebase/auth";

// ✅ هذا التكوين مأخوذ من إعدادات Firebase الرسمية
const firebaseConfig = {
  apiKey: "AIzaSyCRpZf2RKFWk7aT8rF5CEEDVkjblJg5uC8",
  authDomain: "arfatbarber.firebaseapp.com",
  projectId: "arfatbarber",
  storageBucket: "arfatbarber.appspot.com", // ✅ تصحيح هنا
  messagingSenderId: "275175753990",
  appId: "1:275175753990:web:20bd913d8fef6da6c37687",
  measurementId: "G-5SK9SHENGX"
};

// ✅ تهيئة التطبيق
const app = initializeApp(firebaseConfig);

// ✅ خدمات Firebase
export const db = getFirestore(app);
export const auth = getAuth(app);
export { app };
</file>

<file path="src/pages/barberPanel/BarberPanel.jsx">
// src/pages/barberPanel/BarberPanel.jsx
import { useEffect, useMemo, useState } from "react";
import { useTranslation } from "react-i18next";
import { useNavigate, Link, useLocation } from "react-router-dom";
import NotificationTestCard from "./components/NotificationTestCard";

// ✅ fallback workingHours — إذا ما في بيانات من Firestore
import fallbackWorkingHours from "../../components/booking/workingHours";

// ✅ Firestore weekly hours (SYNC بين الزبون والحلاق)
import useWeeklyWorkingHours from "../../hooks/useWeeklyWorkingHours";

// utils slots (مصدر واحد للحقيقة)
import { generateSlots30Min, applyExtraSlots } from "../../utils/slots";
import { todayYMD, getWeekdayNameEN } from "./utils/dates";

// hooks
import useBookingsLive from "./hooks/useBookingsLive";
import useBlockedDay from "./hooks/useBlockedDay";
import useBlockedTimes from "./hooks/useBlockedTimes";
import useLimitOnePerDaySetting from "./hooks/useLimitOnePerDaySetting";
import useSlotExtrasLive from "./hooks/useSlotExtrasLive";

// components
import DateDropdown from "./components/DateDropdown";
import TimesGrid from "./components/TimesGrid";
import ExtraSlotsCard from "./components/ExtraSlotsCard";
import RecentBookingsCard from "./components/RecentBookingsCard";
import LimitOnePerDayCard from "./components/LimitOnePerDayCard";

export default function BarberPanel() {
  const { t, i18n } = useTranslation();
  const navigate = useNavigate();
  const { pathname } = useLocation();

  const isArabic = i18n.language === "ar";
  const fontClass = isArabic ? "font-ar" : "font-body";

  const [selectedDate, setSelectedDate] = useState("");
  const [statusMessage, setStatusMessage] = useState("");

  // نطاق تطبيق extraSlots
  const [applyMode, setApplyMode] = useState("THIS_DATE"); // THIS_DATE | SAME_WEEKDAY_UNTIL | EVERY_DAY_UNTIL
  const [applyUntil, setApplyUntil] = useState("");

  // ✅ weekly hours live (SYNC)
  const { weeklyHours, loadingWeekly } = useWeeklyWorkingHours({ live: true });
  const workingHours = weeklyHours || fallbackWorkingHours;

  // bookings live
  const { bookings, activeBookings, recentBookings } = useBookingsLive();

  // day block
  const { isDayBlocked, loadingBlock, toggleDay } = useBlockedDay(selectedDate);

  // blocked times
  const { blockedTimes, selectedTimes, handleToggleTime, handleApplyBlock } =
    useBlockedTimes({ selectedDate, bookings, setStatusMessage });

  // settings
  const {
    limitOnePerDay,
    loadingSettings,
    savingSettings,
    toggleLimitOnePerDay,
  } = useLimitOnePerDaySetting();

  // slotExtras live (SYNC)
  const { extraSlots, loadingExtras, savingExtras, applyExtraSlotsChange } =
    useSlotExtrasLive({ selectedDate, workingHours, activeBookings });

  // ====== auto logout ======
  useEffect(() => {
    let timer;

    const resetTimer = () => {
      if (timer) clearTimeout(timer);
      timer = setTimeout(
        () => {
          localStorage.removeItem("barberUser");
          alert("⚠️ تم تسجيل الخروج بسبب عدم النشاط لمدة ساعتين.");
          navigate("/login");
        },
        2 * 60 * 60 * 1000,
      );
    };

    resetTimer();
    const handleActivity = () => resetTimer();

    window.addEventListener("click", handleActivity);
    window.addEventListener("keydown", handleActivity);

    return () => {
      clearTimeout(timer);
      window.removeEventListener("click", handleActivity);
      window.removeEventListener("keydown", handleActivity);
    };
  }, [navigate]);

  // ====== times grid: workingHours + extraSlots ======
  const timesForBarberGrid = useMemo(() => {
    if (!selectedDate) return [];
    const weekday = getWeekdayNameEN(selectedDate);
    const hours = workingHours?.[weekday] || null;
    if (!hours?.from || !hours?.to) return [];
    const base = generateSlots30Min(hours.from, hours.to);
    return applyExtraSlots(base, extraSlots);
  }, [selectedDate, extraSlots, workingHours]);

  const isToday = selectedDate && selectedDate === todayYMD();

  const gridTimesFiltered = useMemo(() => {
    if (!timesForBarberGrid.length) return [];
    if (!isToday) return timesForBarberGrid;
    const now = new Date();
    return timesForBarberGrid.filter(
      (time) => new Date(`${selectedDate}T${time}:00`) > now,
    );
  }, [timesForBarberGrid, isToday, selectedDate]);

  const dayIsClosedByHours = useMemo(() => {
    if (!selectedDate) return false;
    const weekday = getWeekdayNameEN(selectedDate);
    const hours = workingHours?.[weekday] || null;
    return !hours?.from || !hours?.to;
  }, [selectedDate, workingHours]);

  // ====== Header Buttons (موبايل-أول) ======
  const isActive = (to) =>
    pathname === to || (to !== "/" && pathname.startsWith(to + "/"));

  const navBtnClass = (active, tone = "normal") => {
    const base =
      "px-4 py-2 rounded-full text-sm font-black transition border whitespace-nowrap";
    if (tone === "danger") {
      return [
        base,
        active
          ? "bg-rose-600 text-white border-rose-600 shadow"
          : "bg-white text-rose-700 border-rose-200 hover:bg-rose-50",
      ].join(" ");
    }
    return [
      base,
      active
        ? "bg-emerald-600 text-white border-emerald-600 shadow"
        : "bg-white text-slate-800 border-slate-200 hover:bg-slate-50",
    ].join(" ");
  };

  const handleLogout = () => {
    if (window.confirm("هل أنت متأكد أنك تريد تسجيل الخروج؟")) {
      localStorage.removeItem("barberUser");
      navigate("/login");
    }
  };

  return (
    <div
      className={`min-h-screen bg-gray-100 p-4 sm:p-6 ${fontClass}`}
      dir="rtl"
    >
      <div className="h-12 sm:h-16" />

      <div className="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
        {/* Header */}
        <div className="bg-white px-5 sm:px-8 py-5 border-b">
          <div className="flex items-start justify-between gap-4">
            <div>
              <h1 className="text-2xl sm:text-3xl font-black text-gray-800">
                إدارة الساعات
              </h1>
              <p className="text-xs sm:text-sm text-gray-500 font-semibold mt-1">
                كل شيء واضح وسريع — اختار تاريخ واشتغل مباشرة.
              </p>
            </div>

            {/* حالة سريعة (اختياري) */}
            <div className="text-xs font-black text-gray-500">
              {loadingWeekly ? "جاري مزامنة ساعات الأسبوع..." : " "}
            </div>
          </div>

          {/* أزرار الإدارة: سكرول أفقي للموبايل */}
          <div className="mt-4 -mx-1 px-1">
            <div className="flex items-center gap-2 overflow-x-auto pb-1">
              <button
                onClick={() => navigate("/admin-bookings")}
                className={navBtnClass(isActive("/admin-bookings"))}
              >
                لوحة الحجوزات
              </button>

              <button
                onClick={() => navigate("/barber/weekly-hours")}
                className={navBtnClass(isActive("/barber/weekly-hours"))}
              >
                ساعات العمل الأسبوعية
              </button>
              <button
                onClick={() => navigate("/barber/reviews")}
                className={navBtnClass(isActive("/barber/reviews"))}
              >
                إدارة التقييمات
              </button>

              <Link
                to="/blocked-phones"
                className={navBtnClass(isActive("/blocked-phones"))}
              >
                الأرقام المحظورة
              </Link>

              <button
                onClick={() => navigate("/dashboard")}
                className={navBtnClass(isActive("/dashboard"))}
              >
                الإحصائيات
              </button>

              <button
                onClick={handleLogout}
                className={navBtnClass(false, "danger")}
              >
                تسجيل الخروج
              </button>
            </div>
          </div>
        </div>
        {/* 🔔 Notification Test (Barber) */}
        <div className="px-5 sm:px-8 py-6 border-b bg-gray-50">
          <NotificationTestCard />
        </div>
        {/* Date */}
        <div className="p-5 sm:p-8">
          <label className="block mb-3 text-lg font-black text-gray-700">
            اختر التاريخ
          </label>

          {/* خلي تجربة الاختيار سهلة للموبايل */}
          <div className="space-y-3">
            <DateDropdown
              selectedDate={selectedDate}
              onChange={setSelectedDate}
            />

            <input
              type="date"
              value={selectedDate}
              onChange={(e) => setSelectedDate(e.target.value)}
              className="w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-50 text-gray-800 focus:outline-none focus:ring-2 focus:ring-emerald-300 transition"
              min={new Date().toISOString().split("T")[0]}
            />
          </div>

          {!selectedDate && (
            <p className="mt-3 text-sm text-gray-500 font-semibold">
              اختر تاريخ لتظهر لك ساعات اليوم وتعديلات الحظر والإضافات.
            </p>
          )}

          {/* حالة اليوم */}
          {selectedDate && (
            <div className="mt-5 rounded-2xl border border-gray-200 bg-white p-4">
              <div className="flex items-center justify-between gap-4">
                <div>
                  <div className="text-sm font-black text-gray-800">
                    حالة اليوم
                  </div>
                  <div className="text-xs font-black mt-1">
                    {dayIsClosedByHours ? (
                      <span className="text-rose-600">
                        مغلق حسب ساعات الأسبوع (عدّل من صفحة ساعات العمل
                        الأسبوعية)
                      </span>
                    ) : isDayBlocked ? (
                      <span className="text-rose-600">
                        معطّل بالكامل (تم تعطيله يدويًا)
                      </span>
                    ) : (
                      <span className="text-emerald-700">مفتوح</span>
                    )}
                  </div>
                </div>

                <button
                  onClick={toggleDay}
                  disabled={loadingBlock || dayIsClosedByHours}
                  className={[
                    "px-4 py-2 rounded-xl text-white font-black transition",
                    dayIsClosedByHours
                      ? "bg-gray-300 cursor-not-allowed"
                      : isDayBlocked
                        ? "bg-rose-600 hover:bg-rose-700"
                        : "bg-emerald-600 hover:bg-emerald-700",
                  ].join(" ")}
                >
                  {loadingBlock
                    ? "جاري..."
                    : dayIsClosedByHours
                      ? "اليوم مغلق"
                      : isDayBlocked
                        ? "تفعيل اليوم"
                        : "تعطيل اليوم"}
                </button>
              </div>
            </div>
          )}

          {selectedDate && dayIsClosedByHours && (
            <div className="mt-4 rounded-2xl border border-rose-200 bg-rose-50 p-4">
              <div className="text-sm font-black text-rose-700">
                هذا اليوم مغلق حسب ساعات الأسبوع.
              </div>
              <div className="text-xs font-black text-rose-700/80 mt-1">
                إذا بدك تفتحه: روح على “ساعات العمل الأسبوعية” وعدّل هذا اليوم.
              </div>
            </div>
          )}
        </div>

        {/* Times */}
        {selectedDate && !dayIsClosedByHours && !isDayBlocked && (
          <div className="p-5 sm:p-8 pt-4 border-t bg-gray-50">
            <h2 className="text-xl font-black text-gray-800 mb-3">
              الأوقات (مطابقة للزبون)
            </h2>

            <TimesGrid
              times={gridTimesFiltered}
              selectedDate={selectedDate}
              bookings={bookings}
              blockedTimes={blockedTimes}
              selectedTimes={selectedTimes}
              onToggleTime={handleToggleTime}
            />

            <div className="mt-4">
              {selectedTimes.length > 0 ? (
                <button
                  onClick={handleApplyBlock}
                  className="w-full bg-rose-600 text-white py-3 rounded-xl font-black hover:bg-rose-700 transition-colors focus:outline-none focus:ring-2 focus:ring-rose-300"
                >
                  {t("remove_selected_times") ||
                    "تطبيق الحظر على الساعات المحددة"}
                </button>
              ) : (
                <p className="text-sm text-gray-500 font-semibold">
                  اختر ساعة أو أكثر ثم اضغط لحظرها.
                </p>
              )}
            </div>
          </div>
        )}

        {selectedDate && isDayBlocked && (
          <div className="p-5 sm:p-8 pt-4 border-t bg-yellow-50 text-center text-rose-700 font-black text-base">
            تم تعطيل هذا اليوم بالكامل. لا يمكن تعديل أو حظر الساعات حتى يتم
            تفعيله من جديد.
          </div>
        )}

        {/* Extra Slots */}
        {selectedDate && !dayIsClosedByHours && !isDayBlocked && (
          <div className="px-5 sm:px-8 pb-8">
            <ExtraSlotsCard
              selectedDate={selectedDate}
              extraSlots={extraSlots}
              loadingExtras={loadingExtras}
              savingExtras={savingExtras}
              applyMode={applyMode}
              setApplyMode={setApplyMode}
              applyUntil={applyUntil}
              setApplyUntil={setApplyUntil}
              onApply={(nextValue) =>
                applyExtraSlotsChange({
                  nextValue,
                  applyMode,
                  applyUntil,
                  setStatusMessage,
                  selectedDate,
                })
              }
            />
          </div>
        )}

        {statusMessage && (
          <div className="p-4 bg-emerald-100 border border-emerald-300 text-emerald-800 text-center font-black">
            {statusMessage}
          </div>
        )}
      </div>

      {/* Recent */}
      <RecentBookingsCard recentBookings={recentBookings} />

      {/* Limit one per day */}
      <LimitOnePerDayCard
        limitOnePerDay={limitOnePerDay}
        loadingSettings={loadingSettings}
        savingSettings={savingSettings}
        onToggle={toggleLimitOnePerDay}
      />
    </div>
  );
}
</file>

<file path="src/pages/Contact.jsx">
import { useEffect } from "react";
import { useTranslation } from "react-i18next";
import {
  FaWhatsapp,
  FaPhone,
  FaEnvelope,
  FaInstagram,
  FaFacebook,
  FaTiktok,
} from "react-icons/fa";
import AOS from "aos";
import "aos/dist/aos.css";

function Contact() {
  const { t } = useTranslation();

 useEffect(() => {
  AOS.init({
    duration: 1000,
    once: true,
  });
}, []);


  return (
    <section className="min-h-screen bg-primary text-light px-6 py-20 font-body">
      <div className="max-w-4xl mx-auto text-center">
        <h1 className="text-4xl font-heading text-gold mb-8" data-aos="fade-up">
          {t("contact") || "Contact Us"}
        </h1>

        {/* الخريطة */}
        <div data-aos="fade-up" className="mb-10 rounded-xl overflow-hidden shadow-xl">
          <iframe
            title="Location"
            src="https://www.google.com/maps/embed?pb=!1m17!1m12!1m3!1d3392.888281731437!2d35.27657307554316!3d32.930468874419614!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x151d3c2b896e621d%3A0x6162a13ac8997f60!2zMzLCsDU1JzQ5LjciTiAzNcKwMTYnMzUuNyJF!5e0!3m2!1sen!2sil!4v1716391693450!5m2!1sen!2sil"
            width="100%"
            height="350"
            style={{ border: 0 }}
            allowFullScreen=""
            loading="lazy"
            className="rounded-xl"
          ></iframe>
        </div>

        {/* أزرار تواصل مباشرة */}
        <div className="grid md:grid-cols-3 gap-6 mb-12" data-aos="fade-up" data-aos-delay="100">
          <a
            href="https://wa.me/972549896985"
            target="_blank"
            rel="noopener noreferrer"
            className="bg-gold text-primary hover:bg-darkText hover:text-light py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-300 shadow"
          >
            <FaWhatsapp /> WhatsApp
          </a>
          <a
            href="tel:+972549896985"
            className="bg-gold text-primary hover:bg-darkText hover:text-light py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-300 shadow"
          >
            <FaPhone /> {t("call") || "Call"}
          </a>
          <a
            href="mailto:info@arfatbarber.com"
            className="bg-gold text-primary hover:bg-darkText hover:text-light py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all duration-300 shadow"
          >
            <FaEnvelope /> {t("email") || "Email"}
          </a>
        </div>

        {/* سوشيال ميديا */}
        <div
          className="flex justify-center gap-4 text-gold"
          data-aos="fade-up"
          data-aos-delay="200"
        >
          <a
            href="https://www.instagram.com/arafat_barber/"
            target="_blank"
            rel="noreferrer"
            className="w-10 h-10 flex items-center justify-center border-2 border-gold rounded-full hover:bg-gold hover:text-primary transition"
          >
            <FaInstagram size={20} />
          </a>
          <a
            href="https://facebook.com"
            target="_blank"
            rel="noreferrer"
            className="w-10 h-10 flex items-center justify-center border-2 border-gold rounded-full hover:bg-gold hover:text-primary transition"
          >
            <FaFacebook size={20} />
          </a>
          <a
            href="https://www.tiktok.com/@arfatbarber"
            target="_blank"
            rel="noreferrer"
            className="w-10 h-10 flex items-center justify-center border-2 border-gold rounded-full hover:bg-gold hover:text-primary transition"
          >
            <FaTiktok size={20} />
          </a>
        </div>
      </div>
    </section>
  );
}

export default Contact;
</file>

<file path="src/components/booking/CheckReservation.jsx">
// src/components/booking/CheckReservation.jsx
import { useState } from "react";
import { collection, query, where, getDocs } from "firebase/firestore";
import { db } from "../../firebase";
import { useTranslation } from "react-i18next";
import SectionTitle from "../common/SectionTitle";
import {
  toILPhoneE164,
  isILPhoneE164,
  e164ToLocalPretty,
} from "../../utils/phone";
import {
  Phone,
  CalendarDays,
  Clock3,
  Scissors,
  ShieldCheck,
} from "lucide-react";

function InfoRow({ label, value, icon }) {
  return (
    <div
      className="bg-gray-50 border border-gray-200 rounded-2xl p-4 flex flex-col gap-1 text-right"
      dir="rtl"
    >
      <div className="text-xs text-gray-500 flex flex-row-reverse items-center gap-2">
        {icon}
        <span>{label}</span>
      </div>
      <div className="text-sm font-bold text-gray-900">{value || "-"}</div>
    </div>
  );
}

export default function CheckReservation() {
  const [phone, setPhone] = useState("");
  const [results, setResults] = useState([]);
  const [notFound, setNotFound] = useState(false);
  const [loading, setLoading] = useState(false);
  const { t } = useTranslation();

  const handleCheck = async () => {
    setResults([]);
    setNotFound(false);
    if (!phone) return;

    const p = toILPhoneE164(phone);
    if (!isILPhoneE164(p)) {
      setNotFound(true);
      return;
    }

    setLoading(true);
    try {
      const qy = query(
        collection(db, "bookings"),
        where("phoneNumber", "==", p),
        where("bookingCode", "!=", ""),
      );
      const querySnapshot = await getDocs(qy);

      if (querySnapshot.empty) {
        setNotFound(true);
      } else {
        const data = querySnapshot.docs
          .map((doc) => ({ id: doc.id, ...doc.data() }))
          .filter(
            (doc) =>
              doc.fullName &&
              doc.selectedDate &&
              doc.selectedTime &&
              doc.bookingCode,
          );

        setResults(data);
      }
    } catch (error) {
      console.error("Error fetching bookings:", error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <section className="bg-beige py-12 px-4 font-body">
      <div className="max-w-2xl mx-auto">
        <SectionTitle icon="🔎">
          {t("check_booking") || "تحقق من الحجز"}
        </SectionTitle>

        <p className="text-center text-sm text-gray-600 mt-2">
          أدخل رقم هاتفك لعرض حجوزاتك. احتفظ بالكود لأنه مهم للتحقق أو الإلغاء.
        </p>

        {/* Card */}
        <div
          className="mt-6 rounded-3xl border border-gray-200 bg-white p-6 shadow-sm"
          dir="rtl"
        >
          {/* Header mini */}
          <div className="flex flex-row-reverse items-center justify-between gap-3 mb-4">
            <div className="flex flex-row-reverse items-center gap-2">
              <ShieldCheck className="w-5 h-5 opacity-70" />
              <span className="font-extrabold text-gray-900">متابعة الحجز</span>
            </div>
            <span className="px-3 py-1 text-xs rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700">
              خطوة 1
            </span>
          </div>

          {/* Phone input */}
          <div className="space-y-2">
            <label className="block text-sm font-semibold text-gray-800">
              {t("phone") || "رقم الهاتف"}
            </label>

            <div className="relative">
              <span className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">
                <Phone className="w-4 h-4" />
              </span>

              <input
                type="tel"
                placeholder="مثال: 05X-XXXXXXX"
                className="w-full border border-gray-300 rounded-2xl pr-11 pl-4 py-3 text-right shadow-sm focus:ring-2 focus:ring-gold bg-white"
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
              />
            </div>

            <button
              onClick={handleCheck}
              disabled={loading || !phone}
              className={`w-full mt-2 bg-gold text-primary py-3 rounded-2xl font-extrabold transition ${
                loading || !phone
                  ? "opacity-60 cursor-not-allowed"
                  : "hover:bg-darkText hover:text-light"
              }`}
            >
              {loading
                ? t("loading") || "جارٍ التحقق..."
                : t("check") || "تحقق"}
            </button>

            {notFound && (
              <div className="mt-3 rounded-2xl border border-rose-200 bg-rose-50 p-4 text-right text-rose-700">
                {t("no_booking_found") ||
                  "لا يوجد حجوزات لهذا الرقم (أو الرقم غير صحيح)."}
              </div>
            )}
          </div>
        </div>

        {/* Results */}
        {results.length > 0 && (
          <div className="mt-6 space-y-4">
            {results.map((r) => (
              <div
                key={r.id}
                className="rounded-3xl border border-gray-200 bg-white p-6 shadow-sm"
                dir="rtl"
              >
                <div className="flex flex-row-reverse justify-between items-start mb-4">
                  <div className="text-right">
                    <div className="text-lg font-extrabold text-gray-900">
                      {r.fullName}
                    </div>
                    <div className="text-sm text-gray-700 mt-1">
                      {e164ToLocalPretty(r.phoneNumber)}
                    </div>
                  </div>
                  <span className="px-3 py-1 text-xs rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700">
                    حجز
                  </span>
                </div>

                <div className="grid grid-cols-1 gap-3">
                  <InfoRow
                    label="الخدمة"
                    value={r.selectedService}
                    icon={<Scissors className="w-4 h-4 opacity-70" />}
                  />
                  <InfoRow
                    label="الساعة"
                    value={r.selectedTime}
                    icon={<Clock3 className="w-4 h-4 opacity-70" />}
                  />
                  <InfoRow
                    label="التاريخ"
                    value={r.selectedDate}
                    icon={<CalendarDays className="w-4 h-4 opacity-70" />}
                  />
                </div>

                <div className="mt-4 rounded-2xl border border-gray-200 bg-gray-50 p-4 text-right">
                  <div className="text-xs text-gray-500 mb-1">🔐 كود الحجز</div>
                  <div className="text-xl font-black font-mono tracking-widest text-gray-900">
                    {r.bookingCode || "-"}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="src/hooks/useAvailableTimes.js">
// src/hooks/useAvailableTimes.js
import { useEffect, useMemo, useState } from "react";
import { db } from "../firebase";
import { collection, doc, onSnapshot, query, where } from "firebase/firestore";

import { generateSlots30Min, applyExtraSlots, safeInt } from "../utils/slots";

function toDateAt(ymd, hhmm) {
  try {
    return new Date(`${ymd}T${hhmm}:00`);
  } catch {
    return null;
  }
}

export default function useAvailableTimes(selectedDate, workingHours) {
  const [availableTimes, setAvailableTimes] = useState([]);
  const [isDayBlocked, setIsDayBlocked] = useState(false);
  const [loadingTimes, setLoadingTimes] = useState(false);

  useEffect(() => {
    // ✅ لا تاريخ -> فاضي
    if (!selectedDate) {
      setAvailableTimes([]);
      setIsDayBlocked(false);
      setLoadingTimes(false);
      return;
    }

    // ✅ لو ساعات الأسبوع لسه مش جاهزة (Firestore لسه بجيبها)
    if (!workingHours || typeof workingHours !== "object") {
      setAvailableTimes([]);
      setIsDayBlocked(false);
      setLoadingTimes(false);
      return;
    }

    setLoadingTimes(true);

    // 1) listeners state
    let dayBlocked = false;
    let blockedTimesArr = [];
    let extraSlots = 0;
    let bookedSet = new Set();

    const recompute = () => {
      try {
        // ساعات الدوام حسب اليوم
        const d = new Date(`${selectedDate}T00:00:00`);
        const weekday = d.toLocaleDateString("en-US", { weekday: "long" });
        const hours = workingHours?.[weekday] || null;

        // ✅ اليوم مغلق (يا إمّا محظور أو ما في ساعات)
        if (dayBlocked || !hours?.from || !hours?.to) {
          setIsDayBlocked(dayBlocked || !hours?.from || !hours?.to);
          setAvailableTimes([]);
          setLoadingTimes(false);
          return;
        }

        setIsDayBlocked(false);

        const baseSlots = generateSlots30Min(hours.from, hours.to);
        const slots = applyExtraSlots(baseSlots, extraSlots);

        const now = new Date();
        const todayStr = now.toLocaleDateString("sv-SE"); // YYYY-MM-DD
        const isToday = selectedDate === todayStr;

        const blockedSet = new Set(blockedTimesArr);

        const finalSlots = slots.filter((t) => {
          if (blockedSet.has(t)) return false;
          if (bookedSet.has(t)) return false;

          if (isToday) {
            const dt = toDateAt(selectedDate, t);
            if (!dt) return false;
            return dt > now;
          }
          return true;
        });

        setAvailableTimes(finalSlots);
        setLoadingTimes(false);
      } catch (e) {
        console.error("recompute error:", e);
        setIsDayBlocked(false);
        setAvailableTimes([]);
        setLoadingTimes(false);
      }
    };

    // 2) blockedDays realtime
    const unsubDay = onSnapshot(
      doc(db, "blockedDays", selectedDate),
      (snap) => {
        dayBlocked = snap.exists();
        recompute();
      },
      (err) => {
        console.error("blockedDays snapshot error:", err);
        dayBlocked = false;
        recompute();
      }
    );

    // 3) blockedTimes realtime
    const unsubTimes = onSnapshot(
      doc(db, "blockedTimes", selectedDate),
      (snap) => {
        const times =
          snap.exists() && Array.isArray(snap.data()?.times)
            ? snap.data().times
            : [];
        blockedTimesArr = times;
        recompute();
      },
      (err) => {
        console.error("blockedTimes snapshot error:", err);
        blockedTimesArr = [];
        recompute();
      }
    );

    // 4) slotExtras realtime
    const unsubExtras = onSnapshot(
      doc(db, "slotExtras", selectedDate),
      (snap) => {
        extraSlots = snap.exists() ? safeInt(snap.data()?.extraSlots, 0) : 0;
        recompute();
      },
      (err) => {
        console.error("slotExtras snapshot error:", err);
        extraSlots = 0;
        recompute();
      }
    );

    // 5) bookings realtime (لنفس التاريخ)
    const qBookings = query(
      collection(db, "bookings"),
      where("selectedDate", "==", selectedDate)
    );

    const unsubBookings = onSnapshot(
      qBookings,
      (snap) => {
        const s = new Set();
        snap.docs.forEach((d) => {
          const b = d.data();
          if (!b?.cancelledAt && b?.selectedTime) s.add(b.selectedTime);
        });
        bookedSet = s;
        recompute();
      },
      (err) => {
        console.error("bookings snapshot error:", err);
        bookedSet = new Set();
        recompute();
      }
    );

    // initial compute (لو snapshots تأخرت لحظة)
    recompute();

    return () => {
      unsubDay();
      unsubTimes();
      unsubExtras();
      unsubBookings();
    };
  }, [selectedDate, workingHours]);

  return useMemo(
    () => ({ availableTimes, isDayBlocked, loadingTimes }),
    [availableTimes, isDayBlocked, loadingTimes]
  );
}
</file>

<file path="src/App.jsx">
// ✅ App.jsx بعد تعديل حماية FCM
import Header from "./components/layout/Header";
import AppRoutes from "./routes";
import "./i18n";
import { useTranslation } from "react-i18next";
import FloatingWhatsappButton from "./components/layout/FloatingWhatsappButton";
import { useEffect } from "react";
import { getMessaging, getToken, onMessage } from "firebase/messaging";
import { app } from "./firebase";

function App() {
  const { i18n } = useTranslation();
  const isArabic = i18n.language === "ar";
  const fontClass = isArabic ? "font-ar" : "font-body";

  useEffect(() => {
    // ✅ تأكد إن المتصفح يدعم الإشعارات
    if (!("Notification" in window)) return;

    try {
      const messaging = getMessaging(app);

      Notification.requestPermission()
        .then((permission) => {
          if (permission === "granted") {
            return getToken(messaging, {
              vapidKey:
                "BMSKYpj6OfL2RinVjw4jUNlL-Hbi1Ev4eiTibIKlvFwqSULUm42ricVJRcKbptmiepuDbl3andf-F2tf7Cmr-U8",
            });
          }
        })
        .then((currentToken) => {
          if (currentToken) {
            console.log("✅ Token:", currentToken);
          }
        })
        .catch((err) => {
          console.warn("🔒 FCM error:", err);
        });

      // ✅ استقبال الإشعار في حال كان المستخدم يفتح الموقع
      onMessage(messaging, (payload) => {
        alert(`${payload.notification.title}\n${payload.notification.body}`);
      });
    } catch (e) {
      console.warn("🔴 FCM Init error", e);
    }
  }, []);

  return (
    <div className={`${fontClass} min-h-screen`}>
      <Header />
      <AppRoutes />
      <FloatingWhatsappButton />
    </div>
  );
}

export default App;
</file>

<file path="src/components/home/InstagramSlider.jsx">
import { useTranslation } from "react-i18next";
import { useState, useEffect } from "react";
import { Swiper, SwiperSlide } from "swiper/react";
import { Autoplay, Thumbs } from "swiper/modules";
import SectionTitle from "../common/SectionTitle";

import AOS from "aos";
import "aos/dist/aos.css";

import "swiper/css";
import "swiper/css/thumbs";
import "swiper/css/autoplay";

const images = [
  "/cuts/p1.jpg",
  "/cuts/p2.jpg",
  "/cuts/p3.jpg",
  "/cuts/p4.jpg",
  "/cuts/p5.jpg",
  "/cuts/p6.jpg",
  "/cuts/p8.jpg",
  "/cuts/p9.jpg",
  "/cuts/p10.jpg",
  "/cuts/p11.jpg",
];

function InstagramSlider() {
  const [thumbsSwiper, setThumbsSwiper] = useState(null);
  const { t } = useTranslation();

  useEffect(() => {
    AOS.init({ duration: 900, once: true });
  }, []);

  return (
    <section className="relative bg-[#f8f6f1] py-20 px-4 md:px-16 text-center overflow-hidden">
      {/* ديكور خفيف جداً (يعطي حياة بدون ما يزعج) */}
      <div className="pointer-events-none absolute inset-0">
        <div className="absolute -top-24 -left-24 w-72 h-72 rounded-full bg-gold/10 blur-3xl" />
        <div className="absolute -bottom-24 -right-24 w-72 h-72 rounded-full bg-gold/10 blur-3xl" />
      </div>

      <div
        className="relative max-w-5xl mx-auto bg-white/90 backdrop-blur rounded-3xl shadow-lg p-8 md:p-12 border border-gold/10 transition-transform duration-300 hover:-translate-y-1"
        data-aos="fade-up"
      >
        <SectionTitle>{t("slider_title") || "قصّات من لمساتنا"}</SectionTitle>

        <div className="rounded-2xl overflow-hidden shadow-md ring-1 ring-black/5">
          <Swiper
            modules={[Autoplay, Thumbs]}
            thumbs={{ swiper: thumbsSwiper }}
            autoplay={{ delay: 3000, disableOnInteraction: false }}
            loop={true}
            spaceBetween={10}
            speed={1100}
            grabCursor={true}
          >
            {images.map((src, i) => (
              <SwiperSlide key={i}>
                <img
                  src={src}
                  alt={`cut-${i}`}
                  className="w-full h-[420px] md:h-[450px] object-cover transition-transform duration-700 ease-in-out hover:scale-105"
                />
              </SwiperSlide>
            ))}
          </Swiper>
        </div>

        <div className="mt-6">
          <Swiper
            modules={[Thumbs]}
            onSwiper={setThumbsSwiper}
            slidesPerView={5}
            spaceBetween={10}
            watchSlidesProgress
          >
            {images.map((src, i) => (
              <SwiperSlide key={i}>
                <img
                  src={src}
                  alt={`thumb-${i}`}
                  className="w-full h-20 object-cover rounded-xl border border-transparent hover:border-gold/70 transition-all duration-300 cursor-pointer ring-1 ring-black/5"
                />
              </SwiperSlide>
            ))}
          </Swiper>
        </div>
      </div>
    </section>
  );
}

export default InstagramSlider;
</file>

<file path="src/components/layout/Footer.jsx">
import { useTranslation } from "react-i18next";
import {
  FaInstagram,
  FaFacebook,
  FaTiktok,
  FaPhone,
} from "react-icons/fa";
import { SiWaze } from "react-icons/si";

function Footer() {
  const { t } = useTranslation();

  return (
    <footer className="bg-primary text-light pt-16 pb-8 px-6 text-sm font-body relative">
      <div className="max-w-7xl mx-auto text-center space-y-6">
        {/* عنوان تواصل معنا */}
        <h2 className="text-2xl md:text-3xl font-notokufi font-extrabold text-gold tracking-tight leading-snug">
  {t("contact") || "تواصل معنا"}
</h2>

        {/* الموقع ورقم الهاتف */}
        <div className="space-y-2 text-gold text-lg font-semibold">
          <a
            href="https://waze.com/ul?ll=32.93047,35.27657&navigate=yes"
            target="_blank"
            rel="noopener noreferrer"
            className="flex justify-center items-center gap-2 hover:text-white transition"
          >
            <SiWaze size={20} />
            {t("address") || "البعنة - شارع غدارة"}
          </a>

          <a
            href="tel:+972549896985"
            className="flex justify-center items-center gap-2 hover:text-white transition"
          >
            <FaPhone size={18} />
            +972 54-989-6985
          </a>
        </div>

        {/* أيقونات السوشيال */}
        <div className="flex justify-center gap-4 mt-4">
          <a
            href="https://www.instagram.com/arafat_barber/"
            target="_blank"
            rel="noreferrer"
            className="w-11 h-11 flex items-center justify-center border-2 border-gold rounded-full text-gold hover:bg-gold hover:text-primary transition"
          >
            <FaInstagram size={20} />
          </a>
          <a
            href="https://facebook.com"
            target="_blank"
            rel="noreferrer"
            className="w-11 h-11 flex items-center justify-center border-2 border-gold rounded-full text-gold hover:bg-gold hover:text-primary transition"
          >
            <FaFacebook size={20} />
          </a>
          <a
            href="https://www.tiktok.com/@arfatbarber"
            target="_blank"
            rel="noreferrer"
            className="w-11 h-11 flex items-center justify-center border-2 border-gold rounded-full text-gold hover:bg-gold hover:text-primary transition"
          >
            <FaTiktok size={20} />
          </a>
        </div>

        {/* الحقوق */}
        <div className="text-center text-sm mt-6 space-y-1 text-light">
          <p>© 2025 Arfat Barber. {t("all_rights")}</p>
        </div>
      </div>

      {/* رابط صفحة الحلاق - ثابت أسفل اليسار */}
      <a
        href="/barber"
        className="absolute bottom-2 left-6 text-gold text-lg font-heading font-bold hover:text-white transition"
        title="دخول صفحة الحلاق"
      >
        Arfat Barber
      </a>
    </footer>
  );
}

export default Footer;
</file>

<file path="package.json">
{
  "name": "my-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "@fontsource/cairo": "^5.2.5",
    "@fontsource/inter": "^5.2.5",
    "@fontsource/playfair-display": "^5.2.5",
    "@fontsource/poppins": "^5.2.6",
    "aos": "^2.3.4",
    "date-fns": "^4.1.0",
    "firebase": "^11.8.1",
    "firebase-admin": "^13.6.0",
    "framer-motion": "^12.23.12",
    "i18next": "^25.1.3",
    "i18next-browser-languagedetector": "^8.1.0",
    "lucide-react": "^0.540.0",
    "react": "^19.1.0",
    "react-calendar": "^6.0.0",
    "react-datepicker": "^8.3.0",
    "react-dom": "^19.1.0",
    "react-i18next": "^15.5.1",
    "react-icons": "^5.5.0",
    "react-router-dom": "^7.6.0",
    "swiper": "^11.2.6",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@eslint/js": "^9.25.0",
    "@types/react": "^19.1.2",
    "@types/react-dom": "^19.1.2",
    "@vitejs/plugin-react": "^4.4.1",
    "autoprefixer": "^10.4.14",
    "eslint": "^9.25.0",
    "eslint-plugin-react-hooks": "^5.2.0",
    "eslint-plugin-react-refresh": "^0.4.19",
    "globals": "^16.0.0",
    "postcss": "^8.4.21",
    "tailwindcss": "^3.3.2",
    "vite": "^6.3.5"
  }
}
</file>

<file path="src/components/layout/Header.jsx">
// ✅ src/components/layout/Header.jsx — UX ممتاز + اللغات ظاهرة دائمًا
import { useTranslation } from "react-i18next";
import LanguageSwitcher from "./LanguageSwitcher";
import { Link, useLocation } from "react-router-dom";
import { useEffect, useRef, useState } from "react";
import logo from "../../assets/arfatblacklogo.png";

function Header() {
  const { t, i18n } = useTranslation();
  const isArabic = i18n.language === "ar";
  const fontClass = isArabic ? "font-tajawal" : "font-heading";

  const [menuOpen, setMenuOpen] = useState(false);
  const location = useLocation();
  const menuRef = useRef(null);
  const buttonRef = useRef(null);
  const headerRef = useRef(null);

  // أغلق القائمة عند تغيّر المسار
  useEffect(() => {
    setMenuOpen(false);
  }, [location.pathname]);
  // ✅ خزّن ارتفاع الهيدر كـ CSS variable عشان أي sticky تحت الهيدر يشتغل صح
  useEffect(() => {
    const applyHeaderHeight = () => {
      const h = headerRef.current?.offsetHeight || 72;
      document.documentElement.style.setProperty("--app-header-h", `${h}px`);
    };

    applyHeaderHeight();

    // لو الهيدر تغيّر بسبب ريسبونسف/فونت/لغة
    window.addEventListener("resize", applyHeaderHeight);

    return () => window.removeEventListener("resize", applyHeaderHeight);
  }, [i18n.language]);

  // قفل تمرير الصفحة + Esc + ضغط خارج القائمة
  useEffect(() => {
    const prevOverflow = document.body.style.overflow;

    if (menuOpen) document.body.style.overflow = "hidden";
    else document.body.style.overflow = prevOverflow || "";

    const onKeyDown = (e) => {
      if (e.key === "Escape") setMenuOpen(false);
    };

    const onClickOutside = (e) => {
      if (!menuRef.current) return;
      const isInsideMenu = menuRef.current.contains(e.target);
      const isOnButton = buttonRef.current?.contains(e.target);
      if (menuOpen && !isInsideMenu && !isOnButton) setMenuOpen(false);
    };

    document.addEventListener("keydown", onKeyDown);
    document.addEventListener("click", onClickOutside);

    return () => {
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("click", onClickOutside);
      document.body.style.overflow = prevOverflow || "";
    };
  }, [menuOpen]);

  const linkClass = (to) =>
    `hover:text-gold transition ${
      location.pathname === to ? "text-gold font-semibold" : ""
    }`;

  return (
    <header
      ref={headerRef}
      className={`bg-primary text-light shadow-md fixed top-0 left-0 w-full z-50 ${fontClass}`}
      role="banner"
    >
      <a
        href="#main"
        className="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-gold text-primary px-3 py-2 rounded-md"
      >
        {isArabic ? "تخطَّ إلى المحتوى" : "Skip to content"}
      </a>

      <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between relative">
        {/* الشعار */}
        <Link
          to="/"
          className="flex items-center gap-3 text-2xl md:text-3xl font-notokufi font-bold tracking-tight text-gold"
          aria-label="Arfat Barber - Home"
        >
          <img
            src={logo}
            alt="Arfat Barber Logo"
            className="w-10 h-10 md:w-12 md:h-12 object-contain rounded-full"
            loading="eager"
            fetchPriority="high"
          />
          Arfat Barber
        </Link>

        {/* روابط سطح المكتب */}
        <nav
          className="hidden md:flex gap-x-10 items-center text-lg font-tajawal font-medium tracking-wide px-2"
          aria-label={isArabic ? "التنقل الرئيسي" : "Main navigation"}
        >
          <Link to="/" className={linkClass("/")}>
            {t("home")}
          </Link>

          {/* <a href="#services" className="hover:text-gold transition">{t("services")}</a> */}

          <Link to="/contact" className={linkClass("/contact")}>
            {t("contact")}
          </Link>
        </nav>

        {/* يمين سطح المكتب: احجز الآن + اللغات */}
        <div className="hidden md:flex items-center gap-4">
          <Link
            to="/?scrollTo=booking"
            className="bg-gold text-primary font-tajawal font-bold px-4 py-2 rounded-xl shadow-sm hover:bg-darkText hover:text-light transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-gold"
          >
            {t("book_now")}
          </Link>
          <LanguageSwitcher />
        </div>

        {/* يمين الموبايل: اللغات ظاهرة دائمًا + زر القائمة */}
        <div className="md:hidden flex items-center gap-3">
          <LanguageSwitcher />

          {/* ← تبقى ظاهرة حتى لو القائمة مسكّرة */}
          <button
            ref={buttonRef}
            onClick={() => setMenuOpen((v) => !v)}
            className="focus:outline-none rounded-md p-2"
            aria-label={
              menuOpen
                ? isArabic
                  ? "إغلاق القائمة"
                  : "Close menu"
                : isArabic
                  ? "فتح القائمة"
                  : "Open menu"
            }
            aria-expanded={menuOpen}
            aria-controls="mobile-menu"
          >
            <span className="sr-only">{menuOpen ? "Close" : "Open"}</span>
            <div className="w-6 h-6 relative" aria-hidden="true">
              <span
                className={`absolute left-0 top-1 w-6 h-0.5 bg-light transition-transform ${
                  menuOpen ? "rotate-45 translate-y-2" : ""
                }`}
              />
              <span
                className={`absolute left-0 top-2.5 w-6 h-0.5 bg-light transition-opacity ${
                  menuOpen ? "opacity-0" : "opacity-100"
                }`}
              />
              <span
                className={`absolute left-0 top-4 w-6 h-0.5 bg-light transition-transform ${
                  menuOpen ? "-rotate-45 -translate-y-2" : ""
                }`}
              />
            </div>
          </button>
        </div>
      </div>

      {/* قائمة الموبايل — absolute تحت الهيدر، بلا فراغ عند الإغلاق */}
      <div
        id="mobile-menu"
        ref={menuRef}
        className={`md:hidden absolute left-0 top-full w-full bg-primary text-light px-6 pb-4 text-sm font-tajawal font-medium origin-top transition-[opacity,transform] duration-200 ${
          menuOpen
            ? "opacity-100 translate-y-0 pointer-events-auto"
            : "opacity-0 -translate-y-2 pointer-events-none select-none"
        }`}
      >
        <Link
          to="/"
          className="block py-2 hover:text-gold focus:outline-none focus-visible:ring-2 focus-visible:ring-gold rounded"
          onClick={() => setMenuOpen(false)}
          aria-current={location.pathname === "/" ? "page" : undefined}
        >
          {t("home")}
        </Link>

        <Link
          to="/about"
          className="block py-2 hover:text-gold focus:outline-none focus-visible:ring-2 focus-visible:ring-gold rounded"
          onClick={() => setMenuOpen(false)}
          aria-current={location.pathname === "/about" ? "page" : undefined}
        >
          {t("about")}
        </Link>

        <Link
          to="/contact"
          className="block py-2 hover:text-gold focus:outline-none focus-visible:ring-2 focus-visible:ring-gold rounded"
          onClick={() => setMenuOpen(false)}
          aria-current={location.pathname === "/contact" ? "page" : undefined}
        >
          {t("contact")}
        </Link>

        <Link
          to="/?scrollTo=booking"
          className="block mt-2 bg-gold text-primary text-center font-tajawal font-bold px-4 py-2 rounded-xl hover:bg-darkText hover:text-light transition focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-gold"
          onClick={() => setMenuOpen(false)}
        >
          {t("book_now")}
        </Link>
      </div>
    </header>
  );
}

export default Header;
</file>

<file path="src/pages/Dashboard.jsx">
// ✅ src/pages/Dashboard.jsx
import { useEffect, useMemo, useState } from "react";
import { db } from "../firebase";
import { collection, getDocs, doc, getDoc } from "firebase/firestore";
import { useNavigate } from "react-router-dom";

function ymd(d) {
  const x = new Date(d);
  const y = x.getFullYear();
  const m = String(x.getMonth() + 1).padStart(2, "0");
  const day = String(x.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function addMonths(date, delta) {
  const d = new Date(date);
  d.setMonth(d.getMonth() + delta);
  return d;
}

function fmtMonthTitle(date) {
  return date.toLocaleDateString("ar-EG", { year: "numeric", month: "long" });
}

// ✅ قراءة موحّدة وآمنة لعداد الشهر
function readMonthlyTotal(snap) {
  if (!snap?.exists?.()) return 0;
  const data = snap.data?.() || {};
  const v = data.activeTotal ?? data.total ?? 0;
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

export default function Dashboard() {
  const navigate = useNavigate();

  const [closedDates, setClosedDates] = useState([]);
  const [blockedByDay, setBlockedByDay] = useState({});
  const [todayStats, setTodayStats] = useState({
    total: 0,
    passed: 0,
    upcoming: 0,
    firstTime: null,
    lastTime: null,
  });
  const [weekStats, setWeekStats] = useState({
    total: 0,
    passed: 0,
    upcoming: 0,
    from: "",
    to: "",
  });
  const [totalBookings, setTotalBookings] = useState(0);

  const [monthStats, setMonthStats] = useState({ title: "", total: 0 });
  const [prevMonthStats, setPrevMonthStats] = useState({ title: "", total: 0 });

  useEffect(() => {
    const fetchData = async () => {
      const now = new Date();
      const todayStr = ymd(now);

      // ===== blocked days (المستقبل فقط) =====
      const closedSnap = await getDocs(collection(db, "blockedDays"));
      const futureClosed = closedSnap.docs
        .map((d) => d.id)
        .filter((date) => date >= todayStr)
        .sort();
      setClosedDates(futureClosed);

      // ===== blocked times (المستقبل فقط) =====
      const timesSnap = await getDocs(collection(db, "blockedTimes"));
      const result = {};
      timesSnap.docs.forEach((docu) => {
        const date = docu.id;
        const data = docu.data();
        if (data?.times?.length && date >= todayStr) {
          result[date] = data.times.sort();
        }
      });
      setBlockedByDay(result);

      // ===== bookings (active فقط) =====
      const bookingsSnap = await getDocs(collection(db, "bookings"));
      const bookings = bookingsSnap.docs
        .map((d) => d.data())
        .filter((b) => !b.cancelledAt);

      setTotalBookings(bookings.length);

      // ===== اليوم =====
      const todayBookings = bookings.filter((b) => b.selectedDate === todayStr);
      const passedToday = todayBookings.filter(
        (b) => new Date(`${b.selectedDate}T${b.selectedTime}:00`) <= now
      );
      const upcomingToday = todayBookings.filter(
        (b) => new Date(`${b.selectedDate}T${b.selectedTime}:00`) > now
      );
      const sortedTimes = todayBookings
        .map((b) => b.selectedTime)
        .sort((a, b) => a.localeCompare(b));

      setTodayStats({
        total: todayBookings.length,
        passed: passedToday.length,
        upcoming: upcomingToday.length,
        firstTime: sortedTimes[0] || null,
        lastTime: sortedTimes[sortedTimes.length - 1] || null,
      });

      // ===== الأسبوع (من الأحد للسبت) =====
      const day = now.getDay(); // 0 Sunday
      const diffToSunday = day === 0 ? 0 : day;

      const start = new Date(now);
      start.setDate(now.getDate() - diffToSunday);
      start.setHours(0, 0, 0, 0);

      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      end.setHours(23, 59, 59, 999);

      const fromStr = ymd(start);
      const toStr = ymd(end);

      const weekBookings = bookings.filter(
        (b) => b.selectedDate >= fromStr && b.selectedDate <= toStr
      );

      let weekPassed = 0;
      let weekUpcoming = 0;

      weekBookings.forEach((b) => {
        const bookingTime = new Date(`${b.selectedDate}T${b.selectedTime}:00`);
        if (bookingTime < now) weekPassed++;
        else weekUpcoming++;
      });

      setWeekStats({
        total: weekBookings.length,
        passed: weekPassed,
        upcoming: weekUpcoming,
        from: fromStr,
        to: toStr,
      });

      // ===== ✅ الشهر الحالي + الشهر الماضي (موحّد) =====
      const curKey = ymd(now).slice(0, 7); // YYYY-MM
      const prevKey = ymd(addMonths(now, -1)).slice(0, 7);

      const curSnap = await getDoc(doc(db, "statsMonthly", curKey));
      const prevSnap = await getDoc(doc(db, "statsMonthly", prevKey));

      const curTotal = readMonthlyTotal(curSnap);
      const prevTotal = readMonthlyTotal(prevSnap);

      setMonthStats({ title: fmtMonthTitle(now), total: curTotal });
      setPrevMonthStats({
        title: fmtMonthTitle(addMonths(now, -1)),
        total: prevTotal,
      });
    };

    fetchData();
  }, []);

  const formatDate = (dateStr) => {
    const date = new Date(dateStr);
    const weekday = date.toLocaleDateString("ar-EG", { weekday: "long" });
    const formatted = date.toLocaleDateString("ar-EG");
    return `${weekday} ${formatted}`;
  };

  const monthDelta = useMemo(() => {
    const a = monthStats.total;
    const b = prevMonthStats.total;

    const diff = a - b;
    const pct = b === 0 ? (a === 0 ? 0 : 100) : Math.round((diff / b) * 100);

    return { diff, pct };
  }, [monthStats.total, prevMonthStats.total]);

  return (
    <section
      className="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 pt-36 pb-24 px-4 font-ar"
      dir="rtl"
    >
      <div className="max-w-7xl mx-auto">
        <div className="flex justify-between items-center mb-10">
          <h1 className="text-3xl font-bold text-yellow-700 tracking-tight">
            📊 لوحة الإحصائيات
          </h1>
          <button
            onClick={() => navigate(-1)}
            className="text-sm text-blue-600 hover:underline"
          >
            ← الرجوع
          </button>
        </div>

        {/* ✅ كرت التقرير الشهري */}
        <div className="mb-8">
          <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-md">
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <h2 className="text-lg font-extrabold text-slate-900">
                  📅 التقرير الشهري
                </h2>
                <p className="text-xs text-slate-500 mt-1">
                  مقارنة الشهر الحالي مع الشهر الماضي بشكل مباشر وواضح.
                </p>
              </div>

              <div className="text-sm bg-slate-50 border border-slate-200 rounded-xl px-4 py-3">
                <div className="font-bold text-slate-800">
                  الفرق:{" "}
                  <span
                    className={
                      monthDelta.diff >= 0 ? "text-emerald-700" : "text-red-700"
                    }
                  >
                    {monthDelta.diff >= 0
                      ? `+${monthDelta.diff}`
                      : monthDelta.diff}
                  </span>{" "}
                  (
                  {monthDelta.pct >= 0
                    ? `+${monthDelta.pct}%`
                    : `${monthDelta.pct}%`}
                  )
                </div>
                <div className="text-xs text-slate-500 mt-1">
                  *النسبة تعتمد على عدد حجوزات الشهر الماضي.
                </div>
              </div>
            </div>

            <div className="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
              <CardBox color="blue" title={`هذا الشهر: ${monthStats.title}`}>
                <ul className="space-y-2 text-sm text-gray-700">
                  <li>
                    📊 العدد الكلي:{" "}
                    <span className="font-semibold text-slate-900">
                      {monthStats.total}
                    </span>
                  </li>
                </ul>
              </CardBox>

              <CardBox
                color="yellow"
                title={`الشهر الماضي: ${prevMonthStats.title}`}
              >
                <ul className="space-y-2 text-sm text-gray-700">
                  <li>
                    📊 العدد الكلي:{" "}
                    <span className="font-semibold text-slate-900">
                      {prevMonthStats.total}
                    </span>
                  </li>
                </ul>
              </CardBox>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          <CardBox color="blue" title="إحصائيات الأسبوع">
            <p className="text-sm text-gray-500 mb-3">
              من {formatDate(weekStats.from)} إلى {formatDate(weekStats.to)}
            </p>
            <ul className="space-y-2 text-sm text-gray-700">
              <li>
                🧮 عدد الأدوار الكلي:{" "}
                <span className="text-purple-700 font-semibold">
                  {totalBookings}
                </span>
              </li>

              <li>
                📊 عدد الحجوزات هذا الأسبوع:{" "}
                <span className="font-semibold">{weekStats.total}</span>
              </li>
              <li>
                ✅ الأدوار التي مرّت:{" "}
                <span className="text-green-700 font-semibold">
                  {weekStats.passed}
                </span>
              </li>
              <li>
                ⏳ الأدوار القادمة:{" "}
                <span className="text-blue-700 font-semibold">
                  {weekStats.upcoming}
                </span>
              </li>
            </ul>
          </CardBox>

          <CardBox color="green" title="إحصائيات اليوم">
            <ul className="space-y-2 text-sm text-gray-700">
              <li>
                📋 عدد الحجوزات اليوم:{" "}
                <span className="font-semibold">{todayStats.total}</span>
              </li>
              <li>
                ✅ الأدوار التي مرّت:{" "}
                <span className="text-green-700 font-semibold">
                  {todayStats.passed}
                </span>
              </li>
              <li>
                ⏳ الأدوار القادمة:{" "}
                <span className="text-blue-700 font-semibold">
                  {todayStats.upcoming}
                </span>
              </li>
              {todayStats.firstTime && (
                <li>
                  🕒 أول حجز:{" "}
                  <span className="font-semibold text-gray-800">
                    {todayStats.firstTime}
                  </span>
                </li>
              )}
              {todayStats.lastTime && (
                <li>
                  🕔 آخر حجز:{" "}
                  <span className="font-semibold text-gray-800">
                    {todayStats.lastTime}
                  </span>
                </li>
              )}
            </ul>
          </CardBox>

          <CardBox color="red" title="الأوقات المحظورة">
            {Object.keys(blockedByDay).length === 0 && (
              <p className="text-sm text-gray-500">لا توجد أوقات محظورة.</p>
            )}
            {Object.entries(blockedByDay).map(([date, times]) => (
              <div key={date} className="mb-3">
                <p className="text-red-700 font-semibold mb-1">
                  📅 {formatDate(date)}
                </p>
                <div className="flex flex-wrap gap-2">
                  {times.map((time) => (
                    <span
                      key={time}
                      className="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs"
                    >
                      {time}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </CardBox>

          <CardBox color="yellow" title="الأيام المغلقة القادمة">
            <p className="text-sm text-gray-500 mb-2">
              عدد الأيام: {closedDates.length}
            </p>
            <ul className="space-y-1">
              {closedDates.map((date) => (
                <li key={date} className="text-red-700 text-sm">
                  🔒 {formatDate(date)}
                </li>
              ))}
              {closedDates.length === 0 && (
                <li className="text-sm text-gray-500">
                  لا توجد أيام مغلقة قادمة.
                </li>
              )}
            </ul>
          </CardBox>
        </div>
      </div>
    </section>
  );
}

function CardBox({ color = "gray", title, children }) {
  const border = {
    blue: "border-blue-100",
    green: "border-green-100",
    red: "border-red-100",
    yellow: "border-yellow-100",
    gray: "border-gray-200",
  }[color];

  const titleColor = {
    blue: "text-blue-900",
    green: "text-green-900",
    red: "text-red-900",
    yellow: "text-yellow-900",
    gray: "text-gray-900",
  }[color];

  return (
    <div
      className={`bg-white p-6 rounded-2xl border ${border} shadow-md transition-all hover:shadow-lg`}
    >
      <h2 className={`text-lg font-bold mb-3 ${titleColor}`}>{title}</h2>
      {children}
    </div>
  );
}
</file>

<file path="src/routes.jsx">
import { Routes, Route, Navigate } from "react-router-dom";
import React, { useEffect, useState } from "react";
import Dashboard from "./pages/Dashboard";
import BlockedPhones from "./pages/BlockedPhones";
import ReviewsManagerPage from "./pages/barberPanel/ReviewsManagerPage";

import Home from "./pages/Home";
import BookingIntro from "./pages/BookingIntro";
import NotFound from "./pages/NotFound";
import Contact from "./pages/Contact";
import BarberPanel from "./pages/barberPanel/BarberPanel";
import WeeklyHoursPage from "./pages/barberPanel/WeeklyHoursPage"; // ✅ NEW
import BookingForm from "./pages/BookingForm";
import AdminBookings from "./pages/AdminBookings";
import Login from "./pages/Login";
import AdminBookingsV2 from "./pages/AdminBookingsV2.jsx";

// PrivateRoute يستخدم localStorage للتحقق من تسجيل الدخول اليدوي
function PrivateRoute({ children }) {
  const [loading, setLoading] = useState(true);
  const [isLoggedIn, setIsLoggedIn] = useState(false);

  useEffect(() => {
    const user = localStorage.getItem("barberUser");
    setIsLoggedIn(!!user);
    setLoading(false);
  }, []);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        Loading...
      </div>
    );
  }

  return isLoggedIn ? children : <Navigate to="/login" />;
}

export default function AppRoutes() {
  return (
    <Routes>
      <Route path="/" element={<Home />} />
      <Route path="/booking" element={<BookingIntro />} />
      <Route path="/booking-form" element={<BookingForm />} />
      <Route path="/contact" element={<Contact />} />
      <Route path="/login" element={<Login />} />

      <Route
        path="/dashboard"
        element={
          <PrivateRoute>
            <Dashboard />
          </PrivateRoute>
        }
      />

      <Route
        path="/admin-bookings-v2"
        element={
          <PrivateRoute>
            <AdminBookingsV2 />
          </PrivateRoute>
        }
      />

      <Route
        path="/blocked-phones"
        element={
          <PrivateRoute>
            <BlockedPhones />
          </PrivateRoute>
        }
      />

      {/* مسارات خاصة محمية */}
      <Route
        path="/barber"
        element={
          <PrivateRoute>
            <BarberPanel />
          </PrivateRoute>
        }
      />

      {/* ✅ صفحة مستقلة لساعات الأسبوع */}
      <Route
        path="/barber/weekly-hours"
        element={
          <PrivateRoute>
            <WeeklyHoursPage />
          </PrivateRoute>
        }
      />
      <Route
        path="/barber/reviews"
        element={
          <PrivateRoute>
            <ReviewsManagerPage />
          </PrivateRoute>
        }
      />

      <Route
        path="/admin-bookings"
        element={
          <PrivateRoute>
            <AdminBookings />
          </PrivateRoute>
        }
      />

      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
</file>

<file path="src/components/booking/BookingTracker.jsx">
// src/components/booking/BookingTracker.jsx
import { useState } from "react";
import { db } from "../../firebase";
import SectionTitle from "../common/SectionTitle";
import { collection, query, where, getDocs } from "firebase/firestore";
import { useTranslation } from "react-i18next";
import {
  CalendarCheck,
  Phone,
  Clock3,
  CalendarDays,
  Scissors,
} from "lucide-react";
import {
  toILPhoneE164,
  isILPhoneE164,
  e164ToLocalPretty,
  normalizeDigits,
} from "../../utils/phone";

// ✅ بدل deleteDoc: استخدم الإلغاء الصحيح اللي بنقص العداد الشهري
import { cancelBooking } from "../../services/bookingService";

const CANCELLATION_WINDOW_MIN = 50;

/* ============================
   Helpers
   ============================ */

function diffMinutes(fromDate, toDate) {
  const ms = toDate.getTime() - fromDate.getTime();
  return Math.floor(ms / 60000);
}

function getStartAtDate(booking) {
  if (!booking) return null;

  if (booking?.startAt?.toDate) {
    const d = booking.startAt.toDate();
    return d instanceof Date && !isNaN(d) ? d : null;
  }

  if (booking?.selectedDate && booking?.selectedTime) {
    const d = new Date(`${booking.selectedDate}T${booking.selectedTime}:00`);
    return d instanceof Date && !isNaN(d) ? d : null;
  }

  return null;
}

function isBookingActiveNow(booking) {
  if (!booking || booking.cancelledAt) return false;
  const d = getStartAtDate(booking);
  if (!d) return false;
  return d.getTime() > Date.now();
}

function canCancelFixed(startAtDate) {
  if (!(startAtDate instanceof Date) || isNaN(startAtDate)) {
    return { ok: false, reason: "بيانات الموعد غير صالحة." };
  }

  const left = diffMinutes(new Date(), startAtDate);

  if (left < 0) {
    return { ok: false, reason: "لا يمكن الإلغاء: موعد الحجز انتهى بالفعل." };
  }

  if (left < CANCELLATION_WINDOW_MIN) {
    return {
      ok: false,
      reason: `لا يمكن الإلغاء: تبقّى أقل من ${CANCELLATION_WINDOW_MIN} دقيقة على موعدك.`,
    };
  }

  return { ok: true };
}

// تنسيق التاريخ + اسم اليوم بالعربي
function formatDayAndDate(dateYMD) {
  if (!dateYMD) return "";
  const d = new Date(`${dateYMD}T00:00:00`);
  if (!(d instanceof Date) || isNaN(d)) return dateYMD;

  const weekdayNames = [
    "الأحد",
    "الإثنين",
    "الثلاثاء",
    "الأربعاء",
    "الخميس",
    "الجمعة",
    "السبت",
  ];
  const dayName = weekdayNames[d.getDay()];
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();

  return `${dayName} ${dd}-${mm}-${yyyy}`;
}

/* ============================
   Component
   ============================ */

function BookingTracker() {
  const { t } = useTranslation();
  const [phone, setPhone] = useState("");
  const [results, setResults] = useState([]);
  const [notFound, setNotFound] = useState(false);
  const [loading, setLoading] = useState(false);
  const [successMessage, setSuccessMessage] = useState("");
  const [codeInputs, setCodeInputs] = useState({});
  const [errorMessages, setErrorMessages] = useState({});

  const align = "text-right";

  const handleCheck = async () => {
    setResults([]);
    setNotFound(false);
    setSuccessMessage("");
    setErrorMessages({});

    const input = phone.trim();
    if (!input) return;

    const localNumber = normalizeDigits(input); // 050...
    const phoneE164 = toILPhoneE164(input); // +972...
    const hasValidE164 = isILPhoneE164(phoneE164);

    setLoading(true);
    try {
      const byId = {};

      if (hasValidE164) {
        const q1 = query(
          collection(db, "bookings"),
          where("phoneNumber", "==", phoneE164),
        );
        const snap1 = await getDocs(q1);
        snap1.forEach((d) => {
          byId[d.id] = { docId: d.id, ...d.data() };
        });
      }

      if (localNumber) {
        const q2 = query(
          collection(db, "bookings"),
          where("phoneNumber", "==", localNumber),
        );
        const snap2 = await getDocs(q2);
        snap2.forEach((d) => {
          byId[d.id] = { docId: d.id, ...d.data() };
        });
      }

      const rawData = Object.values(byId);
      const activeBookings = rawData.filter(isBookingActiveNow);

      if (activeBookings.length === 0) {
        setNotFound(true);
      } else {
        setResults(activeBookings);
      }
    } catch (error) {
      console.error("Error fetching bookings:", error);
      setNotFound(true);
    }
    setLoading(false);
  };

  const handleCancel = async (booking) => {
    const code = codeInputs[booking.docId] || "";
    if (!code || code !== booking.bookingCode) {
      setErrorMessages((prev) => ({
        ...prev,
        [booking.docId]: "رمز التحقق غير صحيح",
      }));
      return;
    }

    if (!isBookingActiveNow(booking)) {
      setErrorMessages((prev) => ({
        ...prev,
        [booking.docId]: "هذا الحجز لم يعد فعّالاً، لا يمكن إلغاؤه.",
      }));
      return;
    }

    const startAtDate = getStartAtDate(booking);
    const check = canCancelFixed(startAtDate);
    if (!check.ok) {
      setErrorMessages((prev) => ({ ...prev, [booking.docId]: check.reason }));
      return;
    }

    try {
      // ✅ الإلغاء الصحيح (بيحط cancelledAt وبيعمل decrement للعداد الشهري)
      await cancelBooking(booking.docId);

      setResults((prev) => prev.filter((b) => b.docId !== booking.docId));
      setSuccessMessage("✅ تم إلغاء الحجز بنجاح");
    } catch (error) {
      console.error("Error while cancelling:", error);
      alert("حدث خطأ أثناء محاولة الإلغاء.");
    }
  };

  return (
    <section
      id="check-booking"
      dir="rtl"
      className="relative bg-[#f8f6f1] py-20 px-4 text-primary font-body scroll-mt-28 md:scroll-mt-32 overflow-hidden"
      style={{ scrollMarginTop: 120 }} // ✅ دقّة أعلى لو عندك هيدر sticky
    >
      {/* ديكور خفيف جداً (شكل فقط) */}
      <div className="pointer-events-none absolute inset-0">
        <div className="absolute -bottom-24 left-10 w-72 h-72 rounded-full bg-gold/10 blur-3xl" />
      </div>

      {/* العنوان */}
      <SectionTitle
        icon={
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-gold/15 text-gold shadow-sm">
            <CalendarCheck className="w-6 h-6" />
          </div>
        }
      >
        <span className="tracking-wide text-lg font-semibold">
          {t("check_booking", { defaultValue: "تحقّق من الحجز" })}
        </span>
      </SectionTitle>

      {/* الصندوق الرئيسي */}
      <div className="max-w-xl mx-auto bg-[#fcfaf7] border border-gold/20 rounded-3xl shadow-lg p-6 md:p-8 mt-6 backdrop-blur-sm ring-1 ring-black/5 transition-transform duration-300 hover:-translate-y-1">
        {/* إدخال الرقم + زر التحقق */}
        <div className="flex flex-row-reverse gap-3 items-center">
          <input
            type="tel"
            placeholder={t("phone", { defaultValue: "رقم الهاتف" })}
            value={phone}
            onChange={(e) => setPhone(e.target.value)}
            className={`w-full border border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-gold shadow-sm bg-white ${align}`}
          />
          <button
            onClick={handleCheck}
            disabled={loading || !phone.trim()}
            className={`rounded-2xl px-6 py-3 font-bold shadow-sm transition ${
              loading || !phone.trim()
                ? "bg-gray-200 text-gray-500 cursor-not-allowed"
                : "bg-gold text-primary hover:bg-yellow-400"
            }`}
          >
            {loading ? (
              <span className="inline-flex items-center gap-2">
                <span className="h-4 w-4 rounded-full border-2 border-current border-t-transparent animate-spin" />
                {t("loading", { defaultValue: "جارٍ التحقق..." })}
              </span>
            ) : (
              t("check", { defaultValue: "تحقّق" })
            )}
          </button>
        </div>

        {/* رسائل */}
        {successMessage && (
          <div className="mt-4 bg-emerald-50 border border-emerald-200 text-emerald-800 px-4 py-3 rounded-xl text-right shadow-sm">
            {successMessage}
          </div>
        )}

        {notFound && (
          <div className="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl text-right shadow-sm">
            {t("no_booking_found", {
              defaultValue: "لا يوجد حجز فعّال مرتبط بهذا الرقم.",
            })}
          </div>
        )}

        {/* النتائج */}
        {results.length > 0 && (
          <div className="mt-6 space-y-6">
            {results.map((booking) => {
              const prettyDate = formatDayAndDate(booking.selectedDate);

              const serviceTitle = t(`service_${booking.selectedService}`, {
                defaultValue: booking.selectedService || "—",
              });

              return (
                <div
                  key={booking.docId}
                  className="rounded-3xl border border-gray-200 bg-white p-6 shadow-sm hover:shadow-xl transition-all"
                  dir="rtl"
                >
                  {/* الهيدر */}
                  <div className="flex flex-row-reverse justify-between items-start mb-6">
                    {/* يمين: الاسم + الهاتف فقط */}
                    <div className="space-y-3 text-right w-full">
                      <div className="text-xl font-extrabold text-gray-900 leading-tight">
                        {booking.fullName || "بدون اسم"}
                      </div>

                      <div className="flex flex-row-reverse items-center gap-2 text-sm text-gray-700">
                        <Phone className="w-4 h-4 opacity-70" />
                        <span>
                          {t("phone", { defaultValue: "رقم الهاتف" })}:{" "}
                          {e164ToLocalPretty(booking.phoneNumber)}
                        </span>
                      </div>
                    </div>

                    {/* يسار: بادج */}
                    <span className="px-4 py-1 text-sm rounded-full bg-emerald-50 border border-emerald-200 text-emerald-700 shadow-sm whitespace-nowrap">
                      {t("active_booking", { defaultValue: "حجز نشط" })}
                    </span>
                  </div>

                  {/* Grid المعلومات */}
                  <div className="grid grid-cols-1 gap-3 mb-6">
                    <InfoRow
                      label={t("service", { defaultValue: "الخدمة" })}
                      value={serviceTitle}
                      icon={<Scissors className="w-4 h-4 opacity-70" />}
                    />
                    <InfoRow
                      label={t("time", { defaultValue: "الساعة" })}
                      value={booking.selectedTime}
                      icon={<Clock3 className="w-4 h-4 opacity-70" />}
                    />
                    <InfoRow
                      label={t("date", { defaultValue: "التاريخ" })}
                      value={prettyDate}
                      icon={<CalendarDays className="w-4 h-4 opacity-70" />}
                    />
                  </div>

                  {/* إدخال الكود */}
                  <div className="space-y-2 text-right">
                    <label className="block text-sm font-semibold">
                      {t("enter_code", {
                        defaultValue: "أدخل رمز التحقق لإلغاء الحجز",
                      })}
                    </label>
                    <input
                      type="text"
                      inputMode="text"
                      autoComplete="one-time-code"
                      value={codeInputs[booking.docId] || ""}
                      onChange={(e) =>
                        setCodeInputs((prev) => ({
                          ...prev,
                          [booking.docId]: e.target.value,
                        }))
                      }
                      className="w-full border border-gray-300 rounded-xl px-4 py-3 text-right shadow-sm focus:ring-2 focus:ring-gold bg-white"
                      placeholder={t("enter_code", {
                        defaultValue: "أدخل الكود",
                      })}
                    />

                    {errorMessages[booking.docId] && (
                      <p className="text-red-600 text-sm mt-1">
                        {errorMessages[booking.docId]}
                      </p>
                    )}
                  </div>

                  {/* زر الإلغاء */}
                  <div className="flex justify-start mt-5">
                    <button
                      onClick={() => handleCancel(booking)}
                      className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-bold shadow-sm"
                    >
                      {t("cancel_booking", { defaultValue: "إلغاء الحجز" })}
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </section>
  );
}

function InfoRow({ label, value, icon }) {
  return (
    <div
      className="bg-gray-50 border border-gray-200 rounded-2xl p-4 flex flex-col gap-1 text-right shadow-sm"
      dir="rtl"
    >
      <div className="text-xs text-gray-500 flex flex-row-reverse items-center gap-1">
        {icon}
        <span>{label}</span>
      </div>
      <div className="text-base font-semibold text-gray-900">
        {value || "—"}
      </div>
    </div>
  );
}

export default BookingTracker;
</file>

<file path="src/pages/AdminBookings.jsx">
// src/pages/AdminBookings.jsx
import AdminBookingsPage from "./adminBookings/AdminBookingsPage";

export default function AdminBookings() {
  return <AdminBookingsPage />;
}
</file>

<file path="src/pages/Home.jsx">
import { useEffect } from "react";
import { useLocation } from "react-router-dom";

import HeroSection from "../components/home/HeroSection";
import ContactSection from "../components/home/ContactSection";
import InstagramSlider from "../components/home/InstagramSlider";
import BookingSection from "../components/booking/BookingSection";
import BookingTracker from "../components/booking/BookingTracker";
import Footer from "../components/layout/Footer";
import BackToTopButton from "../components/BackToTopButton";

// ✅ جديد
import BarberRatingSection from "../components/reviews/BarberRatingSection";

function Home() {
  const location = useLocation();

  useEffect(() => {
    const params = new URLSearchParams(location.search);
    const targetId = params.get("scrollTo");
    if (targetId) {
      const element = document.getElementById(targetId);
      if (element) {
        setTimeout(() => element.scrollIntoView({ behavior: "smooth" }), 100);
      }
    }
  }, [location]);

  return (
    <main id="main">
      <HeroSection />
      <InstagramSlider />
      <BookingSection />
      <BarberRatingSection />
      <BookingTracker />
      <Footer />
      <BackToTopButton />
    </main>
  );
}

export default Home;
</file>

<file path="src/translations/en.json">
{
  "home": "Home",
  "about": "About",
  "contact": "Contact",
  "language": "Language",
  "book_now": "Book Now",
  "start_booking": "Start Booking",
  "welcome": "Welcome to Arfat Barber",
"hero_subtitle": "We offer you a look that suits and reflects you effortlessly and elegantly."
,  "name": "Full Name",
  "phone": "Phone Number",
  "select_date": "Select a date",
  "choose_time": "Choose Time",
  "choose_service": "Choose a Service",
  "service_haircut": "Haircut",
  "service_beard": "Beard Trim",
  "service_combo": "Haircut + Beard",
  "confirm_booking": "Confirm Booking",
  "thank_you": "Thank you! Your booking was received. Keep the code to verify or cancel.",
  "no_hours": "No available hours for this day (Closed).",
  "fill_required_fields": "Please fill all required fields.",
  "all_rights": "All rights reserved.",
  "not_found_message": "Oops! The page you're looking for doesn't exist.",
  "go_home": "Go Back Home",
  "slider_title": "Cuts from our hands",
  "call": "Call",
  "email": "Email",
  "address": "📍 Ba'aneh - Ghaddara Street",
  "working_hours": "Working Hours",
  "open_now": "We are open now",
  "closed_today": "We are closed now",
  "sunday": "Sunday",
  "monday": "Monday",
  "tuesday": "Tuesday",
  "wednesday": "Wednesday",
  "thursday": "Thursday",
  "friday": "Friday",
  "saturday": "Saturday",
  "closed": "Closed",
  "barber_panel": "Barber Panel",
  "enter_password": "Enter Password",
  "login": "Login",
  "manage_times": "Manage Blocked Times",
  "remove_selected_times": "Remove Selected Times",
  "closed_day": "This day is closed",
  "wrong_password": "Incorrect password",
  "logout": "Logout",
  "times_removed_success": "✅ Selected times for this day have been successfully removed",
  "time_restored_success": "✅ Time slot restored successfully",
  "admin_bookings": "Admin Bookings",
  "no_bookings": "No bookings found yet",
  "date_added": "Created At",
  "clear_filter": "Clear Filter",
  "check_booking": "Check Booking ",
  "check": "Check",
  "loading": "Checking...",
  "cancel_booking": "Cancel Booking",
  "booking_canceled": "Booking canceled successfully.",
  "no_booking_found": "No booking found for this number.",
  "enter_code": "Enter code",
  "hero_title": "A style that suits you, effortlessly"
,
  "code_required": "Please enter the code to cancel the booking",
  "choose_date": "Please Enter The Date",
  "time_already_booked": "⚠️ This time slot is already booked. Please choose another.",
"blocked_time": "Blocked by the barber",
"your_code": "Your Code",
"wrong_code": "⚠️ The code is incorrect",
  "pick_date_first": "Pick a date first to show available times.",

  "shop_open_now": "Shop is open now",
  "shop_closed_now": "Shop is closed now",
  "open_until": "Open until",
  "opens_at": "Opens",

  "short_name": "Name",
  "short_phone": "Phone",
  "short_date": "Date",
  "short_time": "Time",
  "short_service": "Service",
  "short_confirm": "Confirm",
  
  
  "closed_now": "Closed Now",
  "main_navigation": "Main Navigation",
  "close_menu": "Close menu",
  "open_menu": "Open menu",
  
  "invalid_name": "Please enter a valid name (at least 2 letters).",
  "invalid_phone": "Please enter a valid phone: starts with 05 and has 10 digits.",
  "invalid_date": "Please select a valid date.",
  "invalid_time": "Please select a valid time.",
  "invalid_service": "Please choose a service.",
  
  "confirm": "Confirm",
  "upcoming_bookings": "Your Upcoming Bookings","looks_good": "Looks good",
  "fix_errors_first": "Please make sure all fields are filled in correctly",
  
  "weekdays": ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],
  
  "closed_all_day": "Closed all day",
  "services": {
    "haircut": "Haircut",
    "beard": "Beard trim"},
    

  "booking_confirmed": "Your booking has been confirmed",
  "copy_code": "Copy Code",
  "copy_all": "Copy All Details",
  "copy_and_close": "Copy Details",
  "share": "Share",
  "keep_code_hint": "Keep this code to modify or cancel your booking later.",
  "got_it": "Got it",
  "close": "Close",

  "service": "Service",
  "appointment_time": "Appointment Time",
  "duration": "Duration",
  "price": "Price",
  "barber": "Barber",
  "location": "Location",
  "notes": "Notes",

  "opening_hours": "Opening Hours",
  "today_status": "Today's Status",




  "add_to_calendar": "Add to Calendar",
  "copied_code": "Code copied",
  "copied_details": "Details copied",
  "customer_name": "Name"






}
</file>

<file path="src/translations/he.json">
{
  "home": "בית",
  "about": "אודות",
  "contact": "צור קשר",
  "language": "שפה",
  "book_now": "הזמן עכשיו",
  "start_booking": "התחל הזמנה",
  "welcome": "ברוך הבא אל Arfat Barber",
"hero_subtitle": "אנחנו מעניקים לך מראה שמתאים ומשקף אותך בפשטות ובאלגנטיות."
,  "name": "שם מלא",
  "phone": "מספר טלפון",
  "select_date": "בחר תאריך",
  "choose_time": "בחר שעה",
  "choose_service": "בחר שירות",
  "service_haircut": "תספורת",
  "service_beard": "קיצוץ זקן",
  "service_combo": "תספורת + זקן",
  "confirm_booking": "אישור הזמנה",
  "thank_you": "תודה! ההזמנה התקבלה. שמור את הקוד לבדיקה או ביטול.",
  "no_hours": "אין שעות פנויות ליום זה (סגור).",
  "fill_required_fields": "אנא מלא את כל השדות הנדרשים",
  "all_rights": "כל הזכויות שמורות.",
  "not_found_message": "אופס! הדף שחיפשת לא קיים.",
  "go_home": "חזור לעמוד הבית",
  "slider_title": "תספורות מעבודתנו",
  "call": "התקשר",
  "email": "אימייל",
  "address": "📍 בענה - רחוב גדרה",
  "working_hours": "שעות פעילות",
  "open_now": "אנחנו פתוחים עכשיו",
  "closed_today": "אנחנו סגורים עכשיו",
  "sunday": "ראשון",
  "monday": "שני",
  "tuesday": "שלישי",
  "wednesday": "רביעי",
  "thursday": "חמישי",
  "friday": "שישי",
  "saturday": "שבת",
  "closed": "סגור",
  "barber_panel": "לוח שליטה לספר",
  "enter_password": "הכנס סיסמה",
  "login": "כניסה",
  "manage_times": "ניהול שעות חסומות",
  "remove_selected_times": "מחק את השעות שנבחרו",
  "closed_day": "היום סגור",
  "wrong_password": "הסיסמה שגויה",
  "logout": "התנתק",
  "times_removed_success": "✅ השעות שנבחרו הוסרו בהצלחה",
  "time_restored_success": "✅ השעה שוחזרה בהצלחה",
  "admin_bookings": "צפייה בהזמנות",
  "no_bookings": "אין הזמנות עדיין",
  "date_added": "נוסף בתאריך",
  "clear_filter": "נקה סינון",
  "check_booking": "בדוק את ההזמנה ",
  "check": "בדוק",
  "loading": "בודק...",
  "cancel_booking": "ביטול הזמנה",
  "booking_canceled": "ההזמנה בוטלה בהצלחה.",
  "no_booking_found": "לא נמצאה הזמנה למספר הזה.",
  "enter_code": "הכנס קוד",
  "hero_title": "סגנון שמתאים לך, בפשטות"
,
  "code_required": "יש להזין את הקוד כדי לבטל",
  "time_already_booked": "⚠️ השעה הזאת כבר תפוסה. אנא בחר שעה אחרת.",
"blocked_time": "נחסם על ידי הספר",
"your_code": "הקוד שלך",

  "choose_date":"בחירת תאריך",
  "wrong_code": "⚠️ הקוד שגוי",
  "shop_open_now": "החנות פתוחה כעת",
  "shop_closed_now": "החנות סגורה כעת",
  "open_until": "פתוח עד",
  "opens_at": "נפתח",

  "short_name": "שם",
  "short_phone": "טלפון",
  "short_date": "תאריך",
  "short_time": "שעה",
  "short_service": "שירות",
  "short_confirm": "אישור",

  
  
  "closed_now": "סגור עכשיו",
  "main_navigation": "ניווט ראשי",
  "close_menu": "סגור תפריט",
  "open_menu": "פתח תפריט",

  "invalid_name": "נא להזין שם תקין (לפחות שני תווים).",
  "invalid_phone": "נא להזין מספר תקין: מתחיל ב-05 ובעל 10 ספרות.",
  "invalid_date": "נא לבחור תאריך תקין.",
  "invalid_time": "נא לבחור שעה תקינה.",
  "invalid_service": "נא לבחור שירות.",
  
  "confirm": "אשר",
  "upcoming_bookings": "ההזמנות הקרובות שלך",
  "looks_good": "נראה טוב",
  "fix_errors_first": "אנא ודא שכל השדות מולאו בצורה נכונה",
  
  "weekdays": ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"],
  
  "closed_all_day": "סגור כל היום"
  ,
   "services": {
    "haircut": "תספורת",
    "beard": "עיצוב זקן"
  },
  
  
  "booking_confirmed": "הזמנתך אושרה בהצלחה",
  "copy_code": "העתק קוד",
  "copy_all": "העתק את כל הפרטים",
  "copy_and_close": "העתק פרטים",
  "share": "שתף",
  "keep_code_hint": "שמור קוד זה לשינוי או ביטול ההזמנה מאוחר יותר.",
  "got_it": "הבנתי",
  "close": "סגור",

  "service": "שירות",
  "appointment_time": "זמן הפגישה",
  "duration": "משך",
  "price": "מחיר",
  "barber": "ספר",
  "location": "מיקום",
  "notes": "הערות",

  "opening_hours": "שעות פתיחה",
  "today_status": "סטטוס היום",
"add_to_calendar": "הוסף ליומן",
  "copied_code": "הקוד הועתק",
  "copied_details": "הפרטים הועתקו",
  "customer_name": "שם",

"phone_already_booked_today":"יש כבר תור על מספר זה !"
}
</file>

<file path="src/translations/ar.json">
{
  "home": "الرئيسية",
  "about": "من نحن",
  "contact": "تواصل معنا",
  "language": "اللغة",
  "book_now": "احجز الآن",
  "start_booking": "ابدأ الحجز",
  "welcome": "أهلاً بك في حلاقة عرفات",
"hero_subtitle": "نمنحك مظهرًا يناسبك ويعبر عنك ."
,  "name": "الاسم الكامل",
  "phone": "رقم الهاتف",
  "select_date": "اختر التاريخ",
  "choose_time": "اختر الساعة",
  "choose_service": "اختر الخدمة",
  "service_haircut": "قص شعر",
  "service_beard": "تعليم لحية",
  "service_combo": "قص شعر + لحية",
  "confirm_booking": "تأكيد الحجز",
  "thank_you": "شكراً! تم استلام الحجز بنجاح. احتفظ بالكود للتحقق أو الإلغاء.",
  "no_hours": "لا يوجد حجوزات هذا اليوم يمكنك الحجز ليوم اخر.",
  "fill_required_fields": "يرجى تعبئة جميع الحقول المطلوبة",
  "all_rights": "جميع الحقوق محفوظة.",
  "not_found_message": "عذرًا! الصفحة التي تبحث عنها غير موجودة.",
  "go_home": "العودة للرئيسية",
  "slider_title": "قصات من لمساتنا",
  "call": "اتصال",
  "email": "بريد إلكتروني",
  "address": "📍 البعنة - شارع غدّارة",
  "working_hours": "ساعات العمل",
  "open_now": "المحل فاتح الآن",
  "closed_today": "المحل مغلق الآن",
  "sunday": "الأحد",
  "monday": "الإثنين",
  "tuesday": "الثلاثاء",
  "wednesday": "الأربعاء",
  "thursday": "الخميس",
  "friday": "الجمعة",
  "saturday": "السبت",
  "closed": "مغلق",
  "barber_panel": "لوحة تحكم الحلاق",
  "enter_password": "ادخل كلمة المرور",
  "login": "دخول",
  "manage_times": "إدارة الساعات",
  "remove_selected_times": "احذف الساعات المختارة",
  "closed_day": "هذا اليوم مغلق",
  "wrong_password": "كلمة المرور غير صحيحة",
  "logout": "تسجيل الخروج",
  "times_removed_success": "✅ تم حذف الساعات المحددة لهذا اليوم بنجاح",
  "time_restored_success": "✅ تم استرجاع الساعة بنجاح",
  "admin_bookings": "لوحة الحجوزات",
  "no_bookings": "لا يوجد حجوزات حتى الآن",
  "date_added": "تاريخ الإضافة",
  "clear_filter": "إزالة الفلتر",
  "check_booking": "تحقق من الحجز ",
  "check": "تحقق",
  "loading": "جاري التحقق...",
  "cancel_booking": "إلغاء الحجز",
  "booking_canceled": "تم إلغاء الحجز بنجاح.",
  "no_booking_found": "لا يوجد حجز مرتبط بهذا الرقم.",
  "enter_code": "أدخل الكود",
  "hero_title": "أسلوب يليق بك، بكل بساطة"
,
  "code_required": "يرجى إدخال الكود لإلغاء الحجز",
  "choose_date": "اختر تاريخ الحجز",
  "blocked_time": "⚠️ محجوز",
  "wrong_code": "⚠️ الكود غير صحيح",
  "pick_date_first": "اختر التاريخ أولًا لعرض الساعات المتاحة."
,
"your_code": "كود الحجز",
"step": "خطوه",
  "time_already_booked": "⚠️ هذه الساعة محجوزة بالفعل، يرجى اختيار ساعة أخرى.",
  "shop_open_now": "المحل مفتوح الآن",
  "shop_closed_now": "المحل مغلق الآن",
  "open_until": "مفتوح حتى",
  "opens_at": "يفتح",

  "short_name": "اسم",
  "short_phone": "هاتف",
  "short_date": "تاريخ",
  "short_time": "ساعة",
  "short_service": "خدمة",
  "short_confirm": "تأكيد",
 
  "closed_now": "مغلق الآن",
  "invalid_name": "الرجاء إدخال اسم صحيح (حرفين فأكثر).",
  "invalid_phone": "الرجاء إدخال رقم صحيح يبدأ بـ 05 ومكوّن من 10 أرقام.",
  "invalid_date": "الرجاء اختيار تاريخ صالح.",
  "invalid_time": "الرجاء اختيار وقت صالح.",
  "invalid_service": "الرجاء اختيار خدمة.",
  
 
  "day_blocked": "اليوم محجوز بالكامل",
 
  "confirm": "تأكيد",
  "upcoming_bookings": "حجوزاتك القادمة",
"looks_good": "يبدو جيدًا",
"fix_errors_first": "تأكد من تعبئة الحقول بشكل صحيح",
"weekdays": ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"],
 
  "closed_all_day": "مغلق طوال اليوم",
 "services": {
    "haircut": "قص شعر",
    "beard": "تعليم لحية"
  },


  "booking_confirmed": "تم تأكيد الحجز بنجاح",
  "copy_code": "نسخ الكود",
  "copy_all": "نسخ كل التفاصيل",
  "copy_and_close": "نسخ التفاصيل",
  "share": "مشاركة",
  "keep_code_hint": "احتفظ بهذا الكود لتعديل أو إلغاء الحجز لاحقًا.",
  "got_it": "تمام",
  "close": "إغلاق",

  "service": "الخدمة",
  "appointment_time": "موعدك",
  "duration": "المدة",
  "price": "السعر",
  "barber": "الحلاق",
  "location": "الموقع",
  "notes": "ملاحظات",

  "opening_hours": "ساعات الدوام",
  "today_status": "حالة اليوم",

 
  
  

  "add_to_calendar": "أضف للتقويم",
  "copied_code": "تم نسخ الكود",
  "copied_details": "تم نسخ التفاصيل",
  "customer_name": "الاسم",
"phone_already_booked_today":" الهاتف يملك حجز حاليا لا يمكنك حجز دور اخر حاليا برقم الهاتف هذا !"



}
</file>

<file path="src/components/booking/BookingSection.jsx">
// src/components/booking/BookingSection.jsx
import OpeningStatusCard from "./parts/OpeningStatusCard";
import SuccessModal from "./parts/SuccessModal";
import ServiceSelector from "./parts/ServiceSelector";
import TimeSelector from "./parts/TimeSelector";
import DateField from "./parts/DateField";
import SectionTitle from "../common/SectionTitle";
import ProgressBar from "./parts/ProgressBar";
import PhoneInput from "./parts/PhoneInput";

import useAvailableTimes from "../../hooks/useAvailableTimes";
import useBookingSubmit from "../../hooks/useBookingSubmit";

import { useState, useEffect, useMemo } from "react";
import { useTranslation } from "react-i18next";
import { getOpeningStatus } from "../../utils/dateTime";

// ✅ workingHours موحّد (نفس الزبون + الحلاق)
import fallbackWorkingHours from "../../constants/workingHours";
import useWeeklyWorkingHours from "../../hooks/useWeeklyWorkingHours";

// ✅ أدوات الهاتف الموحّدة
import {
  toILPhoneE164,
  isILPhoneE164,
  normalizeDigits,
} from "../../utils/phone";

/* ===========================
   تحقق احترافي (Inline)
   =========================== */

// اسم: حرفين فأكثر (يسمح بأحرف عربية/لاتينية + مسافات/'-)
const isNameValid = (v) => {
  if (typeof v !== "string") return false;
  const s = v.trim();
  if (s.length < 2) return false;
  return /^[\p{L}\s'-]{2,}$/u.test(s);
};

// ✅ فحص الهاتف عبر util الموحّد (يقبل كل الصيغ، ويشترط E.164 بعد التطبيع)
const isPhoneValid = (v) => {
  const p = toILPhoneE164(v);
  return isILPhoneE164(p);
};

const isDateValid = (v) => typeof v === "string" && v.trim().length > 0;
const isTimeValid = (v) => typeof v === "string" && v.trim().length > 0;
const isServiceValid = (v) => typeof v === "string" && v.trim().length > 0;

const validateForm = (form) => {
  const errors = {};
  if (!isNameValid(form.fullName)) errors.fullName = "invalid_name";
  if (!isPhoneValid(form.phoneNumber)) errors.phoneNumber = "invalid_phone";
  if (!isDateValid(form.selectedDate)) errors.selectedDate = "invalid_date";
  if (!isTimeValid(form.selectedTime)) errors.selectedTime = "invalid_time";
  if (!isServiceValid(form.selectedService))
    errors.selectedService = "invalid_service";
  return errors;
};

/* ===========================
   ثوابت خارج الكمبوننت
   =========================== */
const initialForm = Object.freeze({
  fullName: "",
  phoneNumber: "",
  selectedDate: "",
  selectedTime: "",
  selectedService: "",
});

const initialTouched = Object.freeze({
  fullName: false,
  phoneNumber: false,
  selectedDate: false,
  selectedTime: false,
  selectedService: false,
});

function BookingSection() {
  const { t, i18n } = useTranslation();
  const isArabic = i18n.language === "ar";
  const fontClass = isArabic ? "font-ar" : "font-body";

  const { weeklyHours } = useWeeklyWorkingHours({ live: true });

  // ✅ مصدر واحد للحقيقة لكل الموقع
  const workingHours = weeklyHours || fallbackWorkingHours;

  // ✅ لازم تكون بعد تعريف workingHours
  const status = getOpeningStatus(workingHours);

  // حالة النموذج كلها في كائن واحد
  const [form, setForm] = useState(initialForm);

  // آخر خطوة لمسها المستخدم
  const [activeStep, setActiveStep] = useState(1);

  // أخطاء وحقول تم لمسها
  const [errors, setErrors] = useState({});
  const [touched, setTouched] = useState(initialTouched);

  const { availableTimes, isDayBlocked, loadingTimes } = useAvailableTimes(
    form.selectedDate,
    workingHours,
  );

  const {
    handleSubmit,
    submitted,
    showSuccessMessage,
    setShowSuccessMessage,
    code,
    messageRef,
  } = useBookingSubmit(form, setForm, t);

  const resetFormUI = () => {
    setForm(initialForm);
    setErrors({});
    setTouched(initialTouched);
    setActiveStep(1);
  };

  // تحقق حيّ (debounce)
  useEffect(() => {
    const id = setTimeout(() => setErrors(validateForm(form)), 150);
    return () => clearTimeout(id);
  }, [form]);

  // عند ظهور رسالة النجاح
  useEffect(() => {
    if (showSuccessMessage) {
      setErrors({});
      setTouched(initialTouched);
      setActiveStep(6);
    }
  }, [showSuccessMessage]);

  const hasErrors = useMemo(() => {
    return Object.keys(validateForm(form)).length > 0;
  }, [form]);

  const fieldState = (key) => {
    const invalid = Boolean(errors[key]);
    const wasTouched = touched[key];
    return {
      isInvalid: invalid && wasTouched,
      isValid:
        !invalid && wasTouched && (form[key] || "").toString().length > 0,
    };
  };

  const completed = useMemo(
    () => ({
      name: isNameValid(form.fullName),
      phone: isPhoneValid(form.phoneNumber),
      date: isDateValid(form.selectedDate),
      time: isTimeValid(form.selectedTime),
      service: isServiceValid(form.selectedService),
      confirm: submitted && Object.keys(validateForm(form)).length === 0,
    }),
    [form, submitted],
  );

  const scrollToFirstError = (errs) => {
    const keys = [
      "fullName",
      "phoneNumber",
      "selectedDate",
      "selectedTime",
      "selectedService",
    ];
    for (const k of keys) {
      if (errs[k]) {
        const el = document.getElementById(`field-${k}`);
        if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
        break;
      }
    }
  };

  return (
    <section
      id="booking"
      className={`bg-[#f8f8f8] text-primary py-16 px-4 ${fontClass}`}
    >
      <div className="max-w-xl mx-auto">
        <SectionTitle>{t("book_now")}</SectionTitle>

        <div className="mb-8">
          <OpeningStatusCard
            t={t}
            status={status}
            workingHours={workingHours}
          />
        </div>

        <div className="bg-white shadow-xl rounded-2xl p-8 space-y-6 border border-gray-100">
          <SuccessModal
            visible={submitted && showSuccessMessage}
            onClose={() => {
              setShowSuccessMessage(false);
              resetFormUI();
            }}
            code={code}
            t={t}
          />

          <ProgressBar
            step={activeStep}
            completed={completed}
            labels={[
              t("name"),
              t("phone"),
              t("choose_date"),
              t("choose_time"),
              t("choose_service"),
              t("confirm_booking") || t("confirm"),
            ]}
          />

          <form onSubmit={handleSubmit} className="space-y-8" ref={messageRef}>
            {/* الاسم */}
            <div id="field-fullName">
              <label className="block text-sm font-semibold text-gold mb-2">
                {t("name")}
              </label>
              {(() => {
                const { isInvalid, isValid } = fieldState("fullName");
                return (
                  <input
                    type="text"
                    placeholder={t("name")}
                    autoComplete="name"
                    className={`w-full p-3 rounded-xl border transition ${
                      isInvalid
                        ? "border-red-500 focus:ring-red-300"
                        : isValid
                          ? "border-emerald-500 focus:ring-emerald-300"
                          : "border-gray-300 focus:border-gold focus:ring-2 focus:ring-gold/40"
                    }`}
                    value={form.fullName}
                    onChange={(e) =>
                      setForm((s) => ({ ...s, fullName: e.target.value }))
                    }
                    onBlur={() => setTouched((s) => ({ ...s, fullName: true }))}
                    onFocus={() => setActiveStep(1)}
                    aria-invalid={isInvalid ? "true" : "false"}
                    aria-describedby={isInvalid ? "err-fullName" : undefined}
                    required
                  />
                );
              })()}
              {touched.fullName && errors.fullName && (
                <p id="err-fullName" className="text-red-500 text-xs mt-1">
                  {t(errors.fullName)}
                </p>
              )}
            </div>

            {/* الهاتف */}
            <div id="field-phoneNumber">
              <label className="block text-sm font-semibold text-gold mb-2">
                {t("phone")}
              </label>

              <div onFocusCapture={() => setActiveStep(2)}>
                <PhoneInput
                  value={form.phoneNumber}
                  onChange={(val) =>
                    setForm((s) => ({
                      ...s,
                      phoneNumber: normalizeDigits(val),
                    }))
                  }
                  onBlur={() =>
                    setTouched((s) => ({ ...s, phoneNumber: true }))
                  }
                  placeholder={t("phone")}
                  inputMode="numeric"
                  autoComplete="tel"
                  enterKeyHint="done"
                  onKeyDown={(e) => {
                    if (e.key === "Enter" && !isPhoneValid(form.phoneNumber)) {
                      e.preventDefault();
                    }
                  }}
                  isValid={isPhoneValid(form.phoneNumber)}
                  isInvalid={
                    touched.phoneNumber && !isPhoneValid(form.phoneNumber)
                  }
                  aria-invalid={
                    touched.phoneNumber && !isPhoneValid(form.phoneNumber)
                      ? "true"
                      : "false"
                  }
                  aria-describedby={
                    touched.phoneNumber && !isPhoneValid(form.phoneNumber)
                      ? "err-phone"
                      : undefined
                  }
                />

                {touched.phoneNumber && !isPhoneValid(form.phoneNumber) && (
                  <p id="err-phone" className="text-red-500 text-xs mt-1">
                    {t("invalid_phone")}
                  </p>
                )}
              </div>
            </div>

            {/* التاريخ */}
            <div id="field-selectedDate">
              <label className="block text-sm font-semibold text-gold mb-2">
                {t("choose_date")}
              </label>
              <div onFocusCapture={() => setActiveStep(3)}>
                <DateField
                  valueYMD={form.selectedDate}
                  onChangeYMD={(ymd) =>
                    setForm((s) => ({
                      ...s,
                      selectedDate: ymd,
                      selectedTime: "",
                    }))
                  }
                  t={t}
                  onBlur={() =>
                    setTouched((s) => ({ ...s, selectedDate: true }))
                  }
                  aria-invalid={
                    touched.selectedDate && errors.selectedDate
                      ? "true"
                      : "false"
                  }
                  aria-describedby={
                    touched.selectedDate && errors.selectedDate
                      ? "err-date"
                      : undefined
                  }
                />
              </div>
              {touched.selectedDate && errors.selectedDate && (
                <p id="err-date" className="text-red-500 text-xs mt-1">
                  {t(errors.selectedDate)}
                </p>
              )}
              {form.selectedDate && isDayBlocked && (
                <p className="text-red-600 font-semibold text-center text-sm mt-2">
                  {t("day_blocked")}
                </p>
              )}
            </div>

            {/* الساعات */}
            {form.selectedDate ? (
              isDayBlocked ? (
                <p className="text-red-600 font-semibold text-center text-sm mt-2">
                  {t("day_blocked")}
                </p>
              ) : (
                <div>
                  <label className="block text-sm font-semibold text-gold mb-3">
                    {t("choose_time")}
                  </label>

                  {loadingTimes ? (
                    <div className="flex items-center justify-center py-6">
                      <div className="animate-spin rounded-full h-6 w-6 border-2 border-gold border-t-transparent" />
                      <span className="ml-2 text-slate-500 text-sm">
                        {t("loading_times")}
                      </span>
                    </div>
                  ) : availableTimes.length > 0 ? (
                    <TimeSelector
                      selectedDate={form.selectedDate}
                      selectedTime={form.selectedTime}
                      onSelectTime={(time) =>
                        setForm((s) => ({ ...s, selectedTime: time }))
                      }
                      availableTimes={availableTimes}
                      workingHours={workingHours}
                      t={t}
                    />
                  ) : (
                    <p className="text-red-500 text-sm font-medium mt-2">
                      {t("no_hours")}
                    </p>
                  )}
                </div>
              )
            ) : (
              <div className="rounded-xl border border-dashed border-gray-200 p-4 bg-gray-50 text-center text-sm text-gray-600">
                {t("pick_date_first")}
              </div>
            )}

            {/* اختيار الخدمة */}
            <div id="field-selectedService">
              <label className="block text-sm font-semibold text-gold mb-3">
                {t("choose_service")}
              </label>
              <div onFocusCapture={() => setActiveStep(5)}>
                <ServiceSelector
                  selectedService={form.selectedService}
                  onSelect={(id) => {
                    setForm((s) => ({ ...s, selectedService: id }));
                    setActiveStep(5);
                  }}
                  t={t}
                  onBlur={() =>
                    setTouched((s) => ({ ...s, selectedService: true }))
                  }
                />
              </div>
              {touched.selectedService && errors.selectedService && (
                <p className="text-red-500 text-xs mt-1">
                  {t(errors.selectedService)}
                </p>
              )}
            </div>

            {/* زر التأكيد */}
            <button
              type="submit"
              onClick={(e) => {
                const allTouched = {
                  fullName: true,
                  phoneNumber: true,
                  selectedDate: true,
                  selectedTime: true,
                  selectedService: true,
                };
                setTouched(allTouched);
                const currentErrors = validateForm(form);
                setErrors(currentErrors);
                if (Object.keys(currentErrors).length > 0) {
                  e.preventDefault();
                  scrollToFirstError(currentErrors);
                }
              }}
              disabled={hasErrors}
              className={`w-full font-bold py-3 rounded-xl shadow transition ${
                hasErrors
                  ? "bg-gray-300 text-gray-600 cursor-not-allowed"
                  : "bg-gradient-to-r from-gold to-yellow-400 text-primary hover:scale-[1.02] hover:shadow-lg"
              }`}
            >
              {t("confirm_booking")}
            </button>
          </form>
        </div>
      </div>
    </section>
  );
}

export default BookingSection;
</file>

</files>
