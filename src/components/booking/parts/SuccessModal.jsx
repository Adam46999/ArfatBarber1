// src/components/booking/SuccessModal.jsx
import { useEffect, useRef, useState } from "react";

/**
 * Props:
 * - visible (bool)
 * - onClose (func)
 * - code (string)
 * - t (func) ุฏุงูุฉ ุงูุชุฑุฌูุฉ
 * - booking (object ุงุฎุชูุงุฑู)
 */
export default function SuccessModal({
  visible,
  onClose,
  code,
  t,
  booking = {},
}) {
  const [copiedCode, setCopiedCode] = useState(false);
  const [copiedAll, setCopiedAll] = useState(false);
  const dialogRef = useRef(null);
  const closeBtnRef = useRef(null);

  // โ ูุง ููุนูุฏ null ูุจู ุงููHooksุ ูุญูู ุชุดุบูู ุงูุชุฃุซูุฑ ุจุดุฑุท "visible"
  useEffect(() => {
    if (!visible) return; // ุฅุฐุง ุงูููุฏุงู ูุฎูู ูุง ูุนูู ุดูุก

    const onKey = (e) => {
      if (e.key === "Escape") onClose?.();
    };
    document.addEventListener("keydown", onKey);

    // ุชุฑููุฒ ุฒุฑ ุงูุฅุบูุงู ุจุนุฏ ุงููุชุญ
    const id = setTimeout(() => closeBtnRef.current?.focus(), 30);

    return () => {
      document.removeEventListener("keydown", onKey);
      clearTimeout(id);
    };
    // ููุงุญุธุฉ: onClose ุฏุงุฎู deps ุขูู ูุฃููุง ูุง ูุบููุฑ ูุฑุฌุนู ุนุงุฏุฉ
  }, [visible, onClose]);

  const handleCopyCode = async () => {
    try {
      await navigator.clipboard.writeText(String(code || ""));
      setCopiedCode(true);
      setTimeout(() => setCopiedCode(false), 2200);
    } catch (err) {
      console.error("share failed", err);

      // no-empty fix: ุฅููุง ุชุนููู ุฃู ููุฌ ุจุณูุท
      // console.error("copy code failed", err);
    }
  };

  const handleCopyAll = async () => {
    try {
      const lines = [
        `${t?.("thank_you") || "ุดูุฑูุง ูู"} โ`,
        `${t?.("your_code") || "ุงูููุฏ"}: ${code || "-"}`,
        booking?.service
          ? `${t?.("service") || "ุงูุฎุฏูุฉ"}: ${booking.service}`
          : null,
        booking?.date || booking?.time
          ? `${t?.("appointment_time") || "ููุนุฏู"}: ${[
              booking.date,
              booking.time,
            ]
              .filter(Boolean)
              .join(" | ")}`
          : null,
        booking?.duration
          ? `${t?.("duration") || "ุงููุฏุฉ"}: ${booking.duration}`
          : null,
        booking?.price ? `${t?.("price") || "ุงูุณุนุฑ"}: ${booking.price}` : null,
        booking?.barber
          ? `${t?.("barber") || "ุงูุญูุงู"}: ${booking.barber}`
          : null,
        booking?.phone ? `${t?.("phone") || "ุงููุงุชู"}: ${booking.phone}` : null,
        booking?.location
          ? `${t?.("location") || "ุงููููุน"}: ${booking.location}`
          : null,
        booking?.notes
          ? `${t?.("notes") || "ููุงุญุธุงุช"}: ${booking.notes}`
          : null,
      ]
        .filter(Boolean)
        .join("\n");

      await navigator.clipboard.writeText(lines);
      setCopiedAll(true);
      setTimeout(() => setCopiedAll(false), 1800);
    } catch (err) {
      console.error("share failed", err);

      // no-empty fix
      // console.error("copy all failed", err);
    }
  };

  const handleShare = async () => {
    const title = t?.("booking_confirmed") || "ุชู ุชุฃููุฏ ุงูุญุฌุฒ";
    const text =
      (t?.("your_code") || "ุงูููุฏ") +
      `: ${code}\n` +
      (booking?.service
        ? `${t?.("service") || "ุงูุฎุฏูุฉ"}: ${booking.service}\n`
        : "") +
      (booking?.date || booking?.time
        ? `${t?.("appointment_time") || "ููุนุฏู"}: ${[booking.date, booking.time]
            .filter(Boolean)
            .join(" | ")}\n`
        : "");
    try {
      if (navigator.share) {
        await navigator.share({ title, text });
      } else {
        await handleCopyAll();
      }
    } catch (err) {
      console.error("share failed", err);

      // no-empty fix
      // console.error("share failed", err);
    }
  };

  const stop = (e) => e.stopPropagation();

  const Row = ({ label, value, mono }) =>
    value ? (
      <div className="flex items-center justify-between gap-3 py-2 border-b last:border-b-0 border-gray-100">
        <span className="text-gray-600">{label}</span>
        <span
          className={
            mono
              ? "font-mono font-semibold text-gray-900"
              : "font-semibold text-gray-900"
          }
        >
          {value}
        </span>
      </div>
    ) : null;

  // โ ููุนูุฏ null ุจุนุฏ ุงููHooks
  if (!visible) return null;

  return (
    <div
      className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm"
      onClick={onClose}
      aria-modal="true"
      role="dialog"
      aria-labelledby="success-title"
      aria-describedby="success-desc"
    >
      <div
        ref={dialogRef}
        onClick={stop}
        className="
          relative w-full max-w-md mx-4
          rounded-2xl overflow-hidden
          shadow-[0_20px_60px_-10px_rgba(0,0,0,0.35)]
          ring-1 ring-green-400/30
          bg-gradient-to-b from-white to-green-50
          animate-[fadeIn_.2s_ease]
        "
      >
        <div className="absolute inset-x-0 top-0 h-1 bg-gradient-to-r from-green-500 via-emerald-500 to-green-600" />

        <button
          ref={closeBtnRef}
          onClick={onClose}
          className="absolute top-3 end-3 inline-flex h-9 w-9 items-center justify-center rounded-full border border-gray-200 bg-white/80 text-gray-600 hover:text-red-600 hover:border-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
          aria-label={t?.("close") || "ุฅุบูุงู"}
        >
          ร
        </button>

        <div className="px-6 pt-8 pb-4 text-center">
          <div className="mx-auto mb-3 flex h-14 w-14 items-center justify-center rounded-full bg-green-100">
            <span className="text-2xl">โ</span>
          </div>
          <h2
            id="success-title"
            className="text-2xl font-extrabold text-gray-900 tracking-tight"
          >
            {t?.("thank_you") || "ุดูุฑูุง ูู"}
          </h2>
          <p id="success-desc" className="mt-1 text-sm text-gray-600">
            {t?.("booking_confirmed") || "ุชู ุชุฃููุฏ ุงูุญุฌุฒ ุจูุฌุงุญ"}
          </p>
        </div>

        <div className="mx-6 rounded-xl border border-green-400/60 bg-white px-4 py-3 mb-4">
          <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-2 text-green-700 font-semibold text-sm">
              <span>๐ {t?.("your_code") || "ุงูููุฏ"}:</span>
            </div>
            <div
              dir="ltr"
              className="font-mono text-base font-bold text-gray-900 select-all"
            >
              {String(code || "-")}
            </div>
          </div>
          <div className="mt-3 flex items-center gap-2">
            <button
              onClick={handleCopyCode}
              className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-green-600 text-white hover:bg-green-700 transition"
            >
              {copiedCode ? "โ ุชู ูุณุฎ ุงูููุฏ" : t?.("copy_code") || "ูุณุฎ ุงูููุฏ"}
            </button>
            <button
              onClick={handleShare}
              className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-gray-900 text-white hover:opacity-90 transition"
            >
              {t?.("share") || "ูุดุงุฑูุฉ"}
            </button>
          </div>
        </div>

        {(booking?.service ||
          booking?.date ||
          booking?.time ||
          booking?.duration ||
          booking?.price ||
          booking?.barber ||
          booking?.phone ||
          booking?.location ||
          booking?.notes) && (
          <div className="mx-6 mb-4 rounded-xl border border-gray-200 bg-white px-4 py-3">
            <Row label={t?.("service") || "ุงูุฎุฏูุฉ"} value={booking.service} />
            <Row
              label={t?.("appointment_time") || "ููุนุฏู"}
              value={[booking.date, booking.time].filter(Boolean).join(" | ")}
            />
            <Row label={t?.("duration") || "ุงููุฏุฉ"} value={booking.duration} />
            <Row label={t?.("price") || "ุงูุณุนุฑ"} value={booking.price} />
            <Row label={t?.("barber") || "ุงูุญูุงู"} value={booking.barber} />
            <Row label={t?.("phone") || "ุงููุงุชู"} value={booking.phone} />
            <Row label={t?.("location") || "ุงููููุน"} value={booking.location} />
            <Row label={t?.("notes") || "ููุงุญุธุงุช"} value={booking.notes} />
            <div className="pt-3 flex items-center gap-2">
              <button
                onClick={handleCopyAll}
                className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-emerald-600 text-white hover:bg-emerald-700 transition"
              >
                {copiedAll
                  ? "โ ุชู ูุณุฎ ุงูุชูุงุตูู"
                  : t?.("copy_all") || "ูุณุฎ ูู ุงูุชูุงุตูู"}
              </button>
            </div>
          </div>
        )}

        <p className="mx-6 text-[13px] text-gray-500 mb-5">
          {t?.("keep_code_hint") ||
            "ุงุญุชูุธ ุจูุฐุง ุงูููุฏ ูุชุนุฏูู ุฃู ุฅูุบุงุก ุงูุญุฌุฒ ูุงุญููุง."}
        </p>

        <div className="px-6 pb-6 flex flex-col sm:flex-row gap-3">
          <button
            onClick={onClose}
            className="w-full inline-flex items-center justify-center rounded-xl bg-green-600 text-white px-4 py-2.5 font-semibold hover:bg-green-700 transition"
          >
            {t?.("got_it") || "ุชูุงู"}
          </button>
          <button
            onClick={handleCopyAll}
            className="w-full inline-flex items-center justify-center rounded-xl bg-white text-gray-900 border border-gray-200 px-4 py-2.5 font-semibold hover:bg-gray-50 transition"
          >
            {copiedAll
              ? "โ ุชู ูุณุฎ ุงูุชูุงุตูู"
              : t?.("copy_and_close") || "ูุณุฎ ุงูุชูุงุตูู"}
          </button>
        </div>
      </div>

      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(6px) scale(0.98); }
          to   { opacity: 1; transform: translateY(0)    scale(1); }
        }
      `}</style>
    </div>
  );
}
